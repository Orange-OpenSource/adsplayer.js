/*
 * The copyright in this software module is being made available under the BSD License, included below. This software module may be subject to other third party and/or contributor rights, including patent rights, and no such rights are granted under this license.
 * The whole software resulting from the execution of this software module together with its external dependent software modules from dash.js project may be subject to Orange and/or other third party rights, including patent rights, and no such rights are granted under this license.
 * 
 * Copyright (c) 2014, Orange
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 * •  Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 * •  Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 * •  Neither the name of the Orange nor the names of its contributors may be used to endorse or promote products derived from this software module without specific prior written permission.
 * 
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS” AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
/* Last build : 10.3.2016_11:13:27 / git revision : 1f8b2c1 */
/* jshint ignore:start */
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.OrangeHasPlayer=b()}):"object"==typeof exports?module.exports=b():a.OrangeHasPlayer=b()}(this,function(){function b(a){var b;for(b=[],i=0,len=a.length;i<len;i+=1)a[i].isRoot?b.push("root"):b.push(a[i].name);var c=function(a,b){var c;if(null!==a&&null!==b)for(c in a)a.hasOwnProperty(c)&&(b.hasOwnProperty(c)||(b[c]=a[c]))},d=function(a,b,d){var e,f,g,h,i;if(null!==a&&0!==a.length)for(e=0,f=a.length;f>e;e+=1)g=a[e],b.hasOwnProperty(g.name)&&(d.hasOwnProperty(g.name)?g.merge&&(h=b[g.name],i=d[g.name],"object"==typeof h&&"object"==typeof i?c(h,i):null!=g.mergeFunction?d[g.name]=g.mergeFunction(h,i):d[g.name]=h+i):d[g.name]=b[g.name])},e=function(a,b){var c,f,g,h,i,j,k,l=a;if(null!==l.children&&0!==l.children.length)for(c=0,f=l.children.length;f>c;c+=1)if(j=l.children[c],b.hasOwnProperty(j.name))if(j.isArray)for(i=b[j.name+"_asArray"],g=0,h=i.length;h>g;g+=1)k=i[g],d(l.properties,b,k),e(j,k);else k=b[j.name],d(l.properties,b,k),e(j,k)},f=function(c){var d,g,h,i,j,k,l;if(null===c)return c;if("object"!=typeof c)return c;for(d=0,g=b.length;g>d;d+=1)"root"===b[d]&&(j=a[d],k=c,e(j,k));for(i in c)if(c.hasOwnProperty(i)){if(h=b.indexOf(i),-1!==h)if(j=a[h],j.isArray)for(l=c[i+"_asArray"],d=0,g=l.length;g>d;d+=1)k=l[d],e(j,k);else k=c[i],e(j,k);f(c[i])}return c};return{run:f}}function c(a,b,c){function d(a){var b=a.localName;return null==b&&(b=a.baseName),(null==b||""==b)&&(b=a.nodeName),b}function e(a){return a.prefix}function f(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):a}function g(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function h(f){if(f.nodeType==u.DOCUMENT_NODE){var i,j,k,l=f.firstChild;for(j=0,k=f.childNodes.length;k>j;j+=1)if(f.childNodes[j].nodeType!==u.COMMENT_NODE){l=f.childNodes[j];break}if(c)i=h(l);else{i={};var m=d(l);i[m]=h(l)}return i}if(f.nodeType==u.ELEMENT_NODE){var i=new Object;i.__cnt=0;for(var n=f.childNodes,o=0;o<n.length;o++){var l=n.item(o),m=d(l);if(i.__cnt++,null==i[m])i[m]=h(l),i[m+"_asArray"]=new Array(1),i[m+"_asArray"][0]=i[m];else{if(null!=i[m]&&!(i[m]instanceof Array)){var p=i[m];i[m]=new Array,i[m][0]=p,i[m+"_asArray"]=i[m]}for(var q=0;null!=i[m][q];)q++;i[m][q]=h(l)}}for(var r=0;r<f.attributes.length;r++){var s=f.attributes.item(r);i.__cnt++;for(var v=s.value,w=0,x=a.length;x>w;w++){var y=a[w];y.test.call(this,s.value)&&(v=y.converter.call(this,s.value))}i[b+s.name]=v}var z=e(f);return null!=z&&""!=z&&(i.__cnt++,i.__prefix=z),1==i.__cnt&&null!=i["#text"]&&(i=i["#text"]),null!=i["#text"]&&(i.__text=i["#text"],t&&(i.__text=g(i.__text)),delete i["#text"],delete i["#text_asArray"]),null!=i["#cdata-section"]&&(i.__cdata=i["#cdata-section"],delete i["#cdata-section"],delete i["#cdata-section_asArray"]),(null!=i.__text||null!=i.__cdata)&&(i.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),i}return f.nodeType==u.TEXT_NODE||f.nodeType==u.CDATA_SECTION_NODE?f.nodeValue:f.nodeType==u.COMMENT_NODE?null:void 0}function i(a,b,c,d){var e="<"+(null!=a&&null!=a.__prefix?a.__prefix+":":"")+b;if(null!=c)for(var f=0;f<c.length;f++){var g=c[f],h=a[g];e+=" "+g.substr(1)+"='"+h+"'"}return e+=d?"/>":">"}function j(a,b){return"</"+(null!=a.__prefix?a.__prefix+":":"")+b+">"}function k(a,b){return-1!==a.indexOf(b,a.length-b.length)}function l(a,b){return k(b.toString(),"_asArray")||0==b.toString().indexOf("_")||a[b]instanceof Function?!0:!1}function m(a){var b=0;if(a instanceof Object)for(var c in a)l(a,c)||b++;return b}function n(a){var b=[];if(a instanceof Object)for(var c in a)-1==c.toString().indexOf("__")&&0==c.toString().indexOf("_")&&b.push(c);return b}function o(a){var b="";return null!=a.__cdata&&(b+="<![CDATA["+a.__cdata+"]]>"),null!=a.__text&&(b+=t?f(a.__text):a.__text),b}function p(a){var b="";return a instanceof Object?b+=o(a):null!=a&&(b+=t?f(a):a),b}function q(a,b,c){var d="";if(0==a.length)d+=i(a,b,c,!0);else for(var e=0;e<a.length;e++)d+=i(a[e],b,n(a[e]),!1),d+=r(a[e]),d+=j(a[e],b);return d}function r(a){var b="",c=m(a);if(c>0)for(var d in a)if(!l(a,d)){var e=a[d],f=n(e);if(null==e||void 0==e)b+=i(e,d,f,!0);else if(e instanceof Object)if(e instanceof Array)b+=q(e,d,f);else{var g=m(e);g>0||null!=e.__text||null!=e.__cdata?(b+=i(e,d,f,!1),b+=r(e),b+=j(e,d)):b+=i(e,d,f,!0)}else b+=i(e,d,f,!1),b+=p(e),b+=j(e,d)}return b+=p(a)}(null===b||void 0===b)&&(b="_"),(null===c||void 0===c)&&(c=!1);var s="1.0.11",t=!1,u={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(a){var b;if(window.DOMParser)try{var c=new window.DOMParser;if(b=c.parseFromString(a,"text/xml"),b.getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(d){return null}return b},this.xml2json=function(a){return h(a)},this.xml_str2json=function(a){var b=this.parseXmlString(a);return null===b?b:this.xml2json(b)},this.json2xml_str=function(a){return r(a)},this.json2xml=function(a){var b=this.json2xml_str(a);return this.parseXmlString(b)},this.getVersion=function(){return s},this.escapeMode=function(a){t=a}}function d(){"use strict";var a,b,c;try{a=navigator.userAgent.toLowerCase(),/msie (\d+\.\d+);/.test(a)?(c=Number(RegExp.$1),a.indexOf("trident/6")>-1&&(c=10),a.indexOf("trident/5")>-1&&(c=9),a.indexOf("trident/4")>-1&&(c=8),b="Internet Explorer"):a.indexOf("trident/7")>-1?(c=11,b="Internet Explorer"):/edge[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Edge"):/firefox[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Firefox"):/opera[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Opera"):/chrome[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Chrome"):/version[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Safari"):/rv[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Mozilla"):/mozilla[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Mozilla"):/binget[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (BinGet)"):/curl[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (cURL)"):/java[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (Java)"):/libwww-perl[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (libwww-perl)"):/microsoft url control -[\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (Microsoft URL Control)"):/peach[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (Peach)"):/php[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (PHP)"):/pxyscand[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (pxyscand)"):/pycurl[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (PycURL)"):/python-urllib[\/\s](\d+\.\d+)/.test(a)?(c=Number(RegExp.$1),b="Library (Python URLlib)"):/appengine-google/.test(a)?(c=Number(RegExp.$1),b="Cloud (Google AppEngine)"):/trident/.test(a)?(c=Number(RegExp.$1),b="Trident"):/adventurer/.test(a)?(c=Number(RegExp.$1),b="Adventurer"):(c="unknown",b="unknown")}catch(d){b="error",c="error"}return{name:b.replace(/\s+/g,""),version:c}}function e(){"use strict";var a,b,c,d;try{a=navigator.userAgent.toLowerCase(),c=-1!==a.indexOf("windows nt 10.0")?"Windows 10":-1!==a.indexOf("windows nt 6.3")?"Windows 8.1":-1!==a.indexOf("windows nt 6.2")?"Windows 8":-1!==a.indexOf("windows nt 6.1")?"Windows 7":-1!==a.indexOf("windows nt 6.0")?"Windows Vista/Windows Server 2008":-1!==a.indexOf("windows nt 5.2")?"Windows XP x64/Windows Server 2003":-1!==a.indexOf("windows nt 5.1")?"Windows XP":-1!==a.indexOf("windows nt 5.01")?"Windows 2000, Service Pack 1 (SP1)":-1!==a.indexOf("windows xp")?"Windows XP":-1!==a.indexOf("windows 2000")?"Windows 2000":-1!==a.indexOf("windows nt 5.0")?"Windows 2000":-1!==a.indexOf("windows nt 4.0")?"Windows NT 4.0":-1!==a.indexOf("windows nt")?"Windows NT 4.0":-1!==a.indexOf("winnt4.0")?"Windows NT 4.0":-1!==a.indexOf("winnt")?"Windows NT 4.0":-1!==a.indexOf("windows me")?"Windows ME":-1!==a.indexOf("win 9x 4.90")?"Windows ME":-1!==a.indexOf("windows 98")?"Windows 98":-1!==a.indexOf("win98")?"Windows 98":-1!==a.indexOf("windows 95")?"Windows 95":-1!==a.indexOf("windows_95")?"Windows 95":-1!==a.indexOf("win95")?"Windows 95":-1!==a.indexOf("ce")?"Windows CE":-1!==a.indexOf("win16")?"Windows 3.11":-1!==a.indexOf("iemobile")?"Windows Mobile":-1!==a.indexOf("wm5 pie")?"Windows Mobile":-1!==a.indexOf("windows")?"Windows (Unknown Version)":-1!==a.indexOf("openbsd")?"Open BSD":-1!==a.indexOf("sunos")?"Sun OS":-1!==a.indexOf("ubuntu")?"Ubuntu":-1!==a.indexOf("ipad")?"iOS (iPad)":-1!==a.indexOf("ipod")?"iOS (iTouch)":-1!==a.indexOf("iphone")?"iOS (iPhone)":-1!==a.indexOf("mac os x beta")?"Mac OSX Beta (Kodiak)":-1!==a.indexOf("mac os x 10.0")?"Mac OSX Cheetah":-1!==a.indexOf("mac os x 10.1")?"Mac OSX Puma":-1!==a.indexOf("mac os x 10.2")?"Mac OSX Jaguar":-1!==a.indexOf("mac os x 10.3")?"Mac OSX Panther":-1!==a.indexOf("mac os x 10.4")?"Mac OSX Tiger":-1!==a.indexOf("mac os x 10.5")?"Mac OSX Leopard":-1!==a.indexOf("mac os x 10.6")?"Mac OSX Snow Leopard":-1!==a.indexOf("mac os x 10.7")?"Mac OSX Lion":-1!==a.indexOf("mac os x")?"Mac OSX (Version Unknown)":-1!==a.indexOf("mac_68000")?"Mac OS Classic (68000)":-1!==a.indexOf("68K")?"Mac OS Classic (68000)":-1!==a.indexOf("mac_powerpc")?"Mac OS Classic (PowerPC)":-1!==a.indexOf("ppc mac")?"Mac OS Classic (PowerPC)":-1!==a.indexOf("macintosh")?"Mac OS Classic":-1!==a.indexOf("googletv")?"Android (GoogleTV)":-1!==a.indexOf("xoom")?"Android (Xoom)":-1!==a.indexOf("htc_flyer")?"Android (HTC Flyer)":-1!==a.indexOf("android")?"Android":-1!==a.indexOf("symbian")?"Symbian":-1!==a.indexOf("series60")?"Symbian (Series 60)":-1!==a.indexOf("series70")?"Symbian (Series 70)":-1!==a.indexOf("series80")?"Symbian (Series 80)":-1!==a.indexOf("series90")?"Symbian (Series 90)":-1!==a.indexOf("x11")?"UNIX":-1!==a.indexOf("nix")?"UNIX":-1!==a.indexOf("linux")?"Linux":-1!==a.indexOf("qnx")?"QNX":-1!==a.indexOf("os/2")?"IBM OS/2":-1!==a.indexOf("beos")?"BeOS":-1!==a.indexOf("blackberry95")?"Blackberry (Storm 1/2)":-1!==a.indexOf("blackberry97")?"Blackberry (Bold)":-1!==a.indexOf("blackberry96")?"Blackberry (Tour)":-1!==a.indexOf("blackberry89")?"Blackberry (Curve 2)":-1!==a.indexOf("blackberry98")?"Blackberry (Torch)":-1!==a.indexOf("playbook")?"Blackberry (Playbook)":-1!==a.indexOf("wnd.rim")?"Blackberry (IE/FF Emulator)":-1!==a.indexOf("blackberry")?"Blackberry":-1!==a.indexOf("palm")?"Palm OS":-1!==a.indexOf("webos")?"WebOS":-1!==a.indexOf("hpwos")?"WebOS (HP)":-1!==a.indexOf("blazer")?"Palm OS (Blazer)":-1!==a.indexOf("xiino")?"Palm OS (Xiino)":-1!==a.indexOf("kindle")?"Kindle":-1!==a.indexOf("wii")?"Nintendo (Wii)":-1!==a.indexOf("nintendo ds")?"Nintendo (DS)":-1!==a.indexOf("playstation 3")?"Sony (Playstation Console)":-1!==a.indexOf("playstation portable")?"Sony (Playstation Portable)":-1!==a.indexOf("webtv")?"MSN TV (WebTV)":-1!==a.indexOf("inferno")?"Inferno":"Unknown",b=navigator.platform.toLowerCase(),d=-1!==b.indexOf("x64")?"64":-1!==a.indexOf("x86_64")?"64":-1!==a.indexOf("x86-64")?"64":-1!==a.indexOf("win64")?"64":-1!==a.indexOf("x64;")?"64":-1!==a.indexOf("amd64")?"64":-1!==a.indexOf("wow64")?"64":-1!==a.indexOf("x64_64")?"64":-1!==a.indexOf("ia65")?"64":-1!==a.indexOf("sparc64")?"64":-1!==a.indexOf("ppc64")?"64":-1!==a.indexOf("irix64")?"64":-1!==a.indexOf("irix64")?"64":"32"}catch(e){c="error",d="error"}return{name:c.replace(/\s+/g,""),bits:"x"+d}}function f(a,b,c,d){this.version="1.0.3",this.player=a,this.video=b,this.parameters=c,this.debug=d,this.timerActivated=!1,(void 0===this.debug||null===this.debug)&&(this.debug=console),this.sessionId=null,this.database=new g(this.video),this.collector=new f.collectors[this.parameters.collector](this.player,this.database),this.formatter=new f.formatters[this.parameters.formatter](this.database,this.parameters),this.sender=new h(this.debug),this.isSending=!1}function g(a){this.sessionId=null,this.video=a,this.browserId="browserid",this.metrics=[]}function h(a){this.debug=a}function j(a,b){this.player=a,this.video=this.player.getVideoModel().getElement(),this.database=b,this.sessionId=null,this.playerId=String(Math.random()).substring(2)}function k(a){AbstractFormatter.call(this,a),this.StateObject={},this.StateObject.Playing={count:0,duration:0,lastNewStateDuration:0},this.StateObject.Buffering={count:0,duration:0,lastNewStateDuration:0},this.StateObject.Paused={count:0,duration:0,lastNewStateDuration:0},this.StateObject.Stopped={count:0,duration:0,lastNewStateDuration:0},this.StateObject.Seeking={count:0,duration:0,lastNewStateDuration:0}}function l(a){var b=0;if(this.param=[],this.enable=!1,a)for(this.enable=!0,b=0;b<a.length;b+=1)this.param.push(parseInt(a[b],10))}function m(){this.enable=!1,this.error=null,this.profil=null,this.usage=null}function n(a,b){AbstractFormatter.call(this,a);var c=b.eventsObjectFilter&&b.eventsObjectFilter.length>0?b.eventsObjectFilter:this.DEFAULT_EVENTS_OBJECT_FILTER,d=b.eventTypeSessionFilter&&b.eventTypeSessionFilter.length>0?b.eventTypeSessionFilter:this.DEFAULT_EVENT_TYPE_SESSION_FILTER,e=b.eventTypeRealTimeFilter&&b.eventTypeRealTimeFilter.length>0?b.eventTypeRealTimeFilter:this.DEFAULT_EVENT_TYPE_REALTIME_FILTER,f=c.split(";");this.eventTypeSessionFilter=this.parseEventsFilter(d),this.eventTypeRealTimeFilter=this.parseEventsFilter(e),this.eventTypeSessionFilter.enable=f.indexOf("session")>-1?!0:!1,this.eventTypeRealTimeFilter.enable=f.indexOf("realtime")>-1?!0:!1}var o,p,q,r={},t={},u={},v={},w={},x={};x.encode=function(a){for(var b=[],c=0;c<a.length;++c){var d=a.charCodeAt(c);128>d?b.push(d):2048>d?(b.push(192|d>>6),b.push(128|63&d)):65536>d?(b.push(224|d>>12),b.push(128|63&d>>6),b.push(128|63&d)):(b.push(240|d>>18),b.push(128|63&d>>12),b.push(128|63&d>>6),b.push(128|63&d))}return b},x.decode=function(a){for(var b=[],c=0;c<a.length;){var d=a[c++];128>d||(224>d?(d=(31&d)<<6,d|=63&a[c++]):240>d?(d=(15&d)<<12,d|=(63&a[c++])<<6,d|=63&a[c++]):(d=(7&d)<<18,d|=(63&a[c++])<<12,d|=(63&a[c++])<<6,d|=63&a[c++])),b.push(String.fromCharCode(d))}return b.join("")};var y={};if(function(b){var c=function(a){for(var c=0,d=[],e=0|a.length/3;0<e--;){var f=(a[c]<<16)+(a[c+1]<<8)+a[c+2];c+=3,d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push(b.charAt(63&f>>6)),d.push(b.charAt(63&f))}if(2==a.length-c){var f=(a[c]<<16)+(a[c+1]<<8);d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push(b.charAt(63&f>>6)),d.push("=")}else if(1==a.length-c){var f=a[c]<<16;d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push("==")}return d.join("")},d=function(){for(var a=[],c=0;c<b.length;++c)a[b.charCodeAt(c)]=c;return a["=".charCodeAt(0)]=0,a}(),e=function(a){for(var b=0,c=[],e=0|a.length/4;0<e--;){var f=(d[a.charCodeAt(b)]<<18)+(d[a.charCodeAt(b+1)]<<12)+(d[a.charCodeAt(b+2)]<<6)+d[a.charCodeAt(b+3)];c.push(255&f>>16),c.push(255&f>>8),c.push(255&f),b+=4}return c&&("="==a.charAt(b-2)?(c.pop(),c.pop()):"="==a.charAt(b-1)&&c.pop()),c},f={};f.encode=function(a){for(var b=[],c=0;c<a.length;++c)b.push(a.charCodeAt(c));return b},f.decode=function(b){for(var c=0;c<s.length;++c)a[c]=String.fromCharCode(a[c]);return a.join("")},y.decodeArray=function(a){var b=e(a);return new Uint8Array(b)},y.encodeASCII=function(a){var b=f.encode(a);return c(b)},y.decodeASCII=function(a){var b=e(a);return f.decode(b)},y.encode=function(a){var b=x.encode(a);return c(b)},y.decode=function(a){var b=e(a);return x.decode(b)}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),void 0===z)var z=y.encode;if(void 0===A)var A=y.decode;if(function(a){"use strict";var b={VERSION:"0.5.3"};b.System=function(){this._mappings={},this._outlets={},this._handlers={},this.strictInjections=!0,this.autoMapOutlets=!1,this.postInjectionHook="setup"},b.System.prototype={_createAndSetupInstance:function(a,b){var c=new b;return this.injectInto(c,a),c},_retrieveFromCacheOrCreate:function(a,b){"undefined"==typeof b&&(b=!1);var c;if(!this._mappings.hasOwnProperty(a))throw new Error(1e3);var d=this._mappings[a];return!b&&d.isSingleton?(null==d.object&&(d.object=this._createAndSetupInstance(a,d.clazz)),c=d.object):c=d.clazz?this._createAndSetupInstance(a,d.clazz):d.object,c},mapOutlet:function(a,b,c){if("undefined"==typeof a)throw new Error(1010);return b=b||"global",c=c||a,this._outlets.hasOwnProperty(b)||(this._outlets[b]={}),this._outlets[b][c]=a,this},getObject:function(a){if("undefined"==typeof a)throw new Error(1020);return this._retrieveFromCacheOrCreate(a)},mapValue:function(a,b){if("undefined"==typeof a)throw new Error(1030);return this._mappings[a]={clazz:null,object:b,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(a),this.hasMapping(a)&&this.injectInto(b,a),this},hasMapping:function(a){if("undefined"==typeof a)throw new Error(1040);return this._mappings.hasOwnProperty(a)},mapClass:function(a,b){if("undefined"==typeof a)throw new Error(1050);if("undefined"==typeof b)throw new Error(1051);return this._mappings[a]={clazz:b,object:null,isSingleton:!1},this.autoMapOutlets&&this.mapOutlet(a),this},mapSingleton:function(a,b){if("undefined"==typeof a)throw new Error(1060);if("undefined"==typeof b)throw new Error(1061);return this._mappings[a]={clazz:b,object:null,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(a),this},instantiate:function(a){if("undefined"==typeof a)throw new Error(1070);return this._retrieveFromCacheOrCreate(a,!0)},injectInto:function(a,b){if("undefined"==typeof a)throw new Error(1080);if("object"==typeof a){var c=[];this._outlets.hasOwnProperty("global")&&c.push(this._outlets.global),"undefined"!=typeof b&&this._outlets.hasOwnProperty(b)&&c.push(this._outlets[b]);for(var d in c){var e=c[d];for(var f in e){var g=e[f];(!this.strictInjections||f in a)&&(a[f]=this.getObject(g))}}"setup"in a&&a.setup.call(a)}return this},unmap:function(a){if("undefined"==typeof a)throw new Error(1090);return delete this._mappings[a],this},unmapOutlet:function(a,b){if("undefined"==typeof a)throw new Error(1100);if("undefined"==typeof b)throw new Error(1101);return delete this._outlets[a][b],this},mapHandler:function(a,b,c,d,e){if("undefined"==typeof a)throw new Error(1110);return b=b||"global",c=c||a,"undefined"==typeof d&&(d=!1),"undefined"==typeof e&&(e=!1),this._handlers.hasOwnProperty(a)||(this._handlers[a]={}),this._handlers[a].hasOwnProperty(b)||(this._handlers[a][b]=[]),this._handlers[a][b].push({handler:c,oneShot:d,passEvent:e}),this},unmapHandler:function(a,b,c){if("undefined"==typeof a)throw new Error(1120);if(b=b||"global",this._handlers.hasOwnProperty(a)&&this._handlers[a].hasOwnProperty(b)){var d=this._handlers[a][b];for(var e in d){var f=d[e];if(!c||f.handler===c){d.splice(e,1);break}}}return this},notify:function(a){if("undefined"==typeof a)throw new Error(1130);var b=Array.prototype.slice.call(arguments),c=b.slice(1);if(this._handlers.hasOwnProperty(a)){var d=this._handlers[a];for(var e in d){var f,g=d[e];"global"!==e&&(f=this.getObject(e));var h,i,j=[];for(h=0,i=g.length;i>h;h++){var k,l=g[h];k=f&&"string"==typeof l.handler?f[l.handler]:l.handler,l.oneShot&&j.unshift(h),l.passEvent?k.apply(f,b):k.apply(f,c)}for(h=0,i=j.length;i>h;h++)g.splice(j[h],1)}}return this}},a.dijon=b}(this),p={},p.math={},p.math.Long=function(a,b){this.low_=0|a,this.high_=0|b},p.math.Long.IntCache_={},p.math.Long.fromInt=function(a){if(a>=-128&&128>a){var b=p.math.Long.IntCache_[a];if(b)return b}var c=new p.math.Long(0|a,0>a?-1:0);return a>=-128&&128>a&&(p.math.Long.IntCache_[a]=c),c},p.math.Long.fromNumber=function(a){return isNaN(a)||!isFinite(a)?p.math.Long.ZERO:a<=-p.math.Long.TWO_PWR_63_DBL_?p.math.Long.MIN_VALUE:a+1>=p.math.Long.TWO_PWR_63_DBL_?p.math.Long.MAX_VALUE:0>a?p.math.Long.fromNumber(-a).negate():new p.math.Long(a%p.math.Long.TWO_PWR_32_DBL_|0,a/p.math.Long.TWO_PWR_32_DBL_|0)},p.math.Long.fromBits=function(a,b){return new p.math.Long(a,b)},p.math.Long.fromString=function(a,b){if(0==a.length)throw Error("number format error: empty string");var c=b||10;if(2>c||c>36)throw Error("radix out of range: "+c);if("-"==a.charAt(0))return p.math.Long.fromString(a.substring(1),c).negate();if(a.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+a);for(var d=p.math.Long.fromNumber(Math.pow(c,8)),e=p.math.Long.ZERO,f=0;f<a.length;f+=8){var g=Math.min(8,a.length-f),h=parseInt(a.substring(f,f+g),c);if(8>g){var i=p.math.Long.fromNumber(Math.pow(c,g));e=e.multiply(i).add(p.math.Long.fromNumber(h))}else e=e.multiply(d),e=e.add(p.math.Long.fromNumber(h))}return e},p.math.Long.TWO_PWR_16_DBL_=65536,p.math.Long.TWO_PWR_24_DBL_=1<<24,p.math.Long.TWO_PWR_32_DBL_=p.math.Long.TWO_PWR_16_DBL_*p.math.Long.TWO_PWR_16_DBL_,p.math.Long.TWO_PWR_31_DBL_=p.math.Long.TWO_PWR_32_DBL_/2,p.math.Long.TWO_PWR_48_DBL_=p.math.Long.TWO_PWR_32_DBL_*p.math.Long.TWO_PWR_16_DBL_,p.math.Long.TWO_PWR_64_DBL_=p.math.Long.TWO_PWR_32_DBL_*p.math.Long.TWO_PWR_32_DBL_,p.math.Long.TWO_PWR_63_DBL_=p.math.Long.TWO_PWR_64_DBL_/2,p.math.Long.ZERO=p.math.Long.fromInt(0),p.math.Long.ONE=p.math.Long.fromInt(1),p.math.Long.NEG_ONE=p.math.Long.fromInt(-1),p.math.Long.MAX_VALUE=p.math.Long.fromBits(-1,2147483647),p.math.Long.MIN_VALUE=p.math.Long.fromBits(0,-2147483648),p.math.Long.TWO_PWR_24_=p.math.Long.fromInt(1<<24),p.math.Long.prototype.toInt=function(){return this.low_},p.math.Long.prototype.toNumber=function(){return this.high_*p.math.Long.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},p.math.Long.prototype.toString=function(a){var b=a||10;if(2>b||b>36)throw Error("radix out of range: "+b);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(p.math.Long.MIN_VALUE)){var c=p.math.Long.fromNumber(b),d=this.div(c),e=d.multiply(c).subtract(this);return d.toString(b)+e.toInt().toString(b)}return"-"+this.negate().toString(b)}for(var f=p.math.Long.fromNumber(Math.pow(b,6)),e=this,g="";;){var h=e.div(f),i=e.subtract(h.multiply(f)).toInt(),j=i.toString(b);if(e=h,e.isZero())return j+g;for(;j.length<6;)j="0"+j;g=""+j+g}},p.math.Long.prototype.getHighBits=function(){return this.high_},p.math.Long.prototype.getLowBits=function(){return this.low_},p.math.Long.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:p.math.Long.TWO_PWR_32_DBL_+this.low_},p.math.Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(p.math.Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var a=0!=this.high_?this.high_:this.low_,b=31;b>0&&0==(a&1<<b);b--);return 0!=this.high_?b+33:b+1},p.math.Long.prototype.isZero=function(){return 0==this.high_&&0==this.low_},p.math.Long.prototype.isNegative=function(){return this.high_<0},p.math.Long.prototype.isOdd=function(){return 1==(1&this.low_)},p.math.Long.prototype.equals=function(a){return this.high_==a.high_&&this.low_==a.low_},p.math.Long.prototype.notEquals=function(a){return this.high_!=a.high_||this.low_!=a.low_},p.math.Long.prototype.lessThan=function(a){return this.compare(a)<0},p.math.Long.prototype.lessThanOrEqual=function(a){return this.compare(a)<=0},p.math.Long.prototype.greaterThan=function(a){return this.compare(a)>0},p.math.Long.prototype.greaterThanOrEqual=function(a){return this.compare(a)>=0},p.math.Long.prototype.compare=function(a){if(this.equals(a))return 0;var b=this.isNegative(),c=a.isNegative();return b&&!c?-1:!b&&c?1:this.subtract(a).isNegative()?-1:1},p.math.Long.prototype.negate=function(){return this.equals(p.math.Long.MIN_VALUE)?p.math.Long.MIN_VALUE:this.not().add(p.math.Long.ONE)},p.math.Long.prototype.add=function(a){var b=this.high_>>>16,c=65535&this.high_,d=this.low_>>>16,e=65535&this.low_,f=a.high_>>>16,g=65535&a.high_,h=a.low_>>>16,i=65535&a.low_,j=0,k=0,l=0,m=0;return m+=e+i,l+=m>>>16,m&=65535,l+=d+h,k+=l>>>16,l&=65535,k+=c+g,j+=k>>>16,k&=65535,j+=b+f,j&=65535,p.math.Long.fromBits(l<<16|m,j<<16|k)},p.math.Long.prototype.subtract=function(a){return this.add(a.negate())},p.math.Long.prototype.multiply=function(a){if(this.isZero())return p.math.Long.ZERO;if(a.isZero())return p.math.Long.ZERO;if(this.equals(p.math.Long.MIN_VALUE))return a.isOdd()?p.math.Long.MIN_VALUE:p.math.Long.ZERO;if(a.equals(p.math.Long.MIN_VALUE))return this.isOdd()?p.math.Long.MIN_VALUE:p.math.Long.ZERO;if(this.isNegative())return a.isNegative()?this.negate().multiply(a.negate()):this.negate().multiply(a).negate();if(a.isNegative())return this.multiply(a.negate()).negate();if(this.lessThan(p.math.Long.TWO_PWR_24_)&&a.lessThan(p.math.Long.TWO_PWR_24_))return p.math.Long.fromNumber(this.toNumber()*a.toNumber());var b=this.high_>>>16,c=65535&this.high_,d=this.low_>>>16,e=65535&this.low_,f=a.high_>>>16,g=65535&a.high_,h=a.low_>>>16,i=65535&a.low_,j=0,k=0,l=0,m=0;return m+=e*i,l+=m>>>16,m&=65535,l+=d*i,k+=l>>>16,l&=65535,l+=e*h,k+=l>>>16,l&=65535,k+=c*i,j+=k>>>16,k&=65535,k+=d*h,j+=k>>>16,k&=65535,k+=e*g,j+=k>>>16,k&=65535,j+=b*i+c*h+d*g+e*f,j&=65535,p.math.Long.fromBits(l<<16|m,j<<16|k)},p.math.Long.prototype.div=function(a){if(a.isZero())throw Error("division by zero");if(this.isZero())return p.math.Long.ZERO;if(this.equals(p.math.Long.MIN_VALUE)){if(a.equals(p.math.Long.ONE)||a.equals(p.math.Long.NEG_ONE))return p.math.Long.MIN_VALUE;if(a.equals(p.math.Long.MIN_VALUE))return p.math.Long.ONE;var b=this.shiftRight(1),c=b.div(a).shiftLeft(1);if(c.equals(p.math.Long.ZERO))return a.isNegative()?p.math.Long.ONE:p.math.Long.NEG_ONE;var d=this.subtract(a.multiply(c)),e=c.add(d.div(a));return e}if(a.equals(p.math.Long.MIN_VALUE))return p.math.Long.ZERO;if(this.isNegative())return a.isNegative()?this.negate().div(a.negate()):this.negate().div(a).negate();if(a.isNegative())return this.div(a.negate()).negate();for(var f=p.math.Long.ZERO,d=this;d.greaterThanOrEqual(a);){for(var c=Math.max(1,Math.floor(d.toNumber()/a.toNumber())),g=Math.ceil(Math.log(c)/Math.LN2),h=48>=g?1:Math.pow(2,g-48),i=p.math.Long.fromNumber(c),j=i.multiply(a);j.isNegative()||j.greaterThan(d);)c-=h,i=p.math.Long.fromNumber(c),j=i.multiply(a);i.isZero()&&(i=p.math.Long.ONE),f=f.add(i),d=d.subtract(j)}return f},p.math.Long.prototype.modulo=function(a){return this.subtract(this.div(a).multiply(a))},p.math.Long.prototype.not=function(){return p.math.Long.fromBits(~this.low_,~this.high_)},p.math.Long.prototype.and=function(a){return p.math.Long.fromBits(this.low_&a.low_,this.high_&a.high_)},p.math.Long.prototype.or=function(a){return p.math.Long.fromBits(this.low_|a.low_,this.high_|a.high_)},p.math.Long.prototype.xor=function(a){return p.math.Long.fromBits(this.low_^a.low_,this.high_^a.high_)},p.math.Long.prototype.shiftLeft=function(a){if(a&=63,0==a)return this;var b=this.low_;if(32>a){var c=this.high_;return p.math.Long.fromBits(b<<a,c<<a|b>>>32-a)}return p.math.Long.fromBits(0,b<<a-32)},p.math.Long.prototype.shiftRight=function(a){if(a&=63,0==a)return this;var b=this.high_;if(32>a){var c=this.low_;return p.math.Long.fromBits(c>>>a|b<<32-a,b>>a)}return p.math.Long.fromBits(b>>a-32,b>=0?0:-1)},p.math.Long.prototype.shiftRightUnsigned=function(a){if(a&=63,0==a)return this;var b=this.high_;if(32>a){var c=this.low_;return p.math.Long.fromBits(c>>>a|b<<32-a,b>>>a)}return 32==a?p.math.Long.fromBits(b,0):p.math.Long.fromBits(b>>>a-32,0)},"undefined"==typeof B)var B={};"undefined"==typeof B.Math&&(B.Math={}),B.Math.to64BitNumber=function(a,b){var c,d,e;return c=new p.math.Long(0,b),d=new p.math.Long(a,0),e=c.add(d),e.toNumber()},function(a){o=a()}(function(){"use strict";function a(a){var b=Function.call;return function(){return b.apply(a,arguments)}}function b(a){return"[object StopIteration]"===ga(a)||a instanceof $}function c(a,b){b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(ha)&&(a.stack=d(a.stack)+"\n"+ha+"\n"+d(b.stack))}function d(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var g=b[d];f(g)||e(g)||c.push(g)}return c.join("\n")}function e(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function f(a){var b=/at .+ \((.*):(\d+):\d+\)/.exec(a);if(!b)return!1;var c=b[1],d=b[2];return c===W&&d>=Y&&la>=d}function g(){if(Error.captureStackTrace){var a,b,c=Error.prepareStackTrace;return Error.prepareStackTrace=function(c,d){a=d[1].getFileName(),b=d[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=c,W=a,b}}function h(a){return t(a)}function i(){function a(a){c&&(b=t(a),aa(c,function(a,c){X(function(){b.promiseDispatch.apply(b,c)})},void 0),c=void 0,d=void 0)}var b,c=[],d=[],e=da(i.prototype),f=da(k.prototype);return f.promiseDispatch=function(a,e,f){var g=_(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):X(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){return c?f:b=l(b)},Error.captureStackTrace&&h.longStackJumpLimit>0&&(Error.captureStackTrace(f,i),f.stack=f.stack.substring(f.stack.indexOf("\n")+1)),e.promise=f,e.resolve=a,e.fulfill=function(b){a(s(b))},e.reject=function(b){a(r(b))},e.notify=function(a){c&&aa(d,function(b,c){X(function(){c(a)})},void 0)},e}function j(a){var b=i();return F(a,b.resolve,b.reject,b.notify).fail(b.reject),b.promise}function k(a,b,c,d,e){void 0===b&&(b=function(a){return r(new Error("Promise does not support operation: "+a))});var f=da(k.prototype);return f.promiseDispatch=function(c,d,e){var g;try{g=a[d]?a[d].apply(f,e):b.call(f,d,e)}catch(h){g=r(h)}c&&c(g)},c&&(f.valueOf=c),e&&(f.exception=d),f}function l(a){return m(a)?a.valueOf():a}function m(a){return a&&"function"==typeof a.promiseDispatch}function n(a){return a&&"function"==typeof a.then}function o(a){return!p(a)&&!q(a)}function p(a){return!n(l(a))}function q(a){return a=l(a),m(a)&&"exception"in a}function r(a){var b=k({when:function(b){if(b){var c=ba(ia,this);-1!==c&&(ja.splice(c,1),ia.splice(c,1))}return b?b(a):this}},function(){return r(a)},function(){return this},a,!0);return ia.push(b),ja.push(a),b}function s(a){return k({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null==b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return fa(a)}},void 0,function(){return a})}function t(a){return m(a)?a:(a=l(a),n(a)?u(a):s(a))}function u(a){var b=i();return X(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function v(a){return k({isDef:function(){}},function(b,c){return B(a,b,c)},function(){return l(a)})}function w(a,b,d,e){function f(a){try{return"function"==typeof b?b(a):a}catch(c){return r(c)}}function g(a){if("function"==typeof d){c(a,m);try{return d(a)}catch(b){return r(b)}}return r(a)}function j(a){return"function"==typeof e?e(a):a}var k=i(),l=!1,m=t(a);return X(function(){m.promiseDispatch(function(a){l||(l=!0,k.resolve(f(a)))},"when",[function(a){l||(l=!0,k.resolve(g(a)))}])}),m.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=j(a)}catch(d){if(c=!0,!h.onerror)throw d;h.onerror(d)}c||k.notify(b)}]),k.promise}function x(a,b,c){return w(a,function(a){return H(a).then(function(a){return b.apply(void 0,a)},c)},c)}function y(a){return function(){function c(a,c){var g;try{g=d[a](c)}catch(h){return b(h)?h.value:r(h)}return w(g,e,f)}var d=a.apply(this,arguments),e=c.bind(c,"send"),f=c.bind(c,"throw");return e()}}function z(a){throw new $(a)}function A(a){return function(){return x([this,H(arguments)],function(b,c){return a.apply(b,c)})}}function B(a,b,c){var d=i();return X(function(){t(a).promiseDispatch(d.resolve,b,c)}),d.promise}function C(a){return function(b){var c=_(arguments,1);return B(b,a,c)}}function D(a,b){var c=_(arguments,2);return ka(a,b,c)}function E(a,b){return B(a,"apply",[void 0,b])}function F(a){var b=_(arguments,1);return E(a,b)}function G(a){var b=_(arguments,1);return function(){var c=b.concat(_(arguments));return B(a,"apply",[this,c])}}function H(a){return w(a,function(a){var b=a.length;if(0===b)return t(a);var c=i();return aa(a,function(d,e,f){p(e)?(a[f]=l(e),0===--b&&c.resolve(a)):w(e,function(d){a[f]=d,0===--b&&c.resolve(a)}).fail(c.reject)},void 0),c.promise})}function I(a){return w(a,function(a){return a=ca(a,t),w(H(ca(a,function(a){return w(a,Z,Z)})),function(){
return a})})}function J(a,b){return w(a,void 0,b)}function K(a,b){return w(a,void 0,void 0,b)}function L(a,b){return w(a,function(a){return w(b(),function(){return a})},function(a){return w(b(),function(){return r(a)})})}function M(a,b,d,e){var f=function(b){X(function(){if(c(b,a),!h.onerror)throw b;h.onerror(b)})},g=b||d||e?w(a,b,d,e):a;"object"==typeof process&&process&&process.domain&&(f=process.domain.bind(f)),J(g,f)}function N(a,b){var c=i(),d=setTimeout(function(){c.reject(new Error("Timed out after "+b+" ms"))},b);return w(a,function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)}),c.promise}function O(a,b){void 0===b&&(b=a,a=void 0);var c=i();return setTimeout(function(){c.resolve(a)},b),c.promise}function P(a,b){var c=_(b),d=i();return c.push(d.makeNodeResolver()),E(a,c).fail(d.reject),d.promise}function Q(a){var b=_(arguments,1),c=i();return b.push(c.makeNodeResolver()),E(a,b).fail(c.reject),c.promise}function R(a){var b=_(arguments,1);return function(){var c=b.concat(_(arguments)),d=i();return c.push(d.makeNodeResolver()),E(a,c).fail(d.reject),d.promise}}function S(a){var b=_(arguments,1);return function(){function c(){return a.apply(f,arguments)}var d=b.concat(_(arguments)),e=i();d.push(e.makeNodeResolver());var f=this;return E(c,d).fail(e.reject),e.promise}}function T(a,b,c){var d=_(c||[]),e=i();return d.push(e.makeNodeResolver()),ka(a,b,d).fail(e.reject),e.promise}function U(a,b){var c=_(arguments,2),d=i();return c.push(d.makeNodeResolver()),ka(a,b,c).fail(d.reject),d.promise}function V(a,b){return b?void a.then(function(a){X(function(){b(null,a)})},function(a){X(function(){b(a)})}):a}var W,X,Y=g(),Z=function(){};"undefined"!=typeof process?X=process.nextTick:"function"==typeof setImmediate?X="undefined"!=typeof window?setImmediate.bind(window):setImmediate:!function(){function a(){if(--f,++h>=e){h=0,e*=4;for(var a=g&&Math.min(g-1,e);a>f;)++f,b()}for(;g;){--g,c=c.next;var d=c.task;c.task=void 0,d()}h=0}var b,c={task:void 0,next:null},d=c,e=2,f=0,g=0,h=0;if(X=function(a){d=d.next={task:a,next:null},f<++g&&e>f&&(++f,b())},"undefined"!=typeof MessageChannel){var i=new MessageChannel;i.port1.onmessage=a,b=function(){i.port2.postMessage(0)}}else b=function(){setTimeout(a,0)}}();var $,_=a(Array.prototype.slice),aa=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),ba=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),ca=a(Array.prototype.map||function(a,b){var c=this,d=[];return aa(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),da=Object.create||function(a){function b(){}return b.prototype=a,new b},ea=a(Object.prototype.hasOwnProperty),fa=Object.keys||function(a){var b=[];for(var c in a)ea(a,c)&&b.push(c);return b},ga=a(Object.prototype.toString);$="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a},h.longStackJumpLimit=1;var ha="From previous event:";h.nextTick=X,h.defer=i,i.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(_(arguments,1)):a.resolve(c)}},h.promise=j,h.makePromise=k,k.prototype.then=function(a,b,c){return w(this,a,b,c)},k.prototype.thenResolve=function(a){return w(this,function(){return a})},aa(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(a,b){k.prototype[b]=function(){return h[b].apply(h,[this].concat(_(arguments)))}},void 0),k.prototype.toSource=function(){return this.toString()},k.prototype.toString=function(){return"[object Promise]"},h.nearer=l,h.isPromise=m,h.isPromiseAlike=n,h.isPending=o,h.isFulfilled=p,h.isRejected=q;var ia=[],ja=[];"undefined"!=typeof process&&process.on&&process.on("exit",function(){for(var a=0;a<ja.length;a++){var b=ja[a];b&&"undefined"!=typeof b.stack?console.warn("Unhandled rejected promise:",b.stack):console.warn("Unhandled rejected promise (no stack):",b)}}),h.reject=r,h.fulfill=s,h.resolve=t,h.master=v,h.when=w,h.spread=x,h.async=y,h["return"]=z,h.promised=A,h.dispatch=B,h.dispatcher=C,h.get=C("get"),h.set=C("set"),h["delete"]=h.del=C("delete");var ka=h.post=C("post");h.send=D,h.invoke=D,h.fapply=E,h["try"]=F,h.fcall=F,h.fbind=G,h.keys=C("keys"),h.all=H,h.allResolved=I,h["catch"]=h.fail=J,h.progress=K,h["finally"]=h.fin=L,h.done=M,h.timeout=N,h.delay=O,h.nfapply=P,h.nfcall=Q,h.nfbind=R,h.denodeify=h.nfbind,h.nbind=S,h.npost=T,h.nsend=U,h.ninvoke=h.nsend,h.nodeify=V;var la=g();return h});var C=function(){var a={boxes:{},fields:{},debug:!1,warningHandler:function(a){}},b={};return a.registerTypeBoxes=function(){b.moov=a.boxes.MovieBox,b.moof=a.boxes.MovieFragmentBox,b.ftyp=a.boxes.FileTypeBox,b.mfhd=a.boxes.MovieFragmentHeaderBox,b.mfra=a.boxes.MovieFragmentRandomAccessBox,b.udta=a.boxes.UserDataBox,b.trak=a.boxes.TrackBox,b.edts=a.boxes.EditBox,b.mdia=a.boxes.MediaBox,b.minf=a.boxes.MediaInformationBox,b.dinf=a.boxes.DataInformationBox,b.stbl=a.boxes.SampleTableBox,b.mvex=a.boxes.MovieExtendsBox,b.traf=a.boxes.TrackFragmentBox,b.meta=a.boxes.MetaBox,b.mvhd=a.boxes.MovieHeaderBox,b.mdat=a.boxes.MediaDataBox,b.free=a.boxes.FreeSpaceBox,b.sidx=a.boxes.SegmentIndexBox,b.tkhd=a.boxes.TrackHeaderBox,b.mdhd=a.boxes.MediaHeaderBox,b.mehd=a.boxes.MovieExtendsHeaderBox,b.hdlr=a.boxes.HandlerBox,b.stts=a.boxes.TimeToSampleBox,b.stsc=a.boxes.SampleToChunkBox,b.stco=a.boxes.ChunkOffsetBox,b.trex=a.boxes.TrackExtendsBox,b.vmhd=a.boxes.VideoMediaHeaderBox,b.smhd=a.boxes.SoundMediaHeaderBox,b.dref=a.boxes.DataReferenceBox,b["url "]=a.boxes.DataEntryUrlBox,b["urn "]=a.boxes.DataEntryUrnBox,b.tfhd=a.boxes.TrackFragmentHeaderBox,b.tfdt=a.boxes.TrackFragmentBaseMediaDecodeTimeBox,b.trun=a.boxes.TrackFragmentRunBox,b.stsd=a.boxes.SampleDescriptionBox,b.sdtp=a.boxes.SampleDependencyTableBox,b.avc1=a.boxes.AVC1VisualSampleEntryBox,b.encv=a.boxes.EncryptedVideoBox,b.avcC=a.boxes.AVCConfigurationBox,b.pasp=a.boxes.PixelAspectRatioBox,b.mp4a=a.boxes.MP4AudioSampleEntryBox,b.enca=a.boxes.EncryptedAudioBox,b.esds=a.boxes.ESDBox,b.stsz=a.boxes.SampleSizeBox,b.pssh=a.boxes.ProtectionSystemSpecificHeaderBox,b.saiz=a.boxes.SampleAuxiliaryInformationSizesBox,b.saio=a.boxes.SampleAuxiliaryInformationOffsetsBox,b.sinf=a.boxes.ProtectionSchemeInformationBox,b.schi=a.boxes.SchemeInformationBox,b.tenc=a.boxes.TrackEncryptionBox,b.schm=a.boxes.SchemeTypeBox,b.elst=a.boxes.EditListBox,b.hmhd=a.boxes.HintMediaHeaderBox,b.nmhd=a.boxes.NullMediaHeaderBox,b.ctts=a.boxes.CompositionOffsetBox,b.cslg=a.boxes.CompositionToDecodeBox,b.stss=a.boxes.SyncSampleBox,b.tref=a.boxes.TrackReferenceBox,b.frma=a.boxes.OriginalFormatBox,b[JSON.stringify([109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])]=a.boxes.TfxdBox,b[JSON.stringify([212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])]=a.boxes.TfrfBox,b[JSON.stringify([208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])]=a.boxes.PiffProtectionSystemSpecificHeaderBox,b[JSON.stringify([137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])]=a.boxes.PiffTrackEncryptionBox,b[JSON.stringify([162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])]=a.boxes.PiffSampleEncryptionBox},a.constructorTypeBox=function(a){var b,c;return b=Object.create(a.prototype),c=Array.prototype.slice.call(arguments,1),a.apply(b,c),b},a.searchBox=function(c,d){var e;return e=d?b[d]:b[c],e||(e=a.boxes.UnknownBox),e},a.createBox=function(b,c,d){return a.constructorTypeBox.apply(null,[a.searchBox(b,d),c])},a.deserialize=function(b){var c=new a.boxes.File;try{c.read(b)}catch(d){return a.warningHandler(d.message),null}return c},a.serialize=function(a){var b=a.getLength(),c=new Uint8Array(b);return a.write(c),c},a.ParseException=function(a){this.message=a,this.name="ParseException"},a.DataIntegrityException=function(a){this.message=a,this.name="DataIntegrityException"},a}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=C:window.mp4lib=C,C.boxes.File=function(){this.boxes=[]},C.boxes.File.prototype.getBoxByType=function(a){var b=0;for(b=0;b<this.boxes.length;b++)if(this.boxes[b].boxtype===a)return this.boxes[b];return null},C.boxes.File.prototype.getLength=function(){var a=0,b=0;for(b=0;b<this.boxes.length;b++)this.boxes[b].computeLength(),a+=this.boxes[b].size;return a},C.boxes.File.prototype.write=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++)b=this.boxes[c].write(a,b)},C.boxes.File.prototype.read=function(a){for(var b,c=0,d=null,e=0,f=null,g=0,h=a.length;h>g;){if(c=C.fields.FIELD_UINT32.read(a,g),d=C.fields.readString(a,g+4,4),"uuid"==d&&(e=1==c?16:8,f=new C.fields.ArrayField(C.fields.FIELD_INT8,16).read(a,g+e,g+e+16),f=JSON.stringify(f)),b=C.createBox(d,c,f),"uuid"===d?(g=b.read(a,g+16*C.fields.FIELD_INT8.getLength()+8,g+c),f=null):g=b.read(a,g+8,g+c),C.debug&&(b.__sourceBuffer=a.subarray(g-b.size,g)),this.boxes.push(b),b.size<=0||null===b.size)throw new C.ParseException("Problem on size of box "+b.boxtype+", parsing stopped to avoid infinite loop");if(!b.boxtype)throw new C.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}},C.boxes.File.prototype.getBoxOffsetByType=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b+=this.boxes[c].size}return-1},C.boxes.File.prototype.getBoxIndexByType=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b++}return-1},C.boxes.Box=function(a,b,c,d){this.size=b||null,this.boxtype=a,1===this.size&&d&&(this.largesize=d),c&&(this.extended_type=c),this.localPos=0,this.localEnd=0},C.boxes.Box.prototype.write=function(a,b){this.localPos=b;var c=0;if(this._writeData(a,C.fields.FIELD_UINT32,this.size),this.extended_type?this._writeData(a,C.fields.FIELD_ID,"uuid"):this._writeData(a,C.fields.FIELD_ID,this.boxtype),1===this.size&&this._writeData(a,C.fields.FIELD_INT64,this.largesize),this.extended_type)for(c=0;16>c;c++)this._writeData(a,C.fields.FIELD_INT8,this.extended_type[c])},C.boxes.Box.prototype.getBoxByType=function(a){var b=0;if(this.hasOwnProperty("boxes"))for(b=0;b<this.boxes.length;b++)if(this.boxes[b].boxtype===a)return this.boxes[b];return null},C.boxes.Box.prototype.getBoxesByType=function(a){var b=[],c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++)this.boxes[c].boxtype===a&&b.push(this.boxes[c]);return b},C.boxes.Box.prototype.removeBoxByType=function(a){var b=0;if(this.hasOwnProperty("boxes"))for(b=0;b<this.boxes.length;b++)this.boxes[b].boxtype===a&&this.boxes.splice(b,1);else C.warningHandler(""+this.boxtype+"does not have "+a+" box, impossible to remove it")},C.boxes.Box.prototype.getBoxOffsetByType=function(a){var b=8,c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b+=this.boxes[c].size}return null},C.boxes.Box.prototype.getBoxIndexByType=function(a){var b=0,c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b++}return null},C.boxes.Box.prototype.computeLength=function(){this.size=C.fields.FIELD_UINT32.getLength()+C.fields.FIELD_ID.getLength(),this.extended_type&&(this.size+=16*C.fields.FIELD_INT8.getLength())},C.boxes.Box.prototype._readData=function(a,b){var c=b.read(a,this.localPos,this.localEnd);return this.localPos+=b.getLength(c),c},C.boxes.Box.prototype._writeData=function(a,b,c){if(void 0===c||null===c)throw new C.ParseException("a field to write is null or undefined for box : "+this.boxtype);b.write(a,this.localPos,c),this.localPos+=b.getLength(c)},C.boxes.Box.prototype._writeBuffer=function(a,b,c){a.set(b,this.localPos),this.localPos+=c},C.boxes.Box.prototype._writeArrayData=function(a,b,c){var d=0;if(void 0===c||null===c||0===c.length)throw new C.ParseException("an array to write is null, undefined or length = 0 for box : "+this.boxtype);for(d=0;d<c.length;d++)this._writeData(a,b,c[d])},C.boxes.Box.prototype._readArrayData=function(a,b){var c=[],d=b.getLength(),e=(this.localEnd-this.localPos)/d,f=0;for(f=0;e>f;f++)c.push(b.read(a,this.localPos)),this.localPos+=d;return c},C.boxes.Box.prototype._readArrayFieldData=function(a,b,c){var d=-1,e=[],f=0;for(f=0;c>f;f++)e.push(b.read(a,this.localPos)),-1===d&&(d=b.getLength(e[f])),this.localPos+=d;return e},C.boxes.ContainerBox=function(a,b){C.boxes.Box.call(this,a,b),this.boxes=[]},C.boxes.ContainerBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.ContainerBox.prototype.constructor=C.boxes.ContainerBox,C.boxes.ContainerBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},C.boxes.ContainerBox.prototype.write=function(a,b){C.boxes.Box.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},C.boxes.ContainerBox.prototype.read=function(a,b,c){for(var d,e,f=0,g=0,h=null;c>b;){if(f=C.fields.FIELD_UINT32.read(a,b),d=C.fields.readString(a,b+4,4),"uuid"===d&&(g=1==f?16:8,h=new C.fields.ArrayField(C.fields.FIELD_INT8,16).read(a,b+g,b+g+16),h=JSON.stringify(h)),e=C.createBox(d,f,h),"uuid"===d?(b=e.read(a,b+16*C.fields.FIELD_INT8.getLength()+8,b+f),h=null):b=e.read(a,b+8,b+f),C.debug&&(e.__sourceBuffer=a.subarray(b-e.size,b)),this.boxes.push(e),e.size<=0||null===e.size)throw new C.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new C.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return b},C.boxes.FullBox=function(a,b,c){C.boxes.Box.call(this,a,b,c),this.version=null,this.flags=null},C.boxes.FullBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.FullBox.prototype.constructor=C.boxes.FullBox,C.boxes.FullBox.prototype.read=function(a,b,c){this.localPos=b,this.localEnd=c,this.version=this._readData(a,C.fields.FIELD_INT8),this.flags=this._readData(a,C.fields.FIELD_BIT24)},C.boxes.FullBox.prototype.write=function(a,b){C.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT8,this.version),this._writeData(a,C.fields.FIELD_BIT24,this.flags)},C.boxes.FullBox.prototype.getFullBoxAttributesLength=function(){this.size+=C.fields.FIELD_INT8.getLength()+C.fields.FIELD_BIT24.getLength()},C.boxes.FullBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),C.boxes.FullBox.prototype.getFullBoxAttributesLength.call(this)},C.boxes.ContainerFullBox=function(a,b){C.boxes.FullBox.call(this,a,b),this.boxes=[]},C.boxes.ContainerFullBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.ContainerFullBox.prototype.constructor=C.boxes.ContainerFullBox,C.boxes.ContainerFullBox.prototype.computeLength=function(a){C.boxes.FullBox.prototype.computeLength.call(this);var b=0;for(a&&(this.size+=C.fields.FIELD_UINT32.getLength()),b=0;b<this.boxes.length;b++)this.boxes[b].computeLength(),this.size+=this.boxes[b].size},C.boxes.ContainerFullBox.prototype.read=function(a,b,c,d){C.boxes.FullBox.prototype.read.call(this,a,b,c);var e,f,g=0,h=0,i=null;for(d&&(this.entry_count=this._readData(a,C.fields.FIELD_UINT32));this.localPos<this.localEnd;){if(g=C.fields.FIELD_UINT32.read(a,this.localPos),e=C.fields.readString(a,this.localPos+4,4),"uuid"==e&&(h=1==g?16:8,i=new C.fields.ArrayField(C.fields.FIELD_INT8,16).read(a,this.localPos+h,this.localPos+h+16),i=JSON.stringify(i)),f=C.createBox(e,g,i),"uuid"===e?(this.localPos=f.read(a,this.localPos+16*C.fields.FIELD_INT8.getLength()+8,this.localPos+g),i=null):this.localPos=f.read(a,this.localPos+8,this.localPos+g),C.debug&&(f.__sourceBuffer=a.subarray(this.localPos-f.size,this.localPos)),this.boxes.push(f),f.size<=0||null===f.size)throw new C.ParseException("Problem on size of box "+f.boxtype+", parsing stopped to avoid infinite loop");if(!f.boxtype)throw new C.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},C.boxes.ContainerFullBox.prototype.write=function(a,b,c){C.boxes.FullBox.prototype.write.call(this,a,b);var d=0;for(c===!0&&this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),d=0;d<this.boxes.length;d++)this.localPos=this.boxes[d].write(a,this.localPos);return this.localPos},C.boxes.UnknownBox=function(a){C.boxes.Box.call(this,null,a)},C.boxes.UnknownBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.UnknownBox.prototype.constructor=C.boxes.UnknownBox,C.boxes.UnknownBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.unrecognized_data=a.subarray(this.localPos,this.localEnd),this.localEnd},C.boxes.UnknownBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.unrecognized_data,this.unrecognized_data.length),this.localPos},C.boxes.UnknownBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=this.unrecognized_data.length},C.boxes.FileTypeBox=function(a){C.boxes.Box.call(this,"ftyp",a)},C.boxes.FileTypeBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.FileTypeBox.prototype.constructor=C.boxes.FileTypeBox,C.boxes.FileTypeBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_INT32.getLength()+C.fields.FIELD_INT32.getLength()*this.compatible_brands.length},C.boxes.FileTypeBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.major_brand=this._readData(a,C.fields.FIELD_INT32),this.minor_brand=this._readData(a,C.fields.FIELD_INT32),this.compatible_brands=this._readArrayData(a,C.fields.FIELD_INT32),this.localPos},C.boxes.FileTypeBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT32,this.major_brand),this._writeData(a,C.fields.FIELD_INT32,this.minor_brand),this._writeArrayData(a,C.fields.FIELD_INT32,this.compatible_brands),this.localPos},C.boxes.MovieBox=function(a){C.boxes.ContainerBox.call(this,"moov",a)},C.boxes.MovieBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MovieBox.prototype.constructor=C.boxes.MovieBox,C.boxes.MovieFragmentBox=function(a){C.boxes.ContainerBox.call(this,"moof",a)},C.boxes.MovieFragmentBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MovieFragmentBox.prototype.constructor=C.boxes.MovieFragmentBox,C.boxes.MovieFragmentRandomAccessBox=function(a){C.boxes.ContainerBox.call(this,"mfra",a)},C.boxes.MovieFragmentRandomAccessBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MovieFragmentRandomAccessBox.prototype.constructor=C.boxes.MovieFragmentRandomAccessBox,C.boxes.UserDataBox=function(a){C.boxes.ContainerBox.call(this,"udta",a)},C.boxes.UserDataBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.UserDataBox.prototype.constructor=C.boxes.UserDataBox,C.boxes.TrackBox=function(a){C.boxes.ContainerBox.call(this,"trak",a)},C.boxes.TrackBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.TrackBox.prototype.constructor=C.boxes.TrackBox,C.boxes.EditBox=function(a){C.boxes.ContainerBox.call(this,"edts",a)},C.boxes.EditBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.EditBox.prototype.constructor=C.boxes.EditBox,C.boxes.MediaBox=function(a){C.boxes.ContainerBox.call(this,"mdia",a)},C.boxes.MediaBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MediaBox.prototype.constructor=C.boxes.MediaBox,C.boxes.MediaInformationBox=function(a){C.boxes.ContainerBox.call(this,"minf",a)},C.boxes.MediaInformationBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MediaInformationBox.prototype.constructor=C.boxes.MediaInformationBox,C.boxes.DataInformationBox=function(a){C.boxes.ContainerBox.call(this,"dinf",a)},C.boxes.DataInformationBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.DataInformationBox.prototype.constructor=C.boxes.DataInformationBox,C.boxes.SampleTableBox=function(a){C.boxes.ContainerBox.call(this,"stbl",a)},C.boxes.SampleTableBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.SampleTableBox.prototype.constructor=C.boxes.SampleTableBox,C.boxes.MovieExtendsBox=function(a){C.boxes.ContainerBox.call(this,"mvex",a)},C.boxes.MovieExtendsBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.MovieExtendsBox.prototype.constructor=C.boxes.MovieExtendsBox,C.boxes.TrackFragmentBox=function(a){C.boxes.ContainerBox.call(this,"traf",a)},C.boxes.TrackFragmentBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.TrackFragmentBox.prototype.constructor=C.boxes.TrackFragmentBox,C.boxes.MetaBox=function(a){C.boxes.ContainerFullBox.call(this,"meta",a)},C.boxes.MetaBox.prototype=Object.create(C.boxes.ContainerFullBox.prototype),C.boxes.MetaBox.prototype.constructor=C.boxes.MetaBox,C.boxes.MetaBox.prototype.computeLength=function(){C.boxes.ContainerFullBox.prototype.computeLength.call(this,!1)},C.boxes.MetaBox.prototype.read=function(a,b,c){return C.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!1)},C.boxes.MetaBox.prototype.write=function(a,b){return C.boxes.ContainerFullBox.prototype.write.call(this,a,b,!1)},C.boxes.MovieHeaderBox=function(a){C.boxes.FullBox.call(this,"mvhd",a)},C.boxes.MovieHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.MovieHeaderBox.prototype.constructor=C.boxes.MovieHeaderBox,C.boxes.MovieHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_INT32.getLength()+2*C.fields.FIELD_INT16.getLength(),this.size+=2*C.fields.FIELD_INT32.getLength()+9*C.fields.FIELD_INT32.getLength(),this.size+=6*C.fields.FIELD_BIT32.getLength()+C.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=3*C.fields.FIELD_UINT64.getLength()+C.fields.FIELD_UINT32.getLength():this.size+=4*C.fields.FIELD_UINT32.getLength()},C.boxes.MovieHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.creation_time),this._writeData(a,C.fields.FIELD_UINT64,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.timescale),this._writeData(a,C.fields.FIELD_UINT64,this.duration)):(this._writeData(a,C.fields.FIELD_UINT32,this.creation_time),this._writeData(a,C.fields.FIELD_UINT32,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.timescale),this._writeData(a,C.fields.FIELD_UINT32,this.duration)),this._writeData(a,C.fields.FIELD_INT32,this.rate),this._writeData(a,C.fields.FIELD_INT16,this.volume),this._writeData(a,C.fields.FIELD_INT16,this.reserved),this._writeArrayData(a,C.fields.FIELD_INT32,this.reserved_2),this._writeArrayData(a,C.fields.FIELD_INT32,this.matrix),this._writeArrayData(a,C.fields.FIELD_BIT32,this.pre_defined),this._writeData(a,C.fields.FIELD_UINT32,this.next_track_ID),this.localPos},C.boxes.MovieHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1==this.version?(this.creation_time=this._readData(a,C.fields.FIELD_UINT64),this.modification_time=this._readData(a,C.fields.FIELD_UINT64),this.timescale=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,C.fields.FIELD_UINT32),this.modification_time=this._readData(a,C.fields.FIELD_UINT32),this.timescale=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT32)),this.rate=this._readData(a,C.fields.FIELD_INT32),this.volume=this._readData(a,C.fields.FIELD_INT16),this.reserved=this._readData(a,C.fields.FIELD_INT16),this.reserved_2=this._readArrayFieldData(a,C.fields.FIELD_INT32,2),this.matrix=this._readArrayFieldData(a,C.fields.FIELD_INT32,9),this.pre_defined=this._readArrayFieldData(a,C.fields.FIELD_BIT32,6),this.next_track_ID=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.MediaDataBox=function(a){C.boxes.Box.call(this,"mdat",a)},C.boxes.MediaDataBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.MediaDataBox.prototype.constructor=C.boxes.MediaDataBox,C.boxes.MediaDataBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},C.boxes.MediaDataBox.prototype.read=function(a,b,c){return this.data=a.subarray(b,c),c},C.boxes.MediaDataBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.data,this.data.length),this.localPos},C.boxes.FreeSpaceBox=function(a){C.boxes.Box.call(this,"free",a)},C.boxes.FreeSpaceBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.FreeSpaceBox.prototype.constructor=C.boxes.FreeSpaceBox,C.boxes.FreeSpaceBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},C.boxes.FreeSpaceBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.data=a.subarray(this.localPos,this.localEnd),this.localEnd},C.boxes.FreeSpaceBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.data,this.data.length),this.localPos},C.boxes.SegmentIndexBox=function(a){C.boxes.FullBox.call(this,"sidx",a)},C.boxes.SegmentIndexBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SegmentIndexBox.prototype.constructor=C.boxes.SegmentIndexBox,C.boxes.SegmentIndexBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=2*C.fields.FIELD_UINT64.getLength():this.size+=2*C.fields.FIELD_UINT32.getLength(),this.size+=C.fields.FIELD_UINT16.getLength(),this.size+=C.fields.FIELD_UINT16.getLength(),this.size+=(C.fields.FIELD_UINT64.getLength()+C.fields.FIELD_UINT32.getLength())*this.reference_count},C.boxes.SegmentIndexBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.reference_ID=this._readData(a,C.fields.FIELD_UINT32),this.timescale=this._readData(a,C.fields.FIELD_UINT32),1===this.version?(this.earliest_presentation_time=this._readData(a,C.fields.FIELD_UINT64),this.first_offset=this._readData(a,C.fields.FIELD_UINT64)):(this.earliest_presentation_time=this._readData(a,C.fields.FIELD_UINT32),this.first_offset=this._readData(a,C.fields.FIELD_UINT32)),this.reserved=this._readData(a,C.fields.FIELD_UINT16),this.reference_count=this._readData(a,C.fields.FIELD_UINT16),this.references=[],d=0;d<this.reference_count;d++)e={},e.reference_info=this._readData(a,C.fields.FIELD_UINT64),e.SAP=this._readData(a,C.fields.FIELD_UINT32),this.references.push(e);return this.localPos},C.boxes.SegmentIndexBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.reference_ID),this._writeData(a,C.fields.FIELD_UINT32,this.timescale),1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.earliest_presentation_time),this._writeData(a,C.fields.FIELD_UINT64,this.first_offset)):(this._writeData(a,C.fields.FIELD_UINT32,this.earliest_presentation_time),this._writeData(a,C.fields.FIELD_UINT32,this.first_offset)),this._writeData(a,C.fields.FIELD_UINT16,this.reserved),this._writeData(a,C.fields.FIELD_UINT16,this.reference_count),c=0;c<this.reference_count;c++)this._writeData(a,C.fields.FIELD_UINT64,this.references[c].reference_info),this._writeData(a,C.fields.FIELD_UINT32,this.references[c].SAP);return this.localPos},C.boxes.TrackHeaderBox=function(a){C.boxes.FullBox.call(this,"tkhd",a)},C.boxes.TrackHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackHeaderBox.prototype.constructor=C.boxes.TrackHeaderBox,C.boxes.TrackHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=4*C.fields.FIELD_INT16.getLength()+2*C.fields.FIELD_INT32.getLength()+2*C.fields.FIELD_UINT32.getLength()+9*C.fields.FIELD_INT32.getLength(),1==this.version?this.size+=3*C.fields.FIELD_UINT64.getLength()+2*C.fields.FIELD_UINT32.getLength():this.size+=5*C.fields.FIELD_UINT32.getLength()},C.boxes.TrackHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.creation_time=this._readData(a,C.fields.FIELD_UINT64),this.modification_time=this._readData(a,C.fields.FIELD_UINT64),this.track_id=this._readData(a,C.fields.FIELD_UINT32),this.reserved=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,C.fields.FIELD_UINT32),this.modification_time=this._readData(a,C.fields.FIELD_UINT32),this.track_id=this._readData(a,C.fields.FIELD_UINT32),this.reserved=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT32)),this.reserved_2=this._readArrayFieldData(a,C.fields.FIELD_UINT32,2),this.layer=this._readData(a,C.fields.FIELD_INT16),this.alternate_group=this._readData(a,C.fields.FIELD_INT16),this.volume=this._readData(a,C.fields.FIELD_INT16),this.reserved_3=this._readData(a,C.fields.FIELD_INT16),this.matrix=this._readArrayFieldData(a,C.fields.FIELD_INT32,9),this.width=this._readData(a,C.fields.FIELD_INT32),this.height=this._readData(a,C.fields.FIELD_INT32),this.localPos},C.boxes.TrackHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.creation_time),this._writeData(a,C.fields.FIELD_UINT64,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.track_id),this._writeData(a,C.fields.FIELD_UINT32,this.reserved),this._writeData(a,C.fields.FIELD_UINT64,this.duration)):(this._writeData(a,C.fields.FIELD_UINT32,this.creation_time),this._writeData(a,C.fields.FIELD_UINT32,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.track_id),this._writeData(a,C.fields.FIELD_UINT32,this.reserved),this._writeData(a,C.fields.FIELD_UINT32,this.duration)),this._writeArrayData(a,C.fields.FIELD_UINT32,this.reserved_2),this._writeData(a,C.fields.FIELD_INT16,this.layer),this._writeData(a,C.fields.FIELD_INT16,this.alternate_group),this._writeData(a,C.fields.FIELD_INT16,this.volume),this._writeData(a,C.fields.FIELD_INT16,this.reserved_3),this._writeArrayData(a,C.fields.FIELD_INT32,this.matrix),this._writeData(a,C.fields.FIELD_INT32,this.width),this._writeData(a,C.fields.FIELD_INT32,this.height),this.localPos},C.boxes.MediaHeaderBox=function(a){C.boxes.FullBox.call(this,"mdhd",a)},C.boxes.MediaHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.MediaHeaderBox.prototype.constructor=C.boxes.MediaHeaderBox,C.boxes.MediaHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT16.getLength(),1==this.version?this.size+=3*C.fields.FIELD_UINT64.getLength()+C.fields.FIELD_UINT32.getLength():this.size+=4*C.fields.FIELD_UINT32.getLength()},C.boxes.MediaHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.creation_time=this._readData(a,C.fields.FIELD_UINT64),this.modification_time=this._readData(a,C.fields.FIELD_UINT64),this.timescale=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,C.fields.FIELD_UINT32),this.modification_time=this._readData(a,C.fields.FIELD_UINT32),this.timescale=this._readData(a,C.fields.FIELD_UINT32),this.duration=this._readData(a,C.fields.FIELD_UINT32)),this.language=this._readData(a,C.fields.FIELD_UINT16),this.pre_defined=this._readData(a,C.fields.FIELD_UINT16),this.localPos},C.boxes.MediaHeaderBox.prototype.write=function(a,b){
return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.creation_time),this._writeData(a,C.fields.FIELD_UINT64,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.timescale),this._writeData(a,C.fields.FIELD_UINT64,this.duration)):(this._writeData(a,C.fields.FIELD_UINT32,this.creation_time),this._writeData(a,C.fields.FIELD_UINT32,this.modification_time),this._writeData(a,C.fields.FIELD_UINT32,this.timescale),this._writeData(a,C.fields.FIELD_UINT32,this.duration)),this._writeData(a,C.fields.FIELD_UINT16,this.language),this._writeData(a,C.fields.FIELD_UINT16,this.pre_defined),this.localPos},C.boxes.MovieExtendsHeaderBox=function(a){C.boxes.FullBox.call(this,"mehd",a)},C.boxes.MovieExtendsHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.MovieExtendsHeaderBox.prototype.constructor=C.boxes.MovieExtendsHeaderBox,C.boxes.MovieExtendsHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),1==this.version?this.size+=C.fields.FIELD_UINT64.getLength():this.size+=C.fields.FIELD_UINT32.getLength()},C.boxes.MovieExtendsHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?this.fragment_duration=this._readData(a,C.fields.FIELD_UINT64):this.fragment_duration=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.MovieExtendsHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?this._writeData(a,C.fields.FIELD_UINT64,this.fragment_duration):this._writeData(a,C.fields.FIELD_UINT32,this.fragment_duration),this.localPos},C.boxes.HandlerBox=function(a){C.boxes.FullBox.call(this,"hdlr",a)},C.boxes.HandlerBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.HandlerBox.prototype.constructor=C.boxes.HandlerBox,C.boxes.HandlerBox.prototype.HANDLERTYPEVIDEO="vide",C.boxes.HandlerBox.prototype.HANDLERTYPEAUDIO="soun",C.boxes.HandlerBox.prototype.HANDLERTYPETEXT="meta",C.boxes.HandlerBox.prototype.HANDLERVIDEONAME="Video Track",C.boxes.HandlerBox.prototype.HANDLERAUDIONAME="Audio Track",C.boxes.HandlerBox.prototype.HANDLERTEXTNAME="Text Track",C.boxes.HandlerBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT32.getLength()+3*C.fields.FIELD_UINT32.getLength()+C.fields.FIELD_STRING.getLength(this.name)},C.boxes.HandlerBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.pre_defined=this._readData(a,C.fields.FIELD_UINT32),this.handler_type=this._readData(a,C.fields.FIELD_UINT32),this.reserved=this._readArrayFieldData(a,C.fields.FIELD_UINT32,3),this.name=this._readData(a,C.fields.FIELD_STRING),this.localPos},C.boxes.HandlerBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.pre_defined),this._writeData(a,C.fields.FIELD_UINT32,this.handler_type),this._writeArrayData(a,C.fields.FIELD_UINT32,this.reserved),this._writeData(a,C.fields.FIELD_STRING,this.name),this.localPos},C.boxes.TimeToSampleBox=function(a){C.boxes.FullBox.call(this,"stts",a)},C.boxes.TimeToSampleBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TimeToSampleBox.prototype.constructor=C.boxes.TimeToSampleBox,C.boxes.TimeToSampleBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),this.size+=2*this.entry_count*C.fields.FIELD_UINT32.getLength()},C.boxes.TimeToSampleBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,C.fields.FIELD_UINT32),this.entry=[],d=0;d<this.entry_count;d++)e={},e.sample_count=this._readData(a,C.fields.FIELD_UINT32),e.sample_delta=this._readData(a,C.fields.FIELD_UINT32),this.entry.push(e);return this.localPos},C.boxes.TimeToSampleBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].sample_count),this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].sample_delta);return this.localPos},C.boxes.SampleToChunkBox=function(a){C.boxes.FullBox.call(this,"stsc",a)},C.boxes.SampleToChunkBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SampleToChunkBox.prototype.constructor=C.boxes.SampleToChunkBox,C.boxes.SampleToChunkBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),this.size+=3*this.entry_count*C.fields.FIELD_UINT32.getLength()},C.boxes.SampleToChunkBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,C.fields.FIELD_UINT32),this.entry=[],d=0;d<this.entry_count;d++)e={},e.first_chunk=this._readData(a,C.fields.FIELD_UINT32),e.samples_per_chunk=this._readData(a,C.fields.FIELD_UINT32),e.samples_description_index=this._readData(a,C.fields.FIELD_UINT32),this.entry.push(e);return this.localPos},C.boxes.SampleToChunkBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].first_chunk),this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].samples_per_chunk),this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].samples_description_index);return this.localPos},C.boxes.ChunkOffsetBox=function(a){C.boxes.FullBox.call(this,"stco",a)},C.boxes.ChunkOffsetBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.ChunkOffsetBox.prototype.constructor=C.boxes.ChunkOffsetBox,C.boxes.ChunkOffsetBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength()+this.entry_count*C.fields.FIELD_UINT32.getLength()},C.boxes.ChunkOffsetBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.entry_count=this._readData(a,C.fields.FIELD_UINT32),this.chunk_offset=this._readArrayFieldData(a,C.fields.FIELD_UINT32,this.entry_count),this.localPos},C.boxes.ChunkOffsetBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.chunk_offset[c]);return this.localPos},C.boxes.TrackExtendsBox=function(a){C.boxes.FullBox.call(this,"trex",a)},C.boxes.TrackExtendsBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackExtendsBox.prototype.constructor=C.boxes.TrackExtendsBox,C.boxes.TrackExtendsBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*C.fields.FIELD_UINT32.getLength()},C.boxes.TrackExtendsBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_ID=this._readData(a,C.fields.FIELD_UINT32),this.default_sample_description_index=this._readData(a,C.fields.FIELD_UINT32),this.default_sample_duration=this._readData(a,C.fields.FIELD_UINT32),this.default_sample_size=this._readData(a,C.fields.FIELD_UINT32),this.default_sample_flags=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.TrackExtendsBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.track_ID),this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_description_index),this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_duration),this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_size),this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},C.boxes.VideoMediaHeaderBox=function(a){C.boxes.FullBox.call(this,"vmhd",a)},C.boxes.VideoMediaHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.VideoMediaHeaderBox.prototype.constructor=C.boxes.VideoMediaHeaderBox,C.boxes.VideoMediaHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_INT16.getLength()+3*C.fields.FIELD_UINT16.getLength()},C.boxes.VideoMediaHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.graphicsmode=this._readData(a,C.fields.FIELD_INT16),this.opcolor=this._readArrayFieldData(a,C.fields.FIELD_UINT16,3),this.localPos},C.boxes.VideoMediaHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT16,this.graphicsmode),this._writeArrayData(a,C.fields.FIELD_UINT16,this.opcolor),this.localPos},C.boxes.SoundMediaHeaderBox=function(a){C.boxes.FullBox.call(this,"smhd",a)},C.boxes.SoundMediaHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SoundMediaHeaderBox.prototype.constructor=C.boxes.SoundMediaHeaderBox,C.boxes.SoundMediaHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_INT16.getLength()+C.fields.FIELD_UINT16.getLength()},C.boxes.SoundMediaHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.balance=this._readData(a,C.fields.FIELD_INT16),this.reserved=this._readData(a,C.fields.FIELD_UINT16),this.localPos},C.boxes.SoundMediaHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT16,this.balance),this._writeData(a,C.fields.FIELD_UINT16,this.reserved),this.localPos},C.boxes.DataReferenceBox=function(a){C.boxes.ContainerFullBox.call(this,"dref",a)},C.boxes.DataReferenceBox.prototype=Object.create(C.boxes.ContainerFullBox.prototype),C.boxes.DataReferenceBox.prototype.constructor=C.boxes.DataReferenceBox,C.boxes.DataReferenceBox.prototype.computeLength=function(){C.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},C.boxes.DataReferenceBox.prototype.read=function(a,b,c){return C.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!0)},C.boxes.DataReferenceBox.prototype.write=function(a,b){return this.entry_count||(this.entry_count=this.boxes.length),C.boxes.ContainerFullBox.prototype.write.call(this,a,b,!0)},C.boxes.DataEntryUrlBox=function(a){C.boxes.FullBox.call(this,"url ",a)},C.boxes.DataEntryUrlBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.DataEntryUrlBox.prototype.constructor=C.boxes.DataEntryUrlBox,C.boxes.DataEntryUrlBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),void 0!==this.location&&(this.size+=C.fields.FIELD_STRING.getLength(this.location))},C.boxes.DataEntryUrlBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.flags&!1&&(this.location=this._readData(a,C.fields.FIELD_STRING)),this.localPos},C.boxes.DataEntryUrlBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),void 0!==this.location&&this._writeData(a,C.fields.FIELD_STRING,this.location),this.localPos},C.boxes.DataEntryUrnBox=function(a){C.boxes.FullBox.call(this,"urn ",a)},C.boxes.DataEntryUrnBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.DataEntryUrnBox.prototype.constructor=C.boxes.DataEntryUrnBox,C.boxes.DataEntryUrnBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.flags&!1&&(this.size+=C.fields.FIELD_STRING.getLength(this.name)+C.fields.FIELD_STRING.getLength(this.location))},C.boxes.DataEntryUrnBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.flags&!1&&(this.name=this._readData(a,C.fields.FIELD_STRING),this.location=this._readData(a,C.fields.FIELD_STRING)),this.localPos},C.boxes.DataEntryUrnBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this.flags&!1&&(this._writeData(a,C.fields.FIELD_STRING,this.name),this._writeData(a,C.fields.FIELD_STRING,this.location)),this.localPos},C.boxes.MovieFragmentHeaderBox=function(a){C.boxes.FullBox.call(this,"mfhd",a)},C.boxes.MovieFragmentHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.MovieFragmentHeaderBox.prototype.constructor=C.boxes.MovieFragmentHeaderBox,C.boxes.MovieFragmentHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength()},C.boxes.MovieFragmentHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.sequence_number=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.MovieFragmentHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.sequence_number),this.localPos},C.boxes.TrackFragmentHeaderBox=function(a){C.boxes.FullBox.call(this,"tfhd",a)},C.boxes.TrackFragmentHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackFragmentHeaderBox.prototype.constructor=C.boxes.TrackFragmentHeaderBox,C.boxes.TrackFragmentHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),0!==(1&this.flags)&&void 0!==this.base_data_offset&&(this.size+=C.fields.FIELD_UINT64.getLength()),0!==(2&this.flags)&&void 0!==this.sample_description_index&&(this.size+=C.fields.FIELD_UINT32.getLength()),0!==(8&this.flags)&&void 0!==this.default_sample_duration&&(this.size+=C.fields.FIELD_UINT32.getLength()),0!==(16&this.flags)&&void 0!==this.default_sample_size&&(this.size+=C.fields.FIELD_UINT32.getLength()),0!==(32&this.flags)&&void 0!==this.default_sample_flags&&(this.size+=C.fields.FIELD_UINT32.getLength())},C.boxes.TrackFragmentHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_ID=this._readData(a,C.fields.FIELD_UINT32),0!==(1&this.flags)&&(this.base_data_offset=this._readData(a,C.fields.FIELD_UINT64)),0!==(2&this.flags)&&(this.sample_description_index=this._readData(a,C.fields.FIELD_UINT32)),0!==(8&this.flags)&&(this.default_sample_duration=this._readData(a,C.fields.FIELD_UINT32)),0!==(16&this.flags)&&(this.default_sample_size=this._readData(a,C.fields.FIELD_UINT32)),0!==(32&this.flags)&&(this.default_sample_flags=this._readData(a,C.fields.FIELD_UINT32)),this.localPos},C.boxes.TrackFragmentHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.track_ID),0!==(1&this.flags)&&this._writeData(a,C.fields.FIELD_UINT64,this.base_data_offset),0!==(2&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.sample_description_index),0!==(8&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_duration),0!==(16&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_size),0!==(32&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},C.boxes.TrackFragmentBaseMediaDecodeTimeBox=function(a){C.boxes.FullBox.call(this,"tfdt",a)},C.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.constructor=C.boxes.TrackFragmentBaseMediaDecodeTimeBox,C.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=C.fields.FIELD_UINT64.getLength():this.size+=C.fields.FIELD_UINT32.getLength()},C.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?this.baseMediaDecodeTime=this._readData(a,C.fields.FIELD_UINT64):this.baseMediaDecodeTime=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?this._writeData(a,C.fields.FIELD_UINT64,this.baseMediaDecodeTime):this._writeData(a,C.fields.FIELD_UINT32,this.baseMediaDecodeTime),this.localPos},C.boxes.TrackFragmentRunBox=function(a){C.boxes.FullBox.call(this,"trun",a)},C.boxes.TrackFragmentRunBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackFragmentRunBox.prototype.constructor=C.boxes.TrackFragmentRunBox,C.boxes.TrackFragmentRunBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this);var a=0;for(this.size+=C.fields.FIELD_UINT32.getLength(),0!==(1&this.flags)&&void 0!==this.data_offset&&(this.size+=C.fields.FIELD_INT32.getLength()),0!==(4&this.flags)&&void 0!==this.first_sample_flags&&(this.size+=C.fields.FIELD_UINT32.getLength()),a=0;a<this.sample_count;a++)0!==(256&this.flags)&&void 0!==this.samples_table[a].sample_duration&&(this.size+=C.fields.FIELD_UINT32.getLength()),0!==(512&this.flags)&&void 0!==this.samples_table[a].sample_size&&(this.size+=C.fields.FIELD_UINT32.getLength()),0!==(1024&this.flags)&&void 0!==this.samples_table[a].sample_flags&&(this.size+=C.fields.FIELD_UINT32.getLength()),1===this.version?0!==(2048&this.flags)&&void 0!==this.samples_table[a].sample_composition_time_offset&&(this.size+=C.fields.FIELD_INT32.getLength()):0!==(2048&this.flags)&&void 0!==this.samples_table[a].sample_composition_time_offset&&(this.size+=C.fields.FIELD_UINT32.getLength())},C.boxes.TrackFragmentRunBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.sample_count=this._readData(a,C.fields.FIELD_UINT32),0!==(1&this.flags)&&(this.data_offset=this._readData(a,C.fields.FIELD_INT32)),0!==(4&this.flags)&&(this.first_sample_flags=this._readData(a,C.fields.FIELD_UINT32)),this.samples_table=[],d=0;d<this.sample_count;d++)e={},0!==(256&this.flags)&&(e.sample_duration=this._readData(a,C.fields.FIELD_UINT32)),0!==(512&this.flags)&&(e.sample_size=this._readData(a,C.fields.FIELD_UINT32)),0!==(1024&this.flags)&&(e.sample_flags=this._readData(a,C.fields.FIELD_UINT32)),1===this.version?0!==(2048&this.flags)&&(e.sample_composition_time_offset=this._readData(a,C.fields.FIELD_INT32)):0!==(2048&this.flags)&&(e.sample_composition_time_offset=this._readData(a,C.fields.FIELD_UINT32)),this.samples_table.push(e);return this.localPos},C.boxes.TrackFragmentRunBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.sample_count),0!==(1&this.flags)&&this._writeData(a,C.fields.FIELD_INT32,this.data_offset),0!==(4&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.first_sample_flags),c=0;c<this.sample_count;c++)0!==(256&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.samples_table[c].sample_duration),0!==(512&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.samples_table[c].sample_size),0!==(1024&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.samples_table[c].sample_flags),1===this.version?0!==(2048&this.flags)&&this._writeData(a,C.fields.FIELD_INT32,this.samples_table[c].sample_composition_time_offset):0!==(2048&this.flags)&&this._writeData(a,C.fields.FIELD_UINT32,this.samples_table[c].sample_composition_time_offset);return this.localPos},C.boxes.SampleDescriptionBox=function(a){C.boxes.ContainerFullBox.call(this,"stsd",a)},C.boxes.SampleDescriptionBox.prototype=Object.create(C.boxes.ContainerFullBox.prototype),C.boxes.SampleDescriptionBox.prototype.constructor=C.boxes.SampleDescriptionBox,C.boxes.SampleDescriptionBox.prototype.computeLength=function(){C.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},C.boxes.SampleDescriptionBox.prototype.read=function(a,b,c){return C.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!0)},C.boxes.SampleDescriptionBox.prototype.write=function(a,b){return this.entry_count=this.boxes.length,C.boxes.ContainerFullBox.prototype.write.call(this,a,b,!0)},C.boxes.SampleDependencyTableBox=function(a){C.boxes.FullBox.call(this,"sdtp",a)},C.boxes.SampleDependencyTableBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SampleDependencyTableBox.prototype.constructor=C.boxes.SampleDependencyTableBox,C.boxes.SampleDependencyTableBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT8.getLength()*this.sample_dependency_array.length},C.boxes.SampleDependencyTableBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.sample_dependency_array=this._readArrayData(a,C.fields.FIELD_UINT8),this.localPos},C.boxes.SampleDependencyTableBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeArrayData(a,C.fields.FIELD_UINT8,this.sample_dependency_array),this.localPos},C.boxes.SampleEntryBox=function(a,b){C.boxes.Box.call(this,a,b)},C.boxes.SampleEntryBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.SampleEntryBox.prototype.constructor=C.boxes.SampleEntryBox,C.boxes.SampleEntryBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT16.getLength()+6*C.fields.FIELD_UINT8.getLength()},C.boxes.SampleEntryBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.reserved=this._readArrayFieldData(a,C.fields.FIELD_UINT8,6),this.data_reference_index=this._readData(a,C.fields.FIELD_UINT16),this.localPos},C.boxes.SampleEntryBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeArrayData(a,C.fields.FIELD_UINT8,this.reserved),this._writeData(a,C.fields.FIELD_UINT16,this.data_reference_index),this.localPos},C.boxes.VisualSampleEntryBox=function(a,b){C.boxes.SampleEntryBox.call(this,a,b)},C.boxes.VisualSampleEntryBox.prototype=Object.create(C.boxes.SampleEntryBox.prototype),C.boxes.VisualSampleEntryBox.prototype.constructor=C.boxes.VisualSampleEntryBox,C.boxes.VisualSampleEntryBox.prototype.computeLength=function(){C.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=7*C.fields.FIELD_UINT16.getLength()+3*C.fields.FIELD_UINT32.getLength(),this.size+=3*C.fields.FIELD_UINT32.getLength(),this.size+=32},C.boxes.VisualSampleEntryBox.prototype.read=function(a,b,c){return C.boxes.SampleEntryBox.prototype.read.call(this,a,b,c),this.pre_defined=this._readData(a,C.fields.FIELD_UINT16),this.reserved_2=this._readData(a,C.fields.FIELD_UINT16),this.pre_defined_2=this._readArrayFieldData(a,C.fields.FIELD_UINT32,3),this.width=this._readData(a,C.fields.FIELD_UINT16),this.height=this._readData(a,C.fields.FIELD_UINT16),this.horizresolution=this._readData(a,C.fields.FIELD_UINT32),this.vertresolution=this._readData(a,C.fields.FIELD_UINT32),this.reserved_3=this._readData(a,C.fields.FIELD_UINT32),this.frame_count=this._readData(a,C.fields.FIELD_UINT16),this.compressorname=new C.fields.FixedLenStringField(32),this.compressorname=this.compressorname.read(a,this.localPos),this.localPos+=32,this.depth=this._readData(a,C.fields.FIELD_UINT16),this.pre_defined_3=this._readData(a,C.fields.FIELD_INT16),this.localPos},C.boxes.VisualSampleEntryBox.prototype.write=function(a,b){C.boxes.SampleEntryBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT16,this.pre_defined),this._writeData(a,C.fields.FIELD_UINT16,this.reserved_2),this._writeArrayData(a,C.fields.FIELD_UINT32,this.pre_defined_2),this._writeData(a,C.fields.FIELD_UINT16,this.width),this._writeData(a,C.fields.FIELD_UINT16,this.height),this._writeData(a,C.fields.FIELD_UINT32,this.horizresolution),this._writeData(a,C.fields.FIELD_UINT32,this.vertresolution),this._writeData(a,C.fields.FIELD_UINT32,this.reserved_3),this._writeData(a,C.fields.FIELD_UINT16,this.frame_count),c=0;32>c;c++)a[this.localPos+c]=this.compressorname.charCodeAt(c);return this.localPos+=32,this._writeData(a,C.fields.FIELD_UINT16,this.depth),this._writeData(a,C.fields.FIELD_INT16,this.pre_defined_3),this.localPos},C.boxes.VisualSampleEntryContainerBox=function(a,b){C.boxes.VisualSampleEntryBox.call(this,a,b),this.boxes=[]},C.boxes.VisualSampleEntryContainerBox.prototype=Object.create(C.boxes.VisualSampleEntryBox.prototype),C.boxes.VisualSampleEntryContainerBox.prototype.constructor=C.boxes.VisualSampleEntryContainerBox,C.boxes.VisualSampleEntryContainerBox.prototype.computeLength=function(){C.boxes.VisualSampleEntryBox.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},C.boxes.VisualSampleEntryContainerBox.prototype.read=function(a,b,c){C.boxes.VisualSampleEntryBox.prototype.read.call(this,a,b,c);for(var d,e,f=0,g=0,h=null;this.localPos<this.localEnd;){if(f=C.fields.FIELD_UINT32.read(a,this.localPos),d=C.fields.readString(a,this.localPos+4,4),"uuid"==d&&(g=1==f?16:8,h=new C.fields.ArrayField(C.fields.FIELD_INT8,16).read(a,this.localPos+g,this.localPos+g+16),h=JSON.stringify(h)),e=C.createBox(d,f,h),"uuid"===d?this.localPos=e.read(a,this.localPos+16*C.fields.FIELD_INT8.getLength()+8,this.localPos+f):this.localPos=e.read(a,this.localPos+8,this.localPos+f),C.debug&&(e.__sourceBuffer=a.subarray(this.localPos-e.size,this.localPos)),this.boxes.push(e),e.size<=0||null===e.size)throw new C.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new C.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},C.boxes.VisualSampleEntryContainerBox.prototype.write=function(a,b){C.boxes.VisualSampleEntryBox.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},C.boxes.AVC1VisualSampleEntryBox=function(a){C.boxes.VisualSampleEntryContainerBox.call(this,"avc1",a)},C.boxes.AVC1VisualSampleEntryBox.prototype=Object.create(C.boxes.VisualSampleEntryContainerBox.prototype),C.boxes.AVC1VisualSampleEntryBox.prototype.constructor=C.boxes.AVC1VisualSampleEntryBox,C.boxes.EncryptedVideoBox=function(a){C.boxes.VisualSampleEntryContainerBox.call(this,"encv",a)},C.boxes.EncryptedVideoBox.prototype=Object.create(C.boxes.VisualSampleEntryContainerBox.prototype),C.boxes.EncryptedVideoBox.prototype.constructor=C.boxes.EncryptedVideoBox,C.boxes.AVCConfigurationBox=function(a){C.boxes.Box.call(this,"avcC",a)},C.boxes.AVCConfigurationBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.AVCConfigurationBox.prototype.constructor=C.boxes.AVCConfigurationBox,C.boxes.AVCConfigurationBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=4*C.fields.FIELD_UINT8.getLength()+3*C.fields.FIELD_UINT8.getLength(),this.size+=this._getNALLength(this.numOfSequenceParameterSets,this.SPS_NAL),this.size+=this._getNALLength(this.numOfPictureParameterSets,this.PPS_NAL)},C.boxes.AVCConfigurationBox.prototype._getNALLength=function(a,b){var c=0,d=0;for(d=0;a>d;d++)c+=C.fields.FIELD_UINT16.getLength()+b[d].NAL_length;return c},C.boxes.AVCConfigurationBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.configurationVersion=this._readData(a,C.fields.FIELD_UINT8),this.AVCProfileIndication=this._readData(a,C.fields.FIELD_UINT8),this.profile_compatibility=this._readData(a,C.fields.FIELD_UINT8),this.AVCLevelIndication=this._readData(a,C.fields.FIELD_UINT8),this.temp=this._readData(a,C.fields.FIELD_UINT8),this.lengthSizeMinusOne=3&this.temp,this.numOfSequenceParameterSets_tmp=this._readData(a,C.fields.FIELD_UINT8),this.numOfSequenceParameterSets=31&this.numOfSequenceParameterSets_tmp,this.SPS_NAL=this._readNAL(a,this.numOfSequenceParameterSets),this.numOfPictureParameterSets=this._readData(a,C.fields.FIELD_UINT8),this.PPS_NAL=this._readNAL(a,this.numOfPictureParameterSets),this.localPos},C.boxes.AVCConfigurationBox.prototype._readNAL=function(a,b){var c=[],d=0,e={};for(d=0;b>d;d++)e={},e.NAL_length=this._readData(a,C.fields.FIELD_UINT16),e.NAL=a.subarray(this.localPos,this.localPos+e.NAL_length),this.localPos+=e.NAL_length,c.push(e);return c},C.boxes.AVCConfigurationBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT8,this.configurationVersion),this._writeData(a,C.fields.FIELD_UINT8,this.AVCProfileIndication),this._writeData(a,C.fields.FIELD_UINT8,this.profile_compatibility),this._writeData(a,C.fields.FIELD_UINT8,this.AVCLevelIndication),this.temp=252|this.lengthSizeMinusOne,this._writeData(a,C.fields.FIELD_UINT8,this.temp),this.numOfSequenceParameterSets=this.SPS_NAL.length,this.numOfSequenceParameterSets_tmp=224|this.numOfSequenceParameterSets,this._writeData(a,C.fields.FIELD_UINT8,this.numOfSequenceParameterSets_tmp),this._writeNAL(a,this.numOfSequenceParameterSets,this.SPS_NAL),this._writeData(a,C.fields.FIELD_UINT8,this.numOfPictureParameterSets),this._writeNAL(a,this.numOfPictureParameterSets,this.PPS_NAL),this.localPos},C.boxes.AVCConfigurationBox.prototype._writeNAL=function(a,b,c){var d=0;for(d=0;b>d;d++)this._writeData(a,C.fields.FIELD_UINT16,c[d].NAL_length),this._writeBuffer(a,c[d].NAL,c[d].NAL_length)},C.boxes.PixelAspectRatioBox=function(a){C.boxes.Box.call(this,"pasp",a)},C.boxes.PixelAspectRatioBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.PixelAspectRatioBox.prototype.constructor=C.boxes.PixelAspectRatioBox,C.boxes.PixelAspectRatioBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_INT32.getLength()},C.boxes.PixelAspectRatioBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.hSpacing=this._readData(a,C.fields.FIELD_INT32),this.vSpacing=this._readData(a,C.fields.FIELD_INT32),this.localPos},C.boxes.PixelAspectRatioBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT32,this.hSpacing),this._writeData(a,C.fields.FIELD_INT32,this.vSpacing),this.localPos},C.boxes.AudioSampleEntryBox=function(a,b){C.boxes.SampleEntryBox.call(this,a,b)},C.boxes.AudioSampleEntryBox.prototype=Object.create(C.boxes.SampleEntryBox.prototype),C.boxes.AudioSampleEntryBox.prototype.constructor=C.boxes.AudioSampleEntryBox,C.boxes.AudioSampleEntryBox.prototype.computeLength=function(){C.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=4*C.fields.FIELD_UINT16.getLength()+3*C.fields.FIELD_UINT32.getLength()},C.boxes.AudioSampleEntryBox.prototype.read=function(a,b,c){return C.boxes.SampleEntryBox.prototype.read.call(this,a,b,c),this.reserved_2=this._readArrayFieldData(a,C.fields.FIELD_UINT32,2),this.channelcount=this._readData(a,C.fields.FIELD_UINT16),this.samplesize=this._readData(a,C.fields.FIELD_UINT16),this.pre_defined=this._readData(a,C.fields.FIELD_UINT16),this.reserved_3=this._readData(a,C.fields.FIELD_UINT16),this.samplerate=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.AudioSampleEntryBox.prototype.write=function(a,b){return C.boxes.SampleEntryBox.prototype.write.call(this,a,b),this._writeArrayData(a,C.fields.FIELD_UINT32,this.reserved_2),this._writeData(a,C.fields.FIELD_UINT16,this.channelcount),this._writeData(a,C.fields.FIELD_UINT16,this.samplesize),this._writeData(a,C.fields.FIELD_UINT16,this.pre_defined),this._writeData(a,C.fields.FIELD_UINT16,this.reserved_3),this._writeData(a,C.fields.FIELD_UINT32,this.samplerate),this.localPos},C.boxes.AudioSampleEntryContainerBox=function(a,b){C.boxes.AudioSampleEntryBox.call(this,a,b),this.boxes=[]},C.boxes.AudioSampleEntryContainerBox.prototype=Object.create(C.boxes.AudioSampleEntryBox.prototype),C.boxes.AudioSampleEntryContainerBox.prototype.constructor=C.boxes.AudioSampleEntryContainerBox,C.boxes.AudioSampleEntryContainerBox.prototype.computeLength=function(){C.boxes.AudioSampleEntryBox.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},C.boxes.AudioSampleEntryContainerBox.prototype.read=function(a,b,c){
C.boxes.AudioSampleEntryBox.prototype.read.call(this,a,b,c);for(var d,e,f=0,g=0,h=null;this.localPos<this.localEnd;){if(f=C.fields.FIELD_UINT32.read(a,this.localPos),d=C.fields.readString(a,this.localPos+4,4),"uuid"==d&&(g=1==f?16:8,h=new C.fields.ArrayField(C.fields.FIELD_INT8,16).read(a,this.localPos+g,this.localPos+g+16),h=JSON.stringify(h)),e=C.createBox(d,f,h),"uuid"===d?this.localPos=e.read(a,this.localPos+16*C.fields.FIELD_INT8.getLength()+8,this.localPos+f):this.localPos=e.read(a,this.localPos+8,this.localPos+f),C.debug&&(e.__sourceBuffer=a.subarray(this.localPos-e.size,this.localPos)),this.boxes.push(e),e.size<=0||null===e.size)throw new C.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new C.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},C.boxes.AudioSampleEntryContainerBox.prototype.write=function(a,b){C.boxes.AudioSampleEntryBox.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},C.boxes.MP4AudioSampleEntryBox=function(a){C.boxes.AudioSampleEntryContainerBox.call(this,"mp4a",a)},C.boxes.MP4AudioSampleEntryBox.prototype=Object.create(C.boxes.AudioSampleEntryContainerBox.prototype),C.boxes.MP4AudioSampleEntryBox.prototype.constructor=C.boxes.MP4AudioSampleEntryBox,C.boxes.EncryptedAudioBox=function(a){C.boxes.AudioSampleEntryContainerBox.call(this,"enca",a)},C.boxes.EncryptedAudioBox.prototype=Object.create(C.boxes.AudioSampleEntryContainerBox.prototype),C.boxes.EncryptedAudioBox.prototype.constructor=C.boxes.EncryptedAudioBox,C.boxes.ESDBox=function(a){C.boxes.FullBox.call(this,"esds",a)},C.boxes.ESDBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.ESDBox.prototype.constructor=C.boxes.ESDBox,C.boxes.ESDBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT8.getLength()+this.ES_length},C.boxes.ESDBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.ES_tag=this._readData(a,C.fields.FIELD_UINT8),this.ES_length=this._readData(a,C.fields.FIELD_UINT8),this.ES_data=a.subarray(this.localPos,this.localPos+this.ES_length),this.localPos+=this.ES_length,this.localPos},C.boxes.ESDBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT8,this.ES_tag),this._writeData(a,C.fields.FIELD_UINT8,this.ES_length),this._writeBuffer(a,this.ES_data,this.ES_length),this.localPos},C.boxes.SampleSizeBox=function(a){C.boxes.FullBox.call(this,"stsz",a)},C.boxes.SampleSizeBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SampleSizeBox.prototype.constructor=C.boxes.SampleSizeBox,C.boxes.SampleSizeBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT32.getLength()+C.fields.FIELD_UINT32.getLength()*this.sample_count},C.boxes.SampleSizeBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.sample_size=this._readData(a,C.fields.FIELD_UINT32),this.sample_count=this._readData(a,C.fields.FIELD_UINT32),this.entries=this._readArrayFieldData(a,C.fields.FIELD_UINT32,this.sample_count),this.localPos},C.boxes.SampleSizeBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.sample_size),this._writeData(a,C.fields.FIELD_UINT32,this.sample_count),c=0;c<this.sample_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.entries[c]);return this.localPos},C.boxes.ProtectionSystemSpecificHeaderBox=function(a){C.boxes.FullBox.call(this,"pssh",a)},C.boxes.ProtectionSystemSpecificHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.ProtectionSystemSpecificHeaderBox.prototype.constructor=C.boxes.ProtectionSystemSpecificHeaderBox,C.boxes.ProtectionSystemSpecificHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=16*C.fields.FIELD_UINT8.getLength(),this.size+=C.fields.FIELD_UINT32.getLength(),this.size+=C.fields.FIELD_UINT8.getLength()*this.DataSize},C.boxes.ProtectionSystemSpecificHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.SystemID=this._readArrayFieldData(a,C.fields.FIELD_UINT8,16),this.DataSize=this._readData(a,C.fields.FIELD_UINT32),this.Data=this._readArrayFieldData(a,C.fields.FIELD_UINT8,this.DataSize),this.localPos},C.boxes.ProtectionSystemSpecificHeaderBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(c=0;16>c;c++)this._writeData(a,C.fields.FIELD_UINT8,this.SystemID[c]);for(this._writeData(a,C.fields.FIELD_UINT32,this.DataSize),c=0;c<this.DataSize;c++)this._writeData(a,C.fields.FIELD_UINT8,this.Data[c]);return this.localPos},C.boxes.SampleAuxiliaryInformationSizesBox=function(a){C.boxes.FullBox.call(this,"saiz",a)},C.boxes.SampleAuxiliaryInformationSizesBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SampleAuxiliaryInformationSizesBox.prototype.constructor=C.boxes.SampleAuxiliaryInformationSizesBox,C.boxes.SampleAuxiliaryInformationSizesBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*C.fields.FIELD_UINT32.getLength()),this.size+=C.fields.FIELD_UINT8.getLength()+C.fields.FIELD_UINT32.getLength(),0===this.default_sample_info_size&&(this.size+=C.fields.FIELD_UINT8.getLength()*this.sample_count)},C.boxes.SampleAuxiliaryInformationSizesBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1&this.flags&&(this.aux_info_type=this._readData(a,C.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(a,C.fields.FIELD_UINT32)),this.default_sample_info_size=this._readData(a,C.fields.FIELD_UINT8),this.sample_count=this._readData(a,C.fields.FIELD_UINT32),0===this.default_sample_info_size&&(this.sample_info_size=this._readArrayFieldData(a,C.fields.FIELD_UINT8,this.sample_count)),this.localPos},C.boxes.SampleAuxiliaryInformationSizesBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;if(1&this.flags&&(this._writeData(a,C.fields.FIELD_UINT32,this.aux_info_type),this._writeData(a,C.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(a,C.fields.FIELD_UINT8,this.default_sample_info_size),this._writeData(a,C.fields.FIELD_UINT32,this.sample_count),0===this.default_sample_info_size)for(c=0;c<this.sample_count;c++)this._writeData(a,C.fields.FIELD_UINT8,this.sample_info_size[c]);return this.localPos},C.boxes.SampleAuxiliaryInformationOffsetsBox=function(a){C.boxes.FullBox.call(this,"saio",a)},C.boxes.SampleAuxiliaryInformationOffsetsBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.constructor=C.boxes.SampleAuxiliaryInformationOffsetsBox,C.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*C.fields.FIELD_UINT32.getLength()),this.size+=C.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=C.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=C.fields.FIELD_UINT64.getLength()*this.entry_count},C.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1&this.flags&&(this.aux_info_type=this._readData(a,C.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(a,C.fields.FIELD_UINT32)),this.entry_count=this._readData(a,C.fields.FIELD_UINT32),0===this.version?this.offset=this._readArrayFieldData(a,C.fields.FIELD_UINT32,this.entry_count):this.offset=this._readArrayFieldData(a,C.fields.FIELD_UINT64,this.entry_count),this.localPos},C.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;if(1&this.flags&&(this._writeData(a,C.fields.FIELD_UINT32,this.aux_info_type),this._writeData(a,C.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),0===this.version)for(c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.offset[c]);else for(c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT64,this.offset[c]);return this.localPos},C.boxes.ProtectionSchemeInformationBox=function(a){C.boxes.ContainerBox.call(this,"sinf",a)},C.boxes.ProtectionSchemeInformationBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.ProtectionSchemeInformationBox.prototype.constructor=C.boxes.ProtectionSchemeInformationBox,C.boxes.SchemeInformationBox=function(a){C.boxes.ContainerBox.call(this,"schi",a)},C.boxes.SchemeInformationBox.prototype=Object.create(C.boxes.ContainerBox.prototype),C.boxes.SchemeInformationBox.prototype.constructor=C.boxes.SchemeInformationBox,C.boxes.TrackEncryptionBox=function(a){C.boxes.FullBox.call(this,"tenc",a)},C.boxes.TrackEncryptionBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackEncryptionBox.prototype.constructor=C.boxes.TrackEncryptionBox,C.boxes.TrackEncryptionBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_BIT24.getLength(),this.size+=C.fields.FIELD_UINT8.getLength(),this.size+=16*C.fields.FIELD_UINT8.getLength()},C.boxes.TrackEncryptionBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.default_IsEncrypted=this._readData(a,C.fields.FIELD_BIT24),this.default_IV_size=this._readData(a,C.fields.FIELD_UINT8),this.default_KID=this._readArrayFieldData(a,C.fields.FIELD_UINT8,16),this.localPos},C.boxes.TrackEncryptionBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_BIT24,this.default_IsEncrypted),this._writeData(a,C.fields.FIELD_UINT8,this.default_IV_size),this._writeArrayData(a,C.fields.FIELD_UINT8,this.default_KID),this.localPos},C.boxes.SchemeTypeBox=function(a){C.boxes.FullBox.call(this,"schm",a)},C.boxes.SchemeTypeBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SchemeTypeBox.prototype.constructor=C.boxes.SchemeTypeBox,C.boxes.SchemeTypeBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=C.fields.FIELD_STRING.getLength(this.scheme_uri))},C.boxes.SchemeTypeBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.scheme_type=this._readData(a,C.fields.FIELD_UINT32),this.scheme_version=this._readData(a,C.fields.FIELD_UINT32),1&this.flags&&(this.scheme_uri=this._readData(a,C.fields.FIELD_STRING)),this.localPos},C.boxes.SchemeTypeBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.scheme_type),this._writeData(a,C.fields.FIELD_UINT32,this.scheme_version),1&this.flags&&this._writeData(a,C.fields.FIELD_STRING,this.scheme_uri),this.localPos},C.boxes.EditListBox=function(a){C.boxes.FullBox.call(this,"elst",a),this.entries=[]},C.boxes.EditListBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.EditListBox.prototype.constructor=C.boxes.EditListBox,C.boxes.EditListBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=(2*C.fields.FIELD_UINT64.getLength()+2*C.fields.FIELD_UINT16.getLength())*this.entry_count:this.size+=(2*C.fields.FIELD_UINT32.getLength()+2*C.fields.FIELD_UINT16.getLength())*this.entry_count},C.boxes.EditListBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,C.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},1===this.version?(e.segment_duration=this._readData(a,C.fields.FIELD_UINT64),e.media_time=this._readData(a,C.fields.FIELD_UINT64)):(e.segment_duration=this._readData(a,C.fields.FIELD_UINT32),e.media_time=this._readData(a,C.fields.FIELD_UINT32)),e.media_rate_integer=this._readData(a,C.fields.FIELD_UINT16),e.media_rate_fraction=this._readData(a,C.fields.FIELD_UINT16),this.entries.push(e);return this.localPos},C.boxes.EditListBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.entries[c].segment_duration),this._writeData(a,C.fields.FIELD_UINT64,this.entries[c].media_time)):(this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].segment_duration),this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].media_time)),this._writeData(a,C.fields.FIELD_UINT16,this.entries[c].media_rate_integer),this._writeData(a,C.fields.FIELD_UINT16,this.entries[c].media_rate_fraction);return this.localPos},C.boxes.HintMediaHeaderBox=function(a){C.boxes.FullBox.call(this,"hmhd",a)},C.boxes.HintMediaHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.HintMediaHeaderBox.prototype.constructor=C.boxes.HintMediaHeaderBox,C.boxes.HintMediaHeaderBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*C.fields.FIELD_UINT16.getLength(),this.size+=3*C.fields.FIELD_UINT32.getLength()},C.boxes.HintMediaHeaderBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.maxPDUsize=this._readData(a,C.fields.FIELD_UINT16),this.avgPDUsize=this._readData(a,C.fields.FIELD_UINT16),this.maxbitrate=this._readData(a,C.fields.FIELD_UINT32),this.avgbitrate=this._readData(a,C.fields.FIELD_UINT32),this.reserved=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.HintMediaHeaderBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT16,this.maxPDUsize),this._writeData(a,C.fields.FIELD_UINT16,this.avgPDUsize),this._writeData(a,C.fields.FIELD_UINT32,this.maxbitrate),this._writeData(a,C.fields.FIELD_UINT32,this.avgbitrate),this._writeData(a,C.fields.FIELD_UINT32,this.reserved),this.localPos},C.boxes.NullMediaHeaderBox=function(a){C.boxes.FullBox.call(this,"nmhd",a)},C.boxes.NullMediaHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.NullMediaHeaderBox.prototype.constructor=C.boxes.NullMediaHeaderBox,C.boxes.CompositionOffsetBox=function(a){C.boxes.FullBox.call(this,"ctts",a),this.entries=[]},C.boxes.CompositionOffsetBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.CompositionOffsetBox.prototype.constructor=C.boxes.CompositionOffsetBox,C.boxes.CompositionOffsetBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=2*C.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=(C.fields.FIELD_UINT32.getLength()+C.fields.FIELD_INT32.getLength())*this.entry_count},C.boxes.CompositionOffsetBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,C.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},0===this.version?(e.sample_count=this._readData(a,C.fields.FIELD_UINT32),e.sample_offset=this._readData(a,C.fields.FIELD_UINT32)):(e.sample_count=this._readData(a,C.fields.FIELD_UINT32),e.sample_offset=this._readData(a,C.fields.FIELD_INT32)),this.entries.push(e);return this.localPos},C.boxes.CompositionOffsetBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)0===this.version?(this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].sample_count),this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].sample_offset)):(this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].sample_count),this._writeData(a,C.fields.FIELD_INT32,this.entries[c].sample_offset));return this.localPos},C.boxes.CompositionToDecodeBox=function(a){C.boxes.FullBox.call(this,"cslg",a)},C.boxes.CompositionToDecodeBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.CompositionToDecodeBox.prototype.constructor=C.boxes.CompositionToDecodeBox,C.boxes.CompositionToDecodeBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*C.fields.FIELD_INT32.getLength()},C.boxes.CompositionToDecodeBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.compositionToDTSShift=this._readData(a,C.fields.FIELD_INT32),this.leastDecodeToDisplayDelta=this._readData(a,C.fields.FIELD_INT32),this.greatestDecodeToDisplayDelta=this._readData(a,C.fields.FIELD_INT32),this.compositionStartTime=this._readData(a,C.fields.FIELD_INT32),this.compositionEndTime=this._readData(a,C.fields.FIELD_INT32),this.localPos},C.boxes.CompositionToDecodeBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_INT32,this.compositionToDTSShift),this._writeData(a,C.fields.FIELD_INT32,this.leastDecodeToDisplayDelta),this._writeData(a,C.fields.FIELD_INT32,this.greatestDecodeToDisplayDelta),this._writeData(a,C.fields.FIELD_INT32,this.compositionStartTime),this._writeData(a,C.fields.FIELD_INT32,this.compositionEndTime),this.localPos},C.boxes.SyncSampleBox=function(a){C.boxes.FullBox.call(this,"stss",a),this.entries=[]},C.boxes.SyncSampleBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.SyncSampleBox.prototype.constructor=C.boxes.SyncSampleBox,C.boxes.SyncSampleBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength(),this.size+=C.fields.FIELD_UINT32.getLength()*this.entry_count},C.boxes.SyncSampleBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,C.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},e.sample_number=this._readData(a,C.fields.FIELD_UINT32),this.entries.push(e);return this.localPos},C.boxes.SyncSampleBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,C.fields.FIELD_UINT32,this.entries[c].sample_number);return this.localPos},C.boxes.TrackReferenceBox=function(a){C.boxes.FullBox.call(this,"tref",a)},C.boxes.TrackReferenceBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TrackReferenceBox.prototype.constructor=C.boxes.TrackReferenceBox,C.boxes.TrackReferenceBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength()*this.track_IDs.length},C.boxes.TrackReferenceBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_IDs=this._readArrayData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.TrackReferenceBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),this._writeArrayData(a,C.fields.FIELD_UINT32,this.track_IDs),this.localPos},C.boxes.OriginalFormatBox=function(a){C.boxes.Box.call(this,"frma",a)},C.boxes.OriginalFormatBox.prototype=Object.create(C.boxes.Box.prototype),C.boxes.OriginalFormatBox.prototype.constructor=C.boxes.OriginalFormatBox,C.boxes.OriginalFormatBox.prototype.computeLength=function(){C.boxes.Box.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT32.getLength()},C.boxes.OriginalFormatBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.data_format=this._readData(a,C.fields.FIELD_UINT32),this.localPos},C.boxes.OriginalFormatBox.prototype.write=function(a,b){return C.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,C.fields.FIELD_UINT32,this.data_format),this.localPos},C.boxes.PiffSampleEncryptionBox=function(a){C.boxes.FullBox.call(this,"sepiff",a,[162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])},C.boxes.PiffSampleEncryptionBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.PiffSampleEncryptionBox.prototype.constructor=C.boxes.PiffSampleEncryptionBox,C.boxes.PiffSampleEncryptionBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this);var a=0,b=0;for(this.size+=C.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=C.fields.FIELD_UINT8.getLength()),a=0;a<this.sample_count;a++)if(this.size+=8,2&this.flags)for(this.size+=C.fields.FIELD_UINT16.getLength(),b=0;b<this.entry[a].NumberOfEntries;b++)this.size+=C.fields.FIELD_UINT16.getLength(),this.size+=C.fields.FIELD_UINT32.getLength()},C.boxes.PiffSampleEncryptionBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0,d=0;for(this._writeData(a,C.fields.FIELD_UINT32,this.sample_count),1&this.flags&&this._writeData(a,C.fields.FIELD_UINT8,this.IV_size),c=0;c<this.sample_count;c++)if(this._writeBuffer(a,this.entry[c].InitializationVector,8),2&this.flags)for(this._writeData(a,C.fields.FIELD_UINT16,this.entry[c].NumberOfEntries),d=0;d<this.entry[c].NumberOfEntries;d++)this._writeData(a,C.fields.FIELD_UINT16,this.entry[c].clearAndCryptedData[d].BytesOfClearData),this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].clearAndCryptedData[d].BytesOfEncryptedData);return this.localPos},C.boxes.PiffSampleEncryptionBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e=0,f={},g={};for(this.sample_count=this._readData(a,C.fields.FIELD_UINT32),1&this.flags&&(this.IV_size=this._readData(a,C.fields.FIELD_UINT8)),this.entry=[],d=0;d<this.sample_count;d++){if(g={},g.InitializationVector=a.subarray(this.localPos,this.localPos+8),this.localPos+=8,2&this.flags)for(g.NumberOfEntries=this._readData(a,C.fields.FIELD_UINT16),g.clearAndCryptedData=[],e=0;e<g.NumberOfEntries;e++)f={},f.BytesOfClearData=this._readData(a,C.fields.FIELD_UINT16),f.BytesOfEncryptedData=this._readData(a,C.fields.FIELD_UINT32),g.clearAndCryptedData.push(f);this.entry.push(g)}return this.localPos},C.boxes.PiffTrackEncryptionBox=function(a){C.boxes.FullBox.call(this,"tepiff",a,[137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])},C.boxes.PiffTrackEncryptionBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.PiffTrackEncryptionBox.prototype.constructor=C.boxes.PiffTrackEncryptionBox,C.boxes.PiffProtectionSystemSpecificHeaderBox=function(a){C.boxes.FullBox.call(this,"psshpiff",a,[208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])},C.boxes.PiffProtectionSystemSpecificHeaderBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.PiffProtectionSystemSpecificHeaderBox.prototype.constructor=C.boxes.PiffProtectionSystemSpecificHeaderBox,C.boxes.TfxdBox=function(a){C.boxes.FullBox.call(this,"tfxd",a,[109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])},C.boxes.TfxdBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TfxdBox.prototype.constructor=C.boxes.TfxdBox,C.boxes.TfxdBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=2*C.fields.FIELD_UINT64.getLength():this.size+=2*C.fields.FIELD_UINT32.getLength()},C.boxes.TfxdBox.prototype.write=function(a,b){return C.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.fragment_absolute_time),this._writeData(a,C.fields.FIELD_UINT64,this.fragment_duration)):(this._writeData(a,C.fields.FIELD_UINT32,this.fragment_absolute_time),this._writeData(a,C.fields.FIELD_UINT32,this.fragment_duration)),this.localPos},C.boxes.TfxdBox.prototype.read=function(a,b,c){return C.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.fragment_absolute_time=this._readData(a,C.fields.FIELD_UINT64),this.fragment_duration=this._readData(a,C.fields.FIELD_UINT64)):(this.fragment_absolute_time=this._readData(a,C.fields.FIELD_UINT32),this.fragment_duration=this._readData(a,C.fields.FIELD_UINT32)),this.localPos},C.boxes.TfrfBox=function(a){C.boxes.FullBox.call(this,"tfrf",a,[212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])},C.boxes.TfrfBox.prototype=Object.create(C.boxes.FullBox.prototype),C.boxes.TfrfBox.prototype.constructor=C.boxes.TfrfBox,C.boxes.TfrfBox.prototype.computeLength=function(){C.boxes.FullBox.prototype.computeLength.call(this),this.size+=C.fields.FIELD_UINT8.getLength(),1===this.version?this.size+=2*C.fields.FIELD_UINT64.getLength()*this.fragment_count:this.size+=2*C.fields.FIELD_UINT32.getLength()*this.fragment_count},C.boxes.TfrfBox.prototype.write=function(a,b){C.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,C.fields.FIELD_UINT8,this.fragment_count),c=0;c<this.fragment_count;c++)1===this.version?(this._writeData(a,C.fields.FIELD_UINT64,this.entry[c].fragment_absolute_time),this._writeData(a,C.fields.FIELD_UINT64,this.entry[c].fragment_duration)):(this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].fragment_absolute_time),this._writeData(a,C.fields.FIELD_UINT32,this.entry[c].fragment_duration));return this.localPos},C.boxes.TfrfBox.prototype.read=function(a,b,c){C.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.fragment_count=this._readData(a,C.fields.FIELD_UINT8),this.entry=[],d=0;d<this.fragment_count;d++)e={},1===this.version?(e.fragment_absolute_time=this._readData(a,C.fields.FIELD_UINT64),e.fragment_duration=this._readData(a,C.fields.FIELD_UINT64)):(e.fragment_absolute_time=this._readData(a,C.fields.FIELD_UINT32),e.fragment_duration=this._readData(a,C.fields.FIELD_UINT32)),this.entry.push(e);return this.localPos},C.registerTypeBoxes(),C.fields.readBytes=function(a,b,c){var d=0,e=0;for(e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},C.fields.writeBytes=function(a,b,c,d){var e=0;for(e=0;c>e;e++)a[b+c-e-1]=255&d,d>>=8},C.fields.readString=function(a,b,c){var d,e="";for(d=b;b+c>d;d++)e+=String.fromCharCode(a[d]);return e},C.fields.NumberField=function(a,b){this.bits=a,this.signed=b},C.fields.NumberField.prototype.read=function(a,b){return C.fields.readBytes(a,b,this.bits/8)},C.fields.NumberField.prototype.write=function(a,b,c){C.fields.writeBytes(a,b,this.bits/8,c)},C.fields.NumberField.prototype.getLength=function(){return this.bits/8},C.fields.LongNumberField=function(){},C.fields.LongNumberField.prototype.read=function(a,b){var c=C.fields.readBytes(a,b,4),d=C.fields.readBytes(a,b+4,4);return p.math.Long.fromBits(d,c).toNumber()},C.fields.LongNumberField.prototype.write=function(a,b,c){var d=p.math.Long.fromNumber(c),e=d.getLowBits(),f=d.getHighBits();C.fields.writeBytes(a,b,4,f),C.fields.writeBytes(a,b+4,4,e)},C.fields.LongNumberField.prototype.getLength=function(){return 8},C.fields.FixedLenStringField=function(a){this.size=a},C.fields.FixedLenStringField.prototype.read=function(a,b){var c="",d=0;for(d=0;d<this.size;d++)c+=String.fromCharCode(a[b+d]);return c},C.fields.FixedLenStringField.prototype.write=function(a,b,c){var d=0;for(d=0;d<this.size;d++)a[b+d]=c.charCodeAt(d)},C.fields.FixedLenStringField.prototype.getLength=function(){return this.size},C.fields.BoxTypeField=function(){},C.fields.BoxTypeField.prototype.read=function(a,b){var c="",d=0;for(d=0;4>d;d++)c+=String.fromCharCode(a[b+d]);return c},C.fields.BoxTypeField.prototype.write=function(a,b,c){var d=0;for(d=0;4>d;d++)a[b+d]=c.charCodeAt(d)},C.fields.BoxTypeField.prototype.getLength=function(){return 4},C.fields.StringField=function(){},C.fields.StringField.prototype.read=function(a,b,c){var d="",e=0;for(e=b;c>e;e++)if(d+=String.fromCharCode(a[e]),0===a[e])return d;if(255>c-b&&a[0]==String.fromCharCode(c-b))return d=d.substr(1,c-b),C.warningHandler('null-terminated string expected, but found a string "'+d+'", which seems to be length-prefixed instead. Conversion done.'),d;throw new C.ParseException('expected null-terminated string, but end of field reached without termination. Read so far:"'+d+'"')},C.fields.StringField.prototype.write=function(a,b,c){var d=0;for(d=0;d<c.length;d++)a[b+d]=c.charCodeAt(d);a[b+c.length]=0},C.fields.StringField.prototype.getLength=function(a){return a.length},C.fields.ArrayField=function(a,b){this.innerField=a,this.size=b},C.fields.ArrayField.prototype.read=function(a,b){var c=-1,d=[],e=0;for(e=0;e<this.size;e++)d.push(this.innerField.read(a,b)),-1==c&&(c=this.innerField.getLength(d[e])),b+=c;return d},C.fields.FIELD_INT8=new C.fields.NumberField(8,!0),C.fields.FIELD_INT16=new C.fields.NumberField(16,!0),C.fields.FIELD_INT32=new C.fields.NumberField(32,!0),C.fields.FIELD_INT64=new C.fields.LongNumberField,C.fields.FIELD_UINT8=new C.fields.NumberField(8,!1),C.fields.FIELD_UINT16=new C.fields.NumberField(16,!1),C.fields.FIELD_UINT32=new C.fields.NumberField(32,!1),C.fields.FIELD_UINT64=new C.fields.LongNumberField,C.fields.FIELD_BIT8=new C.fields.NumberField(8,!1),C.fields.FIELD_BIT16=new C.fields.NumberField(16,!1),C.fields.FIELD_BIT24=new C.fields.NumberField(24,!1),C.fields.FIELD_BIT32=new C.fields.NumberField(32,!1),C.fields.FIELD_ID=new C.fields.BoxTypeField(4),C.fields.FIELD_STRING=new C.fields.StringField;var D=function(){return{pes:{},si:{},binary:{},ts:{},Pts:{},aac:{},h264:{}}}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=D:window.mpegts=D,D.aac.SAMPLING_FREQUENCY=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],D.aac.getAudioSpecificConfig=function(a){var b=D.binary.getValueFromByte(a[2],0,2),c=D.binary.getValueFromByte(a[2],2,4),d=D.binary.getValueFrom2Bytes(a.subarray(2,5),7,3),e=new Uint8Array(2);return e[0]=b+1<<3,e[0]|=(14&c)>>1,e[1]|=(1&c)<<7,e[1]|=d<<3,e},D.aac.parseADTS=function(a,b){for(var c,d,e=[],f={},g=0;g<a.length;)d=g,f.syncword=(a[g]<<4)+((240&a[g+1])>>4),f.protection_absent=1&a[g+1],f.sampling_frequency_index=(60&a[g+2])>>2,f.channel_configuration=((1&a[g+2])<<1)+((192&a[g+3])>>6),f.aac_frame_length=((3&a[g+3])<<11)+(a[g+4]<<3)+((224&a[g+5])>>5),f.number_of_raw_data_blocks_in_frame=(3&a[g+6])>>2,g+=7,0===f.number_of_raw_data_blocks_in_frame&&(0===f.protection_absent&&(g+=2),c={},c.offset=g,c.length=f.aac_frame_length-(g-d),b&&b[d]&&(c.cts=b[d]),e.push(c),g+=c.length);return e},D.ts.AdaptationField=function(){this.m_cAFLength=null,this.m_bDiscontinuityInd=null,this.m_bRAI=null,this.m_bESPriority=null,this.m_bPCRFlag=null,this.m_bOPCRFlag=null,this.m_bSplicingPointFlag=null,this.m_bPrivateDataFlag=null,this.m_bAdaptationFieldExtFlag=null},D.ts.AdaptationField.prototype.getLength=function(){return this.m_cAFLength+1},D.ts.AdaptationField.prototype.parse=function(a){if(this.m_cAFLength=a[0],0!==this.m_cAFLength){var b=1;this.m_bDiscontinuityInd=D.binary.getBitFromByte(a[b],0),this.m_bRAI=D.binary.getBitFromByte(a[b],1),this.m_bESPriority=D.binary.getBitFromByte(a[b],2),this.m_bPCRFlag=D.binary.getBitFromByte(a[b],3),this.m_bOPCRFlag=D.binary.getBitFromByte(a[b],4),this.m_bSplicingPointFlag=D.binary.getBitFromByte(a[b],5),this.m_bPrivateDataFlag=D.binary.getBitFromByte(a[b],6),this.m_bAdaptationFieldExtFlag=D.binary.getBitFromByte(a[b],7)}},D.binary.readBytes=function(a,b,c){for(var d=0,e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},D.binary.getBitFromByte=function(a,b){var c=0;return c+=1<<7-b,0!==(a&c)},D.binary.getValueFrom3Bytes=function(a,b,c){"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);var d=-1==c?-1:c-(16-b),e=-1==c?0:8-d,f=D.binary.getValueFromByte(a[0],b),g=D.binary.getValueFromByte(a[1]),h=D.binary.getValueFromByte(a[2],0,d,!1);return(f<<16&16711680|g<<8&65280|255&h)>>e},D.binary.getValueFrom2Bytes=function(a,b,c){"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);var d=-1==c?-1:c-(8-b),e=-1==c?0:8-d,f=D.binary.getValueFromByte(a[0],b),g=D.binary.getValueFromByte(a[1],0,d,!1);return(f<<8&65280|255&g)>>e},D.binary.getValueFromByte=function(a,b,c,d){var e=0,f=0;"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);
var g=-1==c?7:b+c-1;for(f=b;g>=f;f++)e+=1<<7-f;var h=a&e;return(d||"undefined"==typeof d)&&(h>>=7-g),h},D.h264.getSequenceHeader=function(a){for(var b,c=-1,d=-1,e=0,f=null,g=0,h=0;e<a.length;)if(0===a[e]&&0===a[e+1]&&0===a[e+2]&&1===a[e+3]){if(b=31&a[e+4],b>=D.h264.NALUTYPE_SPS&&b<=D.h264.NALUTYPE_PPS){if(-1===c&&(c=e),b===D.h264.NALUTYPE_SPS){var i=D.h264.parseSPS(a.subarray(e+5));g=i.pic_width_in_mbs_minus1+1<<4,h=i.pic_height_in_map_units_minus1+1<<4}}else c>0&&(d=e-c);if(b===D.h264.NALUTYPE_IDR||b===D.h264.NALUTYPE_NONIDR)break;e+=4}else{if(0===a[e]&&0===a[e+1]&&1===a[e+2]){c>0&&(d=e-c);break}e++}return-1===c||-1===d?null:(f=new Uint8Array(d),f.set(a.subarray(c,c+d)),{bytes:f,width:g,height:h})},D.h264.read_ue=function(a,b){var c=1,d=0,e=0;for(b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);0===b._bit;)e++,c<<=1,b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);if(c-=1,d=0,e)for(;e>0;)b._bit=b._byte>>b._bitPos&1,b._bitPos--,d=(d<<1)+b._bit,e--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);return c+=d},D.h264.read_flag=function(a,b){var c=0;return b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7),c=b._bit},D.h264.parseSPS=function(a){var b={profile_idc:0,constraint_set0_flag:0,constraint_set1_flag:0,constraint_set2_flag:0,constraint_set3_flag:0,level_idc:0,seq_parameter_set_id:0,chroma_format_idc:0,separate_colour_plane_flag:0,bit_depth_luma_minus8:0,bit_depth_chroma_minus8:0,qpprime_y_zero_transform_bypass_flag:0,seq_scaling_matrix_present_flag:0,log2_max_frame_num_minus4:0,pic_order_cnt_type:0,log2_max_pic_order_cnt_lsb_minus4:0,num_ref_frames:0,gaps_in_frame_num_value_allowed_flag:0,pic_width_in_mbs_minus1:0,pic_height_in_map_units_minus1:0},c={_byte:0,_bit:0,_bytePos:0,_bitPos:0};return c._bytePos=c._bitPos=0,c._byte=a[c._bytePos],c._bytePos++,b.profile_idc=c._byte,c._byte=a[c._bytePos],c._bytePos++,b.constraint_set0_flag=(128&c._byte)>>7,b.constraint_set1_flag=(64&c._byte)>>6,b.constraint_set2_flag=(32&c._byte)>>5,b.constraint_set3_flag=(16&c._byte)>>4,c._byte=a[c._bytePos],c._bytePos++,b.level_idc=c._byte,c._bitPos=7,b.seq_parameter_set_id=D.h264.read_ue(a,c),(100==b.profileIdc||110==b.profileIdc||122==b.profileIdc||244==b.profileIdc||44==b.profileIdc||83==b.profileIdc||86==b.profileIdc)&&(b.chroma_format_idc=D.h264.read_ue(a,c),3===b.chroma_format_idc&&(b.separate_colour_plane_flag=D.h264.read_flag(a,c)),b.bit_depth_luma_minus8=D.h264.read_ue(a,c),b.bit_depth_chroma_minus8=D.h264.read_ue(a,c),b.qpprime_y_zero_transform_bypass_flag=D.h264.read_flag(a,c),b.seq_scaling_matrix_present_flag=D.h264.read_flag(a,c),1===b.seq_scaling_matrix_present_flag),b.log2_max_frame_num_minus4=D.h264.read_ue(a,c),b.pic_order_cnt_type=D.h264.read_ue(a,c),0===b.pic_order_cnt_type?b.log2_max_pic_order_cnt_lsb_minus4=D.h264.read_ue(a,c):1===b.pic_order_cnt_type,b.num_ref_frames=D.h264.read_ue(a,c),b.gaps_in_frame_num_value_allowed_flag=D.h264.read_flag(a,c),b.pic_width_in_mbs_minus1=D.h264.read_ue(a,c),b.pic_height_in_map_units_minus1=D.h264.read_ue(a,c),b},D.h264.bytestreamToMp4=function(a){for(var b=0,c=a.length,d=-1,e=0;c>b;)0===a[b]&&0===a[b+1]&&0===a[b+2]&&1===a[b+3]?(d>=0&&(e=b-d-4,a[d]=(4278190080&e)>>24,a[d+1]=(16711680&e)>>16,a[d+2]=(65280&e)>>8,a[d+3]=255&e),d=b,b+=4):b++;e=b-d-4,a[d]=(4278190080&e)>>24,a[d+1]=(16711680&e)>>16,a[d+2]=(65280&e)>>8,a[d+3]=255&e},D.h264.NALUTYPE_NONIDR=1,D.h264.NALUTYPE_IDR=5,D.h264.NALUTYPE_SEI=6,D.h264.NALUTYPE_SPS=7,D.h264.NALUTYPE_PPS=8,D.h264.NALUTYPE_AU_DELIMITER=9,D.si.PSISection=function(a){this.m_table_id=a,this.m_section_syntax_indicator=1,this.m_section_length=D.si.PSISection.prototype.SECTION_LENGTH,this.m_transport_stream_id=0,this.m_version_number=0,this.m_current_next_indicator=!0,this.m_section_number=0,this.m_last_section_number=0,this.m_bValid=null},D.si.PSISection.prototype.parse=function(a){this.m_bValid=!1;var b=0,c=a[b];return b=0===c?b+1:b+c,this.m_table_id=a[b],b++,this.m_section_syntax_indicator=D.binary.getBitFromByte(a[b],0),this.m_section_length=D.binary.getValueFrom2Bytes(a.subarray(b,b+2),4),b+=2,this.m_transport_stream_id=D.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2,this.m_version_number=D.binary.getValueFromByte(a[b],2,5),this.m_current_next_indicator=D.binary.getBitFromByte(a[b],7),b++,this.m_section_number=a[b],b++,this.m_last_section_number=a[b],this.m_bValid=!0,b},D.si.PSISection.prototype.getSectionLength=function(){return this.m_section_length},D.si.PSISection.prototype.SECTION_LENGTH=9,D.si.PSISection.prototype.HEADER_LENGTH=8,D.si.PAT=function(){D.si.PSISection.call(this,D.si.PAT.prototype.TABLE_ID),this.m_listOfProgramAssociation=[],this.m_network_pid=null},D.si.PAT.prototype=Object.create(D.si.PSISection.prototype),D.si.PAT.prototype.constructor=D.si.PAT,D.si.PAT.prototype.parse=function(a){var b=D.si.PSISection.prototype.parse.call(this,a);if(b++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id==this.TABLE_ID)){for(var c=this.getSectionLength()-this.SECTION_LENGTH;c>=4;){var d=new D.si.ProgramAssociation(a.subarray(b,b+4));0===d.getProgramNumber()?this.m_network_pid=d.getProgramMapPid():this.m_listOfProgramAssociation.push(d),c-=4,b+=4}this.m_bValid=!0}},D.si.PAT.prototype.getPmtPid=function(){var a=D.ts.TsPacket.prototype.UNDEFINED_PID;if(this.m_listOfProgramAssociation.length>=1){var b=this.m_listOfProgramAssociation[0];a=b.getProgramMapPid()}return a},D.si.PAT.prototype.TABLE_ID=0,D.si.PAT.prototype.PID=0,D.si.ProgramAssociation=function(a){this.m_program_number=0,this.m_program_map_pid=0,this.parse(a)},D.si.ProgramAssociation.prototype.getProgramNumber=function(){return this.m_program_number},D.si.ProgramAssociation.prototype.getProgramMapPid=function(){return this.m_program_map_pid},D.si.ProgramAssociation.prototype.getLength=function(){return 4},D.si.ProgramAssociation.prototype.parse=function(a){this.m_program_number=D.binary.getValueFrom2Bytes(a.subarray(0,2)),this.m_program_map_pid=D.binary.getValueFrom2Bytes(a.subarray(2,4),3,13)},D.pes.PesPacket=function(){this.m_cStreamID=null,this.m_nPESPacketLength=null,this.m_cPESScramblingCtrl=null,this.m_bPESpriority=null,this.m_bDataAlignement=null,this.m_bCopyright=null,this.m_bOriginalOrCopy=null,this.m_cPES_header_data_length=null,this.m_cPTS_DTS_flags=null,this.m_bESCR_flag=null,this.m_bES_rate_flag=null,this.m_bDSM_trick_mode_flag=null,this.m_bAdditional_copy_info_flag=null,this.m_bPES_CRC_flag=null,this.m_bPES_extension_flag=null,this.m_pPTS=null,this.m_pDTS=null,this.m_pESCR=null,this.m_ES_rate=null,this.m_DSM_trick_mode=null,this.m_Additional_copy_info=null,this.m_PES_CRC=null,this.m_cNbStuffingBytes=null,this.m_pPESExtension=null,this.m_pPrivateData=null,this.m_payloadArray=null,this.m_nPayloadLength=null,this.m_bDirty=null,this.m_bValid=!1},D.pes.PesPacket.prototype.parse=function(a){var b=0;this.m_nLength=a.length;var c=D.binary.getValueFrom3Bytes(a.subarray(b,b+3));if(c===this.START_CODE_PREFIX){if(b=3,this.m_cStreamID=a[b],b++,this.m_nPESPacketLength=D.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2,this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM)return void(this.m_bValid=!0);if(!this.hasOptionalPESHeader())return this.m_payloadArray=a.subarray(b+D.pes.PesPacket.prototype.FIXED_HEADER_LENGTH),this.m_nPayloadLength=this.m_nLength-D.pes.PesPacket.prototype.FIXED_HEADER_LENGTH,void(this.m_bValid=!0);var d=D.binary.getValueFromByte(a[b],0,2);if(2==d){this.m_cPESScramblingCtrl=D.binary.getValueFromByte(a[b],2,2),this.m_bPESpriority=D.binary.getBitFromByte(a[b],4),this.m_bDataAlignement=D.binary.getBitFromByte(a[b],5),this.m_bCopyright=D.binary.getBitFromByte(a[b],6),this.m_bOriginalOrCopy=D.binary.getBitFromByte(a[b],7),b++,this.m_cPTS_DTS_flags=D.binary.getValueFromByte(a[b],0,2),this.m_bESCR_flag=D.binary.getBitFromByte(a[b],2),this.m_bES_rate_flag=D.binary.getBitFromByte(a[b],3),this.m_bDSM_trick_mode_flag=D.binary.getBitFromByte(a[b],4),this.m_bAdditional_copy_info_flag=D.binary.getBitFromByte(a[b],5),this.m_bPES_CRC_flag=D.binary.getBitFromByte(a[b],6),this.m_bPES_extension_flag=D.binary.getBitFromByte(a[b],7),b++,this.m_cPES_header_data_length=255&a[b],b++,(this.m_cPTS_DTS_flags&D.pes.PesPacket.prototype.FLAG_PTS)==D.pes.PesPacket.prototype.FLAG_PTS&&(this.m_pPTS=new D.Pts(a.subarray(b,b+5)),b+=5),(this.m_cPTS_DTS_flags&D.pes.PesPacket.prototype.FLAG_DTS)==D.pes.PesPacket.prototype.FLAG_DTS&&(this.m_pDTS=new D.Pts(a.subarray(b,b+5)),b+=5),this.m_bESCR_flag&&(b+=6),this.m_bES_rate_flag&&(this.m_ES_rate=D.binary.getValueFrom3Bytes(a.subarray(b,b+3),1,22),b+=3),this.m_bDSM_trick_mode_flag&&(this.m_DSM_trick_mode=a[b],b++),this.m_bAdditional_copy_info_flag&&(this.m_Additional_copy_info=a[b],b++),this.m_bPES_CRC_flag&&(this.m_PES_CRC=D.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2),this.m_bPES_extension_flag;var e=D.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+D.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length;this.m_cNbStuffingBytes=e-b,b+=this.m_cNbStuffingBytes,this.m_nPayloadLength=this.m_nLength-e,this.m_payloadArray=a.subarray(e,e+this.m_nPayloadLength),this.m_bValid=!0}}},D.pes.PesPacket.prototype.hasOptionalPESHeader=function(){return this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM||this.m_cStreamID===D.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM?!1:!0},D.pes.PesPacket.prototype.getHeaderLength=function(){return D.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+D.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length},D.pes.PesPacket.prototype.getPayload=function(){return this.m_payloadArray},D.pes.PesPacket.prototype.getPts=function(){return this.m_pPTS},D.pes.PesPacket.prototype.getDts=function(){return this.m_pDTS},D.pes.PesPacket.prototype.START_CODE_PREFIX=1,D.pes.PesPacket.prototype.FIXED_HEADER_LENGTH=6,D.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH=3,D.pes.PesPacket.prototype.FLAG_DTS=1,D.pes.PesPacket.prototype.FLAG_PTS=2,D.si.PMT=function(){D.si.PSISection.call(this,D.si.PMT.prototype.TABLE_ID),this.m_listOfComponents=[],this.m_PCR_PID=null,this.m_program_info_length=null},D.si.PMT.prototype=Object.create(D.si.PSISection.prototype),D.si.PMT.prototype.constructor=D.si.PMT,D.si.PMT.prototype.parse=function(a){var b=D.si.PSISection.prototype.parse.call(this,a);if(b++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id==this.TABLE_ID)){var c=this.getSectionLength()-this.SECTION_LENGTH;if(!(4>c)){this.m_PCR_PID=D.binary.getValueFrom2Bytes(a.subarray(b,b+2),3),b+=2,this.m_program_info_length=D.binary.getValueFrom2Bytes(a.subarray(b,b+2),4),b+=2,b+=this.m_program_info_length,c=this.m_section_length-this.SECTION_LENGTH-4-this.m_program_info_length;for(var d=null;c>0;)d=new D.si.ESDescription(a.subarray(b,b+c)),this.m_listOfComponents.push(d),c-=d.getLength(),b+=d.getLength();this.m_bValid=!0}}},D.si.PMT.prototype.TABLE_ID=2,D.si.PMT.prototype.gStreamTypes=[{name:"Reserved",value:0,desc:"ITU-T | ISO/IEC Reserved"},{name:"MPEG1-Video",value:224,desc:"ISO/IEC 11172-2 Video"},{name:"MPEG2-Video",value:224,desc:"ITU-T Rec. H.262 | ISO/IEC 13818-2 Video or ISO/IEC 11172-2 constrained parameter video stream"},{name:"MPEG1-Audio",value:192,desc:"ISO/IEC 11172-3 Audio"},{name:"MPEG2-Audio",value:192,desc:"ISO/IEC 13818-3 Audio"},{name:"PRIVATE_SECTIONS",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 private_sections"},{name:"PRIVATE",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 PES packets containing private data"},{name:"MHEG",value:243,desc:"ISO/IEC 13522 MHEG"},{name:"MPEG1-DSM-CC",value:242,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 Annex A DSM-CC"},{name:"H.222.1",value:244,desc:"ITU-T Rec. H.222.1"},{name:"DSM-CC_A",value:244,desc:"ISO/IEC 13818-6 type A"},{name:"DSM-CC_B",value:245,desc:"ISO/IEC 13818-6 type B"},{name:"DSM-CC_C",value:246,desc:"ISO/IEC 13818-6 type C"},{name:"DSM-CC_D",value:247,desc:"ISO/IEC 13818-6 type D"},{name:"Auxiliary",value:0,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 auxiliary"},{name:"MPEG2-AAC-ADTS",value:192,desc:"ISO/IEC 13818-7 Audio with ADTS transport syntax"},{name:"MPEG4-Video",value:224,desc:"ISO/IEC 14496-2 Visual"},{name:"MPEG4-AAC-LATM",value:192,desc:"ISO/IEC 14496-3 Audio with the LATM transport syntax as defined in ISO/IEC 14496-3/AMD-1"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in PES packets"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in ISO/IEC14496_sections"},{name:"DSM-CC_SDP",value:0,desc:"ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"META_PES",value:252,desc:"Metadata carried in PES packets"},{name:"META_SECTIONS",value:252,desc:"Metadata carried in metadata_sections"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Data Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Object Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"MPEG2-IPMP",value:0,desc:"IPMP stream (defined in ISO/IEC 13818-11, MPEG-2 IPMP)"},{name:"H.264",value:224,desc:"AVC video stream as defined in ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"MPEG4AAC",value:192,desc:"ISO/IEC 14496-3 Audio, without using any additional transport syntax, such as DST, ALS and SLS"},{name:"MPEG4Text",value:0,desc:"ISO/IEC 14496-17 Text"},{name:"Aux. Video (23002-3)",value:30,desc:"Auxiliary video stream as defined in ISO/IEC 23002-3"},{name:"H.264-SVC",value:224,desc:"SVC video sub-bitstream of a video stream as defined in the Annex G of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"H.264-MVC",value:224,desc:"MVC video sub-bitstream of a video stream as defined in the Annex H of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"Reserved1",value:0,desc:"TBC Reserved"},{name:"Reserved2",value:0,desc:"TBC Reserved"},{name:"Reserved3",value:0,desc:"TBC Reserved"},{name:"HEVC",value:224,desc:"ITU.-T Rec H.26x | ISO/IEC 23008-2 video stream"}],D.si.PMT.prototype.MPEG2_VIDEO_STREAM_TYPE=2,D.si.PMT.prototype.AVC_VIDEO_STREAM_TYPE=27,D.si.PMT.prototype.MPEG1_AUDIO_STREAM_TYPE=3,D.si.PMT.prototype.MPEG2_AUDIO_STREAM_TYPE=4,D.si.PMT.prototype.AAC_AUDIO_STREAM_TYPE=17,D.si.PMT.prototype.AC3_AUDIO_STREAM_TYPE=6,D.si.PMT.prototype.SUB_STREAM_TYPE=6,D.si.PMT.prototype.STREAM_TYPE_MP1V=1,D.si.PMT.prototype.STREAM_TYPE_MP2V=2,D.si.PMT.prototype.STREAM_TYPE_MP1A=3,D.si.PMT.prototype.STREAM_TYPE_MP2A=4,D.si.PMT.prototype.STREAM_TYPE_PRIVATE=6,D.si.PMT.prototype.STREAM_TYPE_TELETEXT=6,D.si.PMT.prototype.STREAM_TYPE_DVBSUBTITLE=6,D.si.PMT.prototype.STREAM_TYPE_AC3=6,D.si.PMT.prototype.STREAM_TYPE_MP2AAC_ADTS=15,D.si.PMT.prototype.STREAM_TYPE_MP4AAC_LATM=17,D.si.PMT.prototype.STREAM_TYPE_H264=27,D.si.PMT.prototype.STREAM_TYPE_MP4AAC=28,D.si.PMT.prototype.STREAM_TYPE_AUX_23002_3=30,D.si.PMT.prototype.STREAM_TYPE_SVC=31,D.si.PMT.prototype.STREAM_TYPE_MVC=32,D.si.PMT.prototype.STREAM_TYPE_HEVC=36,D.si.ESDescription=function(a){this.m_stream_type=null,this.m_elementary_PID=null,this.m_ES_info_length=null,this.parse(a)},D.si.ESDescription.prototype.getStreamType=function(){return this.m_stream_type},D.si.ESDescription.prototype.getPID=function(){return this.m_elementary_PID},D.si.ESDescription.prototype.getLength=function(){return 5+this.m_ES_info_length},D.si.ESDescription.prototype.parse=function(a){this.m_stream_type=a[0],this.m_elementary_PID=D.binary.getValueFrom2Bytes(a.subarray(1,3),3),this.m_ES_info_length=D.binary.getValueFrom2Bytes(a.subarray(3,5),4)},D.Pts=function(a){var b,c,d=a[0]>>1&7;c=d>>2,b=(3&d)<<30>>>0;var e=a[1];b=(b|e<<22)>>>0;var f=a[2]>>1;b=(b|f<<15)>>>0;var g=a[3];b=(b|g<<7)>>>0;var h=a[4]>>1;b=(b|h)>>>0,this.m_lPTS=p.math.Long.fromBits(b,c).toNumber(),this.m_fPTS=this.m_lPTS/D.Pts.prototype.SYSTEM_CLOCK_FREQUENCY},D.Pts.prototype.getValue=function(){return this.m_lPTS},D.Pts.prototype.getValueInSeconds=function(){return this.m_fPTS},D.Pts.prototype.SYSTEM_CLOCK_FREQUENCY=9e4,D.ts.TsPacket=function(){this.m_cSync=null,this.m_bTransportError=null,this.m_bPUSI=null,this.m_bTransportPriority=null,this.m_nPID=null,this.m_cTransportScramblingCtrl=null,this.m_cAdaptationFieldCtrl=null,this.m_cContinuityCounter=null,this.m_pAdaptationField=null,this.m_payloadArray=null,this.m_cPayloadLength=null,this.m_bDirty=null,this.m_time=null,this.m_arrivalTime=null,this.m_bIgnored=null},D.ts.TsPacket.prototype.parse=function(a){var b=0;if(this.m_cSync=a[b],this.m_cSync===this.SYNC_WORD){if(b++,this.m_bTransportError=D.binary.getBitFromByte(a[b],0),this.m_bPUSI=D.binary.getBitFromByte(a[b],1),this.m_bTransportPriority=D.binary.getBitFromByte(a[b],2),this.m_nPID=D.binary.getValueFrom2Bytes(a.subarray(b,b+2),3,13),b+=2,this.m_cTransportScramblingCtrl=D.binary.getValueFromByte(a[b],0,2),this.m_cAdaptationFieldCtrl=D.binary.getValueFromByte(a[b],2,2),this.m_cContinuityCounter=D.binary.getValueFromByte(a[b],4,4),b++,2&this.m_cAdaptationFieldCtrl){var c=a[b];if(c+b>=this.TS_PACKET_SIZE)return;this.m_pAdaptationField=new D.ts.AdaptationField,this.m_pAdaptationField.parse(a.subarray(b)),b+=this.m_pAdaptationField.getLength()}0!==this.m_cAdaptationFieldCtrl&&1&this.m_cAdaptationFieldCtrl&&(this.m_cPayloadLength=this.TS_PACKET_SIZE-b,this.m_payloadArray=a.subarray(b,b+this.m_cPayloadLength))}},D.ts.TsPacket.prototype.getPid=function(){return this.m_nPID},D.ts.TsPacket.prototype.getPayload=function(){return this.m_payloadArray},D.ts.TsPacket.prototype.getPayloadLength=function(){return this.m_cPayloadLength},D.ts.TsPacket.prototype.getPusi=function(){return this.m_bPUSI},D.ts.TsPacket.prototype.hasAdaptationFieldOnly=function(){return 2===this.m_cAdaptationFieldCtrl},D.ts.TsPacket.prototype.SYNC_WORD=71,D.ts.TsPacket.prototype.TS_PACKET_SIZE=188,D.ts.TsPacket.prototype.UNDEFINED_PID=65535,D.ts.TsPacket.prototype.PAT_PID=0,D.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP=188,D.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,D.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,D.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2=191,D.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM=240,D.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM=241,D.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM=242,D.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM=248,D.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY=255,w=function(){var a,b,c,g,h=!1,i=!1,j=[],k=[],l=[],m=[],n=null,p=null,q="und",r="und",s=null,t=null,u={ref:null,deferInit:null,isActivated:!1},w={video:-1,audio:-1},x={isInDebug:!1,level:0,loggerType:"console"},y="UNINITIALIZED",z=function(){if("UNINITIALIZED"===y)throw new Error("OrangeHasPlayer not initialized")},A=function(){c.log("[OrangeHasPlayer] loadeddata"),this.getAudioTracks(),this.getSubtitleTracks(),this.getSelectedAudioTrack(),this.getSelectedSubtitleTrack(),g.textTracks.length>0&&(g.textTracks[0].mode=i===!0?"showing":"hidden")},B=function(a){a.altKey!==!0||a.ctrlKey!==!0||a.shiftKey!==!0||68!==a.keyCode&&90!==a.keyCode||(x.isInDebug?(x.isInDebug=!1,console.log("debug mode desactivated"),z(),90===a.keyCode&&C(b.getDebug().getLogger().getLogs()),b.getDebug().setLevel(x.level),b.getDebug().setLogger(x.loggerType)):(x.isInDebug=!0,console.log("debug mode activated"),z(),x.level=b.getDebug().getLevel(),b.getDebug().setLevel(68===a.keyCode?4:3),b.getDebug().setLogger(68===a.keyCode?"console":"memory")))},C=function(a){if(a&&a.length>0){var b="hasplayer_logs.txt",c=JSON.stringify(a,null,"\r\n"),d=new Blob([c],{type:"text/json"});if(navigator.msSaveBlob)navigator.msSaveBlob(d,b);else{var e=document.createEvent("MouseEvents"),f=document.createElement("a");f.download=b,f.href=window.URL.createObjectURL(d),f.dataset.downloadurl=["text/json",f.download,f.href].join(":"),e.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),f.dispatchEvent(e)}}},D=function(a,b){var c=document.createEvent("CustomEvent");c.initCustomEvent(a,!1,!1,{type:b.streamType,bitrate:b.switchedQuality,representationId:b.representationId,time:g.currentTime,width:b.width,height:b.height}),g.dispatchEvent(c)},E=function(a,b){var c=0;for(c=b.length-1;c>=0;c-=1)a.splice(c,1)},F=function(a){var b=g.currentTime,d=null,e=[],f=0;for(f=0;f<a.length;f+=1)d=a[f],b>=d.mediaStartTime&&(D("play_bitrate",d),c.log("[OrangeHasPlayer]["+d.streamType+"] send play_bitrate - b="+d.switchedQuality+", t="+d.mediaStartTime+"("+g.playbackRate+")"),e.push(f));E(a,e)},G=function(){0!==g.playbackRate&&(F(l),F(m))},H=function(a){var d,e=b.getMetricsExt();switch(a.data.metric){case"ManifestReady":z(),c.log("[OrangeHasPlayer] ManifestReady"),n=e.getBitratesForType("video"),c.log("[OrangeHasPlayer] video bitrates: "+JSON.stringify(n)),d=document.createEvent("CustomEvent"),d.initCustomEvent("manifest_loaded",!1,!1,{}),g.dispatchEvent(d);break;case"RepresentationSwitch":z(),"video"==a.data.stream?(n=e.getBitratesForType(a.data.stream),n&&(D("download_bitrate",{streamType:a.data.stream,switchedQuality:n[a.data.value.lto],representationId:a.data.value.to,width:e.getVideoWidthForRepresentation(a.data.value.to),height:e.getVideoHeightForRepresentation(a.data.value.to)}),c.log("[OrangeHasPlayer]["+a.data.stream+"] send download_bitrate - b="+n[a.data.value.lto]))):"audio"==a.data.stream&&(p=e.getBitratesForType(a.data.stream),p&&(D("download_bitrate",{streamType:a.data.stream,switchedQuality:p[a.data.value.to],representationId:a.data.value.to,width:e.getVideoWidthForRepresentation(a.data.value.to),height:e.getVideoHeightForRepresentation(a.data.value.to)}),c.log("[OrangeHasPlayer]["+a.data.stream+"] send download_bitrate - b="+n[a.data.value.lto])));break;case"BufferedSwitch":z(),"video"==a.data.stream?l.push({streamType:a.data.stream,mediaStartTime:a.data.value.mt,switchedQuality:n[a.data.value.lto],representationId:a.data.value.to,width:e.getVideoWidthForRepresentation(a.data.value.to),height:e.getVideoHeightForRepresentation(a.data.value.to)}):"audio"==a.data.stream&&m.push({streamType:a.data.stream,mediaStartTime:a.data.value.mt,switchedQuality:p[a.data.value.lto],representationId:a.data.value.to,width:e.getVideoWidthForRepresentation(a.data.value.to),height:e.getVideoHeightForRepresentation(a.data.value.to)});break;case"BufferLevel":d=document.createEvent("CustomEvent"),d.initCustomEvent("bufferLevel_updated",!1,!1,{type:a.data.stream,level:a.data.value.level}),g.dispatchEvent(d);break;case"State":d=document.createEvent("CustomEvent"),d.initCustomEvent("state_changed",!1,!1,{type:a.data.stream,state:a.data.value.current}),g.dispatchEvent(d)}};this.init=function(d){if(!d)throw new Error("OrangeHasPlayer.init(): Invalid Argument");a=new v.di.Context,b=new v(a),g=d,b.startup(),b.attachView(g),y="PLAYER_CREATED",c=b.getDebug(),this.addEventListener("loadeddata",A.bind(this)),b.addEventListener("metricAdded",H),g.addEventListener("timeupdate",G),window.addEventListener("keydown",B)},this.getVersion=function(){return z(),b.getVersion()},this.getVersionFull=function(){return z(),b.getVersionFull()},this.getBuildDate=function(){return z(),b.getBuildDate()},this.loadMetricsAgent=function(a){if(z(),"undefined"==typeof f)throw new Error("OrangeHasPlayer.loadMetricsAgent(): MetricsAgent is undefined");u.ref=new f(b,g,a,b.getDebug()),u.deferInit=o.defer(),u.ref.init(function(a){c.log("Metrics agent state: ",a),u.isActivated=a,u.deferInit.resolve()})},this.load=function(a,c){var d=this,e={video:{"ABR.keepBandwidthCondition":!0},audio:{"ABR.keepBandwidthCondition":!0}};j=[],k=[],l=[],m=[],z(),d.reset(0),w.video>=0&&(b.setQualityFor("video",w.video),e.video["ABR.keepBandwidthCondition"]=!1,w.video=-1),w.audio>=0&&(b.setQualityFor("audio",w.audio),e.audio["ABR.keepBandwidthCondition"]=!1,w.audio=-1),o.when(u.ref?u.deferInit.promise:!0).then(function(){u.ref&&u.isActivated&&a&&u.ref.createSession(),b.setConfig(e),b.setDefaultAudioLang(q),b.setDefaultSubtitleLang(r),b.attachSource(a,c),b.getAutoPlay()&&(y="PLAYER_RUNNING")})},this.refreshManifest=function(a){z(),b.refreshManifest(a)},this.play=function(){z(),g.play(),y="PLAYER_RUNNING"},this.seek=function(a){var c=null;if(z(),"number"!=typeof a)throw new Error("OrangeHasPlayer.seek(): Invalid Arguments");if(this.isLive()){if(c=b.getDVRWindowRange(),null===c)throw new Error("OrangeHasPlayer.seek(): impossible for live stream");if(a<c.start||a>c.end)throw new Error("OrangeHasPlayer.seek(): seek value outside available time range");g.currentTime=a}else{if(0>a||a>g.duration)throw new Error("OrangeHasPlayer.seek(): seek value outside available time range");g.currentTime=a}},this.setTrickModeSpeed=function(a){z(),b.setTrickModeSpeed(a)},this.getTrickModeSpeed=function(){return b.getTrickModeSpeed()},this.pause=function(){if(z(),this.isLive())throw new Error("OrangeHasPlayer.pause(): pause is impossible on live stream");y="PLAYER_PAUSED",g.pause()},this.stop=function(){z(),y="PLAYER_STOPPED",g.pause(),this.isLive()||(g.currentTime=0),u.ref&&u.ref.stop()},this.reset=function(a){z(),b.setQualityFor("video",0),b.setQualityFor("audio",0),b.reset(a),u.ref&&u.ref.stop()},this.getPosition=function(){return z(),this.isLive()?void 0:g.currentTime},this.isLive=function(){return z(),g.duration!==Number.POSITIVE_INFINITY?!1:!0},this.getDuration=function(){return z(),g.duration},this.getVideoBitrates=function(){return z(),n},this.addEventListener=function(a,c,d){switch(a){case"error":case"warning":case"cueEnter":case"cueExit":case"manifestUrlUpdate":b.addEventListener(a,c,d);break;case"manifest_loaded":case"play_bitrate":case"download_bitrate":case"bufferLevel_updated":case"state_changed":g.addEventListener(a,c,d);break;default:g.addEventListener(a,c,d)}},this.removeEventListener=function(a,c){switch(a){case"error":case"warning":case"cueEnter":case"cueExit":case"manifestUrlUpdate":b.removeEventListener(a,c);break;case"play_bitrate":case"download_bitrate":case"bufferLevel_updated":case"state_changed":g.removeEventListener(a,c);break;default:g.removeEventListener(a,c)}},this.setDefaultAudioLang=function(a){if("string"!=typeof a)throw new Error("OrangeHasPlayer.setDefaultAudioLang(): Invalid Arguments");q=a},this.getAudioTracks=function(){var a,c=0;if(z(),0===j.length&&(a=b.getAudioTracks()))for(c=0;c<a.length;c+=1)j.push({id:a[c].id,lang:a[c].lang});return j},this.setAudioTrack=function(a){var d,e=0;if(z(),!a||!a.id&&!a.lang)throw new Error("OrangeHasPlayer.setAudioTrack(): audioTrack parameter is unknown");if(s&&(a.id===s.id||a.lang===s.lang))return void c.log("[OrangeHasPlayer] "+a.lang+" is already selected");if(d=b.getAudioTracks())for(e=0;e<d.length;e+=1)if(a.id===d[e].id||a.lang===d[e].lang)return b.setAudioTrack(d[e]),void(s=d[e])},this.getSelectedAudioTrack=function(){var a,c=0;if(z(),a=b.getSelectedAudioTrack())for(c=0;c<j.length;c+=1)if(j[c].id===a.id||j[c].lang===a.lang)return s=j[c];return null},this.setDefaultSubtitleLang=function(a){if("string"!=typeof a)throw new Error("OrangeHasPlayer.setDefaultSubtitleLang(): Invalid Arguments");r=a},this.getSubtitleTracks=function(){var a,c=0;if(z(),0===k.length&&(a=b.getSubtitleTracks()))for(c=0;c<a.length;c+=1)k.push({id:a[c].id,lang:a[c].lang});return k},this.setSubtitleTrack=function(a){var d,e=0;if(!a||!a.id&&!a.lang)throw new Error("OrangeHasPlayer.setSubtitleTrack(): subtitleTrack parameter is unknown");if(t&&(a.id===t.id||a.lang===t.lang))return void c.log("[OrangeHasPlayer] "+a.lang+" is already selected");if(z(),d=b.getSubtitleTracks())for(e=0;e<d.length;e+=1)if(a.id===d[e].id||a.lang===d[e].lang)return b.setSubtitleTrack(d[e]),void(t=d[e]);throw new Error("OrangeHasPlayer.setSubtitleTrack():"+a.lang+"is unknown")},this.getSelectedSubtitleTrack=function(){var a,c=0;if(z(),a=b.getSelectedSubtitleTrack())for(c=0;c<k.length;c+=1)if(k[c].id===a.id||k[c].lang===a.lang)return t=k[c];return null},this.getMute=function(){return z(),g.muted},this.setMute=function(a){if(z(),"boolean"!=typeof a)throw new Error("OrangeHasPlayer.setMute(): Invalid Arguments");g.muted=a},this.getVolume=function(){return z(),g.volume},this.setVolume=function(a){if(z(),"number"!=typeof a||0>a||a>1)throw new Error("OrangeHasPlayer.setVolume(): Invalid Arguments");g.volume=a},this.setSubtitleVisibility=function(a){if(z(),"boolean"!=typeof a)throw new Error("OrangeHasPlayer.setSubtitleVisibility(): Invalid Arguments");i=a,b.enableSubtitles(a),0!==g.textTracks.length&&(g.textTracks[0].mode=a===!0?"showing":"hidden")},this.getSubtitleVisibility=function(){return z(),i},this.enableSubtitleExternDisplay=function(a){this.setParams({"TextTrackExtensions.displayModeExtern":a})},this.getDVRWindowSize=function(){return z(),b.getDVRWindowSize()},this.getDVRWindowRange=function(){return z(),b.getDVRWindowRange()},this.setInitialQualityFor=function(a,b){w[a]=b},this.setParams=function(a){z(),b.setConfig(a)},this.setDebug=function(a){if(z(),"boolean"!=typeof a)throw new Error("OrangeHasPlayer.setDebug(): Invalid Arguments");a===!0?(x.level=4,b.getDebug().setLevel(4)):(x.level=0,b.getDebug().setLevel(0))},this.fullscreenChanged=function(a){h=!h},this.getTerminalId=function(){var a=d(),b=e();return b.name+"-"+b.bits+"-"+a.name}},w.hasMediaSourceExtension=function(){return(new v.utils.Capabilities).supportsMediaSource()},w.hasMediaKeysExtension=function(){return(new v.utils.Capabilities).supportsMediaKeys()},v=function(a){"use strict";var b,c,d,e,f,g="1.2.0",h="1.2.7_dev",i="1f8b2c1",j="10.3.2016_11:13:27",k=a,l=null,m=!1,n=!1,o=!1,p=!0,r=!1,s=v.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED,t="und",u="und",w=!1,x=function(){return!!c&&!!d&&!n},y=function(){if(!m)throw new Error("MediaPlayer.play(): MediaPlayer not initialized");if(!c)throw new Error("MediaPlayer.play(): Video element not attached to MediaPlayer");if(!d)throw new Error("MediaPlayer.play(): Source not attached to MediaPlayer");return this.capabilities.supportsMediaSource()?(o=!0,e||(e=b.getObject("streamController"),e.setVideoModel(f),e.setAutoPlay(p)),e.setDefaultAudioLang(t),e.setDefaultSubtitleLang(u),e.enableSubtitles(w),e.load(d,l),b.mapValue("scheduleWhilePaused",r),b.mapOutlet("scheduleWhilePaused","stream"),b.mapValue("bufferMax",s),void b.injectInto(this.bufferExt,"bufferMax")):void this.errHandler.sendError(v.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE,"MediaSource extension not supported by the browser")},z=function(){x()&&y.call(this)},A=function(){if(o&&e){if(!n){n=!0;var a={},b=this;a[v.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE]=function(){e=null,o=!1,n=!1,b.debug.log("[MediaPlayer] Player is stopped"),x.call(b)&&z.call(b)},e.subscribe(v.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE,a,void 0,!0),e.reset()}}else x.call(this)&&z.call(this)},B=function(){var a=this.metricsModel.getReadOnlyMetricsFor("video")||this.metricsModel.getReadOnlyMetricsFor("audio");return this.metricsExt.getCurrentDVRInfo(a)},C=function(){return B.call(this).mpd.timeShiftBufferDepth},D=function(a){var b=B.call(this),c=b.range.start+parseInt(a,10);return c>b.range.end&&(c=b.range.end),c},E=function(){var a=this.metricsModel.getReadOnlyMetricsFor("video"),b=a?this.metricsExt.getCurrentDVRInfo(a):null,c=b?b.range:null;return c},F=function(a){e.seek(a)},G=function(){var a=B.call(this);return null===a?0:Math.round(this.duration()-(a.range.end-a.time))},H=function(){var a,b=B.call(this);return null===b?0:(a=b.range.end-b.range.start,Math.round(a<b.mpd.timeShiftBufferDepth?a:b.mpd.timeShiftBufferDepth))},I=function(){var a,b,c=B.call(this);return null===c?0:(a=c.mpd.availabilityStartTime.getTime()/1e3,b=this.time()+(a+c.range.start),
Math.round(b))},J=function(){var a,b,c=B.call(this);return null===c?0:(a=c.mpd.availabilityStartTime.getTime()/1e3,b=a+c.range.start+this.duration(),Math.round(b))},K=function(a,b,c){var d=new Date(1e3*a),e=d.toLocaleDateString(b),f=d.toLocaleTimeString(b,{hour12:c});return f+" "+e},L=function(a){a=Math.max(a,0);var b=Math.floor(a/3600),c=Math.floor(a%3600/60),d=Math.floor(a%3600%60);return(0===b?"":10>b?"0"+b.toString()+":":b.toString()+":")+(10>c?"0"+c.toString():c.toString())+":"+(10>d?"0"+d.toString():d.toString())};return b=new q.System,b.mapValue("system",b),b.mapOutlet("system"),b.injectInto(k),{notifier:void 0,debug:void 0,eventBus:void 0,capabilities:void 0,abrController:void 0,metricsModel:void 0,metricsExt:void 0,bufferExt:void 0,errHandler:void 0,tokenAuthentication:void 0,uriQueryFragModel:void 0,config:void 0,addEventListener:function(a,b,c){if(!m)throw"MediaPlayer not initialized!";this.eventBus.addEventListener(a,b,c)},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)},getVersion:function(){return h},getVersionFull:function(){return-1===i.indexOf("@@")?h+"_"+i:h},getVersionDashJS:function(){return g},getBuildDate:function(){return-1===j.indexOf("@@")?j:"Not a builded version"},startup:function(){m||(b.injectInto(this),m=!0,this.debug.log("[MediaPlayer] Version: "+this.getVersionFull()+" - "+this.getBuildDate()),this.debug.log("[MediaPlayer] user-agent: "+navigator.userAgent))},getDebug:function(){return this.debug},getVideoModel:function(){return f},setAutoPlay:function(a){p=a},getAutoPlay:function(){return p},setScheduleWhilePaused:function(a){r=a},getScheduleWhilePaused:function(){return r},setTokenAuthentication:function(a,b){this.tokenAuthentication.setTokenAuthentication({name:a,type:b})},setBufferMax:function(a){s=a},getBufferMax:function(){return s},getMetricsExt:function(){return this.metricsExt},getMetricsFor:function(a){var b=this.metricsModel.getReadOnlyMetricsFor(a);return b},getQualityFor:function(a){return this.abrController.getQualityFor(a)},setQualityFor:function(a,b){this.abrController.setPlaybackQuality(a,b)},getAutoSwitchQuality:function(){return this.abrController.getAutoSwitchBitrate()},setAutoSwitchQuality:function(a){this.abrController.setAutoSwitchBitrate(a)},setConfig:function(a){this.config&&a&&(this.debug.log("[MediaPlayer] set config: "+JSON.stringify(a,null,"	")),this.config.setParams(a))},setAudioTrack:function(a){e.setAudioTrack(a)},getSelectedAudioTrack:function(){return e?e.getSelectedAudioTrack():null},getSelectedSubtitleTrack:function(){return e?e.getSelectedSubtitleTrack():null},getAudioTracks:function(){return e?e.getAudioTracks():null},setSubtitleTrack:function(a){return e?void e.setSubtitleTrack(a):null},enableSubtitles:function(a){w=a,e&&e.enableSubtitles(a)},getSubtitleTracks:function(){return e?e.getSubtitleTracks():null},attachView:function(a){if(!m)throw new Error("MediaPlayer.attachView(): MediaPlayer not initialized");c=a,f=null,c&&(f=b.getObject("videoModel"),f.setElement(c)),o&&e&&(e.reset(),o=!1)},attachSource:function(a,b){var c,e=this.getVideoModel();if(!m)throw new Error("MediaPlayer.play(): MediaPlayer not initialized");if(!e)throw new Error("MediaPlayer.play(): Video element not attached to MediaPlayer");c=e.getElement().loop,a&&this.metricsModel.addSession(null,a,c,null,"HasPlayer.js_"+this.getVersion()),this.uriQueryFragModel.reset(),d=a?this.uriQueryFragModel.parseURI(a):null,l=b,A.call(this)},refreshManifest:function(a){e&&e.refreshManifest(a)},reset:function(a){this.metricsModel.addState("video","stopped",this.getVideoModel().getCurrentTime(),a),this.attachSource(null),l=null},setDefaultAudioLang:function(a){t=a},setDefaultSubtitleLang:function(a){u=a},setTrickModeSpeed:function(a){e&&(e.getTrickModeSpeed()!==a&&1===a?f.play():e.setTrickModeSpeed(a))},getTrickModeSpeed:function(){return e?e.getTrickModeSpeed():0},play:y,isReady:x,seek:F,time:G,duration:H,timeAsUTC:I,durationAsUTC:J,getDVRWindowSize:C,getDVRSeekOffset:D,getDVRWindowRange:E,formatUTC:K,convertToTimeCode:L}},v.prototype={constructor:v},v.dependencies={},v.dependencies.protection={},v.dependencies.protection.servers={},v.utils={},v.models={},v.modules={},v.vo={},v.vo.metrics={},v.vo.protection={},v.rules={},v.rules.o={},v.di={},v.dependencies.AbrController=function(){"use strict";var a=!0,b={},c={},d="",e=function(a){var c;return b.hasOwnProperty(a)||(b[a]=0),c=b[a]},f=function(a,c){b[a]=c},g=function(a){var b;return c.hasOwnProperty(a)||(c[a]=0),b=c[a]},h=function(a,b){c[a]=b};return{debug:void 0,abrRulesCollection:void 0,manifestExt:void 0,metricsModel:void 0,metricsExt:void 0,config:void 0,getAutoSwitchBitrate:function(){return a},setAutoSwitchBitrate:function(b){a=b},getMetricsFor:function(a){var b=o.defer(),c=this;return c.manifestExt.getIsVideo(a).then(function(d){d?b.resolve(c.metricsModel.getMetricsFor("video")):c.manifestExt.getIsAudio(a).then(function(a){a?b.resolve(c.metricsModel.getMetricsFor("audio")):b.resolve(c.metricsModel.getMetricsFor("stream"))})}),b.promise},_getPlaybackQuality:function(b,c){var i,j,k,l,m,n,p=this,q=o.defer(),r=v.rules.SwitchRequest.prototype.NO_CHANGE,s=v.rules.SwitchRequest.prototype.NO_CHANGE,t=[];return m=e(b),n=g(b),a?(p.debug.log("[AbrController]["+b+"] Check rules...."),p.getMetricsFor(c).then(function(a){p.abrRulesCollection.getRules(v.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES).then(function(e){for(i=0,j=e.length;j>i;i+=1)t.push(e[i].checkIndex(m,a,c,d));o.all(t).then(function(a){for(l={},l[v.rules.SwitchRequest.prototype.STRONG]=v.rules.SwitchRequest.prototype.NO_CHANGE,l[v.rules.SwitchRequest.prototype.WEAK]=v.rules.SwitchRequest.prototype.NO_CHANGE,l[v.rules.SwitchRequest.prototype.DEFAULT]=v.rules.SwitchRequest.prototype.NO_CHANGE,i=0,j=a.length;j>i;i+=1)k=a[i],p.debug.log("[AbrController]["+b+"] Request for quality "+k.quality+", priority = "+k.priority),k.quality!==v.rules.SwitchRequest.prototype.NO_CHANGE&&(l[k.priority]=Math.min(l[k.priority],k.quality));l[v.rules.SwitchRequest.prototype.WEAK]!==v.rules.SwitchRequest.prototype.NO_CHANGE&&(s=v.rules.SwitchRequest.prototype.WEAK,r=l[v.rules.SwitchRequest.prototype.WEAK]),l[v.rules.SwitchRequest.prototype.DEFAULT]!==v.rules.SwitchRequest.prototype.NO_CHANGE&&(s=v.rules.SwitchRequest.prototype.DEFAULT,r=l[v.rules.SwitchRequest.prototype.DEFAULT]),l[v.rules.SwitchRequest.prototype.STRONG]!==v.rules.SwitchRequest.prototype.NO_CHANGE&&(s=v.rules.SwitchRequest.prototype.STRONG,r=l[v.rules.SwitchRequest.prototype.STRONG]),r!==v.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==r&&(m=r),s!==v.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==s&&(n=s),p.manifestExt.getRepresentationCount(c).then(function(a){0>m&&(m=0),m>=a&&(m=a-1),n!==v.rules.SwitchRequest.prototype.STRONG&&n!==v.rules.SwitchRequest.prototype.WEAK&&(n=v.rules.SwitchRequest.prototype.DEFAULT),p.debug.info("[AbrController]["+b+"] Set quality: "+m),f(b,m),h(b,n),q.resolve({quality:m,confidence:n})})})})})):q.resolve({quality:m,confidence:n}),q.promise},getPlaybackQuality:function(a,b){var c,d=this,e=o.defer(),f=d.getQualityFor(a),g=-1,h=-1,i=d.config.getParamFor(a,"ABR.switchUpIncrementally","boolean",!1);return d._getPlaybackQuality(a,b).then(function(j){if(c=j.quality,d.getAutoSwitchBitrate()){i&&c>f&&(d.debug.log("[AbrController]["+a+"] Incremental switch => quality: "+c),c=f+1);var k=d.metricsExt.getQualityBoundaries(a,b);g=k.min,h=k.max,g>c&&(c=g,d.debug.log("[AbrController]["+a+"] New quality < min => "+c)),c>h&&(c=h,d.debug.log("[AbrController]["+a+"] New quality > max => "+c)),d.setPlaybackQuality.call(d,a,c),e.resolve({quality:c,confidence:j.confidence})}else e.resolve({quality:c,confidence:j.confidence})}),e.promise},setPlaybackQuality:function(a,b){var c=e(a);this.debug.log("[AbrController]["+a+"] Set playback quality: "+b),b!==c&&f(a,b)},getQualityFor:function(a){return e(a)},setPlayerState:function(a){d=a}}},v.dependencies.AbrController.prototype={constructor:v.dependencies.AbrController},v.dependencies.AbrController.BANDWIDTH_SAFETY=.9,v.dependencies.BufferController=function(){"use strict";var a,b,c,d,e,f,g,h,i,j="READY",k=j,l=!1,m=!1,n=!1,p=!0,q=[],r=!1,s=-1,t=!0,w=!1,x=-1,y=-1,z=!1,A=!1,B=!1,C=null,D=null,E=null,F=0,G=null,H=0,I=!1,J=null,K=0,L=!1,M=null,N=null,O=!1,P=null,Q=null,R=!0,S=!1,T=-1,U=0,V=1,W=T,X=-1,Y=null,Z=!1,$=!1,_=3,aa=!1,ba=0,ca=-1,da=null,ea=-1,fa=NaN,ga=function(){xa.call(this)&&null!==G&&this.fragmentController.onBufferControllerStateChange()},ha=function(a,b){var c=0,d=null;R===!1&&(d=Q.start,c=a.getTime()-d.getTime(),Q.duration=c,Q.stopreason=b,R=!0)},ia=function(a){var b=this;"text"!==d&&(b.debug.info("[BufferController]["+d+"] stalled = "+a),z=a,b.videoModel.stallStream(d,z),z&&b.abrController.setPlayerState("buffering"))},ja=function(){l&&m&&(this.debug.info("[BufferController]["+d+"] startPlayback"),ia.call(this,!0),La.call(this))},ka=function(){var a,b=this;m!==!0&&(r===!1&&(a=new Date,ha(a,v.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),P=this.metricsModel.addPlayList(d,a,0,v.vo.metrics.PlayList.INITIAL_PLAY_START_REASON)),B&&(B=!1),m=!0,b.debug.info("[BufferController]["+d+"] START"),n=!0,W=T,X=-1,ja.call(b))},la=function(a){var c=this,e=new Date;(r!==!0||s!==a)&&(this.debug.info("[BufferController]["+d+"] SEEK: "+a),m===!0&&na.call(c),this.fragmentController.clearExecutedRequests(G),P=this.metricsModel.addPlayList(d,e,s,v.vo.metrics.PlayList.SEEK_START_REASON),r=!0,s=a,o.when(Y?Y.promise:!0).then(function(){b.segments=null,ka.call(c)}))},ma=function(){this.debug.info("[BufferController]["+d+"] SEEKED"),r=!1,s=-1},na=function(){m&&(this.debug.info("[BufferController]["+d+"] STOP"),clearTimeout(g),clearTimeout(h),m=!1,n=!1,r=!1,s=-1,clearTimeout(da),da=null,ha(new Date,v.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),this.fragmentController.abortRequestsForModel(G))},oa=function(b){return a[b]},pa=function(a){this.debug.info("[BufferController]["+d+"] Load request ",null!==a.url?a.url:a.quality)},qa=function(a,b){void 0!==a.sequenceNumber&&(ea=a.sequenceNumber),this.fragmentController.isInitializationRequest(a)?ra.call(this,a,b):sa.call(this,a,b)},ra=function(a,b){var c=this,e=b.data,f=a.quality;c.debug.log("[BufferController]["+d+"] Initialization loaded ",f),c.fragmentController.process(e).then(function(b){null!==b?(q[f]=b,c.debug.info("[BufferController]["+d+"] Buffer initialization segment ",null!==a.url?a.url:a.quality),o.when(w?Aa.call(c):!0).then(function(){w=!1,ta.call(c,b,a.quality).then(function(){c.debug.log("[BufferController]["+d+"] Initialization segment buffered"),xa()&&Ea.call(c)})})):(c.debug.log("No "+d+" bytes to push."),Ea.call(c))},function(a){ya.call(c),c.errHandler.sendError(v.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",a.message)})},sa=function(c,e){var f=this,g=this.manifestExt.getEventStreamForAdaptationSet(f.getData()),h=this.manifestExt.getEventStreamForRepresentation(f.getData(),b),i=null;fa=c.duration,xa()&&(aa=!1,ba=0,f.debug.log("[BufferController]["+d+"] Media loaded ",c.url),f.chunkAborted===!0&&(f.chunkAborted=!1),1===f.chunkMissingCount&&(f.chunkMissingCount=0),K||isNaN(c.duration)||(K=c.duration),f.fragmentController.process(e.data,c,a).then(function(a){null!==a?((g.length>0||h.length>0)&&va.call(f,a,c,g,h).then(function(a){f.eventController.addInbandEvents(a)}),f.debug.info("[BufferController]["+d+"] Buffer segment from url ",c.url),wa.call(f,a).then(function(a){ta.call(f,a,c.quality,c.index).then(function(){Z&&(Z=!1,f.fragmentController.hasOwnProperty("getStartTime")&&(i=f.fragmentController.getStartTime()),i?f.metricsModel.addBufferedSwitch(d,i,b.id,c.quality):f.metricsModel.addBufferedSwitch(d,c.startTime,b.id,c.quality)),b.segments=null,f.debug.log("[BufferController]["+d+"] Media segment buffered"),ya.call(f),La.call(f)})})):(f.debug.log("[BufferController]["+d+"] Error with segment data, no bytes to push"),ya.call(f),La.call(f))}))},ta=function(a,c,e){var f=this,g=o.defer(),h=f.videoModel.getCurrentTime(),i=new Date;return R===!0&&(R=!1,Q=f.metricsModel.appendPlayListTrace(P,b.id,null,i,h,null,1,null)),Ga()?(za.call(f).then(function(){o.when(D?D.promise:!0).then(function(){Ga()&&(f.debug.log("[BufferController]["+d+"] Buffering segment"),f.sourceBufferExt.append(N,a,$).then(function(){f.debug.log("[BufferController]["+d+"] Segment buffered"),x!=c&&(Z=!0,f.debug.log("[BufferController]["+d+"] set currentBufferedQuality to "+c),x=c),I=!1,A&&H>1?Aa.call(f,-1,Ia.call(f)-30).then(function(){ua.call(f),g.resolve()}):(ua.call(f),g.resolve()),f.system.notify("bufferUpdated")},function(b){f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER,"Failed to append data into "+d+" source buffer",new v.vo.Error(b.err.code,b.err.name,b.err.message)),b.err.code===v.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED&&(J={data:a,quality:c,index:e},C=g,I=!0,F=0,na.call(f))}))})}),g.promise):void 0},ua=function(){var a,b,c=null;if(this.debug.getLevel()>=this.debug.INFO&&N){if(c=this.sourceBufferExt.getAllRanges(N),null===c||0===c.length)return;for(a=0,b=c.length;b>a;a+=1)this.debug.info("[BufferController]["+d+"] Buffered range ["+a+"]: "+c.start(a)+" - "+c.end(a)+" ("+this.getVideoModel().getCurrentTime()+")")}},va=function(a,b,c,d){var e,f,g,h=[],i=0,j=Math.pow(256,2),k=Math.pow(256,3),l=Math.max(isNaN(b.startTime)?0:b.startTime,0),m=[];S=!1,g=c.concat(d);for(var n=0;n<g.length;n++)m[g[n].schemeIdUri]=g[n];for(;i<a.length&&(e=String.fromCharCode(a[i+4],a[i+5],a[i+6],a[i+7]),f=a[i]*k+a[i+1]*j+256*a[i+2]+1*a[i+3],"moov"!==e&&"moof"!==e);){if("emsg"===e){S=!0;for(var p=["","",0,0,0,0,""],q=0,r=i+12;f+i>r;)0===q||1===q||6===q?(0!==a[r]?p[q]+=String.fromCharCode(a[r]):q+=1,r+=1):(p[q]=a[r]*k+a[r+1]*j+256*a[r+2]+1*a[r+3],r+=4,q+=1);var s=p[0],t=p[1],v=p[2],w=p[3],x=p[4],y=p[5],z=p[6],A=l*v+w;if(m[s]){var B=new u.vo.Event;B.eventStream=m[s],B.eventStream.value=t,B.eventStream.timescale=v,B.duration=x,B.id=y,B.presentationTime=A,B.messageData=z,B.presentationTimeDelta=w,h.push(B)}}i+=f}return o.when(h)},wa=function(a){if(!S)return o.when(a);for(var b,c,d=a.length,e=0,f=0,g=0,h=Math.pow(256,2),i=Math.pow(256,3),j=new Uint8Array(a.length);d>e;){if(b=String.fromCharCode(a[e+4],a[e+5],a[e+6],a[e+7]),c=a[e]*i+a[e+1]*h+256*a[e+2]+1*a[e+3],"emsg"!==b)for(g=e;e+c>g;g++)j[f]=a[g],f+=1;e+=c}return o.when(j.subarray(0,f))},xa=function(){var a=this;return m?!0:(ya.call(a),!1)},ya=function(){Y&&(Y.resolve(),Y=null)},za=function(){var a,b=this,c=o.defer(),d=0;return I?(a=function(){var b,e,f=this,g=f.videoModel.getCurrentTime(),h=0;e=f.fragmentController.getExecutedRequestForTime(G,g),b=e&&!isNaN(e.startTime)?e.startTime:Math.floor(g),K=e&&!isNaN(e.duration)?e.duration:1,Aa.call(f,h,b).then(function(b){d+=b,d>=K?c.resolve():setTimeout(a,1e3*K)})},a.call(b),c.promise):o.when(!0)},Aa=function(a,b){var e,f,g=this,h=o.defer();return 0===N.buffered.length?(h.resolve(0),h.promise):(e=void 0!==a&&-1!==a?a:N.buffered.start(0),f=void 0!==b&&-1!==b?b:N.buffered.end(N.buffered.length-1),e>=f?(h.resolve(0),h.promise):(g.debug.info("[BufferController]["+d+"] Remove from "+e+" to "+f+" ("+g.getVideoModel().getCurrentTime()+")"),"text"!==d&&g.sourceBufferExt.abort(c,N),g.sourceBufferExt.remove(N,e,f,E.duration,c,$).then(function(){g.fragmentController.removeExecutedRequestsBeforeTime(G,f+1),g.fragmentController.cancelPendingRequestsForModel(G),h.resolve(f-e)},function(a){g.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER,"Failed to remove data from "+d+" source buffer",new v.vo.Error(a.code,a.name,a.message)),h.resolve(0)}),h.promise))},Ba=function(a){if(xa.call(this)){if(ya.call(this),a.aborted)return void Oa.call(this);if("text"===d)return void this.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status});ba+=1,ba===_?this.errHandler.sendError(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status}):(this.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status}),ca=a.startTime+1.5*a.duration,W===U?Ta.call(this,1.5*a.duration):aa=!0)}},Ca=function(){var a=this;a.debug.log("[BufferController]["+d+"] Stream is complete."),B=!0,ha(new Date,v.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON),ya.call(a),na.call(a),a.system.notify("bufferingCompleted")},Da=function(b){var c=this;return q[b]?(c.debug.info("[BufferController]["+d+"] Buffer initialization segment, quality = ",b),ta.call(this,q[b],b).then(function(){c.debug.log("[BufferController]["+d+"] Initialization segment buffered"),xa()&&Ea.call(c)}),o.when(null)):this.indexHandler.getInitRequest(a[b])},Ea=function(){var a,c,e=this,f=Ia.call(e);xa.call(e)&&(a=e.sourceBufferExt.getBufferRange(N,f),c=a?a.end:f,-1===ea||r?(e.debug.log("[BufferController]["+d+"] loadNextFragment for time: "+c),e.indexHandler.getSegmentRequestForTime(b,c).then(Fa.bind(e))):(e.debug.log("[BufferController]["+d+"] loadNextFragment for sequence number: "+ea),e.indexHandler.getNextSegmentRequestFromSN(b,ea).then(Fa.bind(e))))},Fa=function(a){var c=this,e=c.manifestModel.getValue();return null!==a&&a.action===a.ACTION_COMPLETE?void Ca.call(c):void(null!==a?c.fragmentController.isFragmentLoadedOrPending(c,a)?(c.debug.log("[BufferController]["+d+"] new fragment request => already loaded or pending"),c.indexHandler.getNextSegmentRequest(b).then(Fa.bind(c))):(O&&(a=c.indexHandler.getIFrameRequest(a)),c.fragmentController.prepareFragmentForLoading(c,a,pa,qa,Ba,null).then(function(){ga.call(c)})):(c.debug.log("[BufferController]["+d+"] loadNextFragment failed"),ya.call(c),A?"M3U"===e.name&&Pa.call(c,y).then(function(){b=oa.call(c,y),Ma.call(c,0)},function(a){c.errHandler.sendError(a.name,a.message,a.data)}):Ca.call(c)))},Ga=function(){return!!M&&!!N},Ha=function(){var a=this.videoModel.getCurrentTime();return E.start+E.duration-a},Ia=function(){var a=-1,b=this.videoModel.getCurrentTime();return a=r?s:b},Ja=function(){var a,c=this,f=o.defer(),g=b.segmentAvailabilityRange.end;return c.debug.log("[BufferController]["+d+"] Manifest live edge = "+g),a=Math.max(g-e,b.segmentAvailabilityRange.start),this.indexHandler.getSegmentRequestForTime(b,a).then(function(a){E.liveEdge=a.startTime,c.debug.log("[BufferController]["+d+"] Live edge = "+E.liveEdge),f.resolve(E.liveEdge)}),f.promise},Ka=function(a){if(Ga()){var b=this,c=Ia.call(b);H=b.sourceBufferExt.getBufferLength(N,c),b.debug.log("[BufferController]["+d+"] Working time = "+c+", Buffer level = "+H.toFixed(3)),a&&b.metricsModel.addBufferLevel(d,new Date,H),b.updateBufferState()}},La=function(){var a,b,c=this;xa.call(c)&&(c.debug.log("[BufferController]["+d+"] Check buffer..."),Ka.call(c,!1),z&&H>f&&ia.call(c,!1),a=Ha.call(c),c.debug.log("[BufferController]["+d+"] time to end = "+a),O?1>H&&Oa.call(c):w||e>H&&(a>e||e>=a&&!B)?Oa.call(c):(b=H-e,c.debug.log("[BufferController]["+d+"] Check buffer in "+b+" seconds"),Ma.call(c,b)))},Ma=function(a){var b=this,c=Math.max(1e3*a,2e3);b.debug.log("[BufferController]["+d+"] Check buffer delta = "+c+" ms"),clearTimeout(g),g=setTimeout(function(){g=null,La.call(b)},c)},Na=function(){g&&(clearTimeout(g),g=null,La.call(this))},Oa=function(){var c,e=this,f=new Date,g=e.videoModel.getCurrentTime(),h=e.manifestModel.getValue(),i=null;null!==Y&&e.debug.error("[BufferController]["+d+"] deferredFragmentBuffered has not been resolved, create a new one is not correct."),Y=o.defer(),e.debug.log("[BufferController]["+d+"] Start buffering process..."),Ra.call(e).then(function(j){var k=j;e.abrController.getPlaybackQuality(d,M).then(function(j){O||e.abrController.setAutoSwitchBitrate(!0),c=j.quality,b=oa.call(e,c),c!==y&&(e.debug.log("[BufferController]["+d+"] currentDownloadQuality changed : "+c),y=c,k=!0,b.segments=null,ha(new Date,v.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON),e.debug.log("[BufferController]["+d+"] Send RepresentationSwitch with quality = "+c),e.metricsModel.addRepresentationSwitch(d,f,g,b.id,c),"M3U"!==h.name||!A&&null!==a[c].initialization||(i=o.defer(),Pa.call(e,c).then(function(){b=oa.call(e,c),i.resolve()},function(a){i.reject(a)}))),o.when(i?i.promise:!0).then(function(){k===!0?Da.call(e,c).then(function(a){null!==a&&e.fragmentController.prepareFragmentForLoading(e,a,pa,qa,Ba,null).then(function(){ga.call(e)})},function(a){ya.call(e),a.name===v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED?e.errHandler.sendError(a.name,a.message,a.data):e.errHandler.sendError(v.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing initialization segment",a.message)}):Ea.call(e)},function(a){ya(),e.errHandler.sendError(a.name,a.message,a.data)})})})},Pa=function(b){var c,d=this,e=o.defer(),f=d.manifestModel.getValue();return d.manifestExt.getDataIndex(M,f,E.index).then(function(g){c=f.Period_asArray[E.index].AdaptationSet_asArray[g].Representation_asArray[b],d.parser.hlsParser.updatePlaylist(c).then(function(){Qa.call(d,M,E).then(function(b){a=b,e.resolve()})},function(a){e.reject(a)})}),e.promise},Qa=function(a,b){var c=this,d=o.defer(),e=c.manifestModel.getValue();return c.manifestExt.getDataIndex(a,e,b.index).then(function(a){c.manifestExt.getAdaptationsForPeriod(e,b).then(function(b){c.manifestExt.getRepresentationsForAdaptation(e,b[a]).then(function(a){d.resolve(a)})})}),d.promise},Ra=function(){var b=this,c=o.defer();return t===!1?(c.resolve(!1),c.promise):(b.debug.log("[BufferController]["+d+"] updateData"),q=[],Qa.call(b,M,E).then(function(e){a=e,b.bufferExt.updateData(M,d),t=!1,c.resolve(!0)}),c.promise)},Sa=function(a){var b,c=this,d=0,e=0,f=a.data.request.streamType,g=a.data.httpRequestMetrics,h=a.data.lastTraceTime;c.abrRulesCollection.getRules(v.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES).then(function(i){var j=function(d){var e=d.quality,i=c.abrController.getQualityFor(f);i>e&&(c.debug.info("[BufferController]["+f+"] Abandon current fragment : "+a.data.request.url),b=new Date,g.tfinish=b,g.bytesLength=a.data.request.bytesLoaded,c.metricsModel.appendHttpTrace(g,b,b.getTime()-h.getTime(),[a.data.request.bytesLoaded?a.data.request.bytesLoaded:0]),c.fragmentController.abortRequestsForModel(G),c.debug.info("[BufferController]["+f+"] Segment download abandonned => Retry segment download at lowest quality"),c.abrController.setAutoSwitchBitrate(!1),c.abrController.setPlaybackQuality(f,e))};for(d=0,e=i.length;e>d;d+=1)i[d].execute(a.data.request,j)})},Ta=function(a){var b=this;null===da&&(this.debug.info("[BufferController]["+d+"] Reload session in "+a+" s."),da=setTimeout(function(){da=null,b.debug.info("[BufferController]["+d+"] Reload session"),b.system.notify("needForReload")},1e3*a))};return{videoModel:void 0,metricsModel:void 0,manifestExt:void 0,manifestModel:void 0,bufferExt:void 0,sourceBufferExt:void 0,abrController:void 0,parser:void 0,fragmentExt:void 0,indexHandler:void 0,debug:void 0,system:void 0,errHandler:void 0,config:void 0,abrRulesCollection:void 0,initialize:function(a,b,c,d,g,h,i){var j=this,k=j.manifestModel.getValue();j.debug.log("[BufferController]["+a+"] Initialize"),-1!==navigator.userAgent.indexOf("Espial")&&(j.debug.log("[BufferController]["+a+"] Espial browser = sync append"),$=!0),j[v.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS]=Sa,A=j.manifestExt.getIsDynamic(k),j.setMediaSource(h),j.setType(a),j.setBuffer(d),j.setFragmentController(g),j.setEventController(i),e=j.config.getParamFor(a,"BufferController.minBufferTime","number",-1),f=j.config.getParamFor(a,"BufferController.minBufferTimeForPlaying","number",0),M=c,E=b,t=!0,j.load(),l=!0},load:function(){var a=this,c=a.manifestModel.getValue();Ra.call(this).then(function(){a.abrController.getPlaybackQuality(d,M).then(function(f){b=oa.call(a,f.quality),b&&(K=b.segmentDuration,a.indexHandler.setIsDynamic(A),-1===e&&(e=a.bufferExt.decideBufferLength(c.minBufferTime,E.duration,n)),"video"===d&&(A?a.indexHandler.updateSegmentList(b).then(function(){Ja.call(a).then(function(b){a.system.notify("startTimeFound",b)})}):a.indexHandler.getCurrentTime(b).then(function(c){c<b.segmentAvailabilityRange.start&&(c=b.segmentAvailabilityRange.start),a.system.notify("startTimeFound",c)})))})})},getType:function(){return d},setType:function(a){d=a,void 0!==this.indexHandler&&this.indexHandler.setType(a)},getPeriodInfo:function(){return E},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getFragmentController:function(){return this.fragmentController},setFragmentController:function(a){a&&(this.fragmentController=a,G=this.fragmentController.attachBufferController(this),G.fragmentLoader.subscribe(v.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,this))},setEventController:function(a){this.eventController=a},getData:function(){return M},updateData:function(a,b){var c=this;c.debug.log("[BufferController]["+d+"] Update data"),w=M&&(null!==M.lang?M.lang:M.id)!==(null!==a.lang?a.lang:a.id)?!0:!1,M=a,E=b,t=!0,w&&(c.debug.log("[BufferController]["+d+"] Language changed"),Na.call(this))},getCurrentRepresentation:function(){return b},getBuffer:function(){return N},setBuffer:function(a){N=a},getMinBufferTime:function(){return e},setMinBufferTime:function(a){e=a},setMediaSource:function(a){c=a},isReady:function(){return k===j},isBufferingCompleted:function(){return B},clearMetrics:function(){null!==d&&""!==d&&this.metricsModel.clearCurrentMetricsForType(d)},updateManifest:function(){this.system.notify("manifestUpdate")},updateBufferState:function(){var a,b=this,c=this.videoModel.getCurrentTime(),e=-1===X?c:X,f=c-e;if(clearTimeout(h),h=null,m!==!1&&!O){switch(W){case T:W=U,this.debug.log("[BufferController]["+d+"] BUFFERING - "+c+" - "+H),this.metricsModel.addState(d,"buffering",c);break;case U:if(!this.getVideoModel().isPaused()&&f>0&&H>=1)W=V,this.debug.log("[BufferController]["+d+"] PLAYING - "+c),this.metricsModel.addState(d,"playing",c);else if(!this.getVideoModel().isStalled()&&(a=this.sourceBufferExt.getAllRanges(N),a.length>0)){var g=Ia.call(this)-a.end(a.length-1);this.debug.log("[BufferController]["+d+"] BUFFERING - delay from current time = "+g),g>4&&(this.debug.log("[BufferController]["+d+"] BUFFERING => reload session"),Ta.call(this,1))}break;case V:if(!this.getVideoModel().isPaused()&&(0>=f&&1>=H||0===H)&&(W=U,this.debug.log("[BufferController]["+d+"] BUFFERING - "+c+" - "+H),this.metricsModel.addState(d,"buffering",c),A))if(aa)aa=!1,Ta.call(this,ca-c);else{a=this.sourceBufferExt.getAllRanges(N);var i;for(i=0;i<a.length&&!(c<a.start(i));i++);i<a.length&&this.videoModel.setCurrentTime(a.start(i))}h=setTimeout(function(){h=null,Ka.call(b,!1)},1e3)}c>0&&(X=c)}},updateStalledState:function(){z=this.videoModel.isStalled()},reset:function(a){var b=this,d=function(a){a&&(a.reject(),a=null)},e=o.defer();return na.call(b),b.sourceBufferExt.abort(c,N),o.when(Y?Y.promise:!0).then(function(){d(C),d(D),d(Y),G&&(G.fragmentLoader.unsubscribe(v.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,b.abrController),b.fragmentController.abortRequestsForModel(G),b.fragmentController.detachBufferController(G),G=null),b.clearMetrics(),q=[],p=!0,I=!1,J=null,L=!1,a||b.sourceBufferExt.removeSourceBuffer(c,N),M=null,N=null,e.resolve()},function(){e.reject()}),e.promise},getLastDownloadedSegmentDuration:function(){return fa},setTrickMode:function(a){var b=this,c=o.defer();return this.debug.log("[BufferController]["+d+"] setTrickMode - enabled = "+a),O===a?(c.resolve(),c.promise):(O=a,b.fragmentController.setSampleDuration(O),i=O?b.abrController.getQualityFor(d):i,b.abrController.setPlaybackQuality(d,O?0:i),O?(b.abrController.setAutoSwitchBitrate(!1),c.resolve()):Aa.call(this).then(function(){c.resolve()}),c.promise)},start:ka,seek:la,stop:na,seeked:ma,updateBufferLevel:Ka}},v.dependencies.BufferController.prototype={constructor:v.dependencies.BufferController},v.dependencies.BufferExtensions=function(){"use strict";var a,b,c=0,d=0,e=null,f=null,g=function(a){var b=this.metricsExt.getCurrentHttpRequest(a);return null!==b?(b.tresponse.getTime()-b.trequest.getTime())/1e3:0},h=function(){var a,b,g,h=this;return a=e?h.abrController.getQualityFor("audio"):c,b=f?h.abrController.getQualityFor("video"):d,g=a===c&&b===d};return{system:void 0,videoModel:void 0,metricsExt:void 0,metricsModel:void 0,abrController:void 0,bufferMax:void 0,updateData:function(a,b){if(a){var g=a.Representation_asArray.length-1;"audio"===b?(c=g,e=a):"video"===b&&(d=g,f=a)}},getTopQualityIndex:function(a){var b=null;return"audio"===a?b=c:"video"===a&&(b=d),b},decideBufferLength:function(b,c){return a=isNaN(c)||v.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME<c&&c>b?Math.max(v.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME,b):b>=c?Math.min(c,v.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME):Math.min(c,b)},getLeastBufferLevel:function(){var a=this.metricsModel.getReadOnlyMetricsFor("video"),b=this.metricsExt.getCurrentBufferLevel(a),c=this.metricsModel.getReadOnlyMetricsFor("audio"),d=this.metricsExt.getCurrentBufferLevel(c),e=null;return e=null===b||null===d?null!==d?d.level:null!==b?b.level:null:Math.min(d.level,b.level)},getRequiredBufferLength:function(c,d,e,f){var i,j=this,k=j.metricsModel.getReadOnlyMetricsFor("video"),l=j.metricsModel.getReadOnlyMetricsFor("audio"),m=f>=v.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD,n=o.defer(),p=!1;return j.bufferMax===v.dependencies.BufferExtensions.BUFFER_SIZE_MIN?(i=a,n.resolve(i)):j.bufferMax===v.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY?(i=f,n.resolve(i)):j.bufferMax===v.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED?(b=a,e||c||(p=h.call(j)),p&&(b=m?v.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM:v.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY),i=b+d+Math.max(g.call(j,k),g.call(j,l)),n.resolve(i)):n.reject("invalid bufferMax value: "+j.bufferMax),n.promise},getBufferTarget:function(){return void 0===b?a:b}}},v.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED="required",v.dependencies.BufferExtensions.BUFFER_SIZE_MIN="min",v.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY="infinity",v.dependencies.BufferExtensions.BUFFER_TIME_AT_STARTUP=1,v.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME=16,v.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY=30,v.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM=300,v.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD=600,v.dependencies.BufferExtensions.prototype.constructor=v.dependencies.BufferExtensions,v.utils.Capabilities=function(){"use strict"},v.utils.Capabilities.prototype={constructor:v.utils.Capabilities,system:void 0,supportsMediaSource:function(){"use strict";var a="WebKitMediaSource"in window,b="MediaSource"in window;return a||b},supportsMediaKeys:function(){"use strict";var a="WebKitMediaKeys"in window,b="MSMediaKeys"in window,c="MediaKeys"in window;return a||b||c},supportsEncryptedMedia:function(){return this.system.hasMapping("protectionModel")},supportsCodec:function(a,b){"use strict";if(!(a instanceof HTMLMediaElement))throw"element must be of type HTMLMediaElement.";var c=a.canPlayType(b);return"probably"===c||"maybe"===c}},v.utils.Config=function(){"use strict";var a=["video","audio"],b={"BufferController.minBufferTimeForPlaying":-1,"BufferController.minBufferTime":-1,"ABR.minBandwidth":-1,"ABR.maxBandwidth":-1,"ABR.minQuality":-1,"ABR.maxQuality":-1,"ABR.switchUpIncrementally":!1,"ABR.switchUpRatioSafetyFactor":-1,"ABR.latencyInBandwidth":!0,"ABR.switchDownBufferTime":-1,"ABR.switchDownBufferRatio":-1,"ABR.switchLowerBufferTime":-1,"ABR.switchLowerBufferRatio":-1,"ABR.switchUpBufferTime":-1,"ABR.switchUpBufferRatio":-1,"ABR.keepBandwidthCondition":!0,"ManifestLoader.RetryAttempts":-1,"ManifestLoader.RetryInterval":-1,"FragmentLoader.RetryAttempts":-1,
"FragmentLoader.RetryInterval":-1,video:{},audio:{}},c=function(c){var d,e,f;for(d in c)if(c.hasOwnProperty(d)&&-1===d.indexOf("//"))if(a.indexOf(d)>-1){e=c[d];for(f in e)e.hasOwnProperty(f)&&(b[d][f]=c[d][f])}else b[d]=c[d]},d=function(a,b,c,d){var e=a[b];if(void 0===e||-1===e)return d;if(void 0!==c&&typeof e!==c)switch(c){case"number":e=Number(e);break;case"boolean":e="true"===e||"1"===e||1===e}return e},e=function(a,c,e){return d(b,a,c,e)},f=function(a,c,e,f){var g=b[a];return void 0!==g&&void 0!==g[c]?d(g,c,e,f):d(b,c,e,f)};return{debug:void 0,setup:function(){},setParams:function(a){c(a);var b=this.getParam("Debug.level","number",-1);-1!==b&&this.debug.setLevel(b)},getParam:function(a,b,c){return e(a,b,c)},getParamFor:function(a,b,c,d){return f(a,b,c,d)}}},v.utils.Config.prototype={constructor:v.utils.Config},v.di.Context=function(){"use strict";var a=function(){var a=document.createElement("video"),b=this.system.getObject("debug");v.models.ProtectionModel_21Jan2015.detect(a)?this.system.mapSingleton("protectionModel",v.models.ProtectionModel_21Jan2015):v.models.ProtectionModel_3Feb2014.detect(a)?this.system.mapClass("protectionModel",v.models.ProtectionModel_3Feb2014):v.models.ProtectionModel_01b.detect(a)?this.system.mapClass("protectionModel",v.models.ProtectionModel_01b):(b.log("No supported version of EME detected on this user agent!"),b.log("Attempts to play encrypted content will fail!"))};return{system:void 0,setup:function(){this.system.autoMapOutlets=!0,this.system.mapSingleton("debug",v.utils.Debug),this.system.mapClass("domParser",v.utils.DOMParser),this.system.mapSingleton("tokenAuthentication",v.utils.TokenAuthentication),this.system.mapSingleton("eventBus",v.utils.EventBus),this.system.mapSingleton("capabilities",v.utils.Capabilities),this.system.mapSingleton("textTrackExtensions",v.utils.TextTrackExtensions),this.system.mapSingleton("vttParser",v.utils.VTTParser),this.system.mapSingleton("ttmlParser",v.utils.TTMLParser),this.system.mapSingleton("videoModel",v.models.VideoModel),this.system.mapSingleton("manifestModel",v.models.ManifestModel),this.system.mapSingleton("metricsModel",v.models.MetricsModel),this.system.mapSingleton("uriQueryFragModel",v.models.URIQueryAndFragmentModel),this.system.mapSingleton("ksPlayReady",v.dependencies.protection.KeySystem_PlayReady),this.system.mapSingleton("ksWidevine",v.dependencies.protection.KeySystem_Widevine),this.system.mapSingleton("ksClearKey",v.dependencies.protection.KeySystem_ClearKey),this.system.mapSingleton("serverPlayReady",v.dependencies.protection.servers.PlayReady),this.system.mapSingleton("serverWidevine",v.dependencies.protection.servers.Widevine),this.system.mapSingleton("serverClearKey",v.dependencies.protection.servers.ClearKey),this.system.mapSingleton("serverDRMToday",v.dependencies.protection.servers.DRMToday),this.system.mapSingleton("textSourceBuffer",v.dependencies.TextSourceBuffer),this.system.mapSingleton("textTTMLXMLMP4SourceBuffer",v.dependencies.TextTTMLXMLMP4SourceBuffer),this.system.mapSingleton("mediaSourceExt",v.dependencies.MediaSourceExtensions),this.system.mapSingleton("sourceBufferExt",v.dependencies.SourceBufferExtensions),this.system.mapSingleton("bufferExt",v.dependencies.BufferExtensions),this.system.mapSingleton("abrController",v.dependencies.AbrController),this.system.mapSingleton("errHandler",v.dependencies.ErrorHandler),this.system.mapSingleton("videoExt",v.dependencies.VideoModelExtensions),this.system.mapSingleton("protectionExt",v.dependencies.ProtectionExtensions),this.system.mapClass("protectionController",v.dependencies.ProtectionController),a.call(this),this.system.mapClass("metrics",v.models.MetricsList),this.system.mapClass("abandonRequestRule",v.rules.AbandonRequestsRule),this.system.mapClass("limitSwitchesRule",v.rules.LimitSwitchesRule),this.system.mapClass("abrRulesCollection",v.rules.BaseRulesCollection),this.system.mapClass("eventController",v.dependencies.EventController),this.system.mapClass("textController",v.dependencies.TextController),this.system.mapClass("bufferController",v.dependencies.BufferController),this.system.mapClass("manifestLoader",v.dependencies.ManifestLoader),this.system.mapSingleton("manifestUpdater",v.dependencies.ManifestUpdater),this.system.mapClass("fragmentController",v.dependencies.FragmentController),this.system.mapClass("fragmentLoader",v.dependencies.FragmentLoader),this.system.mapClass("fragmentModel",v.dependencies.FragmentModel),this.system.mapSingleton("streamController",v.dependencies.StreamController),this.system.mapClass("stream",v.dependencies.Stream),this.system.mapSingleton("notifier",v.dependencies.Notifier),this.system.mapClass("indexHandler",u.dependencies.DashHandler),this.system.mapClass("baseURLExt",u.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",u.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",u.dependencies.DashManifestExtensions),this.system.mapSingleton("timelineConverter",u.dependencies.TimelineConverter),this.system.mapSingleton("parser",v.dependencies.Parser),this.system.mapClass("dashParser",u.dependencies.DashParser),this.system.mapClass("mssParser",r.dependencies.MssParser),this.system.mapClass("hlsParser",t.dependencies.HlsParser),this.system.mapClass("hlsDemux",t.dependencies.HlsDemux),this.system.mapSingleton("contextManager",v.modules.ContextManager),this.system.mapSingleton("metricsExt",v.dependencies.MetricsExtensions),this.system.mapSingleton("config",v.utils.Config),this.system.mapClass("downloadRatioRule",v.rules.o.DownloadRatioRule),this.system.mapClass("insufficientBufferRule",v.rules.o.InsufficientBufferRule),this.system.mapHandler("setContext","contextManager","setContext")}}},v.modules.ContextManager=function(){"use strict";return{system:void 0,debug:void 0,setContext:function(a){this.system.autoMapOutlets=!0,"MSS"===a?(this.system.mapClass("mp4Processor",v.dependencies.Mp4Processor),this.system.mapClass("indexHandler",r.dependencies.MssHandler),this.system.mapClass("fragmentController",r.dependencies.MssFragmentController)):"HLS"===a?(this.system.mapClass("mp4Processor",v.dependencies.Mp4Processor),this.system.mapClass("fragmentController",t.dependencies.HlsFragmentController),this.system.mapClass("indexHandler",t.dependencies.HlsHandler)):(this.system.mapClass("fragmentController",v.dependencies.FragmentController),this.system.mapClass("indexHandler",u.dependencies.DashHandler))}}},v.modules.ContextManager.prototype={constructor:v.modules.ContextManager},v.utils.Debug=function(){"use strict";Date.prototype.HHMMSSmmm=function(){var a=this.getHours().toString(),b=this.getMinutes().toString(),c=this.getSeconds().toString(),d=this.getMilliseconds().toString(),e=a[1]?a:"0"+a[0],f=b[1]?b:"0"+b[0],g=c[1]?c:"0"+c[0],h=d[2]?d:"0"+(d[1]?d:"0"+d[0]);return e+":"+f+":"+g+"."+h},Date.prototype.MMSSmmm=function(){var a=this.getMinutes().toString(),b=this.getSeconds().toString(),c=this.getMilliseconds().toString(),d=a[1]?a:"0"+a[0],e=b[1]?b:"0"+b[0],f=c[2]?c:"0"+(c[1]?c:"0"+c[0]);return d+":"+e+"."+f};var a=function(){this.logArray=[],this.showLevel=!0};a.prototype.error=a.prototype.warn=a.prototype.info=a.prototype.debug=function(a){this.logArray.push(a)},a.prototype.getLogs=function(){return this.logArray};var b=0,c=1,d=2,e=3,f=4,g=4,h=0,i=!0,j=!1,k=new Date,l=console,m=function(a,b){if(a<=p()){var g=n(a,b);switch(a){case c:l.error(g);break;case d:l.warn(g);break;case e:l.info(g);break;case f:l.debug(g)}}},n=function(a,b){var c="",d=null;return i&&(d=new Date,c+="["+d.HHMMSSmmm()+"]"),l&&l.showLevel&&(c+="["+o(a)+"]"),j&&(c+="["+new Date(d-k).MMSSmmm()+"]"),Array.apply(null,b).forEach(function(a){c+=a+" "}),c},o=function(a){switch(a){case c:return"ERROR";case d:return"WARN";case e:return"INFO";case f:return"DEBUG";default:return""}},p=function(){return h},q=function(){return l};return{NONE:b,ERROR:c,WARN:d,INFO:e,DEBUG:f,ALL:g,getLevel:p,getLogger:q,setLevel:function(a){h=a},setLogger:function(b){switch(b){case"log4javascript":var c=new log4javascript.PopUpAppender,d=new log4javascript.PatternLayout("%d{HH:mm:ss.SSS} %-5p - %m%n");c.setLayout(d),l.addAppender(c),l.setLevel(log4javascript.Level.ALL),l.initialized=!0;break;case"memory":l=new a;break;case"console":l=console;break;default:l=null}},error:function(){m.call(this,c,arguments)},warn:function(){m.call(this,d,arguments)},info:function(){m.call(this,e,arguments)},log:function(){m.call(this,f,arguments)}}},v.dependencies.ErrorHandler=function(){"use strict";return{eventBus:void 0,debug:void 0,sendWarning:function(a,b,c){this.eventBus.dispatchEvent({type:"warning",data:{code:a,message:b,data:c}}),this.debug.warn("[Warn] Code: "+a+", Message: "+b+", Data: "+JSON.stringify(c,null,"	"))},sendError:function(a,b,c){this.eventBus.dispatchEvent({type:"error",data:{code:a,message:b,data:c}}),this.debug.error("[Error] Code: "+a+", Message: "+b+", Data: "+JSON.stringify(c,null,"	"))}}},v.dependencies.ErrorHandler.prototype={constructor:v.dependencies.ErrorHandler},v.dependencies.ErrorHandler.prototype.INTERNAL_ERROR="INTERNAL_ERROR",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED="MEDIA_ERR_ABORTED",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK="MEDIA_ERR_NETWORK",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE="MEDIA_ERR_DECODE",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED="MEDIA_ERR_SRC_NOT_SUPPORTED",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED="MEDIA_ERR_ENCRYPTED",v.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE="CAPABILITY_ERR_MEDIASOURCE",v.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS="CAPABILITY_ERR_MEDIAKEYS",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE="MEDIA_ERR_CREATE_MEDIASOURCE",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED="MEDIA_ERR_CODEC_UNSUPPORTED",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER="MEDIA_ERR_CREATE_SOURCEBUFFER",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER="MEDIA_ERR_APPEND_SOURCEBUFFER",v.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER="MEDIA_ERR_REMOVE_SOURCEBUFFER",v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE="MANIFEST_ERR_PARSE",v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM="MANIFEST_ERR_NO_STREAM",v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO="MANIFEST_ERR_NO_VIDEO",v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO="MANIFEST_ERR_NO_AUDIO",v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST="DOWNLOAD_ERR_MANIFEST",v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX="DOWNLOAD_ERR_SIDX",v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT="DOWNLOAD_ERR_INIT",v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT="DOWNLOAD_ERR_CONTENT",v.dependencies.ErrorHandler.prototype.CC_ERR_PARSE="CC_ERR_PARSE",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR="MEDIA_KEYERR",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN="MEDIA_KEYERR_UNKNOWN",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT="MEDIA_KEYERR_CLIENT",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE="MEDIA_KEYERR_SERVICE",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT="MEDIA_KEYERR_OUTPUT",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE="MEDIA_KEYERR_HARDWARECHANGE",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN="MEDIA_KEYERR_DOMAIN",v.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED="MEDIA_KEYSYSERR_ACCESS_DENIED",v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN="MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN",v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE="MEDIA_KEYMESSERR_NO_CHALLENGE",v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR="MEDIA_KEYMESSERR_LICENSER_ERROR",v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION="MEDIA_KEYMESSERR_NO_SESSION",v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE="MEDIA_KEYERR_SERVER_CERTIFICATE",v.dependencies.ErrorHandler.prototype.DOM_ERR_INDEX_SIZE=1,v.dependencies.ErrorHandler.prototype.DOM_ERR_HIERARCHY_REQUEST=3,v.dependencies.ErrorHandler.prototype.DOM_ERR_WRONG_DOCUMENT=4,v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_CHARACTER=5,v.dependencies.ErrorHandler.prototype.DOM_ERR_NO_MODIFICATION_ALLOWED=7,v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_FOUND=8,v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED=9,v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_STATE=11,v.dependencies.ErrorHandler.prototype.DOM_ERR_SYNTAX=12,v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_MODIFICATION=13,v.dependencies.ErrorHandler.prototype.DOM_ERR_NAMESPACE=14,v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS=15,v.dependencies.ErrorHandler.prototype.DOM_ERR_SECURITY=18,v.dependencies.ErrorHandler.prototype.DOM_ERR_NETWORK=19,v.dependencies.ErrorHandler.prototype.DOM_ERR_ABORT=20,v.dependencies.ErrorHandler.prototype.DOM_ERR_URL_MISMATCH=21,v.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED=22,v.dependencies.ErrorHandler.prototype.DOM_ERR_TIMEOUT=23,v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_NODE_TYPE=24,v.dependencies.ErrorHandler.prototype.DOM_ERR_DATA_CLONE=25,v.utils.EventBus=function(){"use strict";var a,b=function(b,c){var d=(c?"1":"0")+b;return d in a||(a[d]=[]),a[d]},c=function(){a={}};return c(),{addEventListener:function(a,c,d){var e=b(a,d),f=e.indexOf(c);-1===f&&e.push(c)},removeEventListener:function(a,c,d){var e=b(a,d),f=e.indexOf(c);-1!==f&&e.splice(f,1)},dispatchEvent:function(a){var c=b(a.type,!1).slice(),d=0;for(d=0;d<c.length;d+=1)c[d].call(this,a);return!a.defaultPrevented}}},v.dependencies.EventController=function(){"use strict";var a=[],b=[],c=[],d=null,e=100,f=e/1e3,g="urn:mpeg:dash:event:2012",h=1,i=function(){null!==d&&(clearInterval(d),d=null),a=null,b=null,c=null},j=function(){null!==d&&(clearInterval(d),d=null)},k=function(){var a=this;a.debug.log("[EventController] Start Event Controller"),isNaN(e)||(d=setInterval(n.bind(this),e))},l=function(b){var c=this;a=[],b&&b.length>0&&(a=b),c.debug.log("[EventController] Added "+b.length+" inline events")},m=function(a){var c,d=this,e=0;for(e=0;e<a.length;e++)c=a[e],b[c.id]=c,d.debug.log("[EventController] Add inband event with id "+c.id)},n=function(){o.call(this,b),o.call(this,a),p.call(this)},o=function(a){var b,d,e=this,i=this.videoModel.getCurrentTime(),j=0;if(a)for(j=0;j<a.length;j++)d=a[j],void 0!==d&&(b=d.presentationTime/d.eventStream.timescale,(0===b||i>=b&&b+f>i)&&(e.debug.log("[EventController] Start Event at "+i),d.duration>0&&c.push(d),d.eventStream.schemeIdUri===g&&d.eventStream.value===h&&q.call(this),a.splice(j,1)))},p=function(){var a,b,d=this,e=0;if(c)for(a=this.videoModel.getCurrentTime(),e=0;e<c.length;e++)b=c[e],null!==b&&(b.duration+b.presentationTime)/b.eventStream.timescale<a&&(d.debug.log("[EventController] Remove Event at time "+a),b=null,c.splice(e,1))},q=function(){var a=this,b=a.manifestModel.getValue(),c=b.mpdUrl;b.hasOwnProperty("Location")&&(c=b.Location),a.debug.log("[EventController] Refresh manifest @ "+c),a.manifestLoader.load(c).then(function(b){a.manifestModel.setValue(b)})};return{manifestModel:void 0,manifestLoader:void 0,debug:void 0,system:void 0,videoModel:void 0,addInlineEvents:l,addInbandEvents:m,reset:i,clear:j,start:k}},v.dependencies.EventController.prototype={constructor:v.dependencies.EventController},v.dependencies.FragmentController=function(){"use strict";var a=[],b=function(b){var c=a.length,d=0;for(d=0;c>d;d+=1)if(a[d].getContext()===b)return a[d];return null},c=function(){var b=!0,c=a.length,d=0;for(d=0;c>d;d+=1)if(!a[d].isReady()){b=!1;break}return b},d=function(){var b=0;for(b=0;b<a.length;b+=1)a[b].executeCurrentRequest()};return{system:void 0,debug:void 0,process:function(a){var b=null;return null!==a&&void 0!==a&&a.byteLength>0&&(b=new Uint8Array(a)),o.when(b)},attachBufferController:function(c){var d;return c?(d=b(c),d||(d=this.system.getObject("fragmentModel"),d.setContext(c),a.push(d)),d):null},detachBufferController:function(b){var c=a.indexOf(b);c>-1&&a.splice(c,1)},onBufferControllerStateChange:function(){c()&&d.call(this)},isFragmentLoadedOrPending:function(a,c){var d,e=b(a);return e?d=e.isFragmentLoadedOrPending(c):!1},getPendingRequests:function(a){var c=b(a);return c?c.getPendingRequests():null},getLoadingRequests:function(a){var c=b(a);return c?c.getLoadingRequests():null},isInitializationRequest:function(a){return a&&a.type&&"initialization segment"===a.type.toLowerCase()},getLoadingTime:function(a){var c=b(a);return c?c.getLoadingTime():null},getExecutedRequestForTime:function(a,b){return a?a.getExecutedRequestForTime(b):null},removeExecutedRequest:function(a,b){a&&a.removeExecutedRequest(b)},removeExecutedRequestsBeforeTime:function(a,b){a&&a.removeExecutedRequestsBeforeTime(b)},clearExecutedRequests:function(a){a&&a.clearExecutedRequests()},cancelPendingRequestsForModel:function(a){a&&a.cancelPendingRequests()},abortRequestsForModel:function(a){a&&a.abortRequests()},prepareFragmentForLoading:function(a,c,d,e,f,g){var h=b(a);return h&&c?(h.addRequest(c),h.setCallbacks(d,e,f,g),o.when(!0)):o.when(null)}}},v.dependencies.FragmentController.prototype={constructor:v.dependencies.FragmentController},v.dependencies.FragmentLoader=function(){"use strict";var a=2,b=500,c=a,d=b,e=0,f=[],g=function(a){var b=new XMLHttpRequest,c=!1;b.open("HEAD",a.url,!0),b.onload=function(){b.status<200||b.status>399||(c=!0,a.deferred.resolve(a))},b.onloadend=b.onerror=function(){c||a.deferred.reject(b)},b.send()},h=function(a,b){var c=o.defer(),d=new XMLHttpRequest,e=null,g=!0,h=!0,i=null,j=this;return f.push(d),a.requestStartDate=new Date,e=j.metricsModel.addHttpRequest(a.streamType,null,a.type,a.url,null,a.range,a.requestStartDate,null,null,null,null,a.duration,a.startTime,a.quality),j.metricsModel.appendHttpTrace(e,a.requestStartDate,a.requestStartDate.getTime()-a.requestStartDate.getTime(),[0]),i=a.requestStartDate,d.open("GET",j.tokenAuthentication.addTokenAsQueryArg(a.url),!0),d.responseType="arraybuffer",d=j.tokenAuthentication.setTokenInRequestHeader(d),b&&d.setRequestHeader("Range",b),d.onprogress=function(b){var c=new Date;g&&(g=!1,(!b.lengthComputable||b.lengthComputable&&b.total!==b.loaPded)&&(a.firstByteDate=c,e.tresponse=c)),b.lengthComputable&&(a.bytesLoaded=b.loaded,a.bytesTotal=b.total),j.metricsModel.appendHttpTrace(e,c,c.getTime()-i.getTime(),[a.bytesLoaded?a.bytesLoaded:0]),i=c,j.notify(v.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,{request:a,httpRequestMetrics:e,lastTraceTime:i})},d.onload=function(){if(!(d.status<200||d.status>399)){h=!1;var b,f,g=new Date,k=d.response;a.firstByteDate||(a.firstByteDate=a.requestStartDate),a.requestEndDate=g,b=a.firstByteDate.getTime()-a.requestStartDate.getTime(),f=a.requestEndDate.getTime()-a.firstByteDate.getTime(),j.debug.log("[FragmentLoader]["+a.streamType+"] Loaded: "+a.url+" ("+d.status+", "+b+"ms, "+f+"ms)"),e.tresponse=a.firstByteDate,e.tfinish=a.requestEndDate,e.responsecode=d.status,e.bytesLength=k?k.byteLength:0,j.metricsModel.appendHttpTrace(e,g,g.getTime()-i.getTime(),[k?k.byteLength:0]),i=g,c.resolve({data:k,request:a})}},d.onabort=function(){d.aborted=!0},d.onloadend=d.onerror=function(){if(-1!==f.indexOf(d)&&(f.splice(f.indexOf(d),1),h)){h=!1;var b,g,k=new Date,l=d.response;a.firstByteDate||(a.firstByteDate=a.requestStartDate),a.requestEndDate=k,b=a.firstByteDate.getTime()-a.requestStartDate.getTime(),g=a.requestEndDate.getTime()-a.firstByteDate.getTime(),e.tresponse=a.firstByteDate,e.tfinish=a.requestEndDate,e.responsecode=d.status,j.metricsModel.appendHttpTrace(e,k,k.getTime()-i.getTime(),[l?l.byteLength:0]),i=k,c.reject(d)}},j.debug.log("[FragmentLoader]["+a.streamType+"] Load: "+a.url),d.send(),c.promise},i=function(a,b){var f=this;e++,setTimeout(function(){h.call(f,a).then(function(a){e=0,b.resolve(a)},function(d){c>e?i.call(f,a,b):(e=0,b.reject(d))})},d)};return{metricsModel:void 0,debug:void 0,tokenAuthentication:void 0,config:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,setup:function(){c=this.config.getParam("FragmentLoader.RetryAttempts","number",a),d=this.config.getParam("FragmentLoader.RetryInterval","number",b)},load:function(a){var b=this,d=o.defer();return"Initialization Segment"===a.type&&a.data?d.resolve(a,{data:a.data}):h.call(this,a).then(function(a){d.resolve(a)},function(e){e.aborted?(a.status=0,a.aborted=!0,d.reject(a)):0>=c?(a.status=e.status,d.reject(a)):i.call(b,a,d)}),d.promise},abort:function(){var a=0;for(a=0;a<f.length;a+=1)this.debug.log("[FragmentLoader] Abort XHR "+(f[a].responseURL?f[a].responseURL:"")),f[a].abort();f.length=0,f=[]},checkForExistence:function(a){return a?(a.deferred=o.defer(),g.call(this,a),a.deferred.promise):o.when(null)}}},v.dependencies.FragmentLoader.prototype={constructor:v.dependencies.FragmentLoader},v.dependencies.FragmentLoader.eventList={ENAME_LOADING_PROGRESS:"loadingProgress"},v.dependencies.FragmentModel=function(){"use strict";var a,b,c,d,e,f=[],g=[],h=[],i=2,j=function(e){var g,i,j=this;b.call(a,e),g=function(b,d){h.splice(h.indexOf(b),1),f.push(b),c.call(a,b,d),b.deferred=null},i=function(b){h.splice(h.indexOf(b),1),d.call(a,b),b.deferred=null},j.fragmentLoader.load(e).then(g.bind(a,e),i.bind(a,e))},k=function(a,b){var c=function(a,c){return a[b]<c[b]?-1:a[b]>c[b]?1:0};a.sort(c)},l=function(a){var b=f.indexOf(a);-1!==b&&f.splice(b,1)};return{system:void 0,debug:void 0,fragmentLoader:void 0,setContext:function(b){a=b},getContext:function(){return a},addRequest:function(a){if(a){if(this.isFragmentLoadedOrPending(a))return;g.push(a),k.call(this,g,"index")}},setCallbacks:function(a,f,g,h){b=a,e=h,d=g,c=f},isFragmentLoadedOrPending:function(a){var b,c=!1,d=f.length,e=0;for(e=0;d>e;e++)if(b=f[e],a.startTime===b.startTime||"complete"===b.action&&a.action===b.action){if(a.url===b.url){c=!0;break}l(a)}if(!c)for(e=0,d=g.length;d>e;e+=1)b=g[e],a.url===b.url&&a.startTime===b.startTime&&(c=!0);if(!c)for(e=0,d=h.length;d>e;e+=1)b=h[e],a.url===b.url&&a.startTime===b.startTime&&(c=!0);return c},isReady:function(){return a.isReady()},getPendingRequests:function(){return g},getLoadingRequests:function(){return h},getLoadingTime:function(){var a,b,c=0;for(b=f.length-1;b>=0;b-=1)if(a=f[b],a.requestEndDate instanceof Date&&a.firstByteDate instanceof Date){c=a.requestEndDate.getTime()-a.firstByteDate.getTime();break}return c},getExecutedRequestForTime:function(a){var b,c=f.length-1,d=NaN,e=NaN,g=null;for(b=c;b>=0;b-=1)if(g=f[b],d=g.startTime,e=d+g.duration,!isNaN(d)&&!isNaN(e)&&a>d&&e>a)return g;return null},getExecutedRequestForQualityAndIndex:function(a,b){var c,d=f.length-1,e=null;for(c=d;c>=0;c-=1)if(e=f[c],e.quality===a&&e.index===b)return e;return null},removeExecutedRequest:function(a){l.call(this,a)},removeExecutedRequestsBeforeTime:function(a){var b,c=f.length-1,d=NaN,e=null;for(b=c;b>=0;b-=1)e=f[b],d=e.startTime,!isNaN(d)&&a>d&&l.call(this,e)},clearExecutedRequests:function(){f=[]},cancelPendingRequests:function(){g=[]},abortRequests:function(){this.fragmentLoader.abort(),h=[]},executeCurrentRequest:function(){var b,c=this;if(0!==g.length&&!(h.length>=i))switch(b=g.shift(),b.action){case"complete":f.push(b),e.call(a,b);break;case"download":h.push(b),j.call(c,b);break;default:this.debug.log("Unknown request action."),b.deferred?(b.deferred.reject(),b.deferred=null):d.call(a,b)}}}},v.dependencies.FragmentModel.prototype={constructor:v.dependencies.FragmentModel},v.dependencies.ManifestLoader=function(){"use strict";var a=2,b=500,c=a,d=b,e=0,f=null,g=null,h=function(a){var b,c="",d=0;if(a.length<1)return a;if(15360!==a.charCodeAt(0))return a;for(d=0;d<a.length;d+=1)b=a.charCodeAt(d),c+=String.fromCharCode((255&b)<<8|(65280&b)>>8);return c},i=function(a){var b=null;return-1!==a.indexOf("/")&&(-1!==a.indexOf("?")&&(a=a.substring(0,a.indexOf("?"))),b=a.substring(0,a.lastIndexOf("/")+1)),b},j=function(){null!==g&&g.readyState>0&&g.readyState<4&&(this.debug.log("[ManifestLoader] Manifest download abort."),g.abort()),this.parser.abort()},k=function(a){var b=i(a),j=new Date,l=null,m=!0,n=null,o=null,p=null,q=this;p=function(){g.aborted=!0},n=function(){g.status<200||g.status>299||200===g.status&&4===g.readyState&&(q.debug.log("[ManifestLoader] Manifest downloaded"),g.responseURL&&(q.debug.log("[ManifestLoader] Redirect URL: "+g.responseURL),b=i(g.responseURL)),m=!1,l=new Date,q.tokenAuthentication.checkRequestHeaderForToken(g),q.metricsModel.addHttpRequest("stream",null,"MPD",a,null,null,j,l,g.status,null,null),q.parser.parse(h(g.responseText),b).then(function(b){b.mpdUrl=a,b.mpdLoadedTime=l,q.metricsModel.addManifestUpdate("stream",b.type,j,l,b.availabilityStartTime),f.resolve(b)},function(){q.debug.error("[ManifestLoader] Manifest parsing error"),f.reject({name:v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse manifest",data:{url:a}})}))},o=function(){m&&(m=!1,q.metricsModel.addHttpRequest("stream",null,"MPD",a,null,null,j,new Date,g.status,null,null),g.aborted?f.reject():(e++,c>0&&c>=e?setTimeout(function(){k.call(q,a)},d):f.reject({name:v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download manifest",data:{url:a,status:g.status}})))};try{g.onload=n,g.onloadend=o,g.onerror=o,g.onabort=p,g.open("GET",a,!0),g.send()}catch(r){g.onerror()}};return{debug:void 0,parser:void 0,config:void 0,metricsModel:void 0,tokenAuthentication:void 0,setup:function(){c=this.config.getParam("ManifestLoader.RetryAttempts","number",a),d=this.config.getParam("ManifestLoader.RetryInterval","number",b)},load:function(a){return f=o.defer(),g=new XMLHttpRequest,e=0,k.call(this,a),f.promise},abort:j}},v.dependencies.ManifestLoader.prototype={constructor:v.dependencies.ManifestLoader},v.dependencies.ManifestUpdater=function(){"use strict";var a,b=NaN,c=null,d=!1,e=function(){null!==c&&(clearInterval(c),c=null)},f=function(){e.call(this),isNaN(b)||(this.debug.log("Refresh manifest in "+b+" seconds."),c=setTimeout(h.bind(this),Math.min(1e3*b,Math.pow(2,31)-1),this))},g=function(){var a,c=this,d=c.manifestModel.getValue();void 0!==d&&null!==d&&c.manifestExt.getRefreshDelay(d).then(function(e){a=((new Date).getTime()-d.mpdLoadedTime.getTime())/1e3,b=Math.max(e-a,0),f.call(c)})},h=function(){var b,c,e=this;o.when(a?a.promise:!0).then(function(){a=o.defer(),b=e.manifestModel.getValue(),c=b.mpdUrl,b.hasOwnProperty("Location")&&(c=b.Location),e.manifestLoader.load(c).then(function(a){e.manifestModel.setValue(a),e.debug.log("Manifest has been refreshed."),d||g.call(e)})})},i=function(){a&&a.resolve()};return{debug:void 0,system:void 0,manifestModel:void 0,manifestExt:void 0,manifestLoader:void 0,setup:function(){g.call(this),this.system.mapHandler("streamsComposed",void 0,i.bind(this))},start:function(){d=!1,g.call(this)},stop:function(){d=!0,e.call(this)}}},v.dependencies.ManifestUpdater.prototype={constructor:v.dependencies.ManifestUpdater},v.models.ManifestModel=function(){"use strict";var a=null;return{system:void 0,eventBus:void 0,getValue:function(){return a},setValue:function(b){a=b,a&&this.system.notify("manifestUpdated"),null!==a&&this.eventBus.dispatchEvent({type:"manifestLoaded",data:b})}}},v.models.ManifestModel.prototype={constructor:v.models.ManifestModel},v.dependencies.MediaSourceExtensions=function(){"use strict"},v.dependencies.MediaSourceExtensions.prototype={constructor:v.dependencies.MediaSourceExtensions,createMediaSource:function(){"use strict";var a="WebKitMediaSource"in window,b="MediaSource"in window;return b?new MediaSource:a?new WebKitMediaSource:null},attachMediaSource:function(a,b){"use strict";return b.setSource(window.URL.createObjectURL(a)),o.when(!0)},detachMediaSource:function(a){"use strict";return a.setSource(""),o.when(!0)},setDuration:function(a,b){"use strict";return a.duration=b,o.when(a.duration)},signalEndOfStream:function(a){"use strict";return a.endOfStream(),o.when(!0)}},v.dependencies.MetricsExtensions=function(){"use strict";var a={42:"Baseline","4D":"Main",58:"Extended",64:"High"},b=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return f;return null},c=function(a,b){var c=!1;return"video"===b?(this.manifestExt.getIsVideo(a),"video"===a.type&&(c=!0)):"audio"===b?(this.manifestExt.getIsAudio(a),"audio"===a.type&&(c=!0)):"text"===b?(this.manifestExt.getIsText(a),"text"===a.type&&(c=!0)):c=!1,c},d=v.utils.copyMethods(u.dependencies.DashMetricsExtensions);return d.config=void 0,d.getDuration=function(){var a=this,b=a.manifestModel.getValue(),c=b?b.Period.duration:null;return c!==1/0?c:-1},d.getFormatForType=function(a){var b,c=this,d=c.manifestModel.getValue(),e=0;for(e=0;e<d.Period.AdaptationSet.length;e++)if(b=d.Period.AdaptationSet[e],b.type===a)return b.mimeType;return null},d.getCodecForType=function(a){var b,c=this,d=c.manifestModel.getValue(),e=0;for(e=0;e<d.Period.AdaptationSet.length;e++)if(b=d.Period.AdaptationSet[e],b.type===a||b.contentType===a)return b.Representation[0].codecs;return null},d.getVideoWidthForRepresentation=function(a){var c,d,e=this,f=e.manifestModel.getValue();return f?(d=f.Period_asArray,c=b.call(e,d,a),null===c?null:c.width):null},d.getVideoHeightForRepresentation=function(a){var c,d,e=this,f=e.manifestModel.getValue();return f?(d=f.Period_asArray,c=b.call(e,d,a),null===c?null:c.height):null},d.getCodecsForRepresentation=function(a){var c,d=this,e=d.manifestModel.getValue(),f=e.Period_asArray;return c=b.call(d,f,a),null===c?null:c.codecs},d.getH264ProfileLevel=function(b){if(b.indexOf("avc1")<0)return"";var c=a[b.substr(5,2)],d=parseInt(b.substr(9,2),16)/10;return c+"@"+d.toString()},d.getBitratesForType=function(a,b){var d,e,f,g,h,i,j,k,l=this,m=l.manifestModel.getValue(),n=null,o=[];if(!(null!==m&&void 0!==m||null!==b&&void 0!==b))return null;if(b)n=b;else for(d=m.Period_asArray,f=0;f<d.length;f+=1)for(e=d[f],g=e.AdaptationSet_asArray,j=0;j<g.length;j+=1)if(n=g[j],c.call(l,g[j],a)){n=g[j];break}if(null!==n)for(n=l.manifestExt.processAdaptation(n),i=n.Representation_asArray,k=0;k<i.length;k+=1)h=i[k],o.push(h.bandwidth);return o},d.getBitratesWithResolutionForType=function(a){var b,d,e,f,g,h,i,j,k,l=this,m=l.manifestModel.getValue(),n=[];if(null===m||void 0===m)return null;for(b=m.Period_asArray,e=0;e<b.length;e+=1)for(d=b[e],g=d.AdaptationSet_asArray,j=0;j<g.length;j+=1)if(f=g[j],c.call(l,f,a)){for(f=l.manifestExt.processAdaptation(f),i=f.Representation_asArray,k=0;k<i.length;k+=1){h=i[k];var o={bitrate:h.bandwidth,width:h.width,height:h.height};n.push(o)}return n}return n},d.getQualityBoundaries=function(a,b){if(a){var c,e=d.getBitratesForType(a,b),f=d.config.getParamFor(a,"ABR.minQuality","number",-1),g=d.config.getParamFor(a,"ABR.maxQuality","number",-1),h=d.config.getParamFor(a,"ABR.minBandwidth","number",-1),i=d.config.getParamFor(a,"ABR.maxBandwidth","number",-1),j=e.length;if(-1!==h)for(c=0;c<e.length;c++)if(e[c]>=h){f=-1===f?c:Math.max(c,f);break}if(-1!==i)for(c=e.length-1;c>=0;c--)if(e[c]<=i){g=-1===g?c:Math.min(c,g);break}return f=f>=j?j-1:f,f=0>f?0:f,g=g>=j||0>g?j-1:g,{min:f,max:g}}return null},d},v.dependencies.MetricsExtensions.prototype={constructor:v.dependencies.MetricsExtensions},v.models.MetricsModel=function(){"use strict";return{system:void 0,eventBus:void 0,config:void 0,streamMetrics:{},metricsChanged:function(){this.eventBus.dispatchEvent({type:"metricsChanged",data:{}})},metricChanged:function(a){this.eventBus.dispatchEvent({type:"metricChanged",data:{stream:a}}),this.metricsChanged()},metricUpdated:function(a,b,c){this.eventBus.dispatchEvent({type:"metricUpdated",data:{stream:a,metric:b,value:c}}),this.metricChanged(a)},metricAdded:function(a,b,c){this.eventBus.dispatchEvent({type:"metricAdded",data:{stream:a,metric:b,value:c}}),this.metricChanged(a)},clearCurrentMetricsForType:function(a){
var b=this.config.getParamFor(a,"ABR.keepBandwidthCondition","boolean",!0);for(var c in this.streamMetrics[a])!this.streamMetrics[a].hasOwnProperty(c)||"HttpList"===c&&b!==!1||(this.streamMetrics[a][c]=[]);this.metricChanged(a)},clearAllCurrentMetrics:function(){var a=this;for(var b in this.streamMetrics)this.streamMetrics.hasOwnProperty(b)&&"stream"===b&&delete this.streamMetrics[b];this.metricsChanged.call(a)},getReadOnlyMetricsFor:function(a){return this.streamMetrics.hasOwnProperty(a)?this.streamMetrics[a]:null},getMetricsFor:function(a){var b;return this.streamMetrics.hasOwnProperty(a)?b=this.streamMetrics[a]:(b=this.system.getObject("metrics"),this.streamMetrics[a]=b),b},addTcpConnection:function(a,b,c,d,e,f){var g=new v.vo.metrics.TCPConnection;return g.tcpid=b,g.dest=c,g.topen=d,g.tclose=e,g.tconnect=f,this.getMetricsFor(a).TcpList.push(g),this.metricAdded(a,"TcpConnection",g),g},addHttpRequest:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=new v.vo.metrics.HTTPRequest;return o.stream=a,o.tcpid=b,o.type=c,o.url=d,o.actualurl=e,o.range=f,o.trequest=g,o.tresponse=h,o.tfinish=i,o.responsecode=j,o.interval=k,o.mediaduration=l,o.startTime=m,o.quality=n,this.getMetricsFor(a).HttpList.push(o),this.getMetricsFor(a).HttpList.length>10&&this.getMetricsFor(a).HttpList.shift(),this.metricAdded(a,"HttpRequest",o),o},appendHttpTrace:function(a,b,c,d){var e=new v.vo.metrics.HTTPRequest.Trace;return e.s=b,e.d=c,e.b=d,a.trace.push(e),this.metricUpdated(a.stream,"HttpRequestTrace",a),e},addRepresentationSwitch:function(a,b,c,d,e){var f=new v.vo.metrics.RepresentationSwitch;return f.t=b,f.mt=c,f.to=d,f.lto=e,this.getMetricsFor(a).RepSwitchList.push(f),this.metricAdded(a,"RepresentationSwitch",f),f},addBufferedSwitch:function(a,b,c,d){var e=new v.vo.metrics.BufferedSwitch;return e.mt=b,e.to=c,e.lto=d,this.getMetricsFor(a).BufferedSwitchList.push(e),this.metricAdded(a,"BufferedSwitch",e),e},addState:function(a,b,c,d){var e=new v.vo.metrics.State;return e.current=b,e.position=c,e.reason=d,this.metricAdded(a,"State",e),e},addSession:function(a,b,c,d,e){var f=new v.vo.metrics.Session;return f.uri=b,c?f.loopMode=1:f.loopMode=0,f.endTime=d,f.playerType=e,this.metricAdded(a,"Session",f),f},addCondition:function(a,b,c,d,e,f){var g=new v.vo.metrics.Condition;return g.isFullScreen=b,g.windowSize=c+"x"+d,g.fps=f,g.droppedFrames=e,this.metricAdded(a,"Condition",g),g},addMetaData:function(){this.metricAdded(null,"ManifestReady",null)},addBufferLevel:function(a,b,c){var d=new v.vo.metrics.BufferLevel;return d.t=b,d.level=Number(c.toFixed(3)),this.getMetricsFor(a).BufferLevel.push(d),this.getMetricsFor(a).BufferLevel.length>10&&this.getMetricsFor(a).BufferLevel.shift(),this.metricAdded(a,"BufferLevel",d),d},addDVRInfo:function(a,b,c,d){var e=new v.vo.metrics.DVRInfo;return e.time=b,e.range=d,e.mpd=c,this.getMetricsFor(a).DVRInfo.push(e),this.metricAdded(a,"DVRInfo",e),e},addDroppedFrames:function(a,b){var c=new v.vo.metrics.DroppedFrames,d=this.getMetricsFor(a).DroppedFrames;return c.time=b.creationTime,c.droppedFrames=b.droppedVideoFrames,c.decodedFrameCount=b.totalVideoFrames,d.length>0&&d[d.length-1]===c?d[d.length-1]:(d.push(c),this.metricAdded(a,"DroppedFrames",c),c)},addManifestUpdate:function(a,b,c,d,e,f,g,h,i,j){var k=new v.vo.metrics.ManifestUpdate,l=this.getMetricsFor("stream");return k.streamType=a,k.type=b,k.requestTime=c,k.fetchTime=d,k.availabilityStartTime=e,k.presentationStartTime=f,k.clientTimeOffset=g,k.currentTime=h,k.buffered=i,k.latency=j,l.ManifestUpdate.push(k),this.metricAdded(a,"ManifestUpdate",k),k},updateManifestUpdateInfo:function(a,b){if(a&&b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);this.metricUpdated(a.streamType,"ManifestUpdate",a)}},addManifestUpdatePeriodInfo:function(a,b,c,d,e){var f=new v.vo.metrics.ManifestUpdate.PeriodInfo;return f.id=b,f.index=c,f.start=d,f.duration=e,a.periodInfo.push(f),this.metricUpdated(a.streamType,"ManifestUpdatePeriodInfo",a),f},addManifestUpdateRepresentationInfo:function(a,b,c,d,e,f,g,h){var i=new v.vo.metrics.ManifestUpdate.RepresentationInfo;return i.id=b,i.index=c,i.periodIndex=d,i.streamType=e,i.startNumber=g,i.segmentInfoType=h,i.presentationTimeOffset=f,a.representationInfo.push(i),this.metricUpdated(a.streamType,"ManifestUpdateRepresentationInfo",a),i},addPlayList:function(a,b,c,d){var e=new v.vo.metrics.PlayList;return e.stream=a,e.start=b,e.mstart=c,e.starttype=d,this.getMetricsFor(a).PlayList.push(e),this.getMetricsFor(a).PlayList.length>10&&this.getMetricsFor(a).PlayList.shift(),this.metricAdded(a,"PlayList",e),e},appendPlayListTrace:function(a,b,c,d,e,f,g,h){var i=new v.vo.metrics.PlayList.Trace;return i.representationid=b,i.subreplevel=c,i.start=d,i.mstart=e,i.duration=f,i.playbackspeed=g,i.stopreason=h,a.trace.push(i),a.trace.length>10&&a.trace.shift(),this.metricUpdated(a.stream,"PlayListTrace",a),i}}},v.models.MetricsModel.prototype={constructor:v.models.MetricsModel},v.dependencies.Mp4Processor=function(){"use strict";var a=function(a){var b=new C.boxes.MovieHeaderBox,c=a[a.length-1];return b.version=1,b.creation_time=0,b.modification_time=0,b.timescale=c.timescale,b.duration=Math.round(c.duration*c.timescale),b.rate=65536,b.volume=256,b.reserved=0,b.reserved_2=[0,0],b.matrix=[65536,0,0,0,65536,0,0,0,1073741824],b.pre_defined=[0,0,0,0,0,0],b.next_track_ID=c.trackId+1,b.flags=0,b},b=function(a){var b,c,e;return b=new C.boxes.TrackBox,c=new C.boxes.TrackHeaderBox,c.version=1,c.flags=7,c.creation_time=0,c.modification_time=0,c.track_id=a.trackId,c.reserved=0,c.duration=Math.round(a.duration*a.timescale),c.reserved_2=[0,0],c.layer=0,c.alternate_group=0,c.volume=256,c.reserved_3=0,c.matrix=[65536,0,0,0,65536,0,0,0,1073741824],c.width=a.width<<16,c.height=a.height<<16,b.boxes.push(c),e=new C.boxes.MediaBox,e.boxes.push(d(a)),e.boxes.push(f(a)),e.boxes.push(g(a)),b.boxes.push(e),b},c=function(a){var b,c,d,e=0;return b=a.charCodeAt(0)-96<<10,c=a.charCodeAt(1)-96<<5,d=a.charCodeAt(2)-96,e=b|c|d},d=function(a){var b=new C.boxes.MediaHeaderBox;return b.flags=0,b.version=1,b.creation_time=0,b.modification_time=0,b.timescale=a.timescale,b.duration=Math.round(a.duration*a.timescale),b.pad=0,b.language=c(a.language),b.pre_defined=0,b},e=function(a){var b,c=0;for(b=0;b<a.length;b+=1)c|=a.charCodeAt(b)<<8*(a.length-b-1);return c},f=function(a){var b=new C.boxes.HandlerBox;switch(b.version=0,b.pre_defined=0,a.type){case"video":b.handler_type=e(b.HANDLERTYPEVIDEO),b.name=b.HANDLERVIDEONAME;break;case"audio":b.handler_type=e(b.HANDLERTYPEAUDIO),b.name=b.HANDLERAUDIONAME;break;default:b.handler_type=e(b.HANDLERTYPETEXT),b.name=b.HANDLERTEXTNAME}return b.name+="\x00",b.reserved=[0,0,0],b.flags=0,b},g=function(a){var b=new C.boxes.MediaInformationBox;switch(a.type){case"video":b.boxes.push(E(a));break;case"audio":b.boxes.push(F(a))}return b.boxes.push(h(a)),b.boxes.push(D(a)),b},h=function(){var a,b,c;return a=new C.boxes.DataInformationBox,b=new C.boxes.DataReferenceBox,b.version=0,b.entry_count=1,b.flags=0,c=new C.boxes.DataEntryUrlBox,c.location="",c.version=0,c.flags=1,b.boxes.push(c),a.boxes.push(b),a},i=function(){var a=new C.boxes.TimeToSampleBox;return a.version=0,a.entry_count=0,a.flags=0,a.entry=[],a},j=function(){var a=new C.boxes.SampleToChunkBox;return a.flags=0,a.version=0,a.entry_count=0,a.entry=[],a},k=function(){var a=new C.boxes.ChunkOffsetBox;return a.version=0,a.entry_count=0,a.flags=0,a.chunk_offset=[],a},l=function(){var a=new C.boxes.SampleSizeBox;return a.version=0,a.flags=0,a.sample_count=0,a.sample_size=0,a},m=function(a){var b,c=new Uint8Array(a.length/2);for(b=0;b<a.length/2;b+=1)c[b]=parseInt(""+a[2*b]+a[2*b+1],16);return c},n=function(a,b){var c=new Uint8Array(a.length+b.length);return c.set(a,0),c.set(b,a.length),c},o=function(a){var b,c,d,e,f,g,h,i,j,k=new RegExp("^[A-Z0-9]7","gi"),l=new RegExp("^[A-Z0-9]8","gi");for(b=new C.boxes.AVCConfigurationBox,b.configurationVersion=1,b.lengthSizeMinusOne=3,b.reserved=63,b.SPS_NAL=[],b.PPS_NAL=[],c=new Uint8Array(0),d=a.codecPrivateData,e=d.split("00000001"),e.splice(0,1),f=0,g=0,h=0;h<e.length;h+=1)i=m(e[h]),e[h].match(k)&&(b.SPS_NAL[f++]={NAL_length:i.length,NAL:i},b.AVCProfileIndication=parseInt(e[h].substr(2,2),16),b.profile_compatibility=parseInt(e[h].substr(4,2),16),b.AVCLevelIndication=parseInt(e[h].substr(6,2),16)),e[h].match(l)&&(b.PPS_NAL[g++]={NAL_length:i.length,NAL:i}),j=new Uint8Array(i.length+4),j[3]=i.length,j.set(i,4),c=n(c,j);return b.numOfSequenceParameterSets=f,b.numOfPictureParameterSets=g,b},p=function(a){var b=null;return b=void 0!==a.contentProtection?new C.boxes.EncryptedVideoBox:new C.boxes.AVC1VisualSampleEntryBox,b.data_reference_index=1,b.compressorname="AVC Coding",b.depth=24,b.reserved=[0,0,0,0,0,0],b.reserved_2=0,b.reserved_3=0,b.pre_defined=0,b.pre_defined_2=[0,0,0],b.pre_defined_3=65535,b.frame_count=1,b.horizresolution=4718592,b.vertresolution=4718592,b.height=a.height,b.width=a.width,b.boxes.push(o(a)),void 0!==a.contentProtection&&b.boxes.push(u(a)),b},q=function(a){var b=new C.boxes.OriginalFormatBox;return b.data_format=e(a.codecs.substring(0,a.codecs.indexOf("."))),b},r=function(){var a=new C.boxes.SchemeTypeBox;return a.flags=0,a.version=0,a.scheme_type=1667591779,a.scheme_version=65536,a},s=function(a){var b=new C.boxes.SchemeInformationBox;return b.boxes.push(t(a)),b},t=function(a){var b=new C.boxes.TrackEncryptionBox;return b.flags=0,b.version=0,b.default_IsEncrypted=1,b.default_IV_size=8,b.default_KID=a.contentProtection&&a.contentProtection.length>0&&a.contentProtection[0]["cenc:default_KID"]?a.contentProtection[0]["cenc:default_KID"]:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],b},u=function(a){var b=new C.boxes.ProtectionSchemeInformationBox;return b.boxes.push(q(a)),b.boxes.push(r()),b.boxes.push(s(a)),b},w=function(a){var b=a.codecs.substring(0,a.codecs.indexOf("."));switch(b){case"avc1":return p(a);default:throw{name:v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:b}}}},x=function(a){for(var b=[];a.length>=2;)b.push(parseInt(a.substring(0,2),16)),a=a.substring(2,a.length);return b},y=function(a){var b,c,d,e,f,g,h;return b=x(a.codecPrivateData),c=b.length,d=new Uint8Array(2+c),d[0]=5,d[1]=c,d.set(b,2),e=13+d.length,f=new Uint8Array(2+e),f[0]=4,f[1]=e,f[2]=64,f[3]=20,f[3]|=0,f[3]|=1,f[4]=255,f[5]=255,f[6]=255,f[7]=(4278190080&a.bandwidth)>>24,f[8]=(16711680&a.bandwidth)>>16,f[9]=(65280&a.bandwidth)>>8,f[10]=255&a.bandwidth,f[11]=(4278190080&a.bandwidth)>>24,f[12]|=(16711680&a.bandwidth)>>16,f[13]|=(65280&a.bandwidth)>>8,f[14]|=255&a.bandwidth,f.set(d,15),g=3+f.length,h=new Uint8Array(2+g),h[0]=3,h[1]=g,h[2]=(65280&a.trackId)>>8,h[3]=255&a.trackId,h[4]=0,h.set(f,5),h},z=function(a){var b,c,d=null;return d=void 0!==a.contentProtection?new C.boxes.EncryptedAudioBox:new C.boxes.MP4AudioSampleEntryBox,d.reserved=[0,0,0,0,0,0],d.data_reference_index=1,d.reserved_2=[0,0],d.channelcount=a.channels,d.samplesize=16,d.pre_defined=0,d.reserved_3=0,d.samplerate=a.samplingRate<<16,b=new C.boxes.ESDBox,c=y(a),b.ES_tag=c[0],b.ES_length=c[1],b.ES_data=c.subarray(2,c.length),b.version=0,b.flags=0,d.boxes.push(b),void 0!==a.contentProtection&&d.boxes.push(u(a)),d},A=function(a){var b=a.codecs.substring(0,a.codecs.indexOf("."));switch(b){case"mp4a":return z(a);default:throw{name:v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:b}}}return null},B=function(a){var b=new C.boxes.SampleDescriptionBox;switch(b.version=0,b.flags=0,a.type){case"video":b.boxes.push(w(a));break;case"audio":b.boxes.push(A(a))}return b},D=function(a){var b=new C.boxes.SampleTableBox;return b.boxes.push(i(a)),b.boxes.push(j(a)),b.boxes.push(k(a)),b.boxes.push(l(a)),b.boxes.push(B(a)),b},E=function(){var a=new C.boxes.VideoMediaHeaderBox;return a.version=0,a.flags=1,a.graphicsmode=0,a.opcolor=[0,0,0],a},F=function(){var a=new C.boxes.SoundMediaHeaderBox;return a.version=0,a.balance=0,a.reserved=0,a.flags=1,a},G=function(){var a=new C.boxes.FileTypeBox;return a.major_brand=1769172790,a.minor_brand=1,a.compatible_brands=[],a.compatible_brands[0]=1769172845,a.compatible_brands[1]=1769172790,a.compatible_brands[2]=1836278888,a},H=function(a){var b,c,d,e=a[a.length-1];for(b=new C.boxes.MovieExtendsBox,d=0;d<a.length;d+=1)e=a[d],c=new C.boxes.TrackExtendsBox,c.version=0,c.flags=0,c.track_ID=e.trackId,c.default_sample_description_index=1,c.default_sample_duration=0,c.default_sample_flags=0,c.default_sample_size=0,b.boxes.push(c);return b},I=function(a){var b,c,d,e=[];for(d=0;d<a.length;d+=1)b=new Uint8Array(a[d].initData),c=new C.boxes.ProtectionSystemSpecificHeaderBox,c.read(b,8,b.length),e.push(c);return e},J=function(c){var d,e,f,g;for(d=new C.boxes.File,e=new C.boxes.MovieBox,e.boxes.push(a(c)),g=0;g<c.length;g+=1)e.boxes.push(b(c[g]));for(e.boxes.push(H(c)),g=0;g<c.length;g++)void 0!==c[g].contentProtection&&(f=this.protectionExt.getSupportedKeySystemsFromContentProtection(c[g].contentProtection),e.boxes.push.apply(e.boxes,I(f)));return d.boxes.push(G()),d.boxes.push(e),C.serialize(d)},K=function(a){var b=new C.boxes.MovieFragmentHeaderBox;return b.version=0,b.flags=0,b.sequence_number=a,b},L=function(a){var b=new C.boxes.TrackFragmentBox;return b.version=0,b.flags=0,b.boxes.push(M(a)),b.boxes.push(N(a)),b.boxes.push(O(a)),b},M=function(a){var b=new C.boxes.TrackFragmentHeaderBox;return b.version=0,b.flags=131072,b.track_ID=a.trackId,b},N=function(a){var b=new C.boxes.TrackFragmentBaseMediaDecodeTimeBox;return b.version=1,b.flags=0,b.baseMediaDecodeTime=a.samples.length>0?a.samples[0].dts:0,b},O=function(a){var b,c,d,e,f=new C.boxes.TrackFragmentRunBox;for(c=a.samples[0].cts,d=a.samples[0].duration>0?256:0,f.version=0,f.flags=1|d|512|("video"===a.type?2048:0),f.data_offset=0,f.samples_table=[],f.sample_count=a.samples.length,b=0;b<a.samples.length;b++)e={sample_duration:a.samples[b].duration,sample_size:a.samples[b].size,sample_composition_time_offset:a.samples[b].cts-a.samples[b].dts},e.sample_composition_time_offset<0&&(f.version=1),f.samples_table.push(e);return f},P=function(a){var b=new C.boxes.MediaDataBox;return b.data=a.data,b},Q=function(a,b){var c,d,e,f,g,h,i=0,j={},k=[],l=0;if(c=new C.boxes.File,d=new C.boxes.MovieFragmentBox,d.boxes.push(K(b)),a)for(e=0;e<a.length;e+=1)d.boxes.push(L(a[e]));if(c.boxes.push(d),f=c.getLength(),h=d.getBoxesByType("traf"),f+=8,a&&a.length&&(k=[a.length]),a)for(e=0;e<a.length;e+=1)h[e].getBoxByType("trun").data_offset=f,f+=a[e].data.length,k[e]=a[e].data,i+=k[e].length;for(j.data=new Uint8Array(i),e=0;e<k.length;e++)j.data.set(k[e],l),l+=k[e].length;return c.boxes.push(P(j)),g=C.serialize(c)};return{protectionExt:void 0,generateInitSegment:J,generateMediaSegment:Q}},v.dependencies.Mp4Processor.prototype={constructor:v.dependencies.Mp4Processor},v.dependencies.Notifier=function(){"use strict";var a,b="observableId",c=0,d=function(){return this[b]||(c+=1,this[b]="_id_"+c),this[b]};return{system:void 0,setup:function(){a=this.system,a.mapValue("notify",this.notify),a.mapValue("subscribe",this.subscribe),a.mapValue("unsubscribe",this.unsubscribe)},notify:function(){var b=arguments[0]+d.call(this),c=new v.vo.Event;c.sender=this,c.type=arguments[0],c.data=arguments[1],c.error=arguments[2],c.timestamp=(new Date).getTime(),a.notify.call(a,b,c)},subscribe:function(b,c,e,f){if(!e&&c[b]&&(e=c[b]=c[b].bind(c)),!c)throw"observer object cannot be null or undefined";if(!e)throw"event handler cannot be null or undefined";b+=d.call(this),a.mapHandler(b,void 0,e,f)},unsubscribe:function(b,c,e){e=e||c[b],b+=d.call(this),a.unmapHandler(b,void 0,e)}}},v.dependencies.Notifier.prototype={constructor:v.dependencies.Notifier},v.dependencies.Parser=function(){"use strict";var a=null,b=function(b,c){if(null===a)if(b.indexOf("SmoothStreamingMedia")>-1&&"undefined"!=typeof this.mssParser)this.system.notify("setContext","MSS"),a=this.mssParser;else if(b.indexOf("#EXTM3U")>-1&&"undefined"!=typeof this.hlsParser)this.system.notify("setContext","HLS"),a=this.hlsParser;else{if(!(b.indexOf("MPD")>-1&&"undefined"!=typeof this.dashParser))return o.reject("manifest cannot be parsed, protocol is unsupported!");this.system.notify("setContext","MPD"),a=this.dashParser}return a.parse(b,c)},c=function(){null!==a&&void 0!==a.abort&&a.abort()},d=function(){a=null};return{debug:void 0,system:void 0,dashParser:void 0,mssParser:void 0,hlsParser:void 0,metricsModel:void 0,parse:b,abort:c,reset:d}},v.dependencies.Parser.prototype={constructor:v.dependencies.Parser},v.dependencies.SourceBufferExtensions=function(){"use strict";this.system=void 0,this.manifestExt=void 0},v.dependencies.SourceBufferExtensions.prototype={constructor:v.dependencies.SourceBufferExtensions,createSourceBuffer:function(a,b){"use strict";var c=o.defer(),d=this;try{a?c.resolve(a.addSourceBuffer(b)):c.reject()}catch(e){d.manifestExt.getIsTextTrack(b)?"text/vtt"===b||"text/ttml"===b?c.resolve(d.system.getObject("textSourceBuffer")):"application/ttml+xml+mp4"===b?c.resolve(d.system.getObject("textTTMLXMLMP4SourceBuffer")):c.reject(e):c.reject(e)}return c.promise},removeSourceBuffer:function(a,b){"use strict";var c=o.defer();try{c.resolve(a.removeSourceBuffer(b))}catch(d){b&&"function"==typeof b.getTextTrackExtensions?c.resolve():c.reject(d.description)}return c.promise},getBufferRange:function(a,b,c){"use strict";var d,e,f=null,g=0,h=0,i=null,j=null,k=0,l=c||.01;try{f=a.buffered}catch(m){return null}if(f){for(e=0,d=f.length;d>e;e+=1)if(g=f.start(e),h=f.end(e),null===i){if(k=Math.abs(g-b),b>=g&&h>b){i=g,j=h;continue}if(l>=k){i=g,j=h;continue}}else{if(k=g-j,!(l>=k))break;j=h}if(null!==i)return{start:i,end:j}}return null},getAllRanges:function(a){var b=null;try{return b=a.buffered}catch(c){return null}},getBufferLength:function(a,b,c){"use strict";var d,e,f=this;return d=f.getBufferRange(a,b,c),e=null===d?0:d.end-b},waitForUpdateEnd:function(a){"use strict";var b,c=o.defer(),d=50,e=function(){a.updating||(clearInterval(b),c.resolve(!0))},f=function(){a.updating||(a.removeEventListener("updateend",f,!1),c.resolve(!0))};if(!a.updating)return c.resolve(!0),c.promise;if("function"==typeof a.addEventListener)try{a.addEventListener("updateend",f,!1)}catch(g){b=setInterval(e,d)}else b=setInterval(e,d);return c.promise},append:function(a,b,c){var d=o.defer(),e=this;return e.waitForUpdateEnd(a).then(function(){try{"append"in a?a.append(b):"appendBuffer"in a&&a.appendBuffer(b),c?d.resolve():e.waitForUpdateEnd(a).then(function(){d.resolve()})}catch(f){d.reject({err:f,data:b})}}),d.promise},remove:function(a,b,c,d,e,f){var g=o.defer(),h=this;return h.waitForUpdateEnd(a).then(function(){try{b>=0&&d>b&&c>b&&"ended"!==e.readyState&&a.remove(b,c),f?g.resolve():h.waitForUpdateEnd(a).then(function(){g.resolve()})}catch(i){g.reject(i)}}),g.promise},abort:function(a,b){"use strict";var c=o.defer();try{"open"===a.readyState&&b.abort(),c.resolve()}catch(d){c.reject(d.description)}return c.promise}},Math.sign||(Math.sign=function(a){return 0>a?-1:1}),v.dependencies.Stream=function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,p,q,r,s,t,u,w,x,y,z,A,B,C,D,E,F=null,G=null,H=null,I=null,J=-1,K=null,L=-1,M=null,N=!1,O=-1,P=!0,Q=!1,R=!1,S="und",T="und",U=null,V=-1,W="Stopped",X=1,Y=!1,Z=null,$=null,_=!1,aa=-1,ba=-1,ca=function(a){this.errHandler.sendError(a.data.code,a.data.message,a.data.data)},da=function(){Q&&(this.debug.info("[Stream] Play."),this.videoModel.play())},ea=function(){this.debug.info("[Stream] Pause."),this.videoModel.pause()},fa=function(a,b){Q&&(this.debug.info("[Stream] Seek: "+a),b===!0?(s=a,this.system.mapHandler("bufferUpdated",void 0,La.bind(this)),Ca.call(this,s)):this.videoModel.setCurrentTime(a))},ga=function(a){var b=o.defer(),c=this,d=function(){a.removeEventListener("sourceopen",d),a.removeEventListener("webkitsourceopen",d),b.resolve(a)};return a.addEventListener("sourceopen",d,!1),a.addEventListener("webkitsourceopen",d,!1),c.mediaSourceExt.attachMediaSource(a,c.videoModel),b.promise},ha=function(){var c=this,d=[],e=o.defer(),f=function(){I&&d.push(I.reset(R)),K&&d.push(K.reset(R)),M&&d.push(M.reset(R)),o.all(d).then(function(){Z&&(Z.reset(),Z=void 0),b&&c.mediaSourceExt.detachMediaSource(c.videoModel),Q=!1,H=null,I=null,K=null,M=null,F=null,G=null,b=null,a=null,e.resolve()})};return o.when($?$.promise:!0).then(function(){f()},function(){f()}),e.promise},ia=function(a,b,c){this.debug.log("[Stream] checkIfInitialized videoState="+a+" audioState="+b+" textTrackState="+c),null!==a&&null!==b&&null!==c&&("ready"===a&&"ready"===b&&"ready"===c?(D?D.init(H,G,F):H&&!this.capabilities.supportsEncryptedMedia()&&(this.errHandler.sendError(v.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS,"EME is not supported/enabled",null),$.reject()),$.resolve(!0)):("error"===a||"error"===b||"error"===c)&&$.reject())},ja=function(){var c=null,d=null,e=null,f=this;return $=o.defer(),Z=f.system.getObject("eventController"),f.manifestExt.getVideoData(a,U.index).then(function(g){return f.manifestExt.getDataIndex(g,a,U.index).then(function(a){J=a}),f.manifestExt.getCodec(g).then(function(a){return f.debug.info("[Stream] Video codec: "+a),F=a,f.capabilities.supportsCodec(f.videoModel.getElement(),a)?f.manifestExt.getContentProtectionData(g).then(function(c){return H=c,b?f.sourceBufferExt.createSourceBuffer(b,a):o.reject({code:v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"})}):o.reject({code:v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED,name:"NotSupportedError",message:"Codec not supported"})}).then(function(a){I=f.system.getObject("bufferController"),I.initialize("video",U,g,a,f.fragmentController,b,Z),c="ready",ia.call(f,c,d,e)},function(a){c="error",ia.call(f,c,d,e),a.code&&a.code===v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Video codec is not supported",{codec:F}):f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create video source buffer",new v.vo.Error(a.code,a.name,a.message))}),f.manifestExt.getSpecificAudioData(a,U.index,S)},function(){return c="error",ia.call(f,c,d,e),f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO,"No Video data in manifest"),o.reject()}).then(function(g){return f.manifestExt.getDataIndex(g,a,U.index).then(function(a){L=a}),f.manifestExt.getCodec(g).then(function(a){return f.debug.info("[Stream] Audio codec: "+a),G=a,f.capabilities.supportsCodec(f.videoModel.getElement(),a)?b?f.sourceBufferExt.createSourceBuffer(b,a):o.reject({code:v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"}):o.reject({code:v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED,name:"NotSupportedError",message:"Codec not supported"})}).then(function(a){K=f.system.getObject("bufferController"),K.initialize("audio",U,g,a,f.fragmentController,b,Z),d="ready",ia.call(f,c,d,e)},function(a){d="error",a.code&&a.code===v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Audio codec is not supported",{codec:G}):f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create audio source buffer",new v.vo.Error(a.code,a.name,a.message)),ia.call(f,c,d,e)}),f.manifestExt.getSpecificTextData(a,U.index,T)},function(){return d="ready",ia.call(f,c,d,e),"error"===c?o.reject():(f.debug.log("[Stream] No audio streams."),f.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO,"No audio data in manifest"),f.manifestExt.getSpecificTextData(a,U.index,T))}).then(function(g){var h;return f.manifestExt.getDataIndex(g,a,U.index).then(function(a){O=a}),f.manifestExt.getMimeType(g).then(function(a){return h=a,b?f.sourceBufferExt.createSourceBuffer(b,h):o.reject({code:v.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"})}).then(function(a){M=f.system.getObject("bufferController"),M.initialize("text",U,g,a,f.fragmentController,b),a.hasOwnProperty("initialize")&&a.initialize(h,M,g),e="ready",ia.call(f,c,d,e)},function(a){e="ready",M=null,ia.call(f,c,d,e),a.code&&a.code===v.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?f.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Text codec is not supported",{codec:F}):f.errHandler.sendWarning(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create text source buffer",new v.vo.Error(a.code,a.name,a.message))}),f.manifestExt.getEventsForPeriod(a,U)},function(){return e="ready",ia.call(f,c,d,e),"error"===c?o.reject():(f.debug.log("[Stream] No text tracks."),f.manifestExt.getEventsForPeriod(a,U))}).then(function(a){Z&&Z.addInlineEvents(a)}),$.promise},ka=function(){var a=this,c=o.defer();return a.manifestExt.getDuration(a.manifestModel.getValue(),U).then(function(c){return a.debug.log("[Stream] Setting duration: "+c),a.mediaSourceExt.setDuration(b,c)}).then(function(){Q=!0,c.resolve(!0)}),c.promise},la=function(){this.debug.info("[Stream] <video> loadedmetadata event")},ma=function(){this.debug.info("[Stream] <video> canplay event")},na=function(){this.debug.info("[Stream] <video> playing event"),aa=(new Date).getTime()/1e3,ba=this.getVideoModel().getCurrentTime()},oa=function(){this.debug.info("[Stream] <video> loadstart event")},pa=function(){this.debug.info("[Stream] <video> play event"),1!==X?this.setTrickModeSpeed(1):V>=0?(Ha.call(this,V),V=-1):Ca.call(this),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"play")},qa=function(){var a=this.videoModel.getElement(),b=0;(document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen)&&(b=1),this.metricsModel.addCondition(null,b,a.videoWidth,a.videoHeight)},ra=function(){this.debug.info("[Stream] <video> ended event"),this.metricsModel.addState("video","stopped",this.videoModel.getCurrentTime(),1)},sa=function(){this.debug.info("[Stream] <video> pause event"),aa=-1,ba=-1,this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"pause"),Fa.call(this)},ta=function(a){var b,c=a.srcElement.error,d="[Stream] <video> error: ";if(-1!==c.code){switch(c.code){case 1:b=v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED,d+="fetching process aborted";break;case 2:b=v.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK,d+="network error";break;case 3:b=v.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE,d+="media decoding error";break;case 4:b=v.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED,d+="media format not supported";break;case 5:b=v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,d+="media is encrypted"}R=!0,this.errHandler.sendError(b,d)}},ua=function(){var a=this.videoModel.getCurrentTime();return this.debug.info("[Stream] <video> seeking event: "+a),1!==X&&a.toFixed(3)!==C.toFixed(3)?void this.setTrickModeSpeed(1):(a=a<this.getStartTime()?this.getStartTime():a,void Ca.call(this,a))},va=function(){var a,b,c,d,e,f,g,h,j=this,k=.9,l=function(a,b){return j.videoModel.getCurrentTime()===j.getStartTime()||Y?void j.debug.log("[Stream] Trick mode (x"+X+"): stop"):(b<j.getStartTime()?b=j.getStartTime():b>=j.videoModel.getElement().duration&&(b=j.videoModel.getElement().duration-y,Y=!0),a>0&&j.debug.log("[Stream] Trick mode (x"+X+"): wait "+a.toFixed(3)+" s"),void(B=setTimeout(function(){A=(new Date).getTime()/1e3,j.debug.log("[Stream] Trick mode (x"+X+"): seek time = "+b.toFixed(3)),C=b,j.videoModel.setCurrentTime(b)},a>0?1e3*a:0)))};if(this.debug.info("[Stream] <video> seeked event"),Ea.call(this),1!==X){if(a=(new Date).getTime()/1e3,b=j.videoModel.getCurrentTime(),c=a-w,d=a-A,e=Math.abs(b-x),f=e/c,j.debug.log("[Stream] Trick mode (x"+X+"): elapsed time = "+c.toFixed(3)+", elapsed video time = "+e.toFixed(3)+", speed = "+f.toFixed(3)),"Changed"===W)clearTimeout(B),W="Running",w=(new Date).getTime()/1e3,x=b,j.debug.info("[Stream] Trick mode (x"+X+"): videoTime = "+x),z=Math.abs(u/X)>1?z/Math.abs(u/X):z,g=b+z*Math.sign(X),h=0;else if(f<Math.abs(X)*k){var m=Math.abs(X/f);z*=Math.round(m)+Math.round(m%y),j.debug.info("[Stream] Trick mode (x"+X+"): seek step = "+z),g=b+z*Math.sign(X),h=0}else g=b+z*Math.sign(X),h=Math.abs(g-x)/Math.abs(X)-c-d;l.call(j,h,g)}this.videoModel.listen("seeking",i),aa=-1,ba=-1},wa=function(){this.debug.info("[Stream] <video> progress event"),Ba.call(this)},xa=function(){this.debug.info("[Stream] <video> timeupdate event: "+this.videoModel.getCurrentTime()),Ba.call(this)},ya=function(){this.debug.info("[Stream] <video> durationchange event: "+this.videoModel.getElement().duration)},za=function(){this.debug.info("[Stream] <video> ratechange event: "+this.videoModel.getElement().playbackRate),I&&I.updateStalledState(),K&&K.updateStalledState(),M&&M.updateStalledState()},Aa=function(){ea.call(this),_=!0,this.system.notify("manifestUpdate",!0)},Ba=function(){I&&I.updateBufferLevel(!0),K&&K.updateBufferLevel(!0),M&&M.updateBufferLevel(!0)},Ca=function(a){this.debug.log("[Stream] startBuffering at time "+a),I&&(void 0===a?I.start():I.seek(a)),K&&(void 0===a?K.start():K.seek(a)),M&&N&&(void 0===a?M.start():M.seek(a))},Da=function(){this.debug.log("[Stream] stopBuffering"),I&&I.stop(),K&&K.stop(),M&&M.stop()},Ea=function(){I&&I.seeked(),K&&K.seeked(),M&&M.seeked()},Fa=function(){(!this.scheduleWhilePaused||this.manifestExt.getIsDynamic(a))&&Da.call(this),clearInterval(t)},Ga=function(c){var d=this;a=c,d.debug.log("[Stream] Create MediaSource");try{b=d.mediaSourceExt.createMediaSource()}catch(e){d.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE,"Failed to create MediaSource",{name:e.name,message:e.message})}null!==b&&(d.debug.log("[Stream] Setup MediaSource"),ga.call(d,b).then(function(a){return b=a,d.debug.log("[Stream] Initialize MediaSource"),ja.call(d)}).then(function(){return d.debug.log("[Stream] Initialize playback"),ka.call(d)}).then(function(){d.debug.log("[Stream] Playback initialized")}))},Ha=function(a){this.debug.log("[Stream] Set video model current time: "+a),this.videoModel.unlisten("seeking",i),this.videoModel.setCurrentTime(a)},Ia=function(){I&&!I.isBufferingCompleted()||K&&!K.isBufferingCompleted()||b&&(this.debug.info("[Stream] Signal end of stream"),this.mediaSourceExt.signalEndOfStream(b))},Ja=function(){Da.call(this)},Ka=function(a){this.debug.info("[Stream] Start time = "+a),fa.call(this,a,0===U.index&&P)},La=function(){var a,b,c,d=this;if(d.debug.info("[Stream] Check start time"),a=d.sourceBufferExt.getBufferRange(I.getBuffer(),s,2),null!==a){if(c=s,K){if(b=d.sourceBufferExt.getBufferRange(K.getBuffer(),s,2),null===b)return;if(d.debug.info("[Stream] Check start time: A["+b.start+"-"+b.end+"], V["+a.start+"-"+a.end+"]"),b.end<c)return;b.start>c&&(c=b.start)}d.debug.info("[Stream] Check start time: OK => "+c),d.system.unmapHandler("bufferUpdated"),d.videoModel.isPaused()?V=c:d.videoModel.setCurrentTime(c),da.call(d)}},Ma=function(b){var c,d,e,f,g=this,h=o.defer(),i=o.defer(),j=o.defer(),k=o.defer(),l=o.defer();return a=g.manifestModel.getValue(),U=b,g.debug.log("Manifest updated... set new data on buffers."),I?(c=I.getData(),d=c&&c.hasOwnProperty("id")?g.manifestExt.getDataForId(c.id,a,U.index):g.manifestExt.getDataForIndex(J,a,U.index),d.then(function(a){I.updateData(a,U),i.resolve()})):i.resolve(),K?(e=g.manifestExt.getDataForIndex(L,a,U.index),e.then(function(a){K.updateData(a,U),j.resolve()})):j.resolve(),M&&(f=g.manifestExt.getDataForIndex(O,a,U.index),f.then(function(a){M.updateData(a,U),k.resolve()})),Z&&g.manifestExt.getEventsForPeriod(a,U).then(function(a){Z.addInlineEvents(a),l.resolve()}),o.when(i.promise,j.promise,k.promise).then(function(){_&&I&&(_=!1,g.system.unmapHandler("bufferUpdated"),g.system.mapHandler("bufferUpdated",void 0,La.bind(g)),
I.load()),h.resolve()}),h.promise},Na=function(){var a=this.videoModel.getCurrentTime();M.seek(a)},Oa=function(){if(document.hidden!==!0&&-1!==aa){var a=(new Date).getTime()/1e3,b=this.getVideoModel().getCurrentTime(),c=a-aa,d=b-ba;this.debug.log("[Stream] VisibilityChange: elapsedClockTime = "+c+", elapsedStreamTime = "+d+" ("+(c-d)+")"),c-d>1&&Aa.call(this)}};return{system:void 0,videoModel:void 0,manifestLoader:void 0,manifestModel:void 0,mediaSourceExt:void 0,sourceBufferExt:void 0,manifestExt:void 0,fragmentController:void 0,fragmentExt:void 0,protectionExt:void 0,capabilities:void 0,debug:void 0,metricsExt:void 0,errHandler:void 0,timelineConverter:void 0,scheduleWhilePaused:void 0,metricsModel:void 0,eventBus:void 0,notify:void 0,setup:function(){this.system.mapHandler("bufferingCompleted",void 0,Ia.bind(this)),this.system.mapHandler("segmentLoadingFailed",void 0,Ja.bind(this)),this.system.mapHandler("startTimeFound",void 0,Ka.bind(this)),this.system.mapHandler("needForReload",void 0,Aa.bind(this)),this[v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR]=ca.bind(this),f=pa.bind(this),g=sa.bind(this),h=ta.bind(this),i=ua.bind(this),j=va.bind(this),m=wa.bind(this),n=za.bind(this),k=xa.bind(this),l=ya.bind(this),e=la.bind(this),p=ma.bind(this),q=na.bind(this),r=oa.bind(this),c=qa.bind(this),d=ra.bind(this),E=Oa.bind(this)},load:function(a,b){U=b,Ga.call(this,a)},setVideoModel:function(a){this.videoModel=a,this.videoModel.listen("play",f),this.videoModel.listen("pause",g),this.videoModel.listen("error",h),this.videoModel.listen("seeking",i),this.videoModel.listen("seeked",j),this.videoModel.listen("timeupdate",k),this.videoModel.listen("durationchange",l),this.videoModel.listen("progress",m),this.videoModel.listen("ratechange",n),this.videoModel.listen("loadedmetadata",e),this.videoModel.listen("ended",d),this.videoModel.listen("canplay",p),this.videoModel.listen("playing",q),this.videoModel.listen("loadstart",r),this.videoModel.listen("webkitfullscreenchange",c),this.videoModel.listen("fullscreenchange",c),this.videoModel.listenOnParent("fullscreenchange",c),this.videoModel.listenOnParent("webkitfullscreenchange",c)},setAudioTrack:function(a){var b=this.manifestModel.getValue(),c=this;K&&c.manifestExt.getDataIndex(a,b,U.index).then(function(a){-1!==L&&a!==L&&(L=a,c.system.notify("manifestUpdate"))})},getSelectedAudioTrack:function(){var a=this,b=a.manifestModel.getValue();return K?a.manifestExt.getDataForIndex_(L,b,U.index):void 0},setSubtitleTrack:function(a){var b=o.defer(),c=this.manifestModel.getValue(),d=this;return M?d.manifestExt.getDataIndex(a,c,U.index).then(function(a){O=a,d.system.notify("manifestUpdate")}):b.reject(),b.promise},getSelectedSubtitleTrack:function(){var a=this,b=a.manifestModel.getValue();return M?a.manifestExt.getDataForIndex_(O,b,U.index):void 0},initProtection:function(a){D=a,D&&D.subscribe(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,this)},getVideoModel:function(){return this.videoModel},getManifestExt:function(){var a=this;return a.manifestExt},setAutoPlay:function(a){P=a},setDefaultAudioLang:function(a){S=a},setDefaultSubtitleLang:function(a){T=a},getAutoPlay:function(){return P},reset:function(){var a=o.defer(),b=this;return this.debug.info("[Stream] Reset"),Da.call(this),ea.call(this),clearTimeout(B),b.videoModel.setMute(!1),this.videoModel.unlisten("play",f),this.videoModel.unlisten("pause",g),this.videoModel.unlisten("error",h),this.videoModel.unlisten("seeking",i),this.videoModel.unlisten("seeked",i),this.videoModel.unlisten("timeupdate",k),this.videoModel.unlisten("durationchange",l),this.videoModel.unlisten("progress",m),this.videoModel.unlisten("ratechange",n),this.videoModel.unlisten("loadedmetadata",e),this.videoModel.unlisten("ended",d),this.videoModel.unlisten("canplay",p),this.videoModel.unlisten("playing",q),this.videoModel.unlisten("loadstart",r),this.videoModel.unlisten("webkitfullscreenchange",c),this.videoModel.unlisten("fullscreenchange",c),this.videoModel.unlistenOnParent("fullscreenchange",c),this.videoModel.unlistenOnParent("webkitfullscreenchange",c),this.system.unmapHandler("bufferUpdated"),this.system.unmapHandler("liveEdgeFound"),this.system.unmapHandler("bufferingCompleted"),this.system.unmapHandler("segmentLoadingFailed"),this.system.unmapHandler("needForReload"),this.system.unmapHandler("streamsComposed",void 0,Na),ha.call(this).then(function(){D&&D.unsubscribe(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,b),D=void 0,b.fragmentController=void 0,a.resolve()}),a.promise},getDuration:function(){return U.duration},getStartTime:function(){return U.start},getPeriodIndex:function(){return U.index},getId:function(){return U.id},getPeriodInfo:function(){return U},startEventController:function(){Z.start()},resetEventController:function(){Z.reset()},enableSubtitles:function(a){a!==N&&(N=a,M&&(a?(this.system.mapHandler("streamsComposed",void 0,Na.bind(this),!0),this.system.notify("manifestUpdate")):M.stop()))},setTrickModeSpeed:function(a){var b,c,d=[],e=this,f=1!==a?!0:!1,g=function(){e.videoModel.getCurrentTime()>b+1&&(e.videoModel.unlisten("timeupdate",g),e.debug.info("[Stream] Set mute: false"),e.videoModel.setMute(!1))};a!==X&&I&&(e.debug.info("[Stream] Trick mode: speed = "+a),f&&"Stopped"===W?(e.debug.info("[Stream] Set mute: true"),e.videoModel.setMute(!0),e.videoModel.pause()):f||(X=1,clearTimeout(B),Da.call(e)),d.push(I.setTrickMode(f)),K&&d.push(K.setTrickMode(f)),o.all(d).then(function(){u=X,X=a,b=e.videoModel.getCurrentTime(),f?"Running"===W?W="Changed":"Stopped"===W&&(Y=!1,W="Running",z=y=I.getLastDownloadedSegmentDuration(),w=A=(new Date).getTime()/1e3,x=b,e.debug.info("[Stream] Trick mode (x"+X+"): videoTime = "+x),c=b+z*Math.sign(X),e.debug.info("[Stream] Trick mode (x"+X+"): seek step = "+z),C=c,fa.call(e,c)):(e.debug.info("[Stream] Trick mode: Stopped, current time = "+b),W="Stopped",e.videoModel.listen("timeupdate",g),b=Y?e.getStartTime():b,fa.call(e,Y?e.getStartTime():b,!0))}))},getTrickModeSpeed:function(){return X},updateData:Ma,play:da,seek:fa,pause:ea}},v.dependencies.Stream.prototype={constructor:v.dependencies.Stream},v.dependencies.StreamController=function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k=[],l=!1,m=6,n=.2,p=!0,q=!1,r="und",s="und",t=!1,u=!1,w=function(a,b){var c=a.getElement(),d=b.getElement();return d.parentNode||c.parentNode.insertBefore(d,c),c.style.width="0px",d.style.width="100%",z(c,d),y.call(this,a),x.call(this,b),o.when(!0)},x=function(a){a.listen("seeking",d),a.listen("progress",e),a.listen("timeupdate",c),a.listen("pause",f),a.listen("play",g)},y=function(a){a.unlisten("seeking",d),a.unlisten("progress",e),a.unlisten("timeupdate",c),a.unlisten("pause",f),a.unlisten("play",g)},z=function(a,b){["controls","loop","muted","playbackRate","volume"].forEach(function(c){b[c]=a[c]})},A=function(){var b=a.getVideoModel().getElement().buffered;if(b.length){var c=b.length-1,d=b.end(c),f=a.getStartTime()+a.getDuration()-d;m>f&&(a.getVideoModel().unlisten("progress",e),F())}},B=function(){var b=a.getStartTime()+a.getDuration(),c=a.getVideoModel().getCurrentTime(),d=this,e=a.getVideoModel().getElement(),f=d.videoExt.getPlaybackQuality(e),g=((new Date).getTime()-d.startPlayingTime)/1e3;d.metricsModel.addCondition(null,null,e.videoWidth,e.videoHeight,f.droppedVideoFrames,f.totalVideoFrames/g),G()&&(a.getVideoModel().getElement().seeking||n>b-c&&K.call(this,a,G()))},C=function(){var b=a.getVideoModel().getCurrentTime(),c=H(b);this.metricsModel.addState("video","seeking",a.getVideoModel().getCurrentTime()),c&&c!==a&&K.call(this,a,c,b)},D=function(){this.manifestUpdater.stop(),this.metricsModel.addState("video","paused",a.getVideoModel().getCurrentTime())},E=function(){this.manifestUpdater.start(),void 0===this.startPlayingTime&&(this.startPlayingTime=(new Date).getTime());var b=a.getVideoModel().getElement();this.metricsModel.addCondition(null,0,b.videoWidth,b.videoHeight)},F=function(){var a=G();a&&a.seek(a.getStartTime())},G=function(){var b=a.getPeriodIndex()+1;return b<k.length?k[b]:null},H=function(a){var b=0,c=null,d=k.length,e=0;for(d>0&&(b+=k[0].getStartTime()),e=0;d>e;e+=1)if(c=k[e],b+=c.getDuration(),b>a)return c},I=function(){var a=this.system.getObject("videoModel"),b=document.createElement("video");return a.setElement(b),a},J=function(a){a.parentNode&&a.parentNode.removeChild(a)},K=function(b,c,d){!q&&b&&c&&b!==c&&(q=!0,b.pause(),a=c,w.call(this,b.getVideoModel(),c.getVideoModel()),d?seek(b.getVideoModel().getCurrentTime()):seek(c.getStartTime()),play(),b.resetEventController(),a.startEventController(),q=!1)},L=function(){var c,d,e,f,g,h,i,m=this,n=m.manifestModel.getValue(),q=m.metricsModel.getMetricsFor("stream"),u=m.metricsExt.getCurrentManifestUpdate(q),v=o.defer(),w=[];return m.startPlayingTime=void 0,n?(m.capabilities.supportsEncryptedMedia()&&(b||(b=m.system.getObject("protectionController"),l=!0),b.setMediaElement(m.videoModel.getElement()),j&&b.setProtectionData(j)),m.manifestExt.getMpd(n).then(function(j){a&&(c=a.getPeriodInfo(),j.isClientServerTimeSyncCompleted=c.mpd.isClientServerTimeSyncCompleted,j.clientServerTimeShift=c.mpd.clientServerTimeShift),m.manifestExt.getRegularPeriods(n,j).then(function(c){if(0===c.length)return v.reject();for(f=0,d=c.length;d>f;f+=1){for(h=c[f],g=0,e=k.length;e>g;g+=1)k[g].getId()===h.id&&(i=k[g],w.push(i.updateData(h)));i||(i=m.system.getObject("stream"),i.setVideoModel(0===f?m.videoModel:I.call(m)),i.initProtection(b),i.setAutoPlay(p),i.setDefaultAudioLang(r),i.setDefaultSubtitleLang(s),i.enableSubtitles(t),i.load(n,h),k.push(i)),m.metricsModel.addManifestUpdatePeriodInfo(u,h.id,h.index,h.start,h.duration),i=null}a||(a=k[0],x.call(m,a.getVideoModel())),m.metricsModel.updateManifestUpdateInfo(u,{currentTime:m.videoModel.getCurrentTime(),buffered:m.videoModel.getElement().buffered,presentationStartTime:c[0].start,clientTimeOffset:j.clientServerTimeShift}),o.all(w).then(function(){v.resolve()})})}),v.promise):o.when(!1)},M=function(){if(a){var b=this;b.manifestExt.getAudioDatas(b.manifestModel.getValue(),a.getPeriodIndex()).then(function(a){h=a,b.system.notify("audioTracksUpdated")},function(){h=null,b.system.notify("audioTracksUpdated")})}},N=function(){if(a){var b=this;b.manifestExt.getTextDatas(b.manifestModel.getValue(),a.getPeriodIndex()).then(function(a){i=a,b.system.notify("subtitleTracksUpdated")},function(){i=null,b.system.notify("subtitleTracksUpdated")})}},O=function(a){a===!0&&(u=!0),this.refreshManifest()},P=function(){var a=this;L.call(a).then(function(){M.call(a),N.call(a),a.system.notify("streamsComposed")},function(){a.errHandler.sendError(v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM,"No stream/period is provided in the manifest"),a.reset()})};return{system:void 0,videoModel:void 0,parser:void 0,manifestLoader:void 0,manifestUpdater:void 0,manifestModel:void 0,manifestExt:void 0,fragmentExt:void 0,capabilities:void 0,debug:void 0,metricsModel:void 0,metricsExt:void 0,videoExt:void 0,errHandler:void 0,eventBus:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,startTime:void 0,startPlayingTime:void 0,currentURL:void 0,setup:function(){this.system.mapHandler("manifestUpdate",void 0,O.bind(this)),this.system.mapHandler("manifestUpdated",void 0,P.bind(this)),c=B.bind(this),e=A.bind(this),d=C.bind(this),f=D.bind(this),g=E.bind(this)},getManifestExt:function(){return a.getManifestExt()},setAutoPlay:function(a){p=a},getAutoPlay:function(){return p},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getAudioTracks:function(){return h},getSelectedAudioTrack:function(){return a?a.getSelectedAudioTrack():void 0},setAudioTrack:function(b){a&&a.setAudioTrack(b)},getSubtitleTracks:function(){return i},setSubtitleTrack:function(b){a&&a.setSubtitleTrack(b)},getSelectedSubtitleTrack:function(){return a?a.getSelectedSubtitleTrack():void 0},load:function(a,b){var c=this;c.currentURL=a,b&&(j=b),c.debug.info("[StreamController] load url: "+a),u=!1,c.manifestLoader.load(a).then(function(a){c.manifestModel.setValue(a),c.metricsModel.addMetaData(),c.debug.info("[StreamController] Manifest has loaded."),c.manifestUpdater.start()},function(a){a&&c.errHandler.sendError(a.name,a.message,a.data)})},refreshManifest:function(a){var b=this.manifestModel.getValue(),c=a?a:b.hasOwnProperty("Location")?b.Location:b.mpdUrl;this.debug.log("### Refresh manifest @ "+c);var d=this;this.manifestLoader.abort(),this.manifestLoader.load(c,!0).then(function(a){d.manifestModel.setValue(a),d.debug.log("### Manifest has been refreshed."),u=!1},function(b){void 0!==b&&(a?u&&d.errHandler.sendError(b.name,b.message,b.data):(d.errHandler.sendWarning(b.name,b.message,b.data),d.eventBus.dispatchEvent({type:"manifestUrlUpdate",data:{url:c}})))})},reset:function(){var c={},d=[],e=this;this.debug.info("[StreamController] Reset"),a&&y.call(this,a.getVideoModel()),this.pause(),this.manifestUpdater.stop(),this.manifestLoader.abort(),this.parser.reset(),this.metricsModel.clearAllCurrentMetrics(),q=!1,c[v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]=function(){var c,f,g=0;for(l=!1,b=null,j=null,g=0,c=k.length;c>g;g+=1)f=k[g],d.push(f.reset()),f!==a&&J(f.getVideoModel().getElement()),delete k[g];e.videoModel.reset(),o.all(d).then(function(){k=[],a=null,e.notify(v.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE)}),e.manifestModel.setValue(null)},b?l?(b.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,c,void 0,!0),b.teardown()):(b.setMediaElement(null),c[v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()):c[v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()},setDefaultAudioLang:function(a){r=a},setDefaultSubtitleLang:function(a){s=a},enableSubtitles:function(b){t=b,a&&a.enableSubtitles(b)},setTrickModeSpeed:function(b){a&&a.setTrickModeSpeed(b)},getTrickModeSpeed:function(){return a?a.getTrickModeSpeed():0},play:function(){a.play()},pause:function(){a&&a.pause()},seek:function(b){a&&a.seek(b)}}},v.dependencies.StreamController.prototype={constructor:v.dependencies.StreamController},v.dependencies.StreamController.eventList={ENAME_STREAMS_COMPOSED:"streamsComposed",ENAME_TEARDOWN_COMPLETE:"streamTeardownComplete"},v.utils.TokenAuthentication=function(){"use strict";var a={type:v.utils.TokenAuthentication.TYPE_QUERY};return{debug:void 0,getTokenAuthentication:function(){return a},setTokenAuthentication:function(b){a=b},checkRequestHeaderForToken:function(b){void 0!==a.name&&null!==b.getResponseHeader(a.name)&&(a.token=b.getResponseHeader(a.name),this.debug.log(a.name+" received: "+a.token))},addTokenAsQueryArg:function(b){if(void 0!==a.name&&void 0!==a.token&&a.type===v.utils.TokenAuthentication.TYPE_QUERY){var c=-1===b.indexOf("?")?"?":"&";b+=c+a.name+"="+a.token,this.debug.log(a.name+" is being appended on the request url with a value of : "+a.token)}return b},setTokenInRequestHeader:function(b){return a.type===v.utils.TokenAuthentication.TYPE_HEADER&&(b.setRequestHeader(a.name,a.token),this.debug.log(a.name+" is being set in the request header with a value of : "+a.token)),b}}},v.utils.TokenAuthentication.TYPE_QUERY="query",v.utils.TokenAuthentication.TYPE_HEADER="header",v.models.URIQueryAndFragmentModel=function(){"use strict";var a=new v.vo.URIFragmentData,b=[],c=function(){a=new v.vo.URIFragmentData,b=[]},d=function(c){function d(a,b,c,d){var e=d[0].split(/[=]/);return d.push({key:e[0],value:e[1]}),d.shift(),d}function e(a,c,d){return c>0&&(j&&0===b.length?b=d[c].split(/[&]/):k&&(g=d[c].split(/[&]/))),d}var f,g=[],h=new RegExp(/[?]/),i=new RegExp(/[#]/),j=h.test(c),k=i.test(c);return f=c.split(/[?#]/).map(e),b.length>0&&(b=b.reduce(d,null)),g.length>0&&(g=g.reduce(d,null),g.forEach(function(b){a[b.key]=b.value})),c};return{parseURI:d,reset:c,getURIFragmentData:function(){return a},getURIQueryData:b}},v.models.URIQueryAndFragmentModel.prototype={constructor:v.models.URIQueryAndFragmentModel},v.models.VideoModel=function(){"use strict";var a,b={},c=function(){for(var a in b)if(b[a]===!0)return!0;return!1},d=function(d,e){b[d]=e,c()?a.playbackRate=0:a.playbackRate=1};return{system:void 0,setup:function(){},reset:function(){b=[]},play:function(){a.play()},pause:function(){a.pause()},isPaused:function(){return a.paused},isSeeking:function(){return a.seeking},getPlaybackRate:function(){return a.playbackRate},setPlaybackRate:function(b){a.playbackRate=b},getMute:function(){return a.muted},setMute:function(b){a.muted=b},getCurrentTime:function(){return a.currentTime},setCurrentTime:function(b){a.currentTime=b},listen:function(b,c){a.addEventListener(b,c,!1)},unlisten:function(b,c){a.removeEventListener(b,c,!1)},listenOnParent:function(b,c){a.parentElement.addEventListener(b,c,!1)},unlistenOnParent:function(b,c){a.parentElement.removeEventListener(b,c,!1)},getElement:function(){return a},setElement:function(b){a=b},setSource:function(b){a.src=b},isStalled:function(){return 0===a.playbackRate},stallStream:d}},v.models.VideoModel.prototype={constructor:v.models.VideoModel},v.dependencies.VideoModelExtensions=function(){"use strict";return{getPlaybackQuality:function(a){var b="webkitDroppedFrameCount"in a,c="getVideoPlaybackQuality"in a,d=null;return c?d=a.getVideoPlaybackQuality():b&&(d={droppedVideoFrames:a.webkitDroppedFrameCount,creationTime:new Date,totalVideoFrames:a.webkitDecodedFrameCount}),d}}},v.dependencies.VideoModelExtensions.prototype={constructor:v.dependencies.VideoModelExtensions},v.dependencies.TextController=function(){var a,b,c,d,e="LOADING",f="READY",g=!1,h=null,i=f,j=function(a){this.debug.log("TextController setState to:"+a),i=a},k=function(){if(g&&i===f){var a=this;a.indexHandler.getInitRequest(d[0]).then(function(b){a.fragmentLoader.load(b).then(n.bind(a,b),p.bind(a,b)),j.call(a,e)})}},l=function(){k.call(this)},m=function(a,b){var c=this,d=o.defer(),e=c.manifestModel.getValue();return c.manifestExt.getDataIndex(a,e,b.index).then(function(a){c.manifestExt.getAdaptationsForPeriod(e,b).then(function(b){c.manifestExt.getRepresentationsForAdaptation(e,b[a]).then(function(a){d.resolve(a)})})}),d.promise},n=function(a,b){var d=this;d.fragmentController.process(b.data,a).then(function(a){null!==a&&d.sourceBufferExt.append(c,a,d.videoModel)})},p=function(){};return{videoModel:void 0,fragmentLoader:void 0,fragmentController:void 0,indexHandler:void 0,sourceBufferExt:void 0,manifestModel:void 0,manifestExt:void 0,debug:void 0,initialize:function(a,b,c,d,e){var f=this;f.setVideoModel(d),f.setBuffer(c),f.setMediaSource(e),f.updateData(b,a).then(function(){g=!0,k.call(f)})},setPeriodInfo:function(a){h=a},getPeriodIndex:function(){return h.index},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getData:function(){return b},setData:function(a){b=a},getBuffer:function(){return c},setBuffer:function(a){c=a},setMediaSource:function(b){a=b},updateData:function(a,c){var e=this,g=o.defer();return b=a,h=c,m.call(e,b,h).then(function(a){d=a,j.call(e,f),k.call(e),g.resolve()}),g.promise},reset:function(b){b||(this.sourceBufferExt.abort(a,c),this.sourceBufferExt.removeSourceBuffer(a,c))},start:l}},v.dependencies.TextController.prototype={constructor:v.dependencies.TextController},v.dependencies.TextSourceBuffer=function(){var a,b,c;return{system:void 0,eventBus:void 0,errHandler:void 0,initialize:function(d,e){c=d,a=e.getVideoModel().getElement(),b=e.getData()},append:function(c){var d=this,e=String.fromCharCode.apply(null,new Uint16Array(c));d.getParser().parse(e).then(function(c){var e=b.Representation_asArray[0].id,f=b.lang;d.getTextTrackExtensions().addTextTrack(a,c,e,f,!0).then(function(){d.eventBus.dispatchEvent({type:"updateend"})})},function(a){d.errHandler.sendError(v.dependencies.ErrorHandler.prototype.CC_ERR_PARSE,a,e)})},abort:function(){this.getTextTrackExtensions().deleteCues(a)},getParser:function(){var a;return"text/vtt"===c?a=this.system.getObject("vttParser"):"application/ttml+xml"===c&&(a=this.system.getObject("ttmlParser")),a},getTextTrackExtensions:function(){return this.system.getObject("textTrackExtensions")},addEventListener:function(a,b,c){this.eventBus.addEventListener(a,b,c)},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)}}},v.dependencies.TextSourceBuffer.prototype={constructor:v.dependencies.TextSourceBuffer},v.utils.TextTrackExtensions=function(){"use strict";var a;return{eventBus:void 0,config:void 0,setup:function(){a=window.VTTCue||window.TextTrackCue},cueEnter:function(a,b){this.eventBus.dispatchEvent({type:"cueEnter",data:{text:b,style:a}})},cueExit:function(a,b){this.eventBus.dispatchEvent({type:"cueExit",data:{text:b,style:a}})},addTextTrack:function(b,c,d,e,f){var g,h=null,i=null,j="subtitles";for(0===b.textTracks.length?(j=this.config.getParam("TextTrackExtensions.displayModeExtern","boolean")===!0?"metadata":"subtitles",h=b.addTextTrack(j,d,e),h["default"]=f,h.mode="showing"):h=b.textTracks[0],g=0;g<c.length;g+=1)i=c[g],h.addCue(new a(i.start,i.end,i.data));return o.when(h)},onCueEnter:function(a){this.cueEnter(a.currentTarget.style,a.currentTarget.text)},onCueExit:function(a){this.cueExit(a.currentTarget.style,a.currentTarget.text)},addCues:function(b,c){var d=0,e=null,f=null;for(d=0;d<c.length;d+=1)e=c[d],e.start<e.end&&(f=new a(e.start,e.end,e.data),f.onenter=this.onCueEnter.bind(this),f.onexit=this.onCueExit.bind(this),f.snapToLines=!1,f.line=e.line,e.style&&(f.style=e.style),b.addCue(f))},deleteCues:function(a,b,c,d){var e=null,f=null,g=null,h=0;if(a&&(e=a.textTracks[0])){if(f=e.cues)for(g=f.length-1,h=g;h>=0;h-=1)(void 0===d||-1===d||f[h].endTime<d)&&(void 0===c||-1===c||f[h].startTime>c)&&e.removeCue(f[h]);b&&(e.mode="disabled")}}}},v.dependencies.TextTTMLXMLMP4SourceBuffer=function(){var a,b,c,d,e={length:0,ranges:[],start:function(a){return this.ranges[a].start},end:function(a){return this.ranges[a].end},addRange:function(a,b){var c=0,d=!1,e=.01;for(c=0;c<this.ranges.length;c++)this.ranges[c].end<=a+e&&this.ranges[c].end>=a-e&&(d=!0,this.ranges[c].end=b),this.ranges[c].start<=b+e&&this.ranges[c].start>=b-e&&(d=!0,this.ranges[c].start=a);d||(this.ranges.push({start:a,end:b}),this.length=this.length+1,this.ranges.sort(function(a,b){return a.start-b.start}))},removeRange:function(a,b){var c=0;for(c=this.ranges.length-1;c>=0;c-=1)(void 0===b||-1===b||this.ranges[c].end<=b)&&(void 0===a||-1===a||this.ranges[c].start>=a)&&this.ranges.splice(c,1);this.length=this.ranges.length},reset:function(){this.length=0,this.ranges=[]}};return{updating:!1,system:void 0,eventBus:void 0,buffered:e,textTrackExtensions:void 0,ttmlParser:void 0,debug:void 0,initialize:function(f,g,h){b=f,a=g.getVideoModel().getElement(),e.reset(),c=h.lang,d=h.id},remove:function(b,c){if(0>b||b>=c)throw"INVALID_ACCESS_ERR";this.getTextTrackExtensions().deleteCues(a,!1,b,c),this.buffered.removeRange(b,c)},append:function(b){var e,f,g,h,i,j,k,l,m=this,n=C.deserialize(b),o=n.getBoxByType("moov"),p=0,q="utf-8";return o?(e=o.getBoxByType("mvhd"),m.timescale=e.timescale,void m.textTrackExtensions.addTextTrack(a,[],d,c,!0).then(function(a){m.track=a,m.eventBus.dispatchEvent({type:"updateend"})})):(f=n.getBoxByType("moof"),void(f&&(g=n.getBoxByType("mdat"),h=f.getBoxByType("traf"),i=h.getBoxByType("tfhd"),j=h.getBoxByType("tfdt"),k=h.getBoxByType("trun"),l=j.baseMediaDecodeTime/m.timescale,p=0,p=256&k.flags?k.samples_table[0].sample_duration/m.timescale:i.default_sample_duration/m.timescale,m.buffered.addRange(l,l+p),m.isUTF16(g.data)&&(q="utf-16"),m.convertUTFToString(g.data,q).then(function(a){m.ttmlParser.parse(a).then(function(a){var b;if(a){for(b=0;b<a.length;b+=1)a[b].start=a[b].start+l,a[b].end=a[b].end+l;m.textTrackExtensions.addCues(m.track,a),m.eventBus.dispatchEvent({type:"updateend"})}},function(a){})}))))},convertUTFToString:function(a,b){var c=o.defer(),d=new Blob([a],{type:"text/xml"}),e=new FileReader;return e.onload=function(a){c.resolve(a.target.result)},e.readAsText(d,b),c.promise},isUTF16:function(a){var b,c,d,e,f=0,g=a&&a.length,h=null;if(2>g){if(a[0]>255)return!1}else{if(b=a[0],c=a[1],255===b&&254===c)return!0;if(254===b&&255===c)return!0;for(;g>f;f++){if(0===a[f]){h=f;break}if(a[f]>255)return!1}if(null===h)return!1;if(d=a[h+1],void 0!==d&&d>0&&128>d)return!0;if(e=a[h-1],void 0!==e&&e>0&&128>e)return!0}return!1},abort:function(){this.getTextTrackExtensions().deleteCues(a,!0)},getTextTrackExtensions:function(){return this.textTrackExtensions},addEventListener:function(a,b,c){this.eventBus.addEventListener(a,b,c),this.updating||this.eventBus.dispatchEvent({type:"updateend"})},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)}}},v.dependencies.TextTTMLXMLMP4SourceBuffer.prototype={constructor:v.dependencies.TextTTMLXMLMP4SourceBuffer},v.utils.TTMLParser=function(){"use strict";var a=3600,b=60,c="http://www.w3.org/2006/10/ttaf1",d="http://www.w3.org/2006/10/ttaf1#parameter",e="http://www.w3.org/2006/10/ttaf1#styling",f="http://www.w3.org/ns/ttml",g="http://www.w3.org/ns/ttml#parameter",h="http://www.w3.org/ns/ttml#styling",i="",j="",k="",l=/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])((\.[0-9][0-9][0-9])|(:[0-9][0-9]))$/,m=/^\d+(\.\d+|)(h|m|s|ms|f)$/,n=null,p=null,q=null,r=null,s=null,t=null,u=null,v=[],w=[],x=function(c){var d,e,f;if(l.test(c))return d=c.split(":"),e=parseFloat(d[0])*a+parseFloat(d[1])*b+parseFloat(d[2]),d[3]&&u&&!isNaN(u)&&(e+=parseFloat(d[3])/u),e;if(m.test(c)){switch("ms"==c.substr(c.length-2)?(e=parseFloat(c.substr(0,c.length-3)),f=c.substr(c.length-2)):(e=parseFloat(c.substr(0,c.length-2)),f=c.substr(c.length-1)),f){case"h":e=60*e*60;break;case"m":e=60*e;break;case"s":break;case"ms":e=.01*e;break;case"f":if(!u||isNaN(u))return NaN;e/=u}return e}return NaN},y=function(){var a=!1;return p=n?this.domParser.getChildNode(n,"tt"):null,q=p?this.domParser.getChildNode(p,"head"):null,r=q?this.domParser.getChildNode(q,"layout"):null,s=q?this.domParser.getChildNode(q,"styling"):null,t=p?this.domParser.getChildNode(p,"body"):null,p&&q&&r&&s&&t&&(a=!0),a},z=function(a,b){var c,d,e=0,f=0,g=0,h=0,k=0,l=0,m=0;for(f=0;f<a.length;f+=1){for(g=0;g<j.length;g+=1)if(c=this.domParser.getAttributeValue(a[f],j[g]+b))return c;for(g=0;g<i.length;g+=1)if(c=this.domParser.getAttributeValue(a[f],i[g]+"style"))for(e=0;e<v[c].length;e+=1)for(h=0;h<j.length;h+=1)if(v[c][e].name===j[h]+b)return v[c][e].nodeValue;for(g=0;g<i.length;g+=1)if(d=this.domParser.getAttributeValue(a[f],i[g]+"region"))for(e=0;e<w[d].length;e+=1){for(h=0;h<j.length;h+=1)if(w[d][e].name===j[h]+b)return w[d][e].nodeValue;for(k=0;k<i.length;k+=1)if(c=w[d][e].nodeName===i[k]+"style"?w[d][e].nodeValue:null)for(l=0;l<v[c].length;l+=1)for(m=0;m<j.length;m+=1)if(v[c][l].name===j[m]+b)return v[c][l].nodeValue}}return null},A=function(a,b){var c=null,d=0,e=0;for(d=0;d<a.length;d++)for(e=0;e<k.length;e+=1)if(c=this.domParser.getAttributeValue(a[d],k[e]+b))return c;return c},B=function(a,b){var i=null,j=null,k=null,l=0;switch(b){case"style":j=e,k=h;break;case"parameter":j=d,k=g;break;case"main":j=c,k=f}if(j&&k&&(i=this.domParser.getAttributeName(a,j),0===i.length&&(i=this.domParser.getAttributeName(a,k)),i.length>0))for(l=0;l<i.length;l+=1)i[l]=i[l].split(":").length>1?i[l].split(":")[1]+":":"";return i},C=function(a,b){var c=NaN,d=0;for(d=0;d<i.length&&isNaN(c);d+=1)c=x(this.domParser.getAttributeValue(a,i[d]+b));return c},D=function(a){var b,c,d,e,f,g,h,l,m,q,r,s,x,D,E=[],F=null,G=null,H={backgroundColor:null,color:null,fontSize:null,fontFamily:null};try{if(n=this.domParser.createXmlTree(a),!y.call(this))return b="TTML document has incorrect structure",o.reject(b);for(i=B.call(this,p,"main"),k=B.call(this,p,"parameter"),j=B.call(this,p,"style"),l=0;l<k.length;l+=1)u=this.domParser.getAttributeValue(p,k[l]+"frameRate")?parseInt(u,10):null;if(h=this.domParser.getChildNodes(t,"div"),!h||0===h.length)return b="TTML body document does not contain any div",o.reject(b);for(r=0;r<h.length;r+=1){if(c=this.domParser.getChildNodes(h[r],"p"),!c||0===c.length)return b="TTML document does not contain any cues",o.reject(b);for(v=this.domParser.getAllSpecificNodes(p,"style"),w=this.domParser.getAllSpecificNodes(p,"region"),l=0;l<c.length;l+=1){if(g=null,d=c[l],i=i.concat(B.call(this,d,"main")),j=j.concat(B.call(this,d,"style")),e=C.call(this,d,"begin"),f=C.call(this,d,"end"),isNaN(e)||isNaN(f))return b="TTML document has incorrect timing value",o.reject(b);if(m=this.domParser.getChildNodes(d,"span"),m.length>0){for(q=0;q<m.length;q++)H.backgroundColor=z.call(this,[m[q],d,h],"backgroundColor"),H.color=z.call(this,[m[q],d,h],"color"),H.fontSize=z.call(this,[m[q],d,h],"fontSize"),H.fontFamily=z.call(this,[m[q],d,h],"fontFamily"),D=z.call(this,[m[q],d,h],"extent"),H.fontSize&&"%"===H.fontSize[H.fontSize.length-1]&&D?(D=D.split(" ")[1],D=parseFloat(D.substr(0,D.length-1)),H.fontSize=parseInt(H.fontSize.substr(0,H.fontSize.length-1),10)*D/100+"%"):H.fontSize&&"c"===H.fontSize[H.fontSize.length-1]&&D&&(s=H.fontSize.replace(/\s/g,"").split("c"),x=A.call(this,[m[q],d,h,p],"cellResolution").split(" "),s.length>1?H.fontSize=x[1]/s[1]+"px":H.fontSize=x[1]/s[0]+"px"),g=0===q?{start:e,end:f,data:m[q].textContent,line:80,style:H}:{start:e,end:f,data:m[q-1].textContent+"\n"+m[q].textContent,line:80,style:H};E.push(g)}else H.backgroundColor=z.call(this,[d,h],"backgroundColor"),H.color=z.call(this,[d,h],"color"),H.fontSize=z.call(this,[d,h],"fontSize"),H.fontFamily=z.call(this,[d,h],"fontFamily"),D=z.call(this,[d,h],"extent"),H.fontSize&&"%"===H.fontSize[H.fontSize.length-1]&&D&&(D=D.split(" ")[1],D=parseFloat(D.substr(0,D.length-1)),H.fontSize=parseInt(H.fontSize.substr(0,H.fontSize.length-1),10)*D/100+"%"),l>0&&(F=C.call(this,c[l-1],"begin"),G=C.call(this,c[l-1],"end")),e===F&&f===G?(E.pop(),g={start:e,end:f,data:c[l-1].textContent+"\n"+d.textContent,line:80,style:H}):g={start:e,end:f,data:d.textContent,line:80,style:H},E.push(g)}}return o.when(E)}catch(I){return b=I.message,o.reject(b)}};return{domParser:void 0,parse:D}},v.utils.VTTParser=function(){"use strict";var a=function(a){var b=a.split(":"),c=b.length-1;return a=60*parseInt(b[c-1],10)+parseFloat(b[c],10),2===c&&(a+=3600*parseInt(b[0],10)),a};return{parse:function(b){var c,d=/(?:\r\n|\r|\n)/gm,e=/-->/,f=/(^[\s]+|[\s]+$)/g,g=[];b=b.split(d),c=b.length;for(var h=0;c>h;h++){var i=b[h];if(i.length>0&&"WEBVTT"!==i&&i.match(e)){var j=i.split(e),k=b[h+1];g.push({start:a(j[0].replace(f,"")),end:a(j[1].replace(f,"")),data:k})}}return o.when(g)}}},v.models.ProtectionModel=function(){},v.models.ProtectionModel.eventList={ENAME_NEED_KEY:"needkey",ENAME_KEY_SYSTEM_ACCESS_COMPLETE:"keySystemAccessComplete",ENAME_KEY_SYSTEM_SELECTED:"keySystemSelected",ENAME_VIDEO_ELEMENT_SELECTED:"videoElementSelected",ENAME_SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",ENAME_KEY_MESSAGE:"keyMessage",ENAME_KEY_ADDED:"keyAdded",ENAME_KEY_ERROR:"keyError",ENAME_KEY_SESSION_CREATED:"keySessionCreated",ENAME_KEY_SESSION_REMOVED:"keySessionRemoved",ENAME_KEY_SESSION_CLOSED:"keySessionClosed",ENAME_KEY_STATUSES_CHANGED:"keyStatusesChanged",ENAME_TEARDOWN_COMPLETE:"protectionTeardownComplete"},v.dependencies.protection.CommonEncryption={findCencContentProtection:function(a){var b,c=null,d=0;for(d=0;d<a.length;++d)b=a[d],"urn:mpeg:dash:mp4protection:2011"===b.schemeIdUri.toLowerCase()&&"cenc"===b.value.toLowerCase()&&(c=b);return c},getPSSHData:function(a){var b=8,c=new DataView(a),d=c.getUint8(b);return b+=20,d>0&&(b+=4+16*c.getUint32(b)),b+=4,a.slice(b)},getPSSHForKeySystem:function(a,b){var c=v.dependencies.protection.CommonEncryption.parsePSSHList(b);return c.hasOwnProperty(a.uuid.toLowerCase())?c[a.uuid.toLowerCase()]:null},parseInitDataFromContentProtection:function(a){return a&&"pssh"in a?y.decodeArray(a.pssh.__text).buffer:null},readBytes:function(a,b,c){var d=0,e=0;for(e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},parsePSSHList:function(a){if(null===a)return[];var b,c,d,e,f,g,h,i,j=a,k=!1,l={},m=0;for(a.buffer||(j=new Uint8Array(a));!(k||(g=m,
m>=j.byteLength));)if(b=this.readBytes(j,m,4),c=m+b,m+=4,1886614376===this.readBytes(j,m,4))if(m+=4,d=this.readBytes(j,m,1),0===d||1===d){for(m+=1,m+=3,e="",h=0;4>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=4,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;6>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;m+=6,e=e.toLowerCase(),f=this.readBytes(j,m,4),m+=4,l[e]=j.subarray(g,c).buffer,m=c}else m=c;else m=c;return l},getKeySystemConfigurations:function(a,b,c){var d=[],e=[];return a&&e.push(new v.vo.protection.MediaCapability(a)),b&&d.push(new v.vo.protection.MediaCapability(b)),[new v.vo.protection.KeySystemConfiguration(d,e,"optional","temporary"===c?"optional":"required",[c])]}},ArrayBuffer.isView||(ArrayBuffer.isView=function(a){return a instanceof ArrayBuffer}),ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(a,b){var c,d,e,f=this.byteLength;return a=0|a||0,b=void 0===b?f:0|b,0>a&&(a=Math.max(a+f,0)),0>b&&(b=Math.max(b+f,0)),0===f||a>=f||a>=b?new ArrayBuffer(0):(c=Math.min(f-a,b-a),d=new ArrayBuffer(c),e=new Uint8Array(d),e.set(new Uint8Array(this,a,c)),d)}),v.dependencies.ProtectionController=function(){"use strict";var a,b,c,d=null,e=[],f=null,g=!1,h=function(a){var b=null,d=a.systemString;return c&&(b=d in c?c[d]:null),b},i=function(c,d){var f,g,h,i,j,k=this,l=[],m=[],n=0;if(k.debug.log("[DRM] Select key system"),this.keySystem){for(g=0;g<c.length;g++)if(this.keySystem===c[g].ks){f=c[g].ks.sessionType,l.push({ks:c[g].ks,configs:c[g].ks.getKeySystemConfigurations(b,a,f)}),m.push({schemeIdURI:c[g].ks.schemeIdURI,systemString:c[g].ks.systemString}),h={},h[v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(a){a.error?k.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+a.error}):(k.debug.log("[DRM] KeySystem Access Granted"),k.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:a.data}),k.createKeySession(c[g].initData,c[g].cdmData))},this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,h,void 0,!0),this.protectionModel.requestKeySystemAccess(l);break}}else if(void 0===this.keySystem){for(this.keySystem=null,e.push(c),n=0;n<c.length;n++)f=c[n].ks.sessionType,l.push({ks:c[n].ks,configs:c[n].ks.getKeySystemConfigurations(b,a,f)}),m.push({schemeIdURI:c[n].ks.schemeIdURI,systemString:c[n].ks.systemString});i={},i[v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(a){a.error?(k.debug.log("[DRM] KeySystem Access Denied!"),k.keySystem=void 0,k.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,i),d||k.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+a.error}),k.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:m}))):(j=a.data,k.debug.log("[DRM] KeySystem Access ("+j.keySystem.systemString+") Granted!  Selecting key system..."),k.protectionModel.selectKeySystem(j))},i[v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED]=function(a){if(a.error)k.keySystem=void 0,d||k.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] Error selecting key system! -- "+a.error}),k.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:m}));else for(k.debug.log("[DRM] KeySystem selected => create key session"),k.keySystem=k.protectionModel.keySystem,k.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:j}),n=0;n<e.length;n++)for(g=0;g<e[n].length;g++)if(k.keySystem===e[n][g].ks){k.createKeySession(e[n][g].initData,e[n][g].cdmData);break}},this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,i,void 0,!0),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,i,void 0,!0),this.protectionModel.requestKeySystemAccess(l)}else e.push(c)},j=function(a){var b,c,d=this,e=null;b=a.data,c=b.messageType?b.messageType:"license-request",this.debug.log("[DRM] Key message: type = "+c),this.eventBus.dispatchEvent({type:v.dependencies.ProtectionController.events.KEY_MESSAGE,data:b});var g=b.message,i=b.sessionToken,j=h(this.keySystem),k=this.keySystem.systemString,l=this.protectionExt.getLicenseServer(this.keySystem,j,c),m=!0;if(!l)return void this.debug.log("[DRM] License server request not required for this message (type = "+a.data.messageType+").  Session ID = "+i.getSessionID());if(this.protectionExt.isClearKey(this.keySystem)){var n=this.protectionExt.processClearKeyLicenseRequest(j,g);if(n)return this.debug.log("[DRM] ClearKey license request handled by application!"),void this.protectionModel.updateKeySession(i,n)}f=new XMLHttpRequest;var o=null;if(j)if(j.serverURL){var p=j.serverURL;"string"==typeof p&&""!==p?o=p:"object"==typeof p&&p.hasOwnProperty(c)&&(o=p[c])}else j.laURL&&""!==j.laURL&&(o=j.laURL);else o=this.keySystem.getLicenseServerURLFromInitData(v.dependencies.protection.CommonEncryption.getPSSHData(i.initData)),o||(o=a.data.defaultURL);if(o=l.getServerURLFromMessage(o,g,c),this.debug.log("[DRM] Licenser server url: "+o),!o)return void this.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN,"No license server URL specified"));f.open(l.getHTTPMethod(c),o,!0),f.responseType=l.getResponseType(k,c),f.onload=function(){this.status<200||this.status>299||200===this.status&&4===this.readyState&&(d.debug.log("[DRM] Received license response"),m=!1,e=l.getLicenseMessage(this.response,k,c),null!==e?(m=!1,d.protectionModel.updateKeySession(i,e)):m=!0)},f.onerror=f.onloadend=function(){return m?(m=!1,this.aborted||d.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR,"License request failed",{url:o,status:this.status,error:this.response&&null!==this.response?l.getErrorResponse(this.response):""})),void(f=null)):void(f=null)};var q=function(a){var b;if(a)for(b in a)"authorization"===b.toLowerCase()&&(f.withCredentials=!0),f.setRequestHeader(b,a[b])};j&&q(j.httpRequestHeaders),q(this.keySystem.getRequestHeadersFromMessage(g)),j&&j.withCredentials&&(f.withCredentials=!0),this.debug.log("[DRM] Send license request");var r=this.keySystem.getLicenseRequestFromMessage(g);null===r&&d.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE,"No license challenge from CDM key message")),f.send(this.keySystem.getLicenseRequestFromMessage(g))},k=function(a){var b,c,d=this;return d.debug.log("[DRM] onNeedKey, initDataType = "+a.data.initDataType),"cenc"!==a.data.initDataType?void d.debug.log("[DRM] Only 'cenc' initData is supported!  Ignoring initData of type: "+a.data.initDataType):(b=a.data.initData,ArrayBuffer.isView(b)&&(b=b.buffer),c=this.protectionExt.getSupportedKeySystems(b),0===c.length?void d.debug.log("[DRM] Received needkey event with initData, but we don't support any of the key systems!"):void i.call(this,c,!1))},l=function(a){a.error?(this.debug.error("[DRM] Failed to set license server certificate"),this.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE,"Failed to set server certificate",a.error))):this.debug.log("[DRM] License server certificate successfully updated")},m=function(a){a.error?(this.debug.error("[DRM] Failed to create key session"),this.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION,"Failed to create key session",a.error))):this.debug.log("[DRM] Session created.  SessionID = "+a.data.getSessionID())},n=function(){this.debug.log("[DRM] Key added")},o=function(a){this.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(a.data.code,a.data.message,a.data.data))},p=function(a){a.error?this.debug.warn("[DRM] Failed to close session"):this.debug.log("[DRM] Session closed.  SessionID = "+a.data)},q=function(a){a.error?this.debug.warn("[DRM] Failed to remove session"):this.debug.log("[DRM] Session removed.  SessionID = "+a.data)},r=function(a){a.error||this.debug.log("[DRM] Key statuses changed. statuses = "+a.data)};return{system:void 0,debug:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:void 0,setup:function(){this[v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE]=j.bind(this),this[v.models.ProtectionModel.eventList.ENAME_NEED_KEY]=k.bind(this),this[v.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED]=l.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_ADDED]=n.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_ERROR]=o.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED]=m.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED]=p.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED]=q.bind(this),this[v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED]=r.bind(this),d=this.protectionExt.getKeySystems(),this.protectionModel=this.system.getObject("protectionModel"),this.protectionModel.init(),this.eventBus=this.system.getObject("eventBus"),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this)},init:function(c,d,e){var f;g||(this.debug.log("[DRM] Initialize ProtectionController ("+e+", "+d+")"),a=d,b=e,f=this.protectionExt.getSupportedKeySystemsFromContentProtection(c),f&&f.length>0&&i.call(this,f,!0),g=!0)},addEventListener:function(a,b){this.eventBus.addEventListener(a,b)},removeEventListener:function(a,b){this.eventBus.removeEventListener(a,b)},teardown:function(){f&&(f.aborted=!0,f.abort()),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),this.keySystem=void 0,this.protectionModel.teardown(),this.setMediaElement(null),this.protectionModel=void 0},createKeySession:function(a,b){this.debug.log("[DRM] Create key session");var c,d=v.dependencies.protection.CommonEncryption.getPSSHForKeySystem(this.keySystem,a),e=0;if(d){for(c=this.protectionModel.getAllInitData(),e=0;e<c.length;e++)if(this.protectionExt.initDataEquals(d,c[e]))return void this.debug.log("[DRM] Ignoring initData because we have already seen it!");try{this.protectionModel.createKeySession(d,this.keySystem.sessionType,b)}catch(f){this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Create key session raised en exception",error:new v.vo.Error(f.code,f.name,f.message)})}}else this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"needkey/encrypted event contains no initData corresponding to that key system "+this.keySystem.systemString,error:null})},loadKeySession:function(a){this.protectionModel.loadKeySession(a)},removeKeySession:function(a){this.protectionModel.removeKeySession(a)},closeKeySession:function(a){this.protectionModel.closeKeySession(a)},setServerCertificate:function(a){this.protectionModel.setServerCertificate(a)},setMediaElement:function(a){a?(this.protectionModel.setMediaElement(a),this.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_NEED_KEY,this)):null===a&&(this.protectionModel.setMediaElement(a),this.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_NEED_KEY,this))},setSessionType:function(a){this.keysystem&&(this.keySystem.sessionType=a)},setProtectionData:function(a){c=a,this.protectionExt.init(a)}}},v.dependencies.ProtectionController.events={KEY_SYSTEM_SELECTED:"keySystemSelected",SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",KEY_ADDED:"keyAdded",KEY_SESSION_CREATED:"keySessionCreated",KEY_SESSION_REMOVED:"keySessionRemoved",KEY_SESSION_CLOSED:"keySessionClosed",KEY_STATUSES_CHANGED:"keyStatusesChanged",KEY_MESSAGE:"keyMessage",LICENSE_REQUEST_COMPLETE:"licenseRequestComplete"},v.dependencies.ProtectionController.eventList={ENAME_PROTECTION_ERROR:"protectionError"},v.dependencies.ProtectionController.prototype={constructor:v.dependencies.ProtectionController},v.dependencies.ProtectionExtensions=function(){"use strict";this.system=void 0,this.debug=void 0,this.keySystems=[],this.clearkeyKeySystem=void 0},v.dependencies.ProtectionExtensions.prototype={constructor:v.dependencies.ProtectionExtensions,setup:function(){var a;a=this.system.getObject("ksPlayReady"),this.keySystems.push(a),a=this.system.getObject("ksWidevine"),this.keySystems.push(a),a=this.system.getObject("ksClearKey"),this.keySystems.push(a),this.clearkeyKeySystem=a},init:function(a){for(var b=(function(b){var c=null;return a&&(c=b in a?a[b]:null),c}),c=0;c<this.keySystems.length;c++){var d=this.keySystems[c];d.init(b(d.systemString))}},getKeySystems:function(){return this.keySystems},getKeySystemBySystemString:function(a){for(var b=0;b<this.keySystems.length;b++)if(this.keySystems[b].systemString===a)return this.keySystems[b];return null},isClearKey:function(a){return a===this.clearkeyKeySystem},initDataEquals:function(a,b){if(a.byteLength===b.byteLength){for(var c=new Uint8Array(a),d=new Uint8Array(b),e=0;e<c.length;e++)if(c[e]!==d[e])return!1;return!0}return!1},getSupportedKeySystemsFromContentProtection:function(a){var b,c,d,e,f=[];if(this.debug.log("[DRM] Get supported key systems from content protection"),a)for(d=0;d<this.keySystems.length;++d)for(c=this.keySystems[d],e=0;e<a.length;++e)if(b=a[e],b.schemeIdUri.toLowerCase()===c.schemeIdURI){var g=c.getInitData(b);g&&f.push({ks:this.keySystems[d],initData:g,cdmData:c.getCDMData()})}return f},getSupportedKeySystems:function(a){var b,c=[],d=v.dependencies.protection.CommonEncryption.parsePSSHList(a);for(this.debug.log("[DRM] Get supported key systems from init data"),b=0;b<this.keySystems.length;++b)this.keySystems[b].uuid in d&&c.push({ks:this.keySystems[b],initData:d[this.keySystems[b].uuid]});return c},getLicenseServer:function(a,b,c){if("license-release"===c||"individualization-request"==c)return null;var d=null;return b&&b.hasOwnProperty("drmtoday")?d=this.system.getObject("serverDRMToday"):"com.widevine.alpha"===a.systemString?d=this.system.getObject("serverWidevine"):"com.microsoft.playready"===a.systemString?d=this.system.getObject("serverPlayReady"):"org.w3.clearkey"===a.systemString&&(d=this.system.getObject("serverClearKey")),d},processClearKeyLicenseRequest:function(a,b){try{return v.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData(a,b)}catch(c){return this.log("Failed to retrieve clearkeys from ProtectionData"),null}},autoSelectKeySystem:function(a,b,c,d){if(this.debug.log("[DRM] Auto select key system: "),this.debug.log("[DRM] ---- video codec = "+c),this.debug.log("[DRM] ---- audio codec = "+d),0===a.length)throw new Error("DRM system for this content not supported by the player!");var e=[],f=[];c&&f.push(new v.vo.protection.MediaCapability(c)),d&&e.push(new v.vo.protection.MediaCapability(d));for(var g=new v.vo.protection.KeySystemConfiguration(e,f),h=[],i=0;i<a.length;i++)h.push({ks:a[i].ks,configs:[g]});var j=this;!function(a){var b={};b[v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(b){if(a.protectionModel.unsubscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,this),b.error)j.debug.log(b.error),a.notify(v.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"[DRM] KeySystem Access Denied! -- "+b.error,null));else{var c=b.data;j.debug.log("[DRM] KeySystem Access Granted ("+c.keySystem.systemString+")!"),a.selectKeySystem(c)}},a.protectionModel.subscribe(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,b),a.requestKeySystemAccess(h)}(b)}},v.models.ProtectionModel_01b=function(){var a,b=null,c=null,d=[],e=[],f=function(){var b=this;return{handleEvent:function(f){var g=null;switch(f.type){case c.needkey:var i=ArrayBuffer.isView(f.initData)?f.initData.buffer:f.initData;b.notify(v.models.ProtectionModel.eventList.ENAME_NEED_KEY,new v.vo.protection.NeedKey(i,"cenc"));break;case c.keyerror:if(g=h(e,f.sessionId),g||(g=h(d,f.sessionId)),g){var j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,k="MediakeyError";switch(f.errorCode.code){case 1:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,k+="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,k+="The Key System could not be installed or updated.";break;case 3:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,k+="The message passed into update indicated an error from the license service.";break;case 4:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,k+="There is no available output device with the required characteristics for the content protection system.";break;case 5:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,k+="A hardware configuration change caused a content protection error.";break;case 6:j=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,k+="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}f.systemCode&&(k+="  (System Code = "+f.systemCode+")"),b.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new v.vo.protection.KeyError(j,k))}else b.log("No session token found for key error");break;case c.keyadded:g=h(e,f.sessionId),g||(g=h(d,f.sessionId)),g?b.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ADDED,g):b.log("No session token found for key added");break;case c.keymessage:if(a=null!==f.sessionId&&void 0!==f.sessionId,a?(g=h(e,f.sessionId),!g&&d.length>0&&(g=d.shift(),e.push(g),g.sessionID=f.sessionId)):d.length>0&&(g=d.shift(),e.push(g),0!==d.length&&b.errHandler.mediaKeyMessageError("Multiple key sessions were creates with a user-agent that does not support sessionIDs!! Unpredictable behavior ahead!")),g){var l=ArrayBuffer.isView(f.message)?f.message.buffer:f.message;g.keyMessage=l,b.notify(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new v.vo.protection.KeyMessage(g,l,f.defaultURL))}else b.log("No session token found for key message")}}}},g=null,h=function(a,b){if(b&&a){for(var c=a.length,d=0;c>d;d++)if(a[d].sessionID===b)return a[d];return null}return null},i=function(){b.removeEventListener(c.keyerror,g),b.removeEventListener(c.needkey,g),b.removeEventListener(c.keymessage,g),b.removeEventListener(c.keyadded,g)};return{system:void 0,log:void 0,errHandler:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,setup:function(){g=f.call(this)},init:function(){var a=document.createElement("video");c=v.models.ProtectionModel_01b.detect(a)},teardown:function(){b&&i();for(var a=0;a<e.length;a++)this.closeKeySession(e[a]);this.notify(v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)},getAllInitData:function(){var a,b=[];for(a=0;a<d.length;a++)b.push(d[a].initData);for(a=0;a<e.length;a++)b.push(e[a].initData);return b},requestKeySystemAccess:function(a){var c=b;c||(c=document.createElement("video"));for(var d=!1,e=0;e<a.length;e++)for(var f=a[e].ks.systemString,g=a[e].configs,h=null,i=null,j=0;j<g.length;j++){var k=g[j].videoCapabilities;if(k&&0!==k.length){i=[];for(var l=0;l<k.length;l++)""!==c.canPlayType(k[l].contentType,f)&&i.push(k[l])}if(!(!h&&!i||h&&0===h.length||i&&0===i.length)){d=!0;var m=new v.vo.protection.KeySystemConfiguration(h,i),n=this.protectionExt.getKeySystemBySystemString(f),o=new v.vo.protection.KeySystemAccess(n,m);this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,o);break}}d||this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(a){this.keySystem=a.keySystem,this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)},setMediaElement:function(a){b!==a&&(b&&i(),b=a,b&&(b.addEventListener(c.keyerror,g),b.addEventListener(c.needkey,g),b.addEventListener(c.keymessage,g),b.addEventListener(c.keyadded,g),this.notify(v.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)))},createKeySession:function(f){if(!this.keySystem)throw new Error("Can not create sessions until you have selected a key system");if(a||0===e.length){var g={sessionID:null,initData:f,getSessionID:function(){return this.sessionID},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}};return d.push(g),b[c.generateKeyRequest](this.keySystem.systemString,new Uint8Array(f)),g}throw new Error("Multiple sessions not allowed!")},updateKeySession:function(a,d){var e=a.sessionID;if(this.protectionExt.isClearKey(this.keySystem))for(var f=0;f<d.keyPairs.length;f++)b[c.addKey](this.keySystem.systemString,d.keyPairs[f].key,d.keyPairs[f].keyID,e);else b[c.addKey](this.keySystem.systemString,new Uint8Array(d),a.initData,e)},closeKeySession:function(a){b[c.cancelKeyRequest](this.keySystem.systemString,a.sessionID)},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},v.models.ProtectionModel_01b.prototype={constructor:v.models.ProtectionModel_01b},v.models.ProtectionModel_01b.APIs=[{generateKeyRequest:"generateKeyRequest",addKey:"addKey",cancelKeyRequest:"cancelKeyRequest",needkey:"needkey",keyerror:"keyerror",keyadded:"keyadded",keymessage:"keymessage"},{generateKeyRequest:"webkitGenerateKeyRequest",addKey:"webkitAddKey",cancelKeyRequest:"webkitCancelKeyRequest",needkey:"webkitneedkey",keyerror:"webkitkeyerror",keyadded:"webkitkeyadded",keymessage:"webkitkeymessage"}],v.models.ProtectionModel_01b.detect=function(a){for(var b=v.models.ProtectionModel_01b.APIs,c=0;c<b.length;c++){var d=b[c];if("function"==typeof a[d.generateKeyRequest]&&"function"==typeof a[d.addKey]&&"function"==typeof a[d.cancelKeyRequest])return d}return null},v.models.ProtectionModel_3Feb2014=function(){var a=null,b=null,c=null,d=null,e=[],f=function(){var a=this;return{handleEvent:function(b){switch(b.type){case d.needkey:if(b.initData){var c=ArrayBuffer.isView(b.initData)?b.initData.buffer:b.initData;a.notify(v.models.ProtectionModel.eventList.ENAME_NEED_KEY,new v.vo.protection.NeedKey(c,"cenc"))}}}}},g=null,h=function(){var c=null,e=function(){a.removeEventListener("loadedmetadata",c),a[d.setMediaKeys](b),this.notify(v.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)};a.readyState>=1?e.call(this):(c=e.bind(this),a.addEventListener("loadedmetadata",c))},i=function(a){var b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,c="MediakeyError";switch(a.errorCode.code){case 1:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,c="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,c="The Key System could not be installed or updated.";break;case 3:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,c="The message passed into update indicated an error from the license service.";break;case 4:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,c="There is no available output device with the required characteristics for the content protection system.";break;case 5:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,c+="A hardware configuration change caused a content protection error.";break;case 6:b=v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,c="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}return a.systemCode&&(c+="  (System Code = "+a.systemCode+")"),new v.vo.protection.KeyError(b,c)},j=function(a,b){var c=this;return{session:a,initData:b,handleEvent:function(a){switch(a.type){case d.error:c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,i(a));break;case d.message:var b=ArrayBuffer.isView(a.message)?a.message.buffer:a.message;c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new v.vo.protection.KeyMessage(this,b,a.destinationURL));break;case d.ready:c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this);break;case d.close:c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this.getSessionID())}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}}};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,debug:void 0,keySystem:null,setup:function(){g=f.call(this)},init:function(){var a=document.createElement("video");d=v.models.ProtectionModel_3Feb2014.detect(a)},teardown:function(){try{for(var b=0;b<e.length;b++)this.closeKeySession(e[b]);a&&a.removeEventListener(d.needkey,g),this.notify(v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)}catch(c){this.notify(v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,null,"Error tearing down key sessions and MediaKeys! -- "+c.message)}},getAllInitData:function(){for(var a=[],b=0;b<e.length;b++)a.push(e[b].initData);return a},requestKeySystemAccess:function(a){for(var b=!1,c=0;c<a.length;c++){var e=a[c].ks.systemString,f=a[c].configs,g=null,h=null;this.debug.log("[DRM][3Feb2014] Request access for key system "+e);for(var i=0;i<f.length;i++){var j=f[i].audioCapabilities,k=f[i].videoCapabilities;if(j&&0!==j.length){g=[];for(var l=0;l<j.length;l++)window[d.MediaKeys].isTypeSupported(e,j[l].contentType)&&g.push(j[l])}if(k&&0!==k.length){h=[];for(var m=0;m<k.length;m++)window[d.MediaKeys].isTypeSupported(e,k[m].contentType)&&h.push(k[m])}if(!(!g&&!h||g&&0===g.length||h&&0===h.length)){b=!0;var n=new v.vo.protection.KeySystemConfiguration(g,h),o=this.protectionExt.getKeySystemBySystemString(e),p=new v.vo.protection.KeySystemAccess(o,n);this.debug.log("[DRM][3Feb2014] configuration supported = audio:"+JSON.stringify(g)+", video:"+JSON.stringify(h)),this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,p);break}}}b||this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"[DRM][3Feb2014] Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(e){this.debug.log("[DRM][3Feb2014] Select key system "+e.keySystem.systemString);try{b=e.mediaKeys=new window[d.MediaKeys](e.keySystem.systemString),this.keySystem=e.keySystem,c=e,a&&h.call(this),this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)}catch(f){this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+this.keySystem.systemString+")! Could not create MediaKeys -- TODO")}},setMediaElement:function(c){a!==c&&(a&&a.removeEventListener(d.needkey,g),a=c,a&&b&&h.call(this))},createKeySession:function(a,f,g){if(!this.keySystem||!b||!c)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][3Feb2014] Create key session");var h=c.ksConfiguration.videoCapabilities[0].contentType,i=b.createSession(h,new Uint8Array(a),g?new Uint8Array(g):null),k=j.call(this,i,a);i.addEventListener(d.error,k),i.addEventListener(d.message,k),i.addEventListener(d.ready,k),i.addEventListener(d.close,k),e.push(k),this.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,k)},updateKeySession:function(a,b){var c=a.session;this.debug.log("[DRM][3Feb2014] Update key session"),this.protectionExt.isClearKey(this.keySystem)?c.update(new Uint8Array(b.toJWK())):c.update(new Uint8Array(b))},closeKeySession:function(a){this.debug.log("[DRM][3Feb2014] Close key session, token = "+a.session.sessionId);var b=a.session;b.removeEventListener(d.error,a),b.removeEventListener(d.message,a),b.removeEventListener(d.ready,a),b.removeEventListener(d.close,a);for(var c=0;c<e.length;c++)if(e[c]===a){e.splice(c,1);break}b[d.release]()},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},v.models.ProtectionModel_3Feb2014.APIs=[{setMediaKeys:"msSetMediaKeys",MediaKeys:"MSMediaKeys",release:"close",needkey:"msneedkey",error:"mskeyerror",message:"mskeymessage",ready:"mskeyadded",close:"mskeyclose"},{setMediaKeys:"setMediaKeys",MediaKeys:"MediaKeys",release:"close",needkey:"needkey",error:"keyerror",message:"keymessage",ready:"keyadded",close:"keyclose"}],v.models.ProtectionModel_3Feb2014.detect=function(a){for(var b=v.models.ProtectionModel_3Feb2014.APIs,c=0;c<b.length;c++){var d=b[c];if("function"==typeof a[d.setMediaKeys]&&"function"==typeof window[d.MediaKeys])return d}return null},v.models.ProtectionModel_3Feb2014.prototype={constructor:v.models.ProtectionModel_3Feb2014},v.models.ProtectionModel_21Jan2015=function(){var a=null,b=null,c=null,d=[],e=function(a){var b,c="[";for(b=0;b<a.length;b++)c+="0x"+a[b].toString(16),b<a.length-1&&(c+=",");return c+="]"},f=function(a,b){var c=this;!function(b){var d=a[b].ks,e=a[b].configs;c.debug.log("[DRM][PM_21Jan2015] requestMediaKeySystemAccess: "+d.systemString),navigator.requestMediaKeySystemAccess(d.systemString,e).then(function(a){var b="function"==typeof a.getConfiguration?a.getConfiguration():null,e=new v.vo.protection.KeySystemAccess(d,b);e.mksa=a,c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,e)})["catch"](function(){++b<a.length?f.call(c,a,b):c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied!")})}(b)},g=function(a){
var b=a.session;return b.removeEventListener("keystatuseschange",a),b.removeEventListener("message",a),b.close()},h=function(){var b=this;return{session:null,handleEvent:function(d){switch(d.type){case"encrypted":b.debug.log("[DRM][PM_21Jan2015] 'encrypted' event");break;case"waitingforkey":b.debug.log("[DRM][PM_21Jan2015] 'waitingforkey' event"),null!==this.session&&(this.session.licenseStored=!1,this.session=null),a.removeEventListener("waitingforkey",c),b.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new v.vo.protection.KeyError(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,"Media is encrypted and no key is available"))}}}},i=function(a){for(var b=0;b<d.length;b++)if(d[b]===a){d.splice(b,1);break}},j=function(a,b,c){var f=this,g={session:a,initData:b,licenseStored:!1,handleEvent:function(a){switch(a.type){case"keystatuseschange":f.debug.log("[DRM][PM_21Jan2015] 'keystatuseschange' event: ",a),f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),a.target.keyStatuses.forEach(function(){var a,b;switch(arguments&&arguments.length>0&&(arguments[0]&&("string"==typeof arguments[0]?a=arguments[0]:b=arguments[0]),arguments[1]&&("string"==typeof arguments[1]?a=arguments[1]:b=arguments[1])),f.debug.log("[DRM][PM_21Jan2015] status = "+a+" for KID "+e(new Uint8Array(b))),a){case"expired":f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,null,new v.vo.Error(v.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,"License has expired!!!",null));break;default:f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,{status:a,keyId:b})}});break;case"message":f.debug.log("[DRM][PM_21Jan2015] 'message' event: ",a);var b=ArrayBuffer.isView(a.message)?a.message.buffer:a.message;f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new v.vo.protection.KeyMessage(this,b,void 0,a.messageType))}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return this.session.expiration},getKeyStatuses:function(){return this.session.keyStatuses},getSessionType:function(){return c}};return a.addEventListener("keystatuseschange",g),a.addEventListener("message",g),a.closed.then(function(){i(g),f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,g.getSessionID())}),d.push(g),g};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,debug:null,setup:function(){c=h.call(this)},init:function(){},teardown:function(){var b,e;for(this.debug.log("[DRM][PM_21Jan2015] Teardown"),e=0;e<d.length;e++)b=d[e],b.licenseStored||(d.splice(e,1),e--);a.removeEventListener("waitingforkey",c),this.notify(v.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)},getAllInitData:function(){for(var a=[],b=0;b<d.length;b++)a.push(d[b].initData);return a},requestKeySystemAccess:function(a){f.call(this,a,0)},selectKeySystem:function(c){var d=this;return d.debug.log("[DRM][PM_21Jan2015] Select key system, create new MediaKeys"),null!==b?(d.debug.log("[DRM][PM_21Jan2015] MediaKeys already created"),void d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)):void c.mksa.createMediaKeys().then(function(e){d.keySystem=c.keySystem,b=e,a&&a.setMediaKeys(b),d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)})["catch"](function(){d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+c.keySystem.systemString+")! Could not create MediaKeys -- TODO")})},setMediaElement:function(d){a!==d&&null!==d&&(a&&(a.removeEventListener("encrypted",c),a.removeEventListener("waitingforkey",c),a.setMediaKeys(null)),a=d,a&&(a.addEventListener("encrypted",c),b&&a.setMediaKeys(b)))},setServerCertificate:function(a){if(!this.keySystem||!b)throw new Error("Can not set server certificate until you have selected a key system");var c=this;b.setServerCertificate(a).then(function(){c.notify(v.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED)})["catch"](function(a){c.notify(v.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,null,"Error updating server certificate -- "+a.name)})},createKeySession:function(a,c){if(!this.keySystem||!b)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Create key session, type = "+c);var d=b.createSession(c),e=j.call(this,d,a,c),f=this;d.generateRequest("cenc",a).then(function(){f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,e)})["catch"](function(a){i(e),f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to generate key request",error:new v.vo.Error(a.code,a.name,a.message)})})},updateKeySession:function(b,d){var e=b.session,f=this;f.debug.log("[DRM][PM_21Jan2015] Update key session"),this.protectionExt.isClearKey(this.keySystem)&&(d=d.toJWK()),e.update(d).then(function(){b.licenseStored=!0,c.session=b,a.addEventListener("waitingforkey",c)})["catch"](function(a){f.notify(v.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new v.vo.protection.KeyError(v.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,"Error while providing license to the CDM",a))})},loadKeySession:function(a){if(!this.keySystem||!b)throw new Error("Can not load sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Load key session, id = "+a);var c=b.createSession(),d=this;c.load(a).then(function(b){if(b){var e=j.call(this,c);d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,e)}else d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to load session "+a,error:null})})["catch"](function(b){d.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,{reason:"Failed to load session "+a,error:new v.vo.Error(b.code,b.name,b.message)})})},removeKeySession:function(a){var b=a.session;this.debug.log("[DRM][PM_21Jan2015] Remove key session");var c=this;b.remove().then(function(){c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,a.getSessionID())},function(b){c.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,null,"Error removing session ("+a.getSessionID()+"). "+b.name)})},closeKeySession:function(a){this.debug.log("[DRM][PM_21Jan2015] Close key session");var b=this;g(a)["catch"](function(c){i(a),b.notify(v.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,null,"Error closing session ("+a.getSessionID()+") "+c.name)})},checkIfEncrypted:function(){a.addEventListener("waitingforkey",c)}}},v.models.ProtectionModel_21Jan2015.detect=function(a){return void 0===a.onencrypted||void 0===a.mediaKeys?!1:void 0===navigator.requestMediaKeySystemAccess||"function"!=typeof navigator.requestMediaKeySystemAccess?!1:window.MSMediaKeys?!1:!0},v.models.ProtectionModel_21Jan2015.prototype={constructor:v.models.ProtectionModel_21Jan2015},v.dependencies.protection.KeySystem=function(){},v.dependencies.protection.KeySystem_Access=function(){"use strict"},v.dependencies.protection.KeySystem_Access.prototype={constructor:v.dependencies.protection.KeySystem_Access},v.dependencies.protection.KeySystem_ClearKey=function(){"use strict";var a,b="org.w3.clearkey",c="1077efec-c0b2-4d02-ace3-3c1e52e2fb4b";return{system:void 0,schemeIdURI:"urn:uuid:"+c,systemString:b,uuid:c,sessionType:"temporary",init:function(b){a=b},getInitData:v.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection,getKeySystemConfigurations:v.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(a){return new Uint8Array(a)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null}}},v.dependencies.protection.KeySystem_ClearKey.prototype={constructor:v.dependencies.protection.KeySystem_ClearKey},v.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData=function(a,b){var c=null;if(a){for(var d=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(b))),e=[],f=0;f<d.kids.length;f++){var g=d.kids[f],h=a.clearkeys.hasOwnProperty(g)?a.clearkeys[g]:null;if(!h)throw new Error("[DRM] ClearKey keyID ("+g+") is not known!");e.push(new v.vo.protection.KeyPair(g,h))}c=new v.vo.protection.ClearKeyKeySet(e)}return c},v.dependencies.protection.KeySystem_PlayReady=function(){"use strict";var a,b="com.microsoft.playready",c="9a04f079-9840-4286-ab92-e65be0885f95",d="utf16",e='<PlayReadyCDMData type="LicenseAcquisition"><LicenseAcquisition version="1.0" Proactive="true"><CustomData encoding="base64encoded">%CUSTOMDATA%</CustomData></LicenseAcquisition></PlayReadyCDMData>',f=function(a){var b,c,e,f,g={},h=a instanceof ArrayBuffer?a:a.buffer,i="utf16"===d?new Uint16Array(h):new Uint8Array(h),j=0;for(b=String.fromCharCode.apply(null,i),c=this.domParser.createXmlTree(b),e=c.getElementsByTagName("name"),f=c.getElementsByTagName("value"),j=0;j<e.length;j+=1)g[e[j].childNodes[0].nodeValue]=f[j].childNodes[0].nodeValue;return g.hasOwnProperty("Content")&&(g["Content-Type"]=g.Content,delete g.Content),g.hasOwnProperty("Content-Type")||(g["Content-Type"]="text/xml; charset=utf-8"),g},g=function(a){var b,c,e,f=null,g=a instanceof ArrayBuffer?a:a.buffer,h="utf16"===d?new Uint16Array(g):new Uint8Array(g);return b=String.fromCharCode.apply(null,h),c=this.domParser.createXmlTree(b),c.getElementsByTagName("Challenge")[0]?(e=c.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue,e&&(f=y.decode(e))):f=b,f},h=function(a){if(a){var b,c,d,e,f,g,h,i=new DataView(a),j=i.getUint16(4,!0),k=6,l=0;for(l=0;j>l;l++)if(b=i.getUint16(k,!0),k+=2,c=i.getUint16(k,!0),k+=2,1===b){if(d=a.slice(k,k+c),e=String.fromCharCode.apply(null,new Uint16Array(d)),f=this.domParser.createXmlTree(e),f.getElementsByTagName("LA_URL")[0]&&(g=f.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue))return g;if(f.getElementsByTagName("LUI_URL")[0]&&(h=f.getElementsByTagName("LUI_URL")[0].childNodes[0].nodeValue))return h}else k+=c}return null},i=function(a){var b,c,d,e,f,g=0,h=new Uint8Array([112,115,115,104,0,0,0,0]),i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]),j=null;if("pssh"in a)return v.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(a);if("pro"in a)j=y.decodeArray(a.pro.__text);else{if(!("prheader"in a))return null;j=y.decodeArray(a.prheader.__text)}return b=j.length,c=4+h.length+i.length+4+b,d=new ArrayBuffer(c),e=new Uint8Array(d),f=new DataView(d),f.setUint32(g,c),g+=4,e.set(h,g),g+=h.length,e.set(i,g),g+=i.length,f.setUint32(g,b),g+=4,e.set(j,g),g+=b,e.buffer},j=function(){var b,c,d,f;if(a&&a.cdmData){for(b=[],f=0;f<a.cdmData.length;++f)b.push(a.cdmData.charCodeAt(f)),b.push(0);for(b=String.fromCharCode.apply(null,b),b=y.encode(b),c=e.replace("%CUSTOMDATA%",b),d=[],f=0;f<c.length;++f)d.push(c.charCodeAt(f)),d.push(0);return new Uint8Array(d).buffer}return null};return{schemeIdURI:"urn:uuid:"+c,systemString:b,uuid:c,notify:void 0,subscribe:void 0,unsubscribe:void 0,domParser:void 0,sessionType:"temporary",init:function(b){b&&(a=b,a.sessionType&&(this.sessionType=a.sessionType))},getInitData:i,getKeySystemConfigurations:v.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:f,getLicenseRequestFromMessage:g,getLicenseServerURLFromInitData:h,getCDMData:j,setPlayReadyMessageFormat:function(a){if("utf8"!==a&&"utf16"!==a)throw new Error("Illegal PlayReady message format! -- "+a);d=a}}},v.dependencies.protection.KeySystem_PlayReady.prototype={constructor:v.dependencies.protection.KeySystem_PlayReady},v.dependencies.protection.KeySystem_Widevine=function(){"use strict";var a="com.widevine.alpha",b="edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",c=null,d=function(a){return c&&c.pssh?y.decodeArray(c.pssh).buffer:v.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(a)};return{schemeIdURI:"urn:uuid:"+b,systemString:a,uuid:b,sessionType:"temporary",init:function(a){a&&(c=a,c.sessionType&&(this.sessionType=c.sessionType))},getInitData:d,getKeySystemConfigurations:v.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(a){return new Uint8Array(a)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null}}},v.dependencies.protection.KeySystem_Widevine.prototype={constructor:v.dependencies.protection.KeySystem_Widevine},v.dependencies.protection.servers.ClearKey=function(){"use strict";return{getServerURLFromMessage:function(a,b){var c=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(b))),d=0;for(a+="/?",d=0;d<c.kids.length;d++)a+=c.kids[d]+"&";return a=a.substring(0,a.length-1)},getHTTPMethod:function(){return"GET"},getResponseType:function(){return"json"},getLicenseMessage:function(a){var b,c,d,e,f=[];if(!a.hasOwnProperty("keys"))return null;for(b=0;b<a.keys.length;b++)c=a.keys[b],d=c.kid.replace(/=/g,""),e=c.k.replace(/=/g,""),f.push(new v.vo.protection.KeyPair(d,e));return new v.vo.protection.ClearKeyKeySet(f)},getErrorResponse:function(a){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(a))}}}},v.dependencies.protection.servers.ClearKey.prototype={constructor:v.dependencies.protection.servers.ClearKey},v.dependencies.protection.servers.DRMToday=function(){"use strict";var a={"com.widevine.alpha":{responseType:"json",getLicenseMessage:function(a){return y.decodeArray(a.license)},getErrorResponse:function(a){return a}},"com.microsoft.playready":{responseType:"arraybuffer",getLicenseMessage:function(a){return a},getErrorResponse:function(a){return String.fromCharCode.apply(null,new Uint8Array(a))}}};return{getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(b){return a[b].responseType},getLicenseMessage:function(b,c){return a[c].getLicenseMessage(b)},getErrorResponse:function(b,c){return{code:0,name:"UnknownError",message:a[c].getErrorResponse(b)}}}},v.dependencies.protection.servers.DRMToday.prototype={constructor:v.dependencies.protection.servers.DRMToday},v.dependencies.protection.servers.LicenseServer=function(){},v.dependencies.protection.servers.PlayReady=function(){"use strict";var a=function(a){var b="",c=0,d=0,e=0,f=0,g=new Uint8Array(a);for(g.length>=3&&239===g[0]&&187===g[1]&&191===g[2]&&(c=3);c<g.length;)if(d=g[c],128>d)b+=String.fromCharCode(d),c++;else if(d>191&&224>d){if(c+1>=g.length)throw"UTF-8 Decode failed. Two byte character was truncated.";e=g[c+1],b+=String.fromCharCode((31&d)<<6|63&e),c+=2}else{if(c+2>=g.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";e=g[c+1],f=g[c+2],b+=String.fromCharCode((15&d)<<12|(63&e)<<6|63&f),c+=3}return b},b=function(b){var c=a(b),d=this.domParser.createXmlTree(c),e=d?this.domParser.getChildNode(d,"soap:Envelope"):null,f=e?this.domParser.getChildNode(e,"soap:Body"):null,g=f?this.domParser.getChildNode(f,"soap:Fault"):null;return g?null:b},c=function(b){var c=a(b),d=this.domParser.createXmlTree(c),e=d?this.domParser.getChildNode(d,"soap:Envelope"):null,f=e?this.domParser.getChildNode(e,"soap:Body"):null,g=f?this.domParser.getChildNode(f,"soap:Fault"):null,h=g?this.domParser.getChildNode(g,"detail"):null,i=h?this.domParser.getChildNode(h,"Exception"):null,j=null,k="",l="",m="",n=-1,o=-1;return null===g?{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(b))}:(j=this.domParser.getChildNode(g,"faultstring").firstChild,k=j?j.nodeValue:null,null!==i&&(j=this.domParser.getChildNode(i,"StatusCode"),l=j?j.firstChild.nodeValue:null,j=this.domParser.getChildNode(i,"Message"),m=j?j.firstChild.nodeValue:null,n=m?m.lastIndexOf("[")+1:-1,o=m?m.indexOf("]"):-1),{code:l,name:k,message:m?m.substring(n,o):""})};return{domParser:void 0,getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(a){return b.call(this,a)},getErrorResponse:function(a){return c.call(this,a)}}},v.dependencies.protection.servers.PlayReady.prototype={constructor:v.dependencies.protection.servers.PlayReady},v.dependencies.protection.servers.Widevine=function(){"use strict";return{getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(a){return a},getErrorResponse:function(a){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(a))}}}},v.dependencies.protection.servers.Widevine.prototype={constructor:v.dependencies.protection.servers.Widevine},v.vo.protection.ClearKeyKeySet=function(a,b){if(b&&"persistent"!==b&&"temporary"!==b)throw new Error("Invalid ClearKey key set type!  Must be one of 'persistent' or 'temporary'");this.keyPairs=a,this.type=b,this.toJWK=function(){var a,b=this.keyPairs.length,c={};for(c.keys=[],a=0;b>a;a++){var d={kty:"oct",alg:"A128KW",kid:this.keyPairs[a].keyID,k:this.keyPairs[a].key};c.keys.push(d)}this.type&&(c.type=this.type);var e=JSON.stringify(c),f=e.length,g=new ArrayBuffer(f),h=new Uint8Array(g);for(a=0;f>a;a++)h[a]=e.charCodeAt(a);return g}},v.vo.protection.ClearKeyKeySet.prototype={constructor:v.vo.protection.ClearKeyKeySet},v.vo.protection.KeyError=function(a,b,c){"use strict";this.code=a,this.message=b,this.data=c},v.vo.protection.KeyError.prototype={constructor:v.vo.protection.KeyError},v.vo.protection.KeyMessage=function(a,b,c,d){"use strict";this.sessionToken=a,this.message=b,this.defaultURL=c,this.messageType=d},v.vo.protection.KeyMessage.prototype={constructor:v.vo.protection.KeyMessage},v.vo.protection.KeyPair=function(a,b){"use strict";this.keyID=a,this.key=b},v.vo.protection.KeyPair.prototype={constructor:v.vo.protection.KeyPair},v.vo.protection.KeySystemAccess=function(a,b){this.keySystem=a,this.ksConfiguration=b},v.vo.protection.KeySystemAccess.prototype={constructor:v.vo.protection.KeySystemAccess},v.vo.protection.KeySystemConfiguration=function(a,b,c,d,e){this.initDataTypes=["cenc"],this.audioCapabilities=a,this.videoCapabilities=b,this.distinctiveIdentifier=c,this.persistentState=d,this.sessionTypes=e},v.vo.protection.KeySystemConfiguration.prototype={constructor:v.vo.protection.KeySystemConfiguration},v.vo.protection.LicenseRequestComplete=function(a,b){"use strict";this.message=a,this.requestData=b},v.vo.protection.LicenseRequestComplete.prototype={constructor:v.vo.protection.LicenseRequestComplete},v.vo.protection.MediaCapability=function(a,b){this.contentType=a,this.robustness=b},v.vo.protection.MediaCapability.prototype={constructor:v.vo.protection.MediaCapability},v.vo.protection.NeedKey=function(a,b){this.initData=a,this.initDataType=b},v.vo.protection.NeedKey.prototype={constructor:v.vo.protection.NeedKey},v.vo.protection.ProtectionData=function(a,b,c,d){this.laURL=a,this.httpRequestHeaders=b,this.bearerToken=c,this.clearkeys=d},v.vo.protection.ProtectionData.prototype={constructor:v.vo.protection.ProtectionData},v.models.SessionToken=function(){"use strict"},v.models.SessionToken.prototype={initData:null,getSessionID:function(){return""},getExpirationTime:function(){return NaN},getKeyStatuses:function(){return null}},v.rules.BaseRulesCollection=function(){"use strict";var a=[],b=[];return{downloadRatioRule:void 0,insufficientBufferRule:void 0,abandonRequestRule:void 0,getRules:function(c){switch(c){case v.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES:return o.when(a);case v.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES:return o.when(b);default:return null}},setup:function(){a.push(this.downloadRatioRule),a.push(this.insufficientBufferRule),b.push(this.abandonRequestRule)}}},v.rules.BaseRulesCollection.prototype={constructor:v.rules.BaseRulesCollection,QUALITY_SWITCH_RULES:"qualitySwitchRules",ABANDON_FRAGMENT_RULES:"abandonFragmentRules"},v.rules.DownloadRatioRule=function(){"use strict";var a=function(a,b,c){var d=this,e=o.defer();return d.manifestExt.getRepresentationFor(a,c).then(function(a){d.manifestExt.getBandwidth(a).then(function(a){e.resolve(a/b)})}),e.promise};return{debug:void 0,manifestExt:void 0,metricsExt:void 0,checkIndex:function(b,c,d){var e,f,g,h,i,j,k,l,m,n=this,p=n.metricsExt.getCurrentHttpRequest(c),q=.75;return c?null===p?o.when(new v.rules.SwitchRequest):(f=(p.tfinish.getTime()-p.trequest.getTime())/1e3,e=(p.tfinish.getTime()-p.tresponse.getTime())/1e3,0>=f?o.when(new v.rules.SwitchRequest):null===p.mediaduration||void 0===p.mediaduration||p.mediaduration<=0||isNaN(p.mediaduration)?o.when(new v.rules.SwitchRequest):(j=o.defer(),h=p.mediaduration/f,g=p.mediaduration/e*q,isNaN(g)||isNaN(h)?(n.debug.log("The ratios are NaN, bailing."),o.when(new v.rules.SwitchRequest)):(isNaN(g)?j.resolve(new v.rules.SwitchRequest):4>g?b>0?(n.debug.log("We are not at the lowest bitrate, so switch down."),n.manifestExt.getRepresentationFor(b-1,d).then(function(a){n.manifestExt.getBandwidth(a).then(function(a){n.manifestExt.getRepresentationFor(b,d).then(function(c){n.manifestExt.getBandwidth(c).then(function(c){i=a/c,i>g?(n.debug.log("Things must be going pretty bad, switch all the way down."),j.resolve(new v.rules.SwitchRequest(0))):(n.debug.log("Things could be better, so just switch down one index."),j.resolve(new v.rules.SwitchRequest(b-1)))})})})})):j.resolve(new v.rules.SwitchRequest(b)):n.manifestExt.getRepresentationCount(d).then(function(c){c-=1,c>b?n.manifestExt.getRepresentationFor(b+1,d).then(function(e){n.manifestExt.getBandwidth(e).then(function(e){n.manifestExt.getRepresentationFor(b,d).then(function(f){n.manifestExt.getBandwidth(f).then(function(f){if(i=e/f,g>=i)if(g>100)n.debug.log("Tons of bandwidth available, go all the way up."),j.resolve(new v.rules.SwitchRequest(c-1));else if(g>10)n.debug.log("Just enough bandwidth available, switch up one."),j.resolve(new v.rules.SwitchRequest(b+1));else{for(l=-1,k=[];(l+=1)<c;)k.push(a.call(n,l,f,d));o.all(k).then(function(a){for(l=0,m=a.length;m>l&&!(g<a[l]);l+=1);n.debug.log("Calculated ideal new quality index is: "+l),j.resolve(new v.rules.SwitchRequest(l))})}else j.resolve(new v.rules.SwitchRequest)})})})}):j.resolve(new v.rules.SwitchRequest(c))}),j.promise))):o.when(new v.rules.SwitchRequest)}}},v.rules.DownloadRatioRule.prototype={constructor:v.rules.DownloadRatioRule},v.rules.InsufficientBufferRule=function(){"use strict";var a=0,b=3;return{debug:void 0,checkIndex:function(c,d){var e,f,g=this,h=!1,i=v.rules.SwitchRequest.prototype.DEFAULT;return null===d.PlayList||void 0===d.PlayList||0===d.PlayList.length?o.when(new v.rules.SwitchRequest):(e=d.PlayList[d.PlayList.length-1],null===e||void 0===e||0===e.trace.length?o.when(new v.rules.SwitchRequest):(f=e.trace[e.trace.length-2],null===f||void 0===f||null===f.stopreason||void 0===f.stopreason?o.when(new v.rules.SwitchRequest):(f.stopreason===v.vo.metrics.PlayList.Trace.REBUFFERING_REASON&&(h=!0,a+=1,g.debug.log("Number of times the buffer has run dry: "+a)),a>b&&(i=v.rules.SwitchRequest.prototype.STRONG,g.debug.log("Apply STRONG to buffer rule.")),h?(g.debug.log("The buffer ran dry recently, switch down."),o.when(new v.rules.SwitchRequest(c-1,i))):a>b?(g.debug.log("Too many dry buffer hits, quit switching bitrates."),o.when(new v.rules.SwitchRequest(c,i))):o.when(new v.rules.SwitchRequest(v.rules.SwitchRequest.prototype.NO_CHANGE,i)))))}}},v.rules.InsufficientBufferRule.prototype={constructor:v.rules.InsufficientBufferRule},v.rules.LimitSwitchesRule=function(){"use strict";var a=10,b=2e4,c=5,d=0;return{debug:void 0,checkIndex:function(e,f){if(d>0)return d-=1,o.when(new v.rules.SwitchRequest(e,v.rules.SwitchRequest.prototype.STRONG));var g,h,i,j=this,k=!1,l=(new Date).getTime(),m=f.RepSwitchList.length;for(i=m-1;i>=0;i-=1){if(g=f.RepSwitchList[i],h=l-g.t.getTime(),h>=b){j.debug.log("Reached time limit, bailing.");break}if(i>=a){j.debug.log("Found too many switches within validation time, force the stream to not change."),k=!0;break}}return k?(j.debug.log("Wait some time before allowing another switch."),d=c,o.when(new v.rules.SwitchRequest(e,v.rules.SwitchRequest.prototype.STRONG))):o.when(new v.rules.SwitchRequest(v.rules.SwitchRequest.prototype.NO_CHANGE,v.rules.SwitchRequest.prototype.STRONG))}}},v.rules.LimitSwitchesRule.prototype={constructor:v.rules.LimitSwitchesRule},v.rules.SwitchRequest=function(a,b){"use strict";this.quality=a,this.priority=b,void 0===this.quality&&(this.quality=999),void 0===this.priority&&(this.priority=.5)},v.rules.SwitchRequest.prototype={constructor:v.rules.SwitchRequest,NO_CHANGE:999,DEFAULT:.5,STRONG:1,WEAK:0},v.rules.AbandonRequestsRule=function(){"use strict";var a=.5,b=2;return{debug:void 0,metricsExt:void 0,execute:function(c,d){var e,f,g,h=(new Date).getTime(),i=c.streamType,j=new v.rules.SwitchRequest(v.rules.SwitchRequest.prototype.NO_CHANGE,v.rules.SwitchRequest.prototype.WEAK);return null===c.firstByteDate||c.aborted?(this.debug.log("[AbandonRequestsRule]["+i+"] Request has already been aborted."),void d(j)):(e=(h-c.firstByteDate.getTime())/1e3,c.bytesLoaded<c.bytesTotal&&e>=c.duration*a&&(f=c.bytesLoaded/e,g=c.bytesTotal/f,g>c.duration*b&&(j=new v.rules.SwitchRequest(this.metricsExt.getQualityBoundaries(i).min,v.rules.SwitchRequest.prototype.STRONG),this.debug.info("[AbandonRequestsRule]["+i+"] bw = "+f+" kb/s => switch to lowest quality for "+c.url))),void d(j))}}},v.rules.AbandonRequestsRule.prototype={constructor:v.rules.AbandonRequestsRule},v.rules.o.DownloadRatioRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,checkIndex:function(a,b,c){var d,e,f,g,h,i,j,k=this,l=k.metricsExt.getCurrentHttpRequest(b),m=k.metricsExt.getHttpRequests(b),n=[],p=v.rules.SwitchRequest.prototype.NO_CHANGE,q=0,r=v.rules.SwitchRequest.prototype.DEFAULT;if(!c||!c.hasOwnProperty("type"))return o.when(new v.rules.SwitchRequest);if(g=k.config.getParamFor(c.type,"ABR.latencyInBandwidth","boolean",!0),h=k.config.getParamFor(c.type,"ABR.switchUpRatioSafetyFactor","number",1.5),k.debug.log("[DownloadRatioRule]["+c.type+"] Checking download ratio rule... (current = "+a+")"),!b)return k.debug.log("[DownloadRatioRule]["+c.type+"]No metrics, bailing."),o.when(new v.rules.SwitchRequest);if(null===l)return k.debug.log("[DownloadRatioRule]["+c.type+"]No requests made for this stream yet, bailing."),o.when(new v.rules.SwitchRequest);if(e=(l.tfinish.getTime()-l.trequest.getTime())/1e3,d=(l.tfinish.getTime()-l.tresponse.getTime())/1e3,0>=e)return k.debug.log("[DownloadRatioRule]["+c.type+"]Don't know how long the download of the last fragment took, bailing."),o.when(new v.rules.SwitchRequest);if(null===l.mediaduration||void 0===l.mediaduration||l.mediaduration<=0||isNaN(l.mediaduration))return k.debug.log("[DownloadRatioRule]["+c.type+"] Don't know the duration of the last media fragment, bailing."),o.when(new v.rules.SwitchRequest);if(i=o.defer(),k.debug.info("[DownloadRatioRule]["+c.type+"] DL: "+Number(d.toFixed(3))+"s, Total: "+Number(e.toFixed(3))+"s"),q=l.bytesLength,m.length>=3)for(j=m.length-2;j>=m.length-3;j--)m[j].tfinish&&m[j].trequest&&m[j].tresponse&&(q+=m[j].bytesLength,e+=(m[j].tfinish.getTime()-m[j].trequest.getTime())/1e3,d+=(m[j].tfinish.getTime()-m[j].tresponse.getTime())/1e3);return q*=8,f=g?q/e:q/d,k.debug.info("[DownloadRatioRule]["+c.type+"] BW = "+Math.round(f/1e3)+" kb/s"),isNaN(f)?o.when(new v.rules.SwitchRequest):(k.manifestExt.getRepresentationCount(c).then(function(b){k.manifestExt.getRepresentationFor(a,c).then(function(d){k.manifestExt.getBandwidth(d).then(function(d){for(j=0;b>j;j+=1)n.push(k.manifestExt.getRepresentationBandwidth(c,j));o.all(n).then(function(e){if(d>=f){for(j=a-1;j>0&&!(e[j]<=f);j-=1);p=j,r=v.rules.SwitchRequest.prototype.WEAK,k.debug.info("[DownloadRatioRule]["+c.type+"] SwitchRequest: q="+p+"/"+(b-1)+" ("+e[p]+"), p="+r),i.resolve(new v.rules.SwitchRequest(p,r))}else{for(j=b-1;j>a;j-=1)if(f>e[j]*h){k.debug.log("[DownloadRatioRule]["+c.type+"] bw = "+f+" results[i] * switchUpRatioSafetyFactor ="+e[j]*h+" with i="+j);break}p=j,r=v.rules.SwitchRequest.prototype.STRONG,k.debug.info("[DownloadRatioRule]["+c.type+"] SwitchRequest: q="+p+"/"+(b-1)+" ("+e[p]+"), p="+r),i.resolve(new v.rules.SwitchRequest(p,r))}})})})}),i.promise)}}},v.rules.o.DownloadRatioRule.prototype={constructor:v.rules.o.DownloadRatioRule},v.rules.o.InsufficientBufferRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,isStartBuffering:{},checkIndex:function(a,b,c,d){var e,f,g,h,i,j,k,l,m=this,n=m.metricsExt.getCurrentBufferLevel(b),p=a,q=v.rules.SwitchRequest.prototype.DEFAULT;return null===c?o.when(new v.rules.SwitchRequest):("buffering"===d&&(m.isStartBuffering[c.type]=!0),null===n?o.when(new v.rules.SwitchRequest):(m.debug.info("[InsufficientBufferRule]["+c.type+"] Checking buffer level ... (current = "+a+", buffer level = "+Math.round(100*n.level)/100+")"),l=o.defer(),m.manifestExt.getMpd(m.manifestModel.getValue()).then(function(b){b?(e=m.config.getParamFor(c.type,"BufferController.minBufferTime","number",b.manifest.minBufferTime),f=m.config.getParamFor(c.type,"ABR.switchLowerBufferRatio","number",.25),g=m.config.getParamFor(c.type,"ABR.switchLowerBufferTime","number",f*e),h=m.config.getParamFor(c.type,"ABR.switchDownBufferRatio","number",.5),i=m.config.getParamFor(c.type,"ABR.switchDownBufferTime","number",h*e),j=m.config.getParamFor(c.type,"ABR.switchUpBufferRatio","number",.75),k=m.config.getParamFor(c.type,"ABR.switchUpBufferTime","number",j*e),n.level<i&&m.isStartBuffering[c.type]?l.resolve(new v.rules.SwitchRequest):(n.level>=i&&(m.isStartBuffering[c.type]=!1),m.manifestExt.getRepresentationCount(c).then(function(b){b-=1,n.level<=g?(p=0,q=v.rules.SwitchRequest.prototype.STRONG):n.level<=i&&(p=a>0?a-1:0,q=v.rules.SwitchRequest.prototype.DEFAULT),m.debug.info("[InsufficientBufferRule]["+c.type+"] SwitchRequest: q="+p+", p="+q),l.resolve(new v.rules.SwitchRequest(p,q))}))):(m.debug.log("[InsufficientBufferRule]["+c.type+"] Manifest not present yet"),l.resolve(new v.rules.SwitchRequest))}),l.promise))}}},v.rules.o.InsufficientBufferRule.prototype={constructor:v.rules.o.OInsufficientBufferRule},v.vo.Error=function(a,b,c){"use strict";this.code=a||null,this.message=b||null,this.data=c||null},v.vo.Error.prototype={constructor:v.vo.Error},v.vo.Event=function(){"use strict";this.type=null,this.sender=null,this.data=null,this.error=null,this.timestamp=NaN},v.vo.Event.prototype={constructor:v.vo.Event},v.models.MetricsList=function(){"use strict";return{TcpList:[],HttpList:[],RepSwitchList:[],BufferedSwitchList:[],BufferLevel:[],PlayList:[],DroppedFrames:[],DVRInfo:[],ManifestUpdate:[]}},v.models.MetricsList.prototype={constructor:v.models.MetricsList},v.vo.Mp4Track=function(){"use strict";this.type="und",this.trackId=0,this.timescale=0,this.duration=0,this.codecs="",this.codecPrivateData="",this.bandwidth="",this.width=0,this.height=0,this.language="und",this.channels=0,this.samplingRate=0,this.contentProtection=void 0,this.samples=[],this.data=null},v.vo.Mp4Track.prototype={constructor:v.vo.Mp4Track},v.vo.Mp4Track.Sample=function(){"use strict";this.dts=0,this.cts=0,this.duration=0,this.data=null,this.size=0},v.vo.Mp4Track.Sample.prototype={constructor:v.vo.Mp4Track.Sample},v.vo.SegmentRequest=function(){"use strict";this.action="download",this.startTime=NaN,this.streamType=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=null,this.requestStartDate=null,this.firstByteDate=null,this.requestEndDate=null,this.deferred=null,this.quality=NaN,this.index=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null},v.vo.SegmentRequest.prototype={constructor:v.vo.SegmentRequest,ACTION_DOWNLOAD:"download",ACTION_COMPLETE:"complete"},v.vo.URIFragmentData=function(){"use strict";this.t=null,this.xywh=null,this.track=null,
this.id=null,this.s=null},v.vo.URIFragmentData.prototype={constructor:v.vo.URIFragmentData},v.vo.metrics.BufferLevel=function(){"use strict";this.t=null,this.level=null},v.vo.metrics.BufferLevel.prototype={constructor:v.vo.metrics.BufferLevel},v.vo.metrics.BufferedSwitch=function(){"use strict";this.mt=null,this.to=null,this.lto=null},v.vo.metrics.BufferedSwitch.prototype={constructor:v.vo.metrics.BufferedSwitch},v.vo.metrics.Condition=function(){"use strict";this.isFullScreen=null,this.windowSize=null,this.droppedFrames=null,this.fps=null,this.bandwidth=null},v.vo.metrics.Condition.prototype={constructor:v.vo.metrics.Condition},v.vo.metrics.DroppedFrames=function(){"use strict";this.time=null,this.droppedFrames=null},v.vo.metrics.DroppedFrames.prototype={constructor:v.vo.metrics.DroppedFrames},v.vo.metrics.DVRInfo=function(){"use strict";this.time=null,this.range=null,this.mpd=null},v.vo.metrics.DVRInfo.prototype={constructor:v.vo.metrics.DVRInfo},v.vo.metrics.HTTPRequest=function(){"use strict";this.stream=null,this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.tfinish=null,this.responsecode=null,this.interval=null,this.mediaduration=null,this.trace=[],this.startTime=null,this.quality=null,this.bytesLength=null},v.vo.metrics.HTTPRequest.prototype={constructor:v.vo.metrics.HTTPRequest},v.vo.metrics.HTTPRequest.Trace=function(){"use strict";this.s=null,this.d=null,this.b=[]},v.vo.metrics.HTTPRequest.Trace.prototype={constructor:v.vo.metrics.HTTPRequest.Trace},v.vo.metrics.ManifestUpdate=function(){"use strict";this.streamType=null,this.type=null,this.requestTime=null,this.fetchTime=null,this.availabilityStartTime=null,this.presentationStartTime=0,this.clientTimeOffset=0,this.currentTime=null,this.buffered=null,this.latency=0,this.periodInfo=[],this.representationInfo=[]},v.vo.metrics.ManifestUpdate.PeriodInfo=function(){"use strict";this.id=null,this.index=null,this.start=null,this.duration=null},v.vo.metrics.ManifestUpdate.RepresentationInfo=function(){"use strict";this.id=null,this.index=null,this.streamType=null,this.periodIndex=null,this.presentationTimeOffset=null,this.startNumber=null,this.segmentInfoType=null},v.vo.metrics.ManifestUpdate.prototype={constructor:v.vo.metrics.ManifestUpdate},v.vo.metrics.ManifestUpdate.PeriodInfo.prototype={constructor:v.vo.metrics.ManifestUpdate.PeriodInfo},v.vo.metrics.ManifestUpdate.RepresentationInfo.prototype={constructor:v.vo.metrics.ManifestUpdate.RepresentationInfo},v.vo.metrics.PlayList=function(){"use strict";this.stream=null,this.start=null,this.mstart=null,this.starttype=null,this.trace=[]},v.vo.metrics.PlayList.Trace=function(){"use strict";this.representationid=null,this.subreplevel=null,this.start=null,this.mstart=null,this.duration=null,this.playbackspeed=null,this.stopreason=null},v.vo.metrics.PlayList.prototype={constructor:v.vo.metrics.PlayList},v.vo.metrics.PlayList.INITIAL_PLAY_START_REASON="initial_start",v.vo.metrics.PlayList.SEEK_START_REASON="seek",v.vo.metrics.PlayList.Trace.prototype={constructor:v.vo.metrics.PlayList.Trace()},v.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON="user_request",v.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON="representation_switch",v.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON="end_of_content",v.vo.metrics.PlayList.Trace.REBUFFERING_REASON="rebuffering",v.vo.metrics.RepresentationSwitch=function(){"use strict";this.t=null,this.mt=null,this.to=null,this.lto=null},v.vo.metrics.RepresentationSwitch.prototype={constructor:v.vo.metrics.RepresentationSwitch},v.vo.metrics.Session=function(){"use strict";this.uri=null,this.loopMode=null,this.endTime=null,this.playerType=null},v.vo.metrics.Session.prototype={constructor:v.vo.metrics.Session},v.vo.metrics.State=function(){"use strict";this.t=null,this.current=null,this.position=null,this.reason=null},v.vo.metrics.State.prototype={constructor:v.vo.metrics.State},v.vo.metrics.TCPConnection=function(){"use strict";this.tcpid=null,this.dest=null,this.topen=null,this.tclose=null,this.tconnect=null},v.vo.metrics.TCPConnection.prototype={constructor:v.vo.metrics.TCPConnection},u=function(){"use strict";return{modules:{},dependencies:{},vo:{},di:{}}}(),u.dependencies.BaseURLExtensions=function(){"use strict";var a=function(a,b){for(var c,d,e,f,g,h,i,j,k,l,m=new DataView(a),n={},o=0;"sidx"!==j&&o<m.byteLength;){for(k=m.getUint32(o),o+=4,j="",f=0;4>f;f+=1)l=m.getInt8(o),j+=String.fromCharCode(l),o+=1;"moof"!==j&&"traf"!==j&&"sidx"!==j?o+=k-8:"sidx"===j&&(o-=8)}if(e=m.getUint32(o,!1)+o,e>a.byteLength)throw"sidx terminates after array buffer";for(n.version=m.getUint8(o+8),o+=12,n.timescale=m.getUint32(o+4,!1),o+=8,0===n.version?(n.earliest_presentation_time=m.getUint32(o,!1),n.first_offset=m.getUint32(o+4,!1),o+=8):(n.earliest_presentation_time=B.Math.to64BitNumber(m.getUint32(o+4,!1),m.getUint32(o,!1)),n.first_offset=(m.getUint32(o+8,!1)<<32)+m.getUint32(o+12,!1),o+=16),n.first_offset+=e+(b||0),n.reference_count=m.getUint16(o+2,!1),o+=4,n.references=[],c=n.first_offset,d=n.earliest_presentation_time,f=0;f<n.reference_count;f+=1)h=m.getUint32(o,!1),g=h>>>31,h=2147483647&h,i=m.getUint32(o+4,!1),o+=12,n.references.push({size:h,type:g,offset:c,duration:i,time:d,timescale:n.timescale}),c+=h,d+=i;if(o!==e)throw"Error: final pos "+o+" differs from SIDX end "+e;return n},b=function(b,c,d){var e,f,g,h,i,j,k,l;for(e=a.call(this,b,d),f=e.references,g=[],i=0,j=f.length;j>i;i+=1)h=new u.vo.Segment,h.duration=f[i].duration,h.media=c,h.startTime=f[i].time,h.timescale=f[i].timescale,k=f[i].offset,l=f[i].offset+f[i].size-1,h.mediaRange=k+"-"+l,g.push(h);return this.debug.log("Parsed SIDX box: "+g.length+" segments."),o.when(g)},c=function(a,b){var d,e,f,g,h,i,j,k,l,m=o.defer(),n=new DataView(a),p=0,q="",r=0,s=!1,t=this;for(t.debug.log("Searching for initialization.");"moov"!==q&&p<n.byteLength;){for(r=n.getUint32(p),p+=4,q="",i=0;4>i;i+=1)j=n.getInt8(p),q+=String.fromCharCode(j),p+=1;"ftyp"===q&&(d=p-8),"moov"===q&&(e=p-8),"moov"!==q&&(p+=r-8)}return h=n.byteLength-p,"moov"!==q?(t.debug.log("Loading more bytes to find initialization."),b.range.start=0,b.range.end=b.bytesLoaded+b.bytesToLoad,k=new XMLHttpRequest,k.onloadend=function(){s||m.reject("Error loading initialization.")},k.onload=function(){s=!0,b.bytesLoaded=b.range.end,c.call(t,k.response).then(function(a){m.resolve(a)})},k.onerror=function(){m.reject("Error loading initialization.")},k.open("GET",t.tokenAuthentication.addTokenAsQueryArg(b.url)),k.responseType="arraybuffer",k.setRequestHeader("Range","bytes="+b.range.start+"-"+b.range.end),k=t.tokenAuthentication.setTokenInRequestHeader(k),k.send(null)):(f=void 0===d?e:d,g=e+r-1,l=f+"-"+g,t.debug.log("Found the initialization.  Range: "+l),m.resolve(l)),m.promise},d=function(a){var b=o.defer(),d=new XMLHttpRequest,e=!0,f=this,g={url:a,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:d};return f.debug.log("Start searching for initialization."),g.range.start=0,g.range.end=g.bytesToLoad,d.onload=function(){d.status<200||d.status>299||(e=!1,g.bytesLoaded=g.range.end,c.call(f,d.response,g).then(function(a){b.resolve(a)}))},d.onloadend=d.onerror=function(){if(e){e=!1;var a={};a.url=g.url,a.request=d,f.errHandler.sendError(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT,null,a),b.reject(d)}},d.open("GET",f.tokenAuthentication.addTokenAsQueryArg(g.url)),d.responseType="arraybuffer",d.setRequestHeader("Range","bytes="+g.range.start+"-"+g.range.end),d=f.tokenAuthentication.setTokenInRequestHeader(d),d.send(null),f.debug.log("Perform init search: "+g.url),b.promise},e=function(a,c){var d,f,g,h,i,j,k,l,m=o.defer(),n=new DataView(a),p=new XMLHttpRequest,q=0,r="",s=0,t=!0,u=!1,w=this;for(w.debug.log("Searching for SIDX box."),w.debug.log(c.bytesLoaded+" bytes loaded.");"sidx"!==r&&q<n.byteLength;){for(s=n.getUint32(q),q+=4,r="",i=0;4>i;i+=1)j=n.getInt8(q),r+=String.fromCharCode(j),q+=1;"sidx"!==r&&(q+=s-8)}if(d=n.byteLength-q,"sidx"!==r)m.reject();else if(s-8>d)w.debug.log("Found SIDX but we don't have all of it."),c.range.start=0,c.range.end=c.bytesLoaded+(s-d),p.onload=function(){p.status<200||p.status>299||(t=!1,c.bytesLoaded=c.range.end,e.call(w,p.response,c).then(function(a){m.resolve(a)}))},p.onloadend=p.onerror=function(){if(t){t=!1;var a={};a.url=c.url,a.request=p,w.errHandler.sendError(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,a),m.reject(p)}},p.open("GET",w.tokenAuthentication.addTokenAsQueryArg(c.url)),p.responseType="arraybuffer",p.setRequestHeader("Range","bytes="+c.range.start+"-"+c.range.end),p=w.tokenAuthentication.setTokenInRequestHeader(p),p.send(null);else if(c.range.start=q-8,c.range.end=c.range.start+s,w.debug.log("Found the SIDX box.  Start: "+c.range.start+" | End: "+c.range.end),f=new ArrayBuffer(c.range.end-c.range.start),h=new Uint8Array(f),g=new Uint8Array(a,c.range.start,c.range.end-c.range.start),h.set(g),k=this.parseSIDX.call(this,f,c.range.start),l=k.references,null!==l&&void 0!==l&&l.length>0&&(u=1===l[0].type),u){w.debug.log("Initiate multiple SIDX load.");var x,y,z,A,B,C,D=[];for(x=0,y=l.length;y>x;x+=1)z=l[x].offset,A=l[x].offset+l[x].size-1,B=z+"-"+A,D.push(this.loadSegments.call(w,c.url,B));o.all(D).then(function(a){for(C=[],x=0,y=a.length;y>x;x+=1)C=C.concat(a[x]);m.resolve(C)},function(a){m.reject(a)})}else w.debug.log("Parsing segments from SIDX."),b.call(w,f,c.url,c.range.start).then(function(a){m.resolve(a)});return m.promise},f=function(a,c){var d,f=o.defer(),g=new XMLHttpRequest,h=!0,i=this,j={url:a,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:g};return null===c?(i.debug.log("No known range for SIDX request."),j.searching=!0,j.range.start=0,j.range.end=j.bytesToLoad):(d=c.split("-"),j.range.start=parseFloat(d[0]),j.range.end=parseFloat(d[1])),g.onload=function(){g.status<200||g.status>299||(h=!1,j.searching?(j.bytesLoaded=j.range.end,e.call(i,g.response,j).then(function(a){f.resolve(a)})):b.call(i,g.response,j.url,j.range.start).then(function(a){f.resolve(a)}))},g.onloadend=g.onerror=function(){if(h){h=!1;var a={};a.url=j.url,a.request=g,i.errHandler.sendError(v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,a),f.reject(g)}},g.open("GET",i.tokenAuthentication.addTokenAsQueryArg(j.url)),g.responseType="arraybuffer",g.setRequestHeader("Range","bytes="+j.range.start+"-"+j.range.end),g=i.tokenAuthentication.setTokenInRequestHeader(g),g.send(null),i.debug.log("Perform SIDX load: "+j.url),f.promise};return{debug:void 0,errHandler:void 0,tokenAuthentication:void 0,loadSegments:f,loadInitialization:d,parseSegments:b,parseSIDX:a,findSIDX:e}},u.dependencies.BaseURLExtensions.prototype={constructor:u.dependencies.BaseURLExtensions},u.di.DashContext=function(){"use strict";return{system:void 0,setup:function(){u.di.DashContext.prototype.setup.call(this),this.system.mapClass("parser",u.dependencies.DashParser),this.system.mapClass("indexHandler",u.dependencies.DashHandler),this.system.mapClass("baseURLExt",u.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",u.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",u.dependencies.DashManifestExtensions),this.system.mapSingleton("metricsExt",u.dependencies.DashMetricsExtensions),this.system.mapSingleton("timelineConverter",u.dependencies.TimelineConverter)}}},u.di.DashContext.prototype=new v.di.Context,u.di.DashContext.prototype.constructor=u.di.DashContext,u.dependencies.DashHandler=function(){"use strict";var a,b,c=-1,d=null,e=null,f=function(a,b){for(;a.length<b;)a="0"+a;return a},g=function(a,b,c){for(var d,e,g,h,i=0,j=0,k=b.length,l="%0",m=l.length;;){if(i=a.indexOf("$"+b),0>i)return a;if(j=a.indexOf("$",i+k),0>j)return a;if(d=a.indexOf(l,i+k),d>i&&j>d)switch(e=a.charAt(j-1),g=parseInt(a.substring(d+m,j-1),10),e){case"d":case"i":case"u":h=f(c.toString(),g);break;case"x":h=f(c.toString(16),g);break;case"X":h=f(c.toString(16),g).toUpperCase();break;case"o":h=f(c.toString(8),g);break;default:return this.debug.log("Unsupported/invalid IEEE 1003.1 format identifier string in URL"),a}else h=c;a=a.substring(0,i)+h+a.substring(j+1)}},h=function(a){return a.split("$$").join("$")},i=function(a,b){if(null===b||-1===a.indexOf("$RepresentationID$"))return a;var c=b.toString();return a.split("$RepresentationID$").join(c)},j=function(a,b){return a.representation.startNumber+b},k=function(a,b){var c,d=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].BaseURL;return c=a===d?a:-1!==a.indexOf("http://")||-1!==a.indexOf("https://")?a:d+a},l=function(b,c){var d,e,f=this,g=new v.vo.SegmentRequest;return d=b.adaptation.period,g.streamType=c,g.type="Initialization Segment",g.url=k(b.initialization,b),g.range=b.range,e=d.start,g.availabilityStartTime=f.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(e,b.adaptation.period.mpd,a),g.availabilityEndTime=f.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(e+d.duration,d.mpd,a),g.quality=b.index,g},m=function(a){var c=o.defer(),d=null,e=null,f=this;return a?(a.initialization?(d=l.call(f,a,b),c.resolve(d)):(e=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].BaseURL,f.baseURLExt.loadInitialization(e).then(function(g){a.range=g,a.initialization=e,d=l.call(f,a,b),c.resolve(d)},function(a){c.reject(a)})),c.promise):o.reject("no represenation")},n=function(b){var d,f,g,h=b.adaptation.period,i=!1;return b&&b.segments&&b.segments.length>0&&(null===e||e>b.segments[0].availabilityIdx)&&(e=b.segments[0].availabilityIdx),a?i=!1:0>c?i=!1:c<b.availableSegmentsNumber+e?(f=D(c,b),f&&(g=f.presentationStartTime-h.start,d=b.adaptation.period.duration,i=g>=d)):i=!0,o.when(i)},p=function(b,c){var d,e,f,g,h=this;return e=b.segmentDuration,f=b.adaptation.period.start+c*e,g=f+e,d=new u.vo.Segment,d.representation=b,d.duration=e,d.presentationStartTime=f,d.mediaStartTime=h.timelineConverter.calcMediaTimeFromPresentationTime(d.presentationStartTime,b),d.availabilityStartTime=h.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(d.presentationStartTime,b.adaptation.period.mpd,a),d.availabilityEndTime=h.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(g,b.adaptation.period.mpd,a),d.wallStartTime=h.timelineConverter.calcWallTimeForSegment(d,a),d.replacementNumber=j(d,c),d.availabilityIdx=c,d},q=function(a){var b,c,e,f,g,h,i,j,k,l,m,n,p,q,r=this,s=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].SegmentTemplate,u=s.SegmentTimeline,v=a.availableSegmentsNumber>0,w=10,y=[],z=0,A=-1,B=function(b){return x.call(r,a,z,b.d,q,s.media,b.mediaRange,A)};for(q=a.timescale,b=u.S_asArray,k=t.call(r,a),k?(n=k.start,p=k.end):m=r.timelineConverter.calcMediaTimeFromPresentationTime(d||0,a),e=0,f=b.length;f>e;e+=1)if(c=b[e],h=0,c.hasOwnProperty("r")&&(h=c.r),c.hasOwnProperty("t")&&(z=c.t),0>h&&(j=b[e+1],i=j&&j.hasOwnProperty("t")?j.t/q:a.adaptation.period.duration,h=Math.ceil((i-z/q)/(c.d/q))-1),l){if(v)break;A+=h+1}else for(g=0;h>=g;g+=1){if(A+=1,k){if(A>p){if(l=!0,v)break;continue}A>=n&&y.push(B.call(r,c))}else{if(y.length>w){if(l=!0,v)break;continue}z/q>=m-c.d/q&&y.push(B.call(r,c))}z+=c.d}if(!v){var C,D,E=b[0];C=void 0===E.t?0:r.timelineConverter.calcPresentationTimeFromMediaTime(E.t/q,a),D=r.timelineConverter.calcPresentationTimeFromMediaTime((z-c.d)/q,a),a.segmentAvailabilityRange={start:C,end:D},a.availableSegmentsNumber=A+1}return o.when(y)},r=function(b){var c,d,e,f,h=[],i=this,j=o.defer(),k=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].SegmentTemplate,l=b.segmentDuration,m=null,n=Math.floor(b.adaptation.period.start/l),q=null,r=null;return f=b.startNumber,w.call(i,b).then(function(o){for(b.segmentAvailabilityRange=o,m=s.call(i,b),d=m.start,e=m.end,c=d;e>=c;c+=1)q=p.call(i,b,c-(a?n:0)),q.replacementTime=(f+c-1)*b.segmentDuration,r=k.media,r=g(r,"Number",q.replacementNumber),r=g(r,"Time",q.replacementTime),q.media=r,h.push(q),q=null;b.availableSegmentsNumber=n+Math.ceil((o.end-o.start)/l),j.resolve(h)}),j.promise},s=function(b){var e,f,g,h=this,i=b.adaptation.period.start,j=b.segmentDuration,k=b.adaptation.period.mpd.manifest.minBufferTime,l=b.segmentAvailabilityRange,m=NaN,n=null,o=b.segments,p=2*j,q=Math.max(2*k,10*j);return l||(l=h.timelineConverter.calcSegmentAvailabilityRange(b,a)),a&&!b.adaptation.period.mpd.isClientServerTimeSyncCompleted?(e=Math.floor(l.start/j),f=Math.floor(l.end/j),g={start:e,end:f}):(o?(n=D(c,b),m=n?n.presentationStartTime-i:c>0?c*j:d-i||o[0].presentationStartTime-i):m=c>0?c*j:a?l.end:l.start,e=Math.floor(Math.max(m-p,l.start)/j),f=Math.floor(Math.min(e+q/j,l.end/j)),g={start:e,end:f})},t=function(b){var e,f,g,h=NaN,i=b.segments,j=2,k=10,l=0,m=Number.POSITIVE_INFINITY;if(a&&!b.adaptation.period.mpd.isClientServerTimeSyncCompleted)return g={start:l,end:m};if(!a&&null!==d)return null;if(i){if(0>c)return null;h=c}else h=c>0?c:a?m:l;return e=Math.max(h-j,l),f=Math.min(h+k,m),g={start:e,end:f}},w=function(b){var c,d,e=this,f=o.defer(),g=function(){c=e.timelineConverter.calcSegmentAvailabilityRange(b,a),c.end>0?f.resolve(c):(d=1e3*Math.abs(c.end),setTimeout(g,d))};return g(),f.promise},x=function(b,c,d,e,f,h,i){var k,l,m,n=this,o=c/e,p=Math.min(d/e,b.adaptation.period.mpd.maxSegmentDuration);return k=n.timelineConverter.calcPresentationTimeFromMediaTime(o,b),k=o,l=k+p,m=new u.vo.Segment,m.representation=b,m.duration=p,m.mediaStartTime=o,m.presentationStartTime=k,m.availabilityStartTime=b.adaptation.period.mpd.manifest.mpdLoadedTime,m.availabilityEndTime=n.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(l,b.adaptation.period.mpd,a),m.wallStartTime=n.timelineConverter.calcWallTimeForSegment(m,a),m.replacementTime=c,m.replacementNumber=j(m,i),f=g(f,"Number",m.replacementNumber),f=g(f,"Time",m.replacementTime),m.media=f,m.mediaRange=h,m.availabilityIdx=i,m},y=function(b){var c,d,e,f,g,h=this,i=[],j=o.defer(),k=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].SegmentList,l=k.SegmentURL_asArray.length,m=0,n=k.SegmentURL_asArray.length;return g=b.startNumber,w.call(h,b).then(function(o){for(a||(f=s.call(h,b),m=f.start,n=f.end),c=m;n>c;c+=1)e=k.SegmentURL_asArray[c],d=p.call(h,b,c),d.replacementTime=(g+c-1)*b.segmentDuration,d.media=e.media,d.mediaRange=e.mediaRange,d.index=e.index,d.indexRange=e.indexRange,void 0!==e.sequenceNumber&&(d.sequenceNumber=e.sequenceNumber),i.push(d),d=null;b.segmentAvailabilityRange=o,b.availableSegmentsNumber=l,j.resolve(i)}),j.promise},z=function(a){var b,c,d,e,f=this,g=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].BaseURL,h=o.defer(),i=[],j=0,k=null;return a.indexRange&&(k=a.indexRange),this.baseURLExt.loadSegments(g,k).then(function(g){for(c=0,d=g.length;d>c;c+=1)b=g[c],e=x.call(f,a,b.startTime,b.duration,b.timescale,b.media,b.mediaRange,j),i.push(e),e=null,j+=1;a.segmentAvailabilityRange={start:i[0].presentationStartTime,end:i[d-1].presentationStartTime},a.availableSegmentsNumber=d,h.resolve(i)}),h.promise},A=function(b){var c,d,e=o.defer(),f=this;return F.call(f,b)?(c="SegmentTimeline"===b.segmentInfoType?q.call(f,b):"SegmentTemplate"===b.segmentInfoType?r.call(f,b):"SegmentList"===b.segmentInfoType?y.call(f,b):z.call(f,b),o.when(c).then(function(c){if(b.segments=c,d=c.length-1,a&&isNaN(b.adaptation.period.liveEdge)){var g=f.metricsModel.getMetricsFor("stream"),h=c[d].presentationStartTime;b.adaptation.period.liveEdge=h,f.metricsModel.updateManifestUpdateInfo(f.metricsExt.getCurrentManifestUpdate(g),{presentationStartTime:h})}e.resolve(c)}),e.promise):o.when(b.segments)},B=function(a){var c=this,d=o.defer();return a.segments=null,c.debug.log("[DashHandler]["+b+"] updateSegmentList for representation ",a.id),A.call(c,a).then(function(b){a.segments=b,d.resolve()}),d.promise},C=function(a,c){var d,e,f,g,h=null===c?null:c.segments,i=null===h?0:h.length-1,j=-1,k=this;if(k.debug.log("[DashHandler]["+b+"] getIndexForSegments for time ",a),h&&h.length>0)for(g=i;g>=0;g--){if(d=h[g],e=d.presentationStartTime,f=d.duration,a+u.dependencies.DashHandler.EPSILON>=e&&a-u.dependencies.DashHandler.EPSILON<=e+f){j=d.availabilityIdx,k.debug.log("[DashHandler]["+b+"] getIndexForSegments, idx =  ",j);break}if(-1===j&&a-u.dependencies.DashHandler.EPSILON>e+f){k.debug.log("[DashHandler]["+b+"] getIndexForSegments, (past the end) idx =  ",j),j=isNaN(c.segmentDuration)?d.availabilityIdx+1:Math.floor((a-c.adaptation.period.start)/c.segmentDuration);break}}return-1===j&&(isNaN(c.segmentDuration)?(k.debug.log("Couldn't figure out a time!"),k.debug.log("Time: "+a)):(k.debug.log("[DashHandler]["+b+"] getIndexForSegments, (segment duration) idx =  ",j),j=Math.floor((a-c.adaptation.period.start)/c.segmentDuration))),o.when(j)},D=function(a,b){if(!b||!b.segments)return null;var c,d,e=b.segments.length;for(d=0;e>d;d+=1)if(c=b.segments[d],c.availabilityIdx===a)return c;return null},E=function(a,b){if(!b||!b.segments)return null;var c,d,e=b.segments.length;for(d=0;e>d;d+=1)if(c=b.segments[d],void 0!==c.sequenceNumber&&c.sequenceNumber===a)return e-1>d?b.segments[d+1]:null;return null},F=function(a){var b,e,f,g=!1,h=a.segments;return h&&0!==h.length?(e=h[0].availabilityIdx,b=h[h.length-1].availabilityIdx,f=h[h.length-1].presentationStartTime,g=e>c||c>b||d>f):g=!0,g},G=function(a){if(null===a||void 0===a)return o.when(null);var c,d=new v.vo.SegmentRequest,e=a.representation,f=e.adaptation.period.mpd.manifest.Period_asArray[e.adaptation.period.index].AdaptationSet_asArray[e.adaptation.index].Representation_asArray[e.index].bandwidth;return c=k(a.media,e),c=g(c,"Number",a.replacementNumber),c=g(c,"Time",a.replacementTime),c=g(c,"Bandwidth",f),c=i(c,e.id),c=h(c),d.streamType=b,d.type="Media Segment",d.url=c,d.range=a.mediaRange,d.startTime=a.presentationStartTime,d.duration=a.duration,d.timescale=e.timescale,d.availabilityStartTime=a.availabilityStartTime,d.availabilityEndTime=a.availabilityEndTime,d.wallStartTime=a.wallStartTime,d.quality=e.index,d.index=a.availabilityIdx,void 0!==a.sequenceNumber&&(d.sequenceNumber=a.sequenceNumber),o.when(d)},H=function(a,e){var f,g,h,i=this;return a?(d=e,i.debug.log("[DashHandler]["+b+"] Getting the request for time: "+e),f=o.defer(),A.call(i,a).then(function(){var b;return b=C.call(i,e,a)}).then(function(d){return i.debug.log("[DashHandler]["+b+"] Index for time "+e+" is "+d),c=d,n.call(i,a)}).then(function(d){var e=null;return d?(g=new v.vo.SegmentRequest,g.action=g.ACTION_COMPLETE,g.index=c,i.debug.log("[DashHandler]["+b+"] Signal complete."),i.debug.log(g),f.resolve(g)):(h=D(c,a),e=G.call(i,h)),e}).then(function(a){f.resolve(a)}),f.promise):o.reject("no represenation")},I=function(a){var e,f,g,h=this;if(!a)return o.reject("no represenation");if(-1===c)throw"You must call getSegmentRequestForTime first.";return d=null,c+=1,e=o.defer(),h.debug.log("[DashHandler]["+b+"] Getting the next request => index = "+c),n.call(h,a).then(function(d){d?(f=new v.vo.SegmentRequest,f.action=f.ACTION_COMPLETE,f.index=c,h.debug.log("[DashHandler]["+b+"] Signal complete."),e.resolve(f)):A.call(h,a).then(function(){var b;return g=D(c,a),b=G.call(h,g)}).then(function(a){e.resolve(a)})}),e.promise},J=function(a,d){var e,f,g,h=this;if(!a)return o.reject("no represenation");if(-1===c)throw"You must call getSegmentRequestForTime first.";return e=o.defer(),h.debug.log("[DashHandler]["+b+"] Getting the next request => sn = "+d),A.call(h,a).then(function(){n.call(h,a).then(function(i){i?(f=new v.vo.SegmentRequest,f.action=f.ACTION_COMPLETE,f.index=c,h.debug.log("[DashHandler]["+b+"] Signal complete."),e.resolve(f)):(g=E(d,a),null===g?e.resolve(null):(c=g.availabilityIdx,G.call(h,g).then(function(a){e.resolve(a)})))})}),e.promise},K=function(a,c,d){var e,f=this,g=Math.max(c-d,0),h=o.defer(),i=0;return a?(f.debug.log("[DashHandler]["+b+"] getSegmentCountForDuration"),A.call(f,a).then(function(a){e=a[0].duration,i=Math.ceil(g/e),h.resolve(i)},function(){h.resolve(0)}),h.promise):o.reject("no represenation")},L=function(a){var d,e,f=this,g=o.defer();return a?(e=c,A.call(f,a).then(function(c){0>e?d=f.timelineConverter.calcPresentationStartTime(a.adaptation.period):(e=e<c[0].availabilityIdx?c[0].availabilityIdx:Math.min(c[c.length-1].availabilityIdx,e),d=D(e,a).presentationStartTime,f.debug.log("[DashHandler]["+b+"] getSegmentByIndex, index = "+e+" => time = "+d)),f.debug.log("[DashHandler]["+b+"] getCurrentTime => ",d),g.resolve(d)},function(){g.reject()}),g.promise):o.reject("no represenation")},M=function(a){};return{debug:void 0,baseURLExt:void 0,metricsModel:void 0,metricsExt:void 0,manifestModel:void 0,manifestExt:void 0,timelineConverter:void 0,capabilities:void 0,videoModel:void 0,getType:function(){return b},setType:function(a){b=a},getIsDynamic:function(){return a},setIsDynamic:function(b){a=b},getInitRequest:m,getSegmentRequestForTime:H,getNextSegmentRequest:I,getNextSegmentRequestFromSN:J,getCurrentTime:L,getSegmentCountForDuration:K,updateSegmentList:B,getIFrameRequest:M}},u.dependencies.DashHandler.EPSILON=.003,u.dependencies.DashHandler.prototype={constructor:u.dependencies.DashHandler},u.dependencies.DashManifestExtensions=function(){"use strict";this.timelineConverter=void 0},u.dependencies.DashManifestExtensions.prototype={constructor:u.dependencies.DashManifestExtensions,getIsAudio:function(a){"use strict";var b,c,d,e,f=!1,g=!1;if(a){if(d=a.ContentComponent_asArray)for(b=0,c=d.length;c>b;b+=1)"audio"===d[b].contentType&&(f=!0,g=!0);if(a.mimeType&&(f=-1!==a.mimeType.indexOf("audio"),g=!0),!g)for(b=0,c=a.Representation_asArray.length;!g&&c>b;)e=a.Representation_asArray[b],e.mimeType&&(f=-1!==e.mimeType.indexOf("audio"),g=!0),b+=1;f&&(a.type="audio")}return o.when(f)},getIsVideo:function(a){"use strict";var b,c,d,e,f=!1,g=!1;if(a){if(d=a.ContentComponent_asArray)for(b=0,c=d.length;c>b;b+=1)"video"===d[b].contentType&&(f=!0,g=!0);if(a.mimeType&&(f=-1!==a.mimeType.indexOf("video"),g=!0),!g)for(b=0,c=a.Representation_asArray.length;!g&&c>b;)e=a.Representation_asArray[b],e.mimeType&&(f=-1!==e.mimeType.indexOf("video"),g=!0),b+=1;f&&(a.type="video")}return o.when(f)},getIsText:function(a){"use strict";var b,c,d,e=a.ContentComponent_asArray,f=!1,g=!1;if(a){if(e)for(b=0,c=e.length;c>b;b+=1)"text"===e[b].contentType&&(f=!0,g=!0);if(a.mimeType&&(f=-1!==a.mimeType.indexOf("vtt")||-1!==a.mimeType.indexOf("ttml"),g=!0),!g)for(b=0,c=a.Representation_asArray.length;!g&&c>b;)d=a.Representation_asArray[b],d.mimeType&&(f=-1!==d.mimeType.indexOf("vtt")||-1!==d.mimeType.indexOf("ttml"),g=!0),b+=1;g&&(a.type="text")}return o.when(f)},getIsTextTrack:function(a){return"text/vtt"===a||"application/ttml+xml"===a||"application/ttml+xml+mp4"===a},getIsMain:function(){"use strict";return o.when(!1)},processAdaptation:function(a){"use strict";return void 0!==a.Representation_asArray&&null!==a.Representation_asArray&&a.Representation_asArray.sort(function(a,b){return a.bandwidth-b.bandwidth}),a},getDataForId:function(a,b,c){"use strict";var d,e,f=b.Period_asArray[c].AdaptationSet_asArray;for(d=0,e=f.length;e>d;d+=1)if(f[d].hasOwnProperty("id")&&f[d].id===a)return o.when(f[d]);return o.when(null)},getDataForIndex:function(a,b,c){"use strict";var d=b.Period_asArray[c].AdaptationSet_asArray;return o.when(d[a])},getDataForIndex_:function(a,b,c){"use strict";var d;return b&&c>=0&&(d=b.Period_asArray[c].AdaptationSet_asArray,d&&d.length>0&&!isNaN(a))?d[a]:[]},getIndex:function(a,b){var c,d,e,f=b.Period_asArray;for(d=0;d<f.length;d+=1)for(c=f[d].AdaptationSet_asArray,e=0;e<c.length;e+=1)if(c[e]===a)return e;return-1},getDataIndex:function(a,b,c){"use strict";var d,e,f;if(b&&c>=0)if(d=b.Period_asArray[c].AdaptationSet_asArray,a.id){for(e=0,f=d.length;f>e;e+=1)if(d[e].id&&d[e].id===a.id)return o.when(e)}else{var g,h=JSON.stringify(a);for(e=0,f=d.length;f>e;e+=1)if(g=JSON.stringify(d[e]),g===h)return o.when(e)}return o.when(-1)},getVideoData:function(a,b){"use strict";var c,d,e,f=o.defer(),g=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,d=0,e=c.length;e>d;d+=1)g.push(this.getIsVideo(c[d]));o.all(g).then(function(a){var b=!1;for(d=0,e=a.length;e>d;d+=1)a[d]===!0&&(b=!0,f.resolve(c[d]));b||f.reject()})}else f.reject();return f.promise},getTextDatas:function(a,b){"use strict";var c,d,e,f=o.defer(),g=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,d=0,e=c.length;e>d;d+=1)g.push(this.getIsText(c[d]));o.all(g).then(function(a){var b=[];for(d=0,e=a.length;e>d;d+=1)a[d]===!0&&b.push(c[d]),f.resolve(b)})}else f.reject();return f.promise},getAudioDatas:function(a,b){"use strict";var c,d,e,f=o.defer(),g=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,d=0,e=c.length;e>d;d+=1)g.push(this.getIsAudio(c[d]));o.all(g).then(function(a){var b=[];for(d=0,e=a.length;e>d;d+=1)a[d]===!0&&b.push(c[d]);f.resolve(b)})}else f.reject();return f.promise},getSpecificAudioData:function(a,b,c){"use strict";var d,e,f=o.defer(),g=!1,h=this;return a&&b>=0?this.getAudioDatas(a,b).then(function(a){if(!a||0===a.length)return void f.reject();for(d=0,e=a.length;e>d&&g!==!0;d+=1)a[d].lang===c&&(g=!0,f.resolve(h.processAdaptation(a[d])));g||f.resolve(a[0])}):f.reject(),f.promise},getPrimaryAudioData:function(a,b){"use strict";var c,d,e=o.defer(),f=[],g=this;return a&&b>=0?this.getAudioDatas(a,b).then(function(a){if(!a||0===a.length)return void e.reject();for(c=0,d=a.length;d>c;c+=1)f.push(g.getIsMain(a[c]));o.all(f).then(function(b){var f=!1;for(c=0,d=b.length;d>c;c+=1)b[c]===!0&&(f=!0,e.resolve(g.processAdaptation(a[c])));f||e.resolve(a[0])})}):e.reject(),e.promise},getPrimaryTextData:function(a,b){"use strict";var c,d,e=o.defer(),f=[],g=this;return a&&b>=0?this.getTextDatas(a,b).then(function(a){if(!a||0===a.length)return void e.reject();for(c=0,d=a.length;d>c;c+=1)f.push(g.getIsMain(a[c]));o.all(f).then(function(b){var f=!1;for(c=0,d=b.length;d>c;c+=1)b[c]===!0&&(f=!0,e.resolve(g.processAdaptation(a[c])));f||e.resolve(a[0])})}):e.reject(),e.promise},getSpecificTextData:function(a,b,c){"use strict";var d,e,f=o.defer(),g=!1,h=this;return a&&b>=0?this.getTextDatas(a,b).then(function(a){if(!a||0===a.length)return void f.reject();for(d=0,e=a.length;e>d&&g!==!0;d+=1)a[d].lang===c&&(g=!0,f.resolve(h.processAdaptation(a[d])));g||f.resolve(a[0])}):f.reject(),f.promise},getCodec:function(a){"use strict";for(var b,c=0,d=null;null===d&&c<a.Representation_asArray.length;)b=a.Representation_asArray[c],null!==b.codecs&&""!==b.codecs&&(d=b.mimeType+';codecs="'+b.codecs+'"'),c++;return o.when(d)},getMimeType:function(a){"use strict";return o.when(a.Representation_asArray[0].mimeType)},getKID:function(a){"use strict";return a&&a.hasOwnProperty("cenc:default_KID")?a["cenc:default_KID"]:null},getContentProtectionData:function(a){"use strict";return a&&a.hasOwnProperty("ContentProtection_asArray")&&0!==a.ContentProtection_asArray.length?o.when(a.ContentProtection_asArray):o.when(null)},getIsDynamic:function(a){"use strict";var b=!1,c="dynamic";return a&&a.hasOwnProperty("type")&&(b=a.type===c),b},getIsDVR:function(a){"use strict";var b,c,d=this.getIsDynamic(a);return b=!isNaN(a.timeShiftBufferDepth),c=d&&b,o.when(c)},getIsOnDemand:function(a){"use strict";var b=!1;return a.profiles&&a.profiles.length>0&&(b=-1!==a.profiles.indexOf("urn:mpeg:dash:profile:isoff-on-demand:2011")),o.when(b)},getDuration:function(a){var b;return b=a&&a.hasOwnProperty("mediaPresentationDuration")?a.mediaPresentationDuration:Number.POSITIVE_INFINITY,o.when(b)},getBandwidth:function(a){"use strict";return o.when(a.bandwidth)},getRefreshDelay:function(a){"use strict";var b=NaN,c=2;return a.hasOwnProperty("minimumUpdatePeriod")&&(b=Math.max(parseFloat(a.minimumUpdatePeriod),c)),
o.when(b)},getRepresentationCount:function(a){"use strict";return a?o.when(a.Representation_asArray.length):o.when(null)},getRepresentationFor:function(a,b){"use strict";return o.when(b.Representation_asArray[a])},getRepresentationsForAdaptation:function(a,b){var c,d,e,f,g,h=this,i=[],j=o.defer();if(a&&b){c=h.processAdaptation(a.Period_asArray[b.period.index].AdaptationSet_asArray[b.index]);for(var k=0;k<c.Representation_asArray.length;k+=1)g=c.Representation_asArray[k],d=new u.vo.Representation,d.index=k,d.adaptation=b,g.hasOwnProperty("id")&&(d.id=g.id),g.hasOwnProperty("SegmentBase")?(f=g.SegmentBase,d.segmentInfoType="SegmentBase"):g.hasOwnProperty("SegmentList")?(f=g.SegmentList,d.segmentInfoType="SegmentList",d.useCalculatedLiveEdgeTime=!0):g.hasOwnProperty("SegmentTemplate")?(f=g.SegmentTemplate,f.hasOwnProperty("SegmentTimeline")?d.segmentInfoType="SegmentTimeline":d.segmentInfoType="SegmentTemplate",f.hasOwnProperty("initialization")&&(d.initialization=f.initialization.split("$Bandwidth$").join(g.bandwidth).split("$RepresentationID$").join(g.id))):(f=g.BaseURL,d.segmentInfoType="BaseURL"),f.hasOwnProperty("Initialization")?(e=f.Initialization,e.hasOwnProperty("sourceURL")?d.initialization=e.sourceURL:e.hasOwnProperty("range")&&(d.initialization=g.BaseURL,d.range=e.range)):g.hasOwnProperty("mimeType")&&h.getIsTextTrack(g.mimeType)&&(d.initialization=g.BaseURL,d.range=0),f.hasOwnProperty("timescale")&&(d.timescale=f.timescale),f.hasOwnProperty("duration")&&(d.segmentDuration=f.duration/d.timescale),f.hasOwnProperty("startNumber")&&(d.startNumber=f.startNumber),f.hasOwnProperty("indexRange")&&(d.indexRange=f.indexRange),f.hasOwnProperty("presentationTimeOffset")&&(d.presentationTimeOffset=f.presentationTimeOffset/d.timescale),d.MSETimeOffset=h.timelineConverter.calcMSETimeOffset(d),i.push(d)}return j.resolve(i),j.promise},getAdaptationsForPeriod:function(a,b){var c,d=null===a?null:a.Period_asArray[b.index],e=[];if(d)for(var f=0;f<d.AdaptationSet_asArray.length;f+=1)c=new u.vo.AdaptationSet,c.index=f,c.period=b,e.push(c);return o.when(e)},getRegularPeriods:function(a,b){var c,d,e=this,f=o.defer(),g=[],h=e.getIsDynamic(a),i=null,j=null,k=null,l=null;for(c=0,d=a.Period_asArray.length;d>c;c+=1)j=a.Period_asArray[c],j.hasOwnProperty("start")?(l=new u.vo.Period,l.start=j.start):null!==i&&j.hasOwnProperty("duration")?(l=new u.vo.Period,l.start=k.start+k.duration,l.duration=j.duration):0!==c||h||(l=new u.vo.Period,l.start=0),null!==k&&isNaN(k.duration)&&(k.duration=l.start-k.start),null!==l&&j.hasOwnProperty("id")&&(l.id=j.id),null!==l&&j.hasOwnProperty("duration")&&(l.duration=j.duration),null!==l&&(l.index=c,l.mpd=b,g.push(l)),i=j,j=null,k=l,l=null;return 0===g.length?o.when(g):(e.getCheckTime(a,g[0]).then(function(a){b.checkTime=a,null!==k&&isNaN(k.duration)?e.getEndTimeForLastPeriod(b).then(function(a){k.duration=a-k.start,f.resolve(g)}):f.resolve(g)}),o.when(f.promise))},getMpd:function(a){var b=new u.vo.Mpd;return a?(b.manifest=a,a.hasOwnProperty("availabilityStartTime")?b.availabilityStartTime=new Date(a.availabilityStartTime.getTime()):b.availabilityStartTime=new Date(a.mpdLoadedTime.getTime()),a.hasOwnProperty("availabilityEndTime")&&(b.availabilityEndTime=new Date(a.availabilityEndTime.getTime())),a.hasOwnProperty("suggestedPresentationDelay")&&(b.suggestedPresentationDelay=a.suggestedPresentationDelay),a.hasOwnProperty("timeShiftBufferDepth")&&(b.timeShiftBufferDepth=a.timeShiftBufferDepth),a.hasOwnProperty("maxSegmentDuration")&&(b.maxSegmentDuration=a.maxSegmentDuration),o.when(b)):o.when(null)},getFetchTime:function(a,b){var c=this.timelineConverter.calcPresentationTimeFromWallTime(a.mpdLoadedTime,b);return o.when(c)},getCheckTime:function(a,b){var c=this,d=o.defer(),e=NaN;return a.hasOwnProperty("minimumUpdatePeriod")?c.getFetchTime(a,b).then(function(b){e=b+a.minimumUpdatePeriod,d.resolve(e)}):d.resolve(e),d.promise},getEndTimeForLastPeriod:function(a){var b;if(a.manifest.mediaPresentationDuration)b=a.manifest.mediaPresentationDuration;else{if(isNaN(a.checkTime))return o.fail(new Error("Must have @mediaPresentationDuration or @minimumUpdatePeriod on MPD or an explicit @duration on the last period."));b=a.checkTime}return o.when(b)},getEventsForPeriod:function(a,b){var c=null===a?null:a.Period_asArray,d=null===c?null:c[b.index].EventStream_asArray,e=[];if(d)for(var f=0;f<d.length;f+=1){var g=new u.vo.EventStream;if(g.period=b,g.timescale=1,!d[f].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";g.schemeIdUri=d[f].schemeIdUri,d[f].hasOwnProperty("timescale")&&(g.timescale=d[f].timescale),d[f].hasOwnProperty("value")&&(g.value=d[f].value);for(var h=0;h<d[f].Event_asArray.length;h+=1){var i=new u.vo.Event;i.presentationTime=0,i.eventStream=g,d[f].Event_asArray[h].hasOwnProperty("presentationTime")&&(i.presentationTime=d[f].Event_asArray[h].presentationTime),d[f].Event_asArray[h].hasOwnProperty("duration")&&(i.duration=d[f].Event_asArray[h].duration),d[f].Event_asArray[h].hasOwnProperty("id")&&(i.id=d[f].Event_asArray[h].id),e.push(i)}}return o.when(e)},getEventStreamForAdaptationSet:function(a){var b,c=[];if(a&&(b=a.InbandEventStream_asArray))for(var d=0;d<b.length;d+=1){var e=new u.vo.EventStream;if(e.timescale=1,!b[d].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";e.schemeIdUri=b[d].schemeIdUri,b[d].hasOwnProperty("timescale")&&(e.timescale=b[d].timescale),b[d].hasOwnProperty("value")&&(e.value=b[d].value),c.push(e)}return c},getEventStreamForRepresentation:function(a,b){var c,d=[];if(a&&b&&(c=a.Representation_asArray[b.index].InbandEventStream_asArray))for(var e=0;e<c.length;e++){var f=new u.vo.EventStream;if(f.timescale=1,f.representation=b,!c[e].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";f.schemeIdUri=c[e].schemeIdUri,c[e].hasOwnProperty("timescale")&&(f.timescale=c[e].timescale),c[e].hasOwnProperty("value")&&(f.value=c[e].value),d.push(f)}return d},getRepresentationBandwidth:function(a,b){var c=this,d=o.defer();return c.getRepresentationFor(b,a).then(function(a){c.getBandwidth(a).then(function(a){d.resolve(a)})}),d.promise}},u.dependencies.DashMetricsExtensions=function(){"use strict";var a=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return j;return-1},b=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return f;return null},c=function(a,b){var c=!1;return"video"===b?(this.manifestExt.getIsVideo(a),"video"===a.type&&(c=!0)):"audio"===b?(this.manifestExt.getIsAudio(a),"audio"===a.type&&(c=!0)):c=!1,c},d=function(a,b){var d,e,f,g,h,i;for(h=0;h<a.length;h+=1)for(d=a[h],f=d.AdaptationSet_asArray,i=0;i<f.length;i+=1)if(e=f[i],g=e.Representation_asArray,c.call(this,e,b))return g.length;return-1},e=function(a){var c,d=this,e=d.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?(c=b.call(d,f,a),null===c?null:c.bandwidth):null},f=function(b){var c,d=this,e=d.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?c=a.call(d,f,b):null},g=function(a){var b,c=this,e=c.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?b=d.call(this,f,a):null},h=function(a){if(null===a)return null;var b,c,d,e=a.RepSwitchList;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},i=function(a){if(null===a)return null;var b,c,d,e=a.BufferLevel;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},j=function(a){if(null===a)return null;var b,c,d=a.HttpList,e=null;if(null===d||d.length<=0)return null;for(b=d.length,c=b-1;c>=0;){if(d[c].responsecode){e=d[c];break}c-=1}return e},k=function(a){return null===a?[]:a.HttpList?a.HttpList:[]},l=function(a){if(null===a)return null;var b,c,d,e=a.DroppedFrames;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},m=function(a){if(null===a)return null;var b,c=a.DVRInfo,d=null;return null===c||c.length<=0?null:(b=c.length-1,d=c[b])},n=function(a){if(null===a)return null;var b,c,d,e=a.ManifestUpdate;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])};return{manifestModel:void 0,manifestExt:void 0,getBandwidthForRepresentation:e,getIndexForRepresentation:f,getMaxIndexForBufferType:g,getCurrentRepresentationSwitch:h,getCurrentBufferLevel:i,getCurrentHttpRequest:j,getHttpRequests:k,getCurrentDroppedFrames:l,getCurrentDVRInfo:m,getCurrentManifestUpdate:n}},u.dependencies.DashMetricsExtensions.prototype={constructor:u.dependencies.DashMetricsExtensions},u.dependencies.DashParser=function(){"use strict";var a=31536e3,d=2592e3,e=86400,f=3600,g=60,h=60,i=1e3,j=/^P(([\d.]*)Y)?(([\d.]*)M)?(([\d.]*)D)?T?(([\d.]*)H)?(([\d.]*)M)?(([\d.]*)S)?/,k=/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2})(?::([0-9]*)(\.[0-9]*)?)?(?:([+-])([0-9]{2})([0-9]{2}))?/,l=/^[-+]?[0-9]+[.]?[0-9]*([eE][-+]?[0-9]+)?$/,m=[{type:"duration",test:function(a){return j.test(a)},converter:function(b){var c=j.exec(b);return parseFloat(c[2]||0)*a+parseFloat(c[4]||0)*d+parseFloat(c[6]||0)*e+parseFloat(c[8]||0)*f+parseFloat(c[10]||0)*g+parseFloat(c[12]||0)}},{type:"datetime",test:function(a){return k.test(a)},converter:function(a){var b,c=k.exec(a);if(b=Date.UTC(parseInt(c[1],10),parseInt(c[2],10)-1,parseInt(c[3],10),parseInt(c[4],10),parseInt(c[5],10),c[6]&&parseInt(c[6],10)||0,c[7]&&parseFloat(c[7])*i||0),c[9]&&c[10]){var d=parseInt(c[9],10)*h+parseInt(c[10],10);b+=("+"===c[8]?-1:1)*d*g*i}return new Date(b)}},{type:"numeric",test:function(a){return l.test(a)},converter:function(a){return parseFloat(a)}}],n=function(){var a,b,c,d;return d=[{name:"profiles",merge:!1},{name:"width",merge:!1},{name:"height",merge:!1},{name:"sar",merge:!1},{name:"frameRate",merge:!1},{name:"audioSamplingRate",merge:!1},{name:"mimeType",merge:!1},{name:"segmentProfiles",merge:!1},{name:"codecs",merge:!1},{name:"maximumSAPPeriod",merge:!1},{name:"startsWithSap",merge:!1},{name:"maxPlayoutRate",merge:!1},{name:"codingDependency",merge:!1},{name:"scanType",merge:!1},{name:"FramePacking",merge:!0},{name:"AudioChannelConfiguration",merge:!0},{name:"ContentProtection",merge:!0}],a={},a.name="AdaptationSet",a.isRoot=!1,a.isArray=!0,a.parent=null,a.children=[],a.properties=d,b={},b.name="Representation",b.isRoot=!1,b.isArray=!0,b.parent=a,b.children=[],b.properties=d,a.children.push(b),c={},c.name="SubRepresentation",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=d,b.children.push(c),a},p=function(){var a,b,c,d;return d=[{name:"SegmentBase",merge:!0},{name:"SegmentTemplate",merge:!0},{name:"SegmentList",merge:!0}],a={},a.name="Period",a.isRoot=!1,a.isArray=!0,a.parent=null,a.children=[],a.properties=d,b={},b.name="AdaptationSet",b.isRoot=!1,b.isArray=!0,b.parent=a,b.children=[],b.properties=d,a.children.push(b),c={},c.name="Representation",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=d,b.children.push(c),a},q=function(){var a,b,c,d,e;return e=[{name:"BaseURL",merge:!0,mergeFunction:function(a,b){var c;return c=0===b.indexOf("http://")?b:a+b}}],a={},a.name="mpd",a.isRoot=!0,a.isArray=!0,a.parent=null,a.children=[],a.properties=e,b={},b.name="Period",b.isRoot=!1,b.isArray=!0,b.parent=null,b.children=[],b.properties=e,a.children.push(b),c={},c.name="AdaptationSet",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=e,b.children.push(c),d={},d.name="Representation",d.isRoot=!1,d.isArray=!0,d.parent=c,d.children=[],d.properties=e,c.children.push(d),a},r=function(){var a=[];return a.push(n()),a.push(p()),a.push(q()),a},s=function(a,d){var e,f=new c(m,"",!0),g=new b(r()),h=new Date,i=null,j=null;try{e=f.xml_str2json(a),i=new Date,e.hasOwnProperty("BaseURL")?(e.BaseURL=e.BaseURL_asArray[0],0!==e.BaseURL.toString().indexOf("http")&&(e.BaseURL=d+e.BaseURL)):e.BaseURL=d,g.run(e),j=new Date,this.debug.log("Parsing complete: ( xml2json: "+(i.getTime()-h.getTime())+"ms, objectiron: "+(j.getTime()-i.getTime())+"ms, total: "+(j.getTime()-h.getTime())/1e3+"s)")}catch(k){return o.reject(null)}return o.when(e)};return{debug:void 0,parse:s}},u.dependencies.DashParser.prototype={constructor:u.dependencies.DashParser},u.dependencies.FragmentExtensions=function(){"use strict";var a=function(a){for(var b,c,d,e,f,g,h=o.defer(),i=new DataView(a),j=0;"tfdt"!==e&&j<i.byteLength;){for(d=i.getUint32(j),j+=4,e="",f=0;4>f;f+=1)g=i.getInt8(j),e+=String.fromCharCode(g),j+=1;"moof"!==e&&"traf"!==e&&"tfdt"!==e&&(j+=d-8)}if(j===i.byteLength)throw"Error finding live offset.";return c=i.getUint8(j),this.debug.log("position: "+j),0===c?(j+=4,b=i.getUint32(j,!1)):(j+=d-16,b=B.Math.to64BitNumber(i.getUint32(j+4,!1),i.getUint32(j,!1))),h.resolve({version:c,base_media_decode_time:b}),h.promise},b=function(a){for(var b,c,d,e,f,g,h,i=new DataView(a),j=0;"sidx"!==f&&j<i.byteLength;){for(g=i.getUint32(j),j+=4,f="",e=0;4>e;e+=1)h=i.getInt8(j),f+=String.fromCharCode(h),j+=1;"moof"!==f&&"traf"!==f&&"sidx"!==f?j+=g-8:"sidx"===f&&(j-=8)}return b=i.getUint8(j+8),j+=12,c=i.getUint32(j+4,!1),j+=8,d=0===b?i.getUint32(j,!1):B.Math.to64BitNumber(i.getUint32(j+4,!1),i.getUint32(j,!1)),o.when({earliestPresentationTime:d,timescale:c})},c=function(b){var c,d,e,f=o.defer(),g=new XMLHttpRequest,h=!1;return c=b,g.onloadend=function(){h||(d="Error loading fragment: "+c,f.reject(d))},g.onload=function(){h=!0,e=a(g.response),f.resolve(e)},g.onerror=function(){d="Error loading fragment: "+c,f.reject(d)},g.responseType="arraybuffer",g.open("GET",c),g.send(null),f.promise};return{debug:void 0,loadFragment:c,parseTFDT:a,parseSIDX:b}},u.dependencies.FragmentExtensions.prototype={constructor:u.dependencies.FragmentExtensions},u.dependencies.TimelineConverter=function(){"use strict";var a=0,b=function(a,b,c,d){var e=NaN;return e=d?c&&b.timeShiftBufferDepth!==Number.POSITIVE_INFINITY?new Date(b.availabilityStartTime.getTime()+1e3*(a+b.timeShiftBufferDepth)):b.availabilityEndTime:c?new Date(b.availabilityStartTime.getTime()+1e3*a):b.availabilityStartTime},c=function(a,c,d){return b.call(this,a,c,d)},d=function(a,c,d){return b.call(this,a,c,d,!0)},e=function(a){var b,c="dynamic"===a.mpd.manifest.type,d=parseInt(this.uriQueryFragModel.getURIFragmentData().s,10);return c?(!isNaN(d)&&d>1262304e3&&(b=d-a.mpd.availabilityStartTime.getTime()/1e3,(b>a.liveEdge||b<a.liveEdge-a.mpd.timeShiftBufferDepth)&&(b=null)),b=b||a.liveEdge):b=!isNaN(d)&&d<a.duration&&d>=0?d:a.start,b},f=function(a,b){return(a.getTime()-b.mpd.availabilityStartTime.getTime())/1e3},g=function(a,b){var c=b.presentationTimeOffset;return a-c},h=function(a,b){var c=b.presentationTimeOffset;return c+a},i=function(a,b){var c,d,e;return b&&(c=a.representation.adaptation.period.mpd.suggestedPresentationDelay,d=a.presentationStartTime+c,e=new Date(a.availabilityStartTime.getTime()+1e3*d)),e},j=function(a,b,c){var d,e=this,f=e.calcSegmentAvailabilityRange(a,c);return b>=f.start&&b<=f.end?b:d=Math.max(f.end-2*a.adaptation.period.mpd.manifest.minBufferTime,f.start)},k=function(b,c){var d,e,g=b.segmentDuration,h=0,i=b.adaptation.period.duration,j={start:h,end:i};return c?b.adaptation.period.mpd.isClientServerTimeSyncCompleted&&!isNaN(g)||!b.segmentAvailabilityRange?(d=b.adaptation.period.mpd.checkTime,e=f(new Date((new Date).getTime()+a),b.adaptation.period),h=Math.max(e-b.adaptation.period.mpd.timeShiftBufferDepth,0),d+=a/1e3,i=isNaN(d)?e:Math.min(d,e),j={start:h,end:i}):b.segmentAvailabilityRange:j},l=function(a){var b=a.presentationTimeOffset;return-b};return{system:void 0,debug:void 0,uriQueryFragModel:void 0,setup:function(){},calcAvailabilityStartTimeFromPresentationTime:c,calcAvailabilityEndTimeFromPresentationTime:d,calcPresentationTimeFromWallTime:f,calcPresentationTimeFromMediaTime:g,calcPresentationStartTime:e,calcActualPresentationTime:j,calcMediaTimeFromPresentationTime:h,calcSegmentAvailabilityRange:k,calcWallTimeForSegment:i,calcMSETimeOffset:l}},u.dependencies.TimelineConverter.prototype={constructor:u.dependencies.TimelineConverter},u.vo.AdaptationSet=function(){"use strict";this.period=null,this.index=-1},u.vo.AdaptationSet.prototype={constructor:u.vo.AdaptationSet},u.vo.Event=function(){"use strict";this.duration=NaN,this.presentationTime=NaN,this.id=NaN,this.messageData="",this.eventStream=null,this.presentationTimeDelta=NaN},u.vo.Event.prototype={constructor:u.vo.Event},u.vo.EventStream=function(){"use strict";this.adaptionSet=null,this.representation=null,this.period=null,this.timescale=1,this.value="",this.schemeIdUri=""},u.vo.EventStream.prototype={constructor:u.vo.EventStream},u.vo.Mpd=function(){"use strict";this.manifest=null,this.suggestedPresentationDelay=0,this.availabilityStartTime=null,this.availabilityEndTime=Number.POSITIVE_INFINITY,this.timeShiftBufferDepth=Number.POSITIVE_INFINITY,this.maxSegmentDuration=Number.POSITIVE_INFINITY,this.checkTime=NaN,this.clientServerTimeShift=0,this.isClientServerTimeSyncCompleted=!1},u.vo.Mpd.prototype={constructor:u.vo.Mpd},u.vo.Period=function(){"use strict";this.id=null,this.index=-1,this.duration=NaN,this.start=NaN,this.mpd=null,this.liveEdge=NaN},u.vo.Period.prototype={constructor:u.vo.Period},u.vo.Representation=function(){"use strict";this.id=null,this.index=-1,this.adaptation=null,this.segmentInfoType=null,this.initialization=null,this.segmentDuration=NaN,this.timescale=1,this.startNumber=1,this.indexRange=null,this.range=null,this.presentationTimeOffset=0,this.MSETimeOffset=NaN,this.segmentAvailabilityRange=null,this.availableSegmentsNumber=0},u.vo.Representation.prototype={constructor:u.vo.Representation},u.vo.Segment=function(){"use strict";this.indexRange=null,this.index=null,this.mediaRange=null,this.media=null,this.duration=NaN,this.replacementTime=null,this.replacementNumber=NaN,this.mediaStartTime=NaN,this.presentationStartTime=NaN,this.availabilityStartTime=NaN,this.availabilityEndTime=NaN,this.availabilityIdx=NaN,this.wallStartTime=NaN,this.representation=null},u.vo.Segment.prototype={constructor:u.vo.Segment},t=function(){"use strict";return{dependencies:{}}}(),t.dependencies.HlsDemux=function(){"use strict";var a=function(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(a,0),c.set(b,a.byteLength),c},b=null,c=null,d=[],e=[],f=-1,g=-1,h=function(a,b,c,d){for(var e,f=b;f<a.length;){if(e=new D.ts.TsPacket,e.parse(a.subarray(f,f+D.ts.TsPacket.prototype.TS_PACKET_SIZE)),e.getPid()===c&&(void 0===d||e.getPusi()===d))return{offset:f,packet:e};f+=D.ts.TsPacket.prototype.TS_PACKET_SIZE}return null},i=function(a){var c=h.call(this,a,0,D.ts.TsPacket.prototype.PAT_PID);return null===c?null:(b=new D.si.PAT,b.parse(c.packet.getPayload()),b)},j=function(a,b){var f,g,i,j=h.call(this,a,0,b),k=0,l=1;if(null===j)return null;for(c=new D.si.PMT,c.parse(j.packet.getPayload()),k=0;k<c.m_listOfComponents.length;k++){if(f=c.m_listOfComponents[k],g=new v.vo.Mp4Track,i=c.gStreamTypes[f.m_stream_type],null!==i)switch(g.streamType=i.name,i.value){case 224:g.type="video";break;case 192:g.type="audio";break;case 252:g.type="data";break;default:g.type="und"}else this.debug.log("[HlsDemux] Stream Type "+f.m_stream_type+" unknown!");g.timescale=D.Pts.prototype.SYSTEM_CLOCK_FREQUENCY,g.pid=f.m_elementary_PID,g.trackId=l,d[f.m_elementary_PID]=l,e.push(g),l++}return c},k=function(a){var b,c,h,i,j,k=null,l=null;b=new D.ts.TsPacket,b.parse(a),b.hasAdaptationFieldOnly()||(c=b.getPid(),h=d[c],void 0!==h&&(i=e[h-1],b.getPusi()?(j=new D.pes.PesPacket,j.parse(b.getPayload()),k=new v.vo.Mp4Track.Sample,k.cts=j.getPts().getValue(),k.dts=null!==j.getDts()?j.getDts().getValue():k.cts,k.size=0,k.duration=0,k.subSamples=[],-1===f&&(f=k.dts),k.dts-=f,k.cts-=f,k.dts+=g,k.cts+=g,l=j.getPayload(),k.subSamples.push(l),i.samples.push(k)):(i.samples.length>0&&(k=i.samples[i.samples.length-1]),k.subSamples.push(b.getPayload()))))},l=function(a){var b,c,d,e,f=0,g=0;for(d=0;d<a.samples.length;d++){for(c=0,b=a.samples[d],e=0;e<b.subSamples.length;e++)c+=b.subSamples[e].length;d>0&&(a.samples[d-1].duration=a.samples[d].dts-a.samples[d-1].dts),b.size=c,f+=c}for(a.samples[a.samples.length-1].duration=a.samples[a.samples.length-2].duration,a.data=new Uint8Array(f),a.dataCTS=[],d=0;d<a.samples.length;d++)for(b=a.samples[d],-1!==a.streamType.search("ADTS")&&(a.dataCTS[g]=b.cts),e=0;e<b.subSamples.length;e++)a.data.set(b.subSamples[e],g),g+=b.subSamples[e].length;if(-1!==a.streamType.search("H.264")&&D.h264.bytestreamToMp4(a.data),-1!==a.streamType.search("ADTS")&&m.call(this,a),a.previousCts&&a.previousDuration){b=a.samples[0];var h=b.cts-(a.previousCts+a.previousDuration);h>0&&(b.cts-=h,b.dts-=h,b.duration+=h,this.debug.log("[HlsDemux]["+a.type+"] Patch sample duration, cts = "+(b.cts/9e4).toFixed(3)+", duration = "+(b.duration/9e4).toFixed(3)))}},m=function(a){var b,c,d,e,f,g,h,i,j=[];for(b=D.aac.parseADTS(a.data,a.dataCTS),c=0,i=0;i<b.length;i++)c+=b[i].length;for(e=new Uint8Array(c),g=a.samples[0].cts,h=1024*a.timescale/a.samplingRate,d=0,i=0;i<b.length;i++)f=new v.vo.Mp4Track.Sample,f.cts=f.dts=b[i].cts?b[i].cts:g,f.size=b[i].length,f.duration=h,j.push(f),g=f.cts+h,i>0&&(j[i-1].duration=j[i].cts-j[i-1].cts,j[i-1].duration>h&&this.debug.log("[HlsDemux]["+a.type+"] Patch sample duration, cts = "+(j[i-1].cts/9e4).toFixed(3)+", duration = "+(j[i-1].duration/9e4).toFixed(3))),e.set(a.data.subarray(b[i].offset,b[i].offset+b[i].length),d),d+=b[i].length;a.data=e,a.samples=j},n=function(a){var b="",c=0,d=0;for(c=0;c<a.length;c++)d=a[c].toString(16),d.length<2&&(d="0"+d),b+=d;return b},o=function(a){for(var b=0;b<e.length;b++)e[b].codecs="";-1===g&&(g=a)},p=function(b,c){var d,e,f,g,i,j,k,l;if(""!==c.codecs)return c;if(d=h.call(this,b,0,c.pid,!0),null===d)return null;if(e=new D.pes.PesPacket,e.parse(d.packet.getPayload()),f=e.getPayload(),-1!==c.streamType.search("H.264")){for(g=D.h264.getSequenceHeader(f);null===g;)d=h.call(this,b,d.offset+D.ts.TsPacket.prototype.TS_PACKET_SIZE,c.pid,!1),f=a(f,d.packet.getPayload()),g=D.h264.getSequenceHeader(f);c.codecPrivateData=n(g.bytes),c.codecs="avc1.",i=/00000001[0-9]7/.exec(c.codecPrivateData),i&&i[0]&&(c.codecs+=c.codecPrivateData.substr(c.codecPrivateData.indexOf(i[0])+10,6)),c.width=g.width,c.height=g.height}return-1!==c.streamType.search("AAC")&&(j=D.aac.getAudioSpecificConfig(f),k=(248&j[0])>>3,c.codecPrivateData=n(j),c.codecs="mp4a.40."+k,l=(7&j[0])<<1|(128&j[1])>>7,c.samplingRate=D.aac.SAMPLING_FREQUENCY[l],c.channels=(120&j[1])>>3,c.bandwidth=0),this.debug.log("[HlsDemux]["+c.type+"] track codecPrivateData = "+c.codecPrivateData),this.debug.log("[HlsDemux]["+c.type+"] track codecs = "+c.codecs),c},q=function(a){var d=0;if(!(null===b&&(b=i.call(this,a),null===b)||null===c&&(c=j.call(this,a,b.getPmtPid()),null===c))){for(d=e.length-1;d>=0;d--)p.call(this,a,e[d]),""===e[d].codecs&&e.splice(d,1);return e}},r=function(a){var b,d=a.length/D.ts.TsPacket.prototype.TS_PACKET_SIZE,f=0;if(this.debug.log("[HlsDemux] Demux chunk, size = "+a.length+", nb packets = "+d),null===q.call(this,a))return null;if(null===c)return e;for(f=0;f<e.length;f++)b=e[f],b.samples.length>0&&(b.previousCts=b.samples[b.samples.length-1].cts,b.previousDuration=b.samples[b.samples.length-1].duration),e[f].samples=[],e[f].data=null;for(f=0;f<a.length;)k.call(this,a.subarray(f,f+D.ts.TsPacket.prototype.TS_PACKET_SIZE)),f+=D.ts.TsPacket.prototype.TS_PACKET_SIZE;for(f=0;f<e.length;f++)b=e[f],l.call(this,b),this.debug.log("[HlsDemux]["+b.type+"] Demux: 1st PTS = "+b.samples[0].dts+" ("+b.samples[0].dts/9e4+")");return e};return{debug:void 0,reset:o,getTracks:q,demux:r}},t.dependencies.HlsDemux.prototype={constructor:t.dependencies.HlsDemux},t.dependencies.HlsParser=function(){var a="#EXTM3U",b="#EXTINF",c="#EXT-X-VERSION",d="#EXT-X-TARGETDURATION",e="#EXT-X-MEDIA-SEQUENCE",f="#EXT-X-STREAM-INF",g="#EXT-X-ENDLIST",h="BANDWIDTH",i="PROGRAM-ID",j="AUDIO",k="SUBTITLES",l="RESOLUTION",m="CODECS",n=new XMLHttpRequest,p=function(a){var b=0;for(a=a.split("\n"),b=0;b<a.length;b+=1)(""===a[b]||" "===a[b])&&(a.splice(b,1),b--);return a},q=function(a,b){return a.indexOf(b)>-1},r=function(a,b){return a.substring(b.length+1,a.length)},s=function(a){return a.substring(a.indexOf(":")+1).split(",")},t=function(a){return 0===a.indexOf("http://")||0===a.indexOf("https://")},u=function(a){var b,c={programId:"",bandwidth:0,resolution:"0x0",codecs:""},d="",e="",f=s(a[0]);for(b=f.length-1;b>=0;b-=1)if(-1===f[b].indexOf("=")&&b>0)f[b-1]+=","+f[b];else switch(d=f[b].trim().split("=")[0],e=f[b].trim().split("=")[1],d){case i:c.programId=e;break;case h:c.bandwidth=parseInt(e,10);break;case l:c.resolution=e;break;case m:c.codecs=e.replace(/"/g,"");break;case j:c.audioId=e;break;case k:c.subtitlesId=e}return c.uri=a[1],c},w=function(a){var b={},c=s(a[0]);return b.duration=parseInt(c[0],10),b.title=c[1],b.uri=a[1],b},x=function(a){var b=[],c=0;for(c=0;c<a.length;c+=1)q(a[c],f)&&b.push(u([a[c],a[c+1]]));return b},y=function(f,h){var i,j,k,l,m,n,o,s=0,u=0,v=this;if(!f||f&&f.length<0)return!1;if(v.debug.log(f),f=p(f),f[0].trim()!==a)return!1;for(i={name:"SegmentList",isRoot:!1,isArray:!1,duration:0,startNumber:0,timescale:1,BaseURL:h.BaseURL,SegmentURL_asArray:[]},h[i.name]=i,j=i.SegmentURL_asArray,h.duration=1/0,o=1;o<f.length;o++)q(f[o],c)?m=r(f[o],c):q(f[o],d)?i.duration=parseInt(r(f[o],d),10):q(f[o],e)?i.startNumber=parseInt(r(f[o],e),10):q(f[o],b)?(n=w([f[o],f[o+1]]),k={name:"SegmentURL",isRoot:!1,isArray:!0,media:t(n.uri)?n.uri:i.BaseURL+n.uri,sequenceNumber:i.startNumber+u,time:0===j.length?0:j[j.length-1].time+j[j.length-1].duration,duration:n.duration},j.push(k),s+=n.duration,u++):q(f[o],g)&&(h.duration=s);return l={name:"Initialization",sourceURL:h.SegmentList.SegmentURL_asArray[0].media},h.SegmentList.Initialization=l,!0},z=function(a,b){var c,d,e=o.defer(),f=a.Period_asArray[0],g=f.AdaptationSet_asArray[0],h=g.Representation_asArray[b],i=new v.vo.SegmentRequest,j=this;f.start=0,g.duration=h.duration,f.duration=h.duration,h.duration!==1/0&&(a.mediaPresentationDuration=h.duration),a.type=h.duration===1/0?"dynamic":"static",c=h.SegmentList.duration*h.SegmentList.SegmentURL_asArray.length,"dynamic"===a.type&&(d=new Date,a.availabilityStartTime=new Date(d.getTime()-1e3*c),a.timeShiftBufferDepth=c-h.SegmentList.duration),a.minBufferTime=2*h.SegmentList.duration,h=g.Representation_asArray[b],i.type="Initialization Segment",i.url=h.SegmentList.Initialization.sourceURL;var k=function(a,b){var c=this.hlsDemux.getTracks(new Uint8Array(b.data)),d=0;for(a.codecs="",d=0;d<c.length;d++)a.codecs+=c[d].codecs,d<c.length-1&&(a.codecs+=",");e.resolve()},l=function(){e.resolve()};return""===h.codecs?(j.debug.log("[HlsParser]","Load initialization segment: "+i.url),j.fragmentLoader.load(i).then(k.bind(j,h),l.bind(j))):e.resolve(),e.promise},A=function(a){var b=null;return-1!==a.indexOf("/")&&(-1!==a.indexOf("?")&&(a=a.substring(0,a.indexOf("?"))),b=a.substring(0,a.lastIndexOf("/")+1)),b},B=function(a){var b=o.defer(),c=!0,d=this,e=function(){n.aborted=!0},f=function(){n.status<200||n.status>299||200===n.status&&4===n.readyState&&(c=!1,y.call(d,n.response,a)?b.resolve():b.reject({name:v.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse variant stream playlist",data:{url:a.url}}))},g=function(){c&&!n.aborted&&b.reject({name:v.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download variant stream playlist",data:{url:a.url}})};try{n.onload=f,n.onloadend=g,n.onerror=g,n.onabort=e,n.open("GET",a.url,!0),n.send()}catch(h){n.onerror()}return b.promise},C=function(b,c){var d,e,f,g,h,i=o.defer(),j=[],k=[],l=0,m=[],n=this,p=0;if(!b||b.length<=0||b[0].trim()!==a)return i.reject(new Error("Can't parse manifest")),i.promise;for(d={},d.name="M3U",d.isRoot=!0,d.isArray=!0,d.parent=null,d.BaseURL=c,d.profiles="urn:mpeg:dash:profile:isoff-live:2011",d.type="static",e={},e.name="Period",e.isRoot=!1,e.isArray=!1,e.parent=d,e.duration=0,e.BaseURL=d.BaseURL,d.Period=e,d.Period_asArray=[e],j=[],e.AdaptationSet=j,e.AdaptationSet_asArray=j,m=x(b.slice(1)),m.sort(function(a,b){return a.bandwidth-b.bandwidth}),f={name:"AdaptationSet",isRoot:!1,isArray:!0,id:"video",lang:"",contentType:"video",mimeType:"video/mp4",maxWidth:0,maxHeight:0,BaseURL:e.BaseURL,Representation:k,Representation_asArray:k},p=0;p<m.length;p+=1)h=m[p],h.bandwidth>64e3&&(g={name:"Representation",isRoot:!1,isArray:!0,id:l.toString(),mimeType:"video/mp4",codecs:h.codecs,bandwidth:h.bandwidth,width:parseInt(h.resolution.split("x")[0],10),height:parseInt(h.resolution.split("x")[1],10),url:t(h.uri)?h.uri:f.BaseURL+h.uri},g.BaseURL=A(g.url),k.push(g),l++);return 0===m.length?(n.debug.error("[HlsParser] no stream in HLS manifest"),i.reject(),i.promise):(j.push(f),n.abrController.getPlaybackQuality("video",f).then(function(a){g=f.Representation_asArray[a.quality],B.call(n,g).then(function(){z.call(n,d,a.quality).then(function(){i.resolve(d)})},function(a){i.reject(a)})}),i.promise)},D=function(a,b){return this.debug.log("[HlsParser]","Doing parse."),this.debug.log("[HlsParser]",a),C.call(this,p(a),b)},E=function(){null!==n&&n.readyState>0&&n.readyState<4&&(this.debug.log("[HlsParser] Playlist manifest download abort."),n.abort())};return{debug:void 0,manifestModel:void 0,fragmentLoader:void 0,abrController:void 0,hlsDemux:void 0,parse:D,updatePlaylist:B,abort:E}},t.dependencies.HlsParser.prototype={constructor:t.dependencies.HlsParser},t.dependencies.HlsHandler=function(){"use strict";var a=function(a){var c,d,e,f=null,g=this,h=null,i=o.defer();return f=a.adaptation.period,h=f.start,c=b.manifestModel.getValue(),d=b.manifestExt.getIsDynamic(c),e=new v.vo.SegmentRequest,e.streamType=b.getType(),e.type="Initialization Segment",e.url=null,e.data=1,e.range=a.range,e.availabilityStartTime=g.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(h,a.adaptation.period.mpd,d),e.availabilityEndTime=g.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(h+f.duration,f.mpd,d),e.quality=a.index,i.resolve(e),i.promise},b=v.utils.copyMethods(u.dependencies.DashHandler);return b.getInitRequest=a,b},t.dependencies.HlsHandler.prototype={constructor:t.dependencies.HlsHandler},t.dependencies.HlsFragmentController=function(){"use strict";var a=null,b=function(a){var b=0,c=d.manifestModel.getValue(),e=d.hlsDemux.getTracks(new Uint8Array(a));for(b=0;b<e.length;b+=1)e[b].duration=c.mediaPresentationDuration;return d.mp4Processor.generateInitSegment(e)},c=function(a){var b=0,c=d.hlsDemux.demux(new Uint8Array(a));for(b=0;b<c.length;b+=1)"video"===c[b].type&&(d.startTime=c[b].samples[0].cts/c[b].timescale);return d.mp4Processor.generateMediaSegment(c,d.sequenceNumber)},d=v.utils.copyMethods(v.dependencies.FragmentController);return d.manifestModel=void 0,d.hlsDemux=void 0,d.mp4Processor=void 0,d.sequenceNumber=1,d.segmentStartTime=null,d.process=function(e,f,g){var h=null,i=null,j=null;return null===e||void 0===e||0===e.byteLength?o.when(e):(f&&"Media Segment"===f.type&&g&&g.length>0&&((null===a||a!==f.quality)&&(d.hlsDemux.reset(9e4*f.startTime),i=b(e),f.index=void 0,a=f.quality),h=c(e),null!==i&&(j=new Uint8Array(i.length+h.length),j.set(i,0),j.set(h,i.length),h=j),d.sequenceNumber++),o.when(h))},d.getStartTime=function(){return d.startTime},d},t.dependencies.HlsFragmentController.prototype={constructor:t.dependencies.HlsFragmentController},r=function(){"use strict";return{dependencies:{}}}(),r.dependencies.MssParser=function(){"use strict";var a=1e7,b={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},c={video:"video/mp4",audio:"audio/mp4",text:"application/ttml+xml+mp4"},d=null,e=null,f=function(){var b,c,f={},h=[],i=this.domParser.getChildNode(d,"SmoothStreamingMedia");for(f.duration=0===parseFloat(this.domParser.getAttributeValue(i,"Duration"))?1/0:parseFloat(this.domParser.getAttributeValue(i,"Duration"))/a,f.BaseURL=e,c=0;c<i.childNodes.length;c++)"StreamIndex"===i.childNodes[c].nodeName&&(b=g.call(this,i.childNodes[c]),
null!==b&&h.push(b));return h.length>0&&(f.AdaptationSet=h.length>1?h:h[0]),f.AdaptationSet_asArray=h,f},g=function(a){var b,d,f,g={},i=[],j={},l=null;for(g.id=this.domParser.getAttributeValue(a,"Name"),g.lang=this.domParser.getAttributeValue(a,"Language"),g.contentType=this.domParser.getAttributeValue(a,"Type"),g.mimeType=c[g.contentType],g.maxWidth=this.domParser.getAttributeValue(a,"MaxWidth"),g.maxHeight=this.domParser.getAttributeValue(a,"MaxHeight"),g.BaseURL=e,j=k.call(this,a),l=this.domParser.getChildNodes(a,"QualityLevel"),f=0;f<l.length;f++)l[f].BaseURL=g.BaseURL,l[f].mimeType=g.mimeType,l[f].Id=g.id+"_"+this.domParser.getAttributeValue(l[f],"Index"),b=h.call(this,l[f],a),null!==b&&(b.SegmentTemplate=j,i.push(b));return 0===i.length?null:(g.Representation=i.length>1?i:i[0],g.Representation_asArray=i,g.SegmentTemplate=j,d=j.SegmentTimeline.S_asArray,this.metricsModel.addDVRInfo(g.contentType,0,null,{start:d[0].t/j.timescale,end:(d[d.length-1].t+d[d.length-1].d)/j.timescale}),g)},h=function(a,b){var c={},d=null;return c.id=a.Id,c.bandwidth=parseInt(this.domParser.getAttributeValue(a,"Bitrate"),10),c.mimeType=a.mimeType,c.width=parseInt(this.domParser.getAttributeValue(a,"MaxWidth"),10),c.height=parseInt(this.domParser.getAttributeValue(a,"MaxHeight"),10),d=this.domParser.getAttributeValue(a,"FourCC"),d||(d=this.domParser.getAttributeValue(b,"FourCC")),"H264"===d||"AVC1"===d?c.codecs=i.call(this,a):(d.indexOf("AAC")>=0||""===d)&&(c.codecs=j.call(this,a,d),c.audioSamplingRate=parseInt(this.domParser.getAttributeValue(a,"SamplingRate"),10),c.audioChannels=parseInt(this.domParser.getAttributeValue(a,"Channels"),10)),c.codecPrivateData=""+this.domParser.getAttributeValue(a,"CodecPrivateData"),c.BaseURL=a.BaseURL,c},i=function(a){var b,c,d=this.domParser.getAttributeValue(a,"CodecPrivateData").toString();return b=/00000001[0-9]7/.exec(d),c=b&&b[0]?d.substr(d.indexOf(b[0])+10,6):void 0,"avc1."+c},j=function(a,c){var d,e,f,g,h=0,i=this.domParser.getAttributeValue(a,"CodecPrivateData").toString(),j=parseInt(this.domParser.getAttributeValue(a,"SamplingRate"),10);return"AACH"===c&&(h=5),void 0===i||""===i?(h=2,f=b[j],"AACH"===c?(h=5,i=new Uint8Array(4),g=b[2*j],i[0]=h<<3|f>>1,i[1]=f<<7|a.Channels<<3|g>>1,i[2]=g<<7|8,i[3]=0,e=new Uint16Array(2),e[0]=(i[0]<<8)+i[1],e[1]=(i[2]<<8)+i[3],d=e[0].toString(16),d=e[0].toString(16)+e[1].toString(16)):(i=new Uint8Array(2),i[0]=h<<3|f>>1,i[1]=f<<7|parseInt(this.domParser.getAttributeValue(a,"Channels"),10)<<3,e=new Uint16Array(1),e[0]=(i[0]<<8)+i[1],d=e[0].toString(16)),i=""+d,i=i.toUpperCase(),a.setAttribute("CodecPrivateData",i)):0===h&&(h=(248&parseInt(i.substr(0,2),16))>>3),"mp4a.40."+h},k=function(b){var c,d={};return c=this.domParser.getAttributeValue(b,"Url").replace("{bitrate}","$Bandwidth$"),c=c.replace("{start time}","$Time$"),d.media=c,d.timescale=a,d.SegmentTimeline=l.call(this,b),d},l=function(a){var b,c,d,e={},f=this.domParser.getChildNodes(a,"c"),g=[];for(b=0;b<f.length;b++)c=parseFloat(this.domParser.getAttributeValue(f[b],"t")),d=parseFloat(this.domParser.getAttributeValue(f[b],"d")),0!==b||c||(c=0),b>0&&(g[g.length-1].d||(g[g.length-1].d=c-g[g.length-1].t),c||(c=g[g.length-1].t+g[g.length-1].d)),g.push({d:d,t:c});return e.S=g,e.S_asArray=g,e},m=function(a){var b,c,d,e;return b=y.decodeArray(a.firstChild.data),c=n(b),c=new Uint16Array(c.buffer),c=String.fromCharCode.apply(null,c),d=(new DOMParser).parseFromString(c,"application/xml"),e=d.querySelector("KID").textContent,e=y.decodeArray(e),p(e),e},n=function(a){var b,c,d,e,f,g=0;for(b=(a[g+3]<<24)+(a[g+2]<<16)+(a[g+1]<<8)+a[g],g+=4,c=(a[g+1]<<8)+a[g],g+=2;g<a.length;)if(d=(a[g+1]<<8)+a[g],g+=2,1===d)return e=(a[g+1]<<8)+a[g],g+=2,f=new Uint8Array(e),f.set(a.subarray(g,g+e)),f;return null},p=function(a){q(a,0,3),q(a,1,2),q(a,4,5),q(a,6,7)},q=function(a,b,c){var d=a[b];a[b]=a[c],a[c]=d},s=function(a){var b,c={},d=this.system.getObject("ksPlayReady");return b={__text:a.firstChild.data,__prefix:"mspr"},c.schemeIdUri=d.schemeIdURI,c.value=d.systemString,c.pro=b,c.pro_asArray=b,c},t=function(a){var b={},c=this.system.getObject("ksWidevine");return b.schemeIdUri=c.schemeIdURI,b.value=c.systemString,b},u=function(b){var c,g,h,i,j,k,l,n={},o=[],p=this.domParser.getChildNode(d,"SmoothStreamingMedia"),q=this.domParser.getChildNode(p,"Protection"),u=null;for(n.profiles="urn:mpeg:dash:profile:isoff-live:2011",n.type=Boolean(this.domParser.getAttributeValue(p,"IsLive"))?"dynamic":"static",n.timeShiftBufferDepth=parseFloat(this.domParser.getAttributeValue(p,"DVRWindowLength"))/a,n.mediaPresentationDuration=0===parseFloat(this.domParser.getAttributeValue(p,"Duration"))?1/0:parseFloat(this.domParser.getAttributeValue(p,"Duration"))/a,n.BaseURL=e,n.minBufferTime=v.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME,"dynamic"===n.type&&(n.availabilityStartTime=new Date(b.getTime()-1e3*n.timeShiftBufferDepth)),n.Period=f.call(this),n.Period_asArray=[n.Period],c=n.Period,c.start=0,void 0!==q&&(u=this.domParser.getChildNode(q,"ProtectionHeader"),u.firstChild.data=u.firstChild.data.replace(/\n|\r/g,""),i=m(u),h=s.call(this,u),h["cenc:default_KID"]=i,o.push(h),navigator.userAgent.indexOf("Chrome")>=0&&(h=t.call(this,u),h["cenc:default_KID"]=i,o.push(h)),n.ContentProtection=o.length>1?o:o[0],n.ContentProtection_asArray=o,navigator.userAgent.indexOf("Chrome")>=0&&(o[o.length-1].pssh={__text:r.dependencies.createVOWidevinePssh(m(u),this.debug)})),g=c.AdaptationSet_asArray,l=0;l<g.length;l+=1)"static"===n.type&&"text"!==g[l].contentType&&(j=g[l].SegmentTemplate.SegmentTimeline.S_asArray[0],k=parseFloat(j.t)/a,c.start=0===c.start?k:Math.max(c.start,k)),void 0!==n.ContentProtection&&(g[l].ContentProtection=n.ContentProtection,g[l].ContentProtection_asArray=n.ContentProtection_asArray);return delete n.ContentProtection,delete n.ContentProtection_asArray,n},w=function(a,b){this.debug.info("[MssParser]","Doing parse.");var c=new Date,f=null,g=null,h=null;return d=this.domParser.createXmlTree(a),f=new Date,null===d?o.reject(null):(e=b,g=u.call(this,c),h=new Date,this.debug.info("[MssParser]","Parsing complete (xmlParser: "+(f.getTime()-c.getTime())+"ms, mss2dash: "+(h.getTime()-f.getTime())+"ms, total: "+((new Date).getTime()-c.getTime())/1e3+"s)"),o.when(g))};return{debug:void 0,system:void 0,domParser:void 0,metricsModel:void 0,parse:w}},r.dependencies.MssParser.prototype={constructor:r.dependencies.MssParser},r.dependencies.MssHandler=function(){"use strict";var a=function(a,b){var c=1;return a.audioChannels?c=a.audioChannels:b.audioChannels&&(c=b.audioChannels),c},b=function(a,b){var c=1;return c=a.audioSamplingRate?a.audioSamplingRate:b.audioSamplingRate},c=function(c){var e,f,g,h,i,j=d.manifestModel.getValue();if(c.initData)return c.initData;if(e=c.adaptation,f=j.Period_asArray[e.period.index].AdaptationSet_asArray[e.index],g=f.Representation_asArray[c.index],h=new v.vo.Mp4Track,h.type=d.getType()||"und",h.trackId=e.index+1,h.timescale=c.timescale,h.duration=c.adaptation.period.duration,h.codecs=g.codecs,h.codecPrivateData=g.codecPrivateData,h.bandwidth=g.bandwidth,"text"!==h.type&&(i=g.mimeType+';codecs="'+g.codecs+'"',!this.capabilities.supportsCodec(this.videoModel.getElement(),i)))throw{name:v.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:i}};return f.ContentProtection_asArray&&f.ContentProtection_asArray.length>0&&(h.contentProtection=f.ContentProtection_asArray),h.width=g.width||f.maxWidth,h.height=g.height||f.maxHeight,h.language=f.lang?f.lang:"und",h.channels=a(f,g),h.samplingRate=b(f,g),c.initData=d.mp4Processor.generateInitSegment([h]),c.initData},d=v.utils.copyMethods(u.dependencies.DashHandler);return d.mp4Processor=void 0,d.getInitRequest=function(a){var b=null,e=this,f=null,g=null,h=o.defer();if(!a)throw new Error("MssHandler.getInitRequest(): representation is undefined");b=a.adaptation.period,f=b.start,g=new v.vo.SegmentRequest,g.streamType=d.getType(),g.type="Initialization Segment",g.url=null;try{g.data=c.call(this,a)}catch(i){return h.reject(i),h.promise}return g.range=a.range,g.availabilityStartTime=e.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(f,a.adaptation.period.mpd,d.getIsDynamic()),g.availabilityEndTime=e.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(f+b.duration,b.mpd,d.getIsDynamic()),g.quality=a.index,h.resolve(g),h.promise},d.getIFrameRequest=function(a){return a&&a.url&&("video"===a.streamType||"audio"===a.streamType)&&(a.url=a.url.replace("Fragments","KeyFrames")),a},d},r.dependencies.MssHandler.prototype={constructor:r.dependencies.MssHandler},r.dependencies.MssFragmentController=function(){"use strict";var a=function(a,b,c){for(var d=this.manifestModel.getValue(),e=!1,f=c.SegmentTemplate.SegmentTimeline.S,g=a.entry,h=0,i=0,j=null,k=0,l=0,m=0,n=-1,o=null;l<g.length;)h=g[l].fragment_absolute_time,i=g[l].fragment_duration,j=f[f.length-1],k=j.t,h>k&&(this.debug.log("[MssFragmentController] Add new segment - t = "+h/1e7),f.push({t:h,d:i}),e=!0),l+=1;for(m=f.length-1;m>=0;m-=1)if(f[m].t===b.baseMediaDecodeTime){n=m;break}if(n>=0)for(l=0;l<g.length;l+=1)n+l<f.length&&(k=f[n+l].t,k+f[n+l].d!=g[l].fragment_absolute_time&&(f[n+l].t=g[l].fragment_absolute_time,f[n+l].d=g[l].fragment_duration,this.debug.log("[MssFragmentController] Correct tfrf time  = "+g[l].fragment_absolute_time+"and duration = "+g[l].fragment_duration+"! ********"),e=!0));if(e&&d.timeShiftBufferDepth&&d.timeShiftBufferDepth>0){for(j=f[f.length-1],k=j.t,o=k-1e7*d.timeShiftBufferDepth,j=f[0];j.t<o;)this.debug.log("[MssFragmentController] Remove segment  - t = "+j.t/1e7),f.splice(0,1),j=f[0];this.metricsModel.addDVRInfo(c.type,0,null,{start:f[0].t/c.SegmentTemplate.timescale,end:(f[f.length-1].t+f[f.length-1].d)/c.SegmentTemplate.timescale})}},b=function(b,c,d){var e=0,f=this.manifestModel.getValue(),g=f?this.manifestExt.getIndex(d,f)+1:-1,h=C.deserialize(b),i=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=!1,t=-1,u=0,v=0,w=0,x=0,y=null;if(!h)return null;if(i=h.getBoxByType("moof"),j=h.getBoxByType("mdat"),k=i.getBoxByType("traf"),l=k.getBoxByType("trun"),m=k.getBoxByType("tfhd"),o=k.getBoxByType("sepiff"),null!==o&&(o.boxtype="senc",o.extended_type=void 0,n=k.getBoxByType("saio"),null===n)){if(n=new C.boxes.SampleAuxiliaryInformationOffsetsBox,n.version=0,n.flags=0,n.entry_count=1,n.offset=[],p=new C.boxes.SampleAuxiliaryInformationSizesBox,p.version=0,p.flags=0,p.sample_count=o.sample_count,p.default_sample_info_size=0,p.sample_info_size=[],2&o.flags){for(e=0;e<o.sample_count;e+=1)p.sample_info_size[e]=8+6*o.entry[e].NumberOfEntries+2,e>0&&p.sample_info_size[e]!==p.sample_info_size[e-1]&&(s=!0);s===!1&&(p.default_sample_info_size=p.sample_info_size[0],p.sample_info_size=[])}else p.default_sample_info_size=8;k.boxes.push(p),k.boxes.push(n)}if(m.track_ID=g,k.removeBoxByType("tfxd"),q=k.getBoxByType("tfdt"),null===q&&(q=new C.boxes.TrackFragmentBaseMediaDecodeTimeBox,q.version=1,q.flags=0,q.baseMediaDecodeTime=Math.floor(c.startTime*c.timescale),t=k.getBoxIndexByType("tfhd"),k.boxes.splice(t+1,0,q)),r=k.getBoxesByType("tfrf"),0!==r.length)for(e=0;e<r.length;e+=1)a.call(this,r[e],q,d),k.removeBoxByType("tfrf");if(m.flags&=16777214,m.flags|=131072,l.flags|=1,l.data_offset=0,this.fixDuration&&1===l.samples_table.length){var z,A=c.duration*c.timescale,B=0,D=j.data;z=void 0===l.samples_table[0].sample_duration?m.default_sample_duration:l.samples_table[0].sample_duration;var E=Math.floor(A/z);for(e=0;E-1>e;e++)l.samples_table.push({sample_duration:l.samples_table[0].sample_duration,sample_size:l.samples_table[0].sample_size,sample_composition_time_offset:l.samples_table[0].sample_composition_time_offset,sample_flags:l.samples_table[0].sample_flags});if(void 0!==l.samples_table[0].sample_duration){for(e=0;e<l.samples_table.length;e++)B+=l.samples_table[e].sample_duration;B>A?l.samples_table[l.samples_table.length-1].sample_duration-=B-A:l.samples_table[l.samples_table.length-1].sample_duration+=A-B}for(l.sample_count=l.samples_table.length,j.data=new Uint8Array(D.length*l.sample_count),e=0;e<l.sample_count;e+=1)j.data.set(D,D.length*e)}return u=h.getLength(),l.data_offset=u-j.size+8,null!==o&&(v=h.getBoxOffsetByType("moof"),w=i.getBoxOffsetByType("traf"),x=k.getBoxOffsetByType("senc"),n.offset[0]=v+w+x+16),y=C.serialize(h)},c=v.utils.copyMethods(v.dependencies.FragmentController);return c.manifestModel=void 0,c.manifestExt=void 0,c.metricsModel=void 0,c.fixDuration=!1,c.process=function(a,c,d){var e=null,f=this.manifestModel.getValue(),g=null;return null!==a&&void 0!==a&&a.byteLength>0?(e=new Uint8Array(a),c&&"Media Segment"===c.type&&f&&d&&d.length>0&&(g=f.Period_asArray[d[0].adaptation.period.index].AdaptationSet_asArray[d[0].adaptation.index],e=b.call(this,e,c,g),!e)?o.when(null):o.when(e)):o.when(null)},c.setSampleDuration=function(a){this.fixDuration=a},c},r.dependencies.MssFragmentController.prototype={constructor:r.dependencies.MssFragmentController},r.dependencies.createVOWidevinePssh=function(a,b){var c=new Uint8Array([255,255,255,255,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,255,255,255,255,8,1,18,16,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,26,12,118,105,97,99,99,101,115,115,111,114,99,97,42,2,83,68]),d=c.length,e=d-32,f="",g=0;if(c[0]=(4278190080&d)>>32,c[1]=(16711680&d)>>16,c[2]=(65280&d)>>8,c[3]=255&d,c[28]=(4278190080&e)>>32,c[29]=(16711680&e)>>16,c[30]=(65280&e)>>8,c[31]=255&e,c.set(a,36),b){for(f="",g=0;g<c.length;g++)f+="\\0x"+c[g].toString(16);b.log("[VoWvPssh] "+f)}return c=String.fromCharCode.apply(null,c),b&&b.log("[VoWvPssh] "+c),c=y.encodeASCII(c),b&&b.log("[VoWvPssh] "+c),c},v.utils.copyMethods=function(a){var b=new a;b.parent={};for(var c in b)b.parent[c]=b[c];return b.setup=function(){for(var a in this.parent)void 0===this.parent[a]&&(this.parent[a]=this[a])},b},v.utils.DOMParser=function(){"use strict";var a=null,b=null;return{getAllSpecificNodes:function(a,b){var c,d,e=0,f=[];if(a&&(d=a.querySelectorAll(b)))for(e=0;e<d.length;e++)c=this.getAttributeValue(d[e],"xml:id"),c&&(f[c]=d[e].attributes);return f},getAttributeName:function(a,b){var c=[],d=null,e=0,f=null;if(a&&a.attributes&&(f=a.attributes))for(e=0;e<f.length;e++)d=f[e],d.value===b&&c.push(d.name);return c},getAttributeValue:function(a,b){var c=null,d=null,e=null;return a&&a.attributes&&(e=a.attributes,e&&(d=e.getNamedItem(b)))?c=d.value:c},getChildNode:function(a,b){var c,d=0;if(a&&a.childNodes)for(d=0;d<a.childNodes.length;d++){if(c=a.childNodes[d],c.nodeName===b)return c;c=void 0}return c},getChildNodes:function(a,b){var c=0,d=[];if(a&&a.childNodes)for(c=0;c<a.childNodes.length;c++)a.childNodes[c].nodeName===b&&d.push(a.childNodes[c]);return d},createXmlTree:function(c){if(window.DOMParser)try{if(a||(a=new window.DOMParser),b=a.parseFromString(c,"text/xml"),b.getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(d){b=null}return b}}},v.utils.ObjectIron=function(a){var b;b=[];for(var c=0,d=a.length;d>c;c+=1)a[c].isRoot?b.push("root"):b.push(a[c].name);var e=function(a,b){var c;if(null!==a&&null!==b)for(c in a)a.hasOwnProperty(c)&&(b.hasOwnProperty(c)||(b[c]=a[c]))},f=function(a,b,c){var d,f,g,h,i;if(null!==a&&0!==a.length)for(d=0,f=a.length;f>d;d+=1)g=a[d],b.hasOwnProperty(g.name)&&(c.hasOwnProperty(g.name)?g.merge&&(h=b[g.name],i=c[g.name],"object"==typeof h&&"object"==typeof i?e(h,i):null!==g.mergeFunction?c[g.name]=g.mergeFunction(h,i):c[g.name]=h+i):c[g.name]=b[g.name])},g=function(a,b){var c,d,e,h,i,j,k,l=a;if(a.transformFunc&&(b=a.transformFunc(b)),null===l.children||0===l.children.length)return b;for(c=0,d=l.children.length;d>c;c+=1){j=l.children[c];var m=null;if(b.hasOwnProperty(j.name))if(j.isArray)for(i=b[j.name+"_asArray"],e=0,h=i.length;h>e;e+=1)k=i[e],f(l.properties,b,k),m=g(j,k),b[j.name+"_asArray"][e]=m,b[j.name][e]=m;else k=b[j.name],f(l.properties,b,k),m=g(j,k),b[j.name]=m,b[j.name+"_asArray"]=[m]}return b},h=function(c){var d,e,f,i,j,k,l;if(null===c)return c;if("object"!=typeof c)return c;for(d=0,e=b.length;e>d;d+=1)"root"===b[d]&&(j=a[d],k=c,c=g(j,k));for(i in c)if(c.hasOwnProperty(i)){if(f=b.indexOf(i),-1!==f)if(j=a[f],j.isArray)for(l=c[i+"_asArray"],d=0,e=l.length;e>d;d+=1)k=l[d],c[i][d]=g(j,k),c[i+"_asArray"][d]=g(j,k);else k=c[i],c[i]=g(j,k),c[i+"_asArray"]=[g(j,k)];c[i]=h(c[i])}return c};return{run:h}};var E=null;f.prototype.getVersion=function(){return this.version},f.prototype.init=function(a){this.getActivation(function(b){this.debug.log("[MetricsAgent]["+this.parameters.activationUrl+"] - Activation: "+b),b===!0&&(this.collector.listen(),this.video.addEventListener("newMetricStored",this.metricAdded.bind(this),!1)),a&&a(b)}.bind(this))},f.prototype.stop=function(){clearInterval(E),this.sessionId=null},f.prototype.createSession=function(){this.sessionId=this.formatter.generateSessionId(),this.database.init(this.sessionId),this.collector.init(this.sessionId),this.formatter.init(this.database)},f.prototype.getActivation=function(a){var b;this.parameters.activationUrl&&this.parameters.activationUrl.length>0?this.sender.http("GET",this.parameters.activationUrl,null,function(c,d){(200>c||c>299)&&a(!1);try{b=JSON.parse(d).active,a(void 0===b?!1:b)}catch(e){a(!1)}}):a(void 0===this.parameters.enable?!0:this.parameters.enable)},f.prototype.sendPeriodicMessage=function(){this.database.updateCurrentState(),this.database.updateCurrentEncoding(null,"video"),this.database.updateCurrentEncoding(null,"audio"),this.sendMetrics()},f.prototype.metricAdded=function(a){var b=a.detail.metric;this.parameters.dbServerUrl&&this.sender.http("POST",this.parameters.dbServerUrl,JSON.stringify(b)),b.hasOwnProperty("state")&&("stopped"===b.state.current?(clearInterval(E),E=null):E||(E=setInterval(function(){this.sendPeriodicMessage()}.bind(this),this.parameters.sendingTime))),this.sendMetrics(b)},f.prototype.sendMetrics=function(a){var b;this.isSending||(this.isSending=!0,b=this.formatter.process(a),b&&this.sender.http("POST",this.parameters.serverUrl,JSON.stringify(b)),this.isSending=!1)},f.formatters={},f.collectors={},g.prototype.isDefined=function(a){return void 0!==a&&null!==a&&""!==a},g.prototype.init=function(a){this.clear(),this.sessionId=a,this.metrics.push({state:{current:"init"},date:(new Date).getTime()})},g.prototype.generateUUID=function(){var a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:7&c|8).toString(16)});return b},g.prototype.getBrowserId=function(){return this.browserUUID},g.prototype.addMetric=function(a){a.date=(new Date).getTime(),this.processMetric(a)},g.prototype.processMetric=function(a){var b=!1,c=null,d=null,e=null,f=null,g=[],h=0,i=null;if(a.hasOwnProperty("session")&&(c=this.getMetricObject("session"))){for(i in a.session)this.isDefined(a.session[i])&&(c[i]=a.session[i]);b=!0}if(a.hasOwnProperty("state")&&(e=this.getMetric("state",!0)[0],e&&(a.state.previousState=e.state.current,a.state.previousTime=e.date,e.state.duration=a.date-e.date),c=this.getMetricObject("session"),c&&("buffering"!==a.state.current||c.startBufferingTime||(c.startBufferingTime=a.date),"playing"!==a.state.current||c.startPlayingTime||(c.startPlayingTime=a.date))),a.hasOwnProperty("encoding")&&(f=this.getMetric("encoding",!0,1,function(b){return b.contentType===a.encoding.contentType}),1===f.length&&(f[0].encoding.time=a.date-f[0].date)),a.hasOwnProperty("metadata")&&a.metadata.bitrates&&"video"===a.metadata.contentType&&(c=this.getMetricObject("session"))){for(h=0;h<a.metadata.bitrates.length;h+=1)g.push(a.metadata.bitrates[h].bitrate);c.minBitrate=Math.min.apply(null,g),c.maxBitrate=Math.max.apply(null,g)}if(a.hasOwnProperty("condition")&&(d=this.getMetricObject("condition"))){for(i in a.condition)this.isDefined(a.condition[i])&&(d[i]=a.condition[i]);b=!0}if(!b){this.metrics.push(a);var j=document.createEvent("CustomEvent");j.initCustomEvent("newMetricStored",!1,!1,{metric:a}),this.video.dispatchEvent(j)}},g.prototype.checkMetric=function(a,b,c){return a.hasOwnProperty(b)?void 0!==c?c(a[b])?!0:!1:!0:!1},g.prototype.getMetric=function(a,b,c,d){var e,f=[];if(void 0!==b&&b===!0)for(e=this.metrics.length-1;e>=0&&(c?f.length<c:!0);e--)this.checkMetric(this.metrics[e],a,d)&&f.push(this.metrics[e]);else for(e=0;e<this.metrics.length&&(c?f.length<c:!0);e+=1)this.checkMetric(this.metrics[e],a,d)&&f.push(this.metrics[e]);return f},g.prototype.getMetricObject=function(a,b,c){var d=this.getMetric(a,b,1,c);return d.length>0?d[0][a]:null},g.prototype.getMetricsObjects=function(a,b,c,d){var e=[],f=0,g=[],h=[];return b&&(f=b),c&&(f+=c),0===f||b&&!c?e=this.getMetric(a,!1,b,d):c&&!b?(e=this.getMetric(a,!0,c,d),e.reverse()):(g=this.getMetric(a,!1,void 0,d),e=this.getMetric(a,!1,b,d),h=f<g.length?this.getMetric(a,!0,c,d):this.getMetric(a,!0,g.length-b,d),e=e.concat(h.reverse()))},g.prototype.getMetrics=function(){return this.metrics},g.prototype.deleteMetrics=function(a){var b=0,c=!0;for(b=this.metrics.length-1;b>=0;b--)this.checkMetric(this.metrics[b],a)&&(c?c=!1:this.metrics.splice(b,1))},g.prototype.updateCurrentEncoding=function(a,b){var c=this.getMetric("encoding",!0,1,function(a){return a.contentType===b}),d=a?a:(new Date).getTime();1===c.length&&(c[0].encoding.time=d-c[0].date)},g.prototype.updateCurrentState=function(a){var b=this.getMetric("state",!0)[0],c=a?a:(new Date).getTime();b&&(b.state.duration=c-b.date,b.state.position=this.video.currentTime)},g.prototype.getCountState=function(a){var b=this.getMetrics(),c=0,d=b.length,e={count:0,duration:0};for(c=0;d>c;c++)b[c].hasOwnProperty("state")&&b[c].state.current===a&&(e.count++,e.duration+=b[c].state.duration);return e.duration=Math.round(e.duration),e},g.prototype.clear=function(){this.metrics=[]},h.prototype.http=function(a,b,c,d){var e=new XMLHttpRequest;e.open(a,b,!0),e.setRequestHeader("Content-Type","application/json; charset=UTF-8"),e.timeout=2e3,e.onloadend=e.onerror=function(){d&&d(e.status,e.response)},"GET"===a?e.send():(this.debug.log("[MetricsAgent]["+b+"] - Send message: "+c),e.send(c))};var F={};return F.Encoding=function(){"use strict";this.contentType=null,this.id=null,this.codec=null,this.index=null,this.bitrate=null,this.position=null,this.previousBitrate=null},F.Session=function(){this.id=null,this.playerid=null,this.playerType=null,this.browserid=null,this.userAgent=null,this.uri=null,this.provider=null,this.loopMode=null,this.loopCount=null,this.startTime=null,this.startBufferingTime=null,this.startPlayingTime=null,this.endTime=null,this.minBitrate=null,this.maxBitrate=null},F.MetaData=function(){this.contentType=null,this.codec=null,this.format=null,this.duration=-1,this.bitrates=[]},F.State=function(){this.current=null,this.position=null,this.previousState=null,this.previousTime=null,this.duration=null,this.reason=null},F.Action=function(){this.contentType=null,this.type=null,this.parameter=null,this.position=null},F.Condition=function(){this.windowSize=null,this.fullScreen=null,this.bandwidth=null,this.fps=null,this.droppedFrames=null},F.Error=function(){this.code=null,this.message=null,this.position=null,this.chunkURL=null},j.prototype.init=function(a){this.sessionId=a,this.previousVideoBandwith=0,this.previousAudioBandwith=0},j.prototype.metricAddedListener=function(a){if(null!==this.sessionId){var b={};switch(a.data.metric){case"RepresentationSwitch":break;case"Condition":b.condition=this.mapConditionObject(a.data),this.database.addMetric(b);break;case"PlayList":b.action=this.mapActionObject(a.data),this.database.addMetric(b);break;case"State":"video"===a.data.stream&&(b.state=this.mapStateObject(a.data),this.database.addMetric(b));break;case"Session":b.session=this.mapSessionObject(a.data),this.database.addMetric(b),this.addState("stopped");break;case"ManifestReady":this.addState("startup"),this.sendMetaData("video")}}},j.prototype.onChangePlayedBitrate=function(a){var b={data:{value:{}}},c={};b.data.stream=a.detail.type,b.data.bandwith=this.customMetricsExtension.getBandwidthForRepresentation(a.detail.representationId),b.data.codec=this.customMetricsExtension.getCodecsForRepresentation(a.detail.representationId),b.data.index=this.customMetricsExtension.getIndexForRepresentation(a.detail.representationId),b.data.max=this.customMetricsExtension.getMaxIndexForBufferType("video"),b.data.value.to=a.detail.representationId,b.data.value.mt=a.detail.time,c.encoding=this.mapEncodingObject(b.data),this.database.addMetric(c),"video"===b.data.stream?this.previousVideoBandwith=b.data.bandwith:"audio"===b.data.stream&&(this.previousAudioBandwith=b.data.bandwith)},j.prototype.onTimeUpdate=function(){var a=this.database.getMetricObject("session");null!==a&&null!==a.startBufferingTime&&(void 0===a.maxPosition||this.video.currentTime>a.maxPosition)&&(a.maxPosition=this.video.currentTime)},j.prototype.onError=function(a){var b=new F.Error,c={};switch(b.code=a.event.code,a.event.message&&(b.message=a.event.message),a.event.code){case"DOWNLOAD_ERR_MANIFEST":case"DOWNLOAD_ERR_SIDX":case"DOWNLOAD_ERR_CONTENT":case"DOWNLOAD_ERR_INIT":b.chunkURL=a.event.data.url,a.event.data.request.status&&(b.message+=a.event.data.request.status)}a.event.data&&a.event.data.currentTime&&(b.position=a.event.data.currentTime),c.error=b,this.database.addMetric(c)},j.prototype.metricUpdatedListener=function(a){if(null!==this.sessionId){var b={};switch(a.data.metric){case"HttpRequestTrace":b.condition=this.mapConditionObject(a.data),this.database.addMetric(b)}}},j.prototype.listen=function(){this.customMetricsExtension=this.player.getMetricsExt(),this.player.addEventListener("metricAdded",this.metricAddedListener.bind(this)),this.player.addEventListener("metricUpdated",this.metricUpdatedListener.bind(this)),this.player.addEventListener("error",this.onError.bind(this)),this.video.addEventListener("timeupdate",this.onTimeUpdate.bind(this)),this.video.addEventListener("play_bitrate",this.onChangePlayedBitrate.bind(this)),window.addEventListener("beforeunload",function(){null!==this.sessionId&&this.addState("stopped",0)}.bind(this),!1)},j.prototype.addState=function(a,b){var c={data:{value:{current:a,position:this.player.getVideoModel().getCurrentTime(),reason:b}}},d={};d.state=this.mapStateObject(c.data),this.database.addMetric(d)},j.prototype.sendMetaData=function(a){var b={},c={data:{contentType:a,codec:this.customMetricsExtension.getCodecForType(a),duration:this.customMetricsExtension.getDuration()}},d=this.customMetricsExtension.getBitratesWithResolutionForType(a),e=this.customMetricsExtension.getFormatForType(a);d.length>0&&(c.data.bitrates=d),e&&(c.data.format=e,b.metadata=this.mapMetaDataObject(c.data),this.database.addMetric(b))},j.prototype.mapSessionObject=function(a){var b=new F.Session;return b.id=this.sessionId,b.playerid=this.playerId,b.browserid=this.database.getBrowserId(),b.userAgent=navigator.userAgent,b.uri=a.value.uri,b.provider=document.location.href,b.loopMode=a.value.loopMode,b.startTime=(new Date).getTime(),b.endTime=a.value.endTime,b.playerType=a.value.playerType,b},j.prototype.mapMetaDataObject=function(a){var b=new F.MetaData;return b.bitrates=a.bitrates,b.contentType=a.contentType,b.duration=a.duration,b.format=a.format,b.codec=a.codec,b},j.prototype.mapStateObject=function(a){var b=new F.State;return b.current=a.value.current,b.position=a.value.position,b.reason=a.value.reason,b},j.prototype.mapConditionObject=function(a){var b,c,d=new F.Condition;return a.stream&&"video"===a.stream?(b=a.value,"Media Segment"===b.type&&b.tfinish&&(c=b.trace[b.trace.length-1]||null,d.bandwidth=8e3*c.b[0]/(b.tfinish.getTime()-b.trequest.getTime()))):(d.droppedFrames=a.value.droppedFrames,d.fullScreen=a.value.isFullScreen,d.windowSize=a.value.windowSize,d.fps=a.value.fps),d},j.prototype.mapErrorObject=function(a){var b=new F.Error;return b.code=a.value.code,b.message=a.value.message,b},j.prototype.mapActionObject=function(a){var b=new F.Action;return b.contentType=a.stream,b.type=a.value.starttype,b.position=this.player.getVideoModel().getCurrentTime(),b},j.prototype.mapEncodingObject=function(a){var b=new F.Encoding;return b.contentType=a.stream,b.id=a.value.to,b.codec=a.codec,b.index=a.index,b.bitrate=a.bandwith,b.position=a.value.mt,"video"===a.stream?b.previousBitrate=this.previousVideoBandwith:"audio"===a.stream&&(b.previousBitrate=this.previousAudioBandwith),b},f.collectors.HasPlayerCollector=j,AbstractFormatter=function(a){this.database=a},AbstractFormatter.prototype.init=function(){this.firstAccess=!0,this.msgnbr=0},AbstractFormatter.prototype.generateSessionId=function(a){return(new Date).getTime()+a+String(Math.random()).substring(2)},AbstractFormatter.prototype.formatPlayingObject=function(){var a=this.database.getCountState("playing");return a},AbstractFormatter.prototype.formatBufferingObject=function(){var a=this.database.getCountState("buffering");return a},AbstractFormatter.prototype.formatPausedObject=function(){var a=this.database.getCountState("paused");return a},AbstractFormatter.prototype.formatStoppedObject=function(){var a=this.database.getCountState("stopped");return a},AbstractFormatter.prototype.formatSeekingObject=function(){var a=this.database.getCountState("seeking");return a},AbstractFormatter.prototype.isVideo=function(a){return"video"===a.contentType},AbstractFormatter.prototype.isExcluded=function(a,b){return b.indexOf(a)>-1},AbstractFormatter.prototype.setFieldValue=function(a,b){void 0===b||null===b||""===b||this.isExcluded(a,this.excludedList)||("number"==typeof b&&isFinite(b)&&b%1!==0&&(b=Math.round(1e3*b)/1e3),this.data[a]=b)},f.formatters.AbstractFormatter=AbstractFormatter,k.prototype=Object.create(AbstractFormatter.prototype),k.prototype.constructor=k,k.prototype.init=function(){AbstractFormatter.prototype.init.call(this)},k.prototype.generateSessionId=function(){return AbstractFormatter.prototype.generateSessionId.call(this,".")},k.prototype.process=function(a){var b=null;return this.database?(a?a.hasOwnProperty("state")&&"init"!==a.state.current&&!this.firstAccess?b=this.formatterNewState(a):a.hasOwnProperty("metadata")?b=this.formatterMetadata():a.hasOwnProperty("encoding")&&"video"===a.encoding.contentType?b=this.formatterChangeBitrate():a.hasOwnProperty("error")&&(b=this.formatterError()):b=this.formatterRecurring(),b&&this.msgnbr++,b):b},k.prototype.updateFormatterState=function(a,b,c){if(b){switch(c.state.current){case"playing":this.StateObject.Playing.count+=a.Playing.count;break;case"buffering":this.StateObject.Buffering.count+=a.Buffering.count;break;case"paused":this.StateObject.Paused.count+=a.Paused.count;break;case"stopped":this.StateObject.Stopped.count+=a.Stopped.count;break;case"seeking":this.StateObject.Seeking.count+=a.Seeking.count}switch(c.state.previousState){case"playing":this.StateObject.Playing.lastNewStateDuration+=a.Playing.duration,this.StateObject.Playing.duration=this.StateObject.Playing.lastNewStateDuration;break;case"buffering":this.StateObject.Buffering.lastNewStateDuration+=a.Buffering.duration,this.StateObject.Buffering.duration=this.StateObject.Buffering.lastNewStateDuration;break;case"paused":this.StateObject.Paused.lastNewStateDuration+=a.Paused.duration,this.StateObject.Paused.duration=this.StateObject.Paused.lastNewStateDuration;break;case"stopped":this.StateObject.Stopped.lastNewStateDuration+=a.Stopped.duration,this.StateObject.Stopped.duration=this.StateObject.Stopped.lastNewStateDuration;break;case"seeking":this.StateObject.Seeking.lastNewStateDuration+=a.Seeking.duration,this.StateObject.Seeking.duration=this.StateObject.Stopped.lastNewStateDuration}}else switch(a.state.current){case"Playing":this.StateObject.Playing.duration=(a.Playing.duration+this.StateObject.Playing.lastNewStateDuration).toFixed(3);break;case"Buffering":this.StateObject.Buffering.duration=(a.Buffering.duration+this.StateObject.Buffering.lastNewStateDuration).toFixed(3);break;case"Paused":this.StateObject.Paused.duration=(a.Paused.duration+this.StateObject.Paused.lastNewStateDuration).toFixed(3);
break;case"Stopped":this.StateObject.Stopped.duration=(a.Stopped.duration+this.StateObject.Stopped.lastNewStateDuration).toFixed(3);break;case"Seeking":this.StateObject.Seeking.duration=(a.Seeking.duration+this.StateObject.Seeking.lastNewStateDuration).toFixed(3)}},k.prototype.setStateObject=function(a){var b={};return b.count=a.count,b.duration=a.duration,b},k.prototype.formatterRecurring=function(){var a={};switch(a.type=0,a.session=this.formatSessionObject([]),a.state=this.formatStateObject([]),a.state.current){case"Playing":a.Playing=this.formatPlayingObject([]);break;case"Buffering":a.Buffering=this.formatBufferingObject([]);break;case"Paused":a.Paused=this.formatPausedObject([]);break;case"Stopped":a.Stopped=this.formatStoppedObject([]);break;case"Seeking":a.Seeking=this.formatSeekingObject([])}return this.updateFormatterState(a,!1),a.Playing=this.setStateObject(this.StateObject.Playing),a.Seeking=this.setStateObject(this.StateObject.Seeking),a.Stopped=this.setStateObject(this.StateObject.Stopped),a.Paused=this.setStateObject(this.StateObject.Paused),a.Buffering=this.setStateObject(this.StateObject.Buffering),a.encoding=this.formatEncodingObject([]),a.condition=this.formatConditionObject([]),a.error=this.formatErrorObject([]),this.formatStartuptime(a),this.firstAccess=!1,a},k.prototype.formatterNewState=function(a){var b={};return b.type=1,this.firstAccess?b.session=this.formatSessionObject([]):b.session=this.formatSessionObject(["playerid","browserid","uri","provider","repeatMode","repeatCount"]),b.state=this.formatStateObject([]),b.Playing=this.formatPlayingObject([]),b.Buffering=this.formatBufferingObject([]),b.Paused=this.formatPausedObject([]),b.Stopped=this.formatStoppedObject([]),b.Seeking=this.formatSeekingObject([]),this.updateFormatterState(b,!0,a),this.database.deleteMetrics("state"),this.database.deleteMetrics("action"),b.Playing=this.setStateObject(this.StateObject.Playing),b.Seeking=this.setStateObject(this.StateObject.Seeking),b.Stopped=this.setStateObject(this.StateObject.Stopped),b.Paused=this.setStateObject(this.StateObject.Paused),b.Buffering=this.setStateObject(this.StateObject.Buffering),b.encoding=this.formatEncodingObject([]),b.condition=this.formatConditionObject([]),b.error=this.formatErrorObject(["code"]),this.formatStartuptime(b),this.firstAccess=!1,b},k.prototype.formatterMetadata=function(){var a={};return a.type=2,this.firstAccess?a.session=this.formatSessionObject([]):a.session=this.formatSessionObject(["playerid","browserid","uri","provider","repeatMode","repeatCount"]),a.metadata=this.formatMetadataObject([]),this.firstAccess=!1,a},k.prototype.formatterChangeBitrate=function(){var a={};return a.type=3,this.firstAccess?a.session=this.formatSessionObject([]):a.session=this.formatSessionObject(["playerid","browserid","uri","provider","repeatMode","repeatCount"]),a.state=this.formatStateObject(["previous","previoustime","progress"]),a.encoding=this.formatEncodingObject([]),a.condition=this.formatConditionObject([]),this.database.deleteMetrics("encoding"),this.firstAccess=!1,a},k.prototype.formatterError=function(){var a={};switch(a.type=10,this.firstAccess?a.session=this.formatSessionObject([]):a.session=this.formatSessionObject(["playerid","browserid","uri","provider","repeatMode","repeatCount"]),a.state=this.formatStateObject([]),a.state.current){case"Playing":a.Playing=this.formatPlayingObject([]);break;case"Buffering":a.Buffering=this.formatBufferingObject([]);break;case"Paused":a.Paused=this.formatPausedObject([]);break;case"Stopped":a.Stopped=this.formatStoppedObject([]);break;case"Seeking":a.Seeking=this.formatSeekingObject([])}return this.updateFormatterState(a,!1),a.Playing=this.setStateObject(this.StateObject.Playing),a.Seeking=this.setStateObject(this.StateObject.Seeking),a.Stopped=this.setStateObject(this.StateObject.Stopped),a.Paused=this.setStateObject(this.StateObject.Paused),a.Buffering=this.setStateObject(this.StateObject.Buffering),a.encoding=this.formatEncodingObject([]),a.condition=this.formatConditionObject([]),a.error=this.formatErrorObject([]),this.formatStartuptime(a),this.firstAccess=!1,a},k.prototype.formatSessionObject=function(a){var b,c=this.database.getMetricObject("session");return null===c?{}:(this.data={},this.excludedList=a,this.setFieldValue("id",c.id),this.setFieldValue("playerid",c.playerid),this.setFieldValue("browserid",c.browserid),this.data.msgnbr=this.msgnbr,c.hasOwnProperty("uri")&&!this.isExcluded("uri",this.excludedList)&&(b=document.createElement("a"),b.href=c.uri,this.data.uri="/"==b.pathname.charAt(0)?b.pathname:"/"+b.pathname,this.data.dhost=b.hostname),this.setFieldValue("provider",c.provider),this.setFieldValue("repeatMode",c.loopMode),this.setFieldValue("repeatCount",c.loopCount),this.data)},k.prototype.formatStateObject=function(a){function b(a){return a.charAt(0).toUpperCase()+a.slice(1)}var c=this.database.getMetricObject("state",!0);return null===c?{}:(this.data={},this.excludedList=a,this.setFieldValue("current",b(c.current)),this.setFieldValue("detail",c.reason),this.setFieldValue("previous",b(c.previousState)),this.setFieldValue("previoustime",c.previousTime),this.setFieldValue("progress",c.position),this.data)},k.prototype.formatEncodingObject=function(a){var b=this.database.getMetricObject("encoding",!0,this.isVideo),c=this.database.getMetricObject("metadata",!0,this.isVideo);return null===c||null===b?{}:(this.data={},this.excludedList=a,this.setFieldValue("current",c.bitrates[b.index]),this.setFieldValue("min",0),this.setFieldValue("max",c.bitrates[c.bitrates.length-1]),this.data)},k.prototype.formatStartuptime=function(a){var b=this.database.getMetricObject("session");b&&b.startTime&&b.startPlayingTime&&(a.startuptime=Math.round(b.startPlayingTime-b.startTime)/1e3)},k.prototype.formatConditionObject=function(a){var b=this.database.getMetricObject("condition");return null===b?{}:(this.data={},this.excludedList=a,this.setFieldValue("fdc",b.droppedFrames),this.setFieldValue("wsize",b.windowSize),this.setFieldValue("full",b.fullScreen),this.setFieldValue("fps",b.fps),this.setFieldValue("dspeed",b.bandwidth/1e3),this.data)},k.prototype.formatErrorObject=function(a){var b={},c=this.database.getMetrics(),d=0,e=c.length,f=null;if(!this.isExcluded("count",a))for(b.count=0,d=0;e>d;d+=1)c[d].hasOwnProperty("error")&&b.count++;return this.isExcluded("code",a)||(f=this.database.getMetricObject("error",!0),null!==f&&(b.code=f.code,b.message=f.message)),b},k.prototype.formatMetadataObject=function(a){var b,c=this.database.getMetricObject("session"),d=this.database.getMetricObject("metadata",!1,this.isVideo);return this.data={},this.excludedList=a,this.setFieldValue("playertype",c.playerType),null===d?this.data:(d.hasOwnProperty("duration")&&(b=d.duration<0?"LIVE":"VOD"),this.setFieldValue("videoid",d.id),this.setFieldValue("encodingbr",d.bitrates),this.setFieldValue("contenttype",b),this.setFieldValue("contentduration",d.duration),this.setFieldValue("encodingformat",d.codec),this.setFieldValue("encapsulation",d.format),this.data)},f.formatters.CSQoE=k,m.prototype.setFilter=function(a,b){this[a]=b},m.prototype.isEnabled=function(){return this.enable},n.prototype=Object.create(AbstractFormatter.prototype),n.prototype.constructor=n,n.prototype.parseEventsFilter=function(a){var b,c=new m,d=a.split(";"),e=[],f=0,g=0;for(f=0;f<d.length;f+=1)for(b=d[f].split(","),e[b[0]]=[],g=1;g<b.length;g+=1)e[b[0]].push(b[g]);return c.setFilter("error",new l(e.error)),c.setFilter("profil",new l(e.profil)),c.setFilter("usage",new l(e.usage)),c},n.prototype.init=function(){AbstractFormatter.prototype.init.call(this),this.duration=0},n.prototype.generateSessionId=function(){return AbstractFormatter.prototype.generateSessionId.call(this,"-")},n.prototype.process=function(a){var b=null;return this.database?(a?(a.hasOwnProperty("metadata")&&void 0!==a.metadata.duration&&(this.duration=a.metadata.duration),a.hasOwnProperty("session")?b=this.formatterSession():a.hasOwnProperty("error")?b=this.formatterRealTime("has/realtime/error/"):a.hasOwnProperty("action")&&this.eventTypeRealTimeFilter.usage.enable===!0?b=this.formatterRealTime("has/realtime/use/"):a.hasOwnProperty("encoding")&&this.eventTypeRealTimeFilter.profil.enable===!0?b=this.formatterRealTime("has/realtime/profil/"):a.hasOwnProperty("state")&&this.firstAccess===!1&&("stopped"===a.state.current&&"init"!==a.state.previousState?b=this.formatterSession():"buffering"===a.state.current&&(b=this.formatterRealTime("has/realtime/error/","buffering")))):b=this.formatterRecurring(),b&&this.msgnbr++,b):b},n.prototype.formatterRecurring=function(){return this.duration>=0?null:this.formatterSession(["status"])},n.prototype.formatterRealTime=function(a,b){var c,d,e,f=[],g={},h={};if(f.push((new Date).getTime()),f.push(a),!this.eventTypeRealTimeFilter.isEnabled())return null;switch(g=this.formatSessionObject(["playerId","browserid","uuid","status"]),a){case"has/realtime/use/":h=this.formatLastActionObject([]);break;case"has/realtime/profil/":h=this.formatLastEncodingObject([]);break;case"has/realtime/error/":if(b&&"buffering"===b){if(c=this.database.getMetricObject("state",!0),null===c)return null;d=new F.Error,d.code=0,d.message="buffering state",d.position=this.formatPositionValue(c.position),h=this.formatErrorObject([],d)}else h=this.formatLastErrorObject([]);if(h.Condition=this.formatTheConditionObject([]),this.eventTypeRealTimeFilter.error.enable===!1||this.eventTypeRealTimeFilter.error.enable===!0&&-1===this.eventTypeRealTimeFilter.error.param.indexOf(h.orangeErrorCode))return null}for(e in h)g[e]=h[e];return g.Playing=this.formatPlayingObject([]),g.Buffering=this.formatBufferingObject([]),g.Seeking=this.formatSeekingObject([]),g.Paused=this.formatPausedObject([]),g.State=this.formatStateObject(),g.msgnbr=this.msgnbr,f.push(g),f},n.prototype.formatterSession=function(){var a=[],b={};return a.push((new Date).getTime()),a.push("has/session/"),this.eventTypeSessionFilter.isEnabled()?(b=this.formatSessionObject([]),b.MetaData=this.formatMetadataObject([]),b.events={},b.events.usage=[],b.events.error=[],b.events.profil=[],b.events.profil=this.formatMetricsList("encoding",this.eventTypeSessionFilter.profil.param[0],this.eventTypeSessionFilter.profil.param[1],this.isVideo),b.events.usage=this.formatMetricsList("action",this.eventTypeSessionFilter.usage.param[0],this.eventTypeSessionFilter.usage.param[1],this.isVideo),b.events.error=this.formatMetricsList("error",this.eventTypeSessionFilter.error.param[0],this.eventTypeSessionFilter.error.param[1]),b.counts={},b.counts.error=[],b.counts.profil=[],b.counts.playing=this.formatPlayingObject([]),b.counts.buffering=this.formatBufferingObject([]),b.counts.seeking=this.formatSeekingObject([]),b.counts.paused=this.formatPausedObject([]),b.counts.profil=this.getCountsMetricTypeObject("encoding","bitrate",["originBitrate","position"],this.isVideo),b.counts.error=this.getCountsMetricTypeObject("error","orangeErrorCode",["chunkURL","errorCode","comment"]),a.push(b),a):null},n.prototype.formatMetricsList=function(a,b,c,d){var e=[],f=this.database.getMetricsObjects(a,b,c,d),g=0;if(f.length>0)for(g=0;g<f.length;g+=1)switch(a){case"encoding":e.push(this.formatEncodingObject([],f[g][a]));break;case"action":var h=this.formatActionObject([],f[g][a]);this.setFieldValue("date",f[g].date),e.push(h);break;case"error":e.push(this.formatErrorObject([],f[g][a]));break;default:return[]}return e},n.prototype.getCountsMetricTypeObject=function(a,b,c,d){var e=this.database.getMetricsObjects(a,void 0,void 0,d);return this.formatMetricCounts(c,e,a,b)},n.prototype.formatSessionObject=function(a){var b,c,d=this.database.getMetricObject("session");return null===d?{}:(this.data={},this.excludedList=a,this.setFieldValue("clientSessionId",d.id),this.setFieldValue("playerId",d.playerid),this.setFieldValue("uuid",void 0),this.setFieldValue("url",d.uri),this.setFieldValue("userAgent",d.userAgent),this.setFieldValue("contentId",void 0),this.setFieldValue("minBitrate",d.minBitrate),this.setFieldValue("maxBitrate",d.maxBitrate),this.setFieldValue("startLaunchDate",d.startTime),this.setFieldValue("startBufferingDate",d.startBufferingTime),this.setFieldValue("watchStartDate",d.startPlayingTime),this.setFieldValue("status","IN_PROGRESS"),this.firstAccess===!0?this.firstAccess=!1:(c=this.database.getMetricObject("state",!0),null!==c&&"stopped"===c.current&&(2===c.reason?this.setFieldValue("status","KO"):this.setFieldValue("status","OK"),this.setFieldValue("maxPosition",this.formatPositionValue(d.maxPosition)),this.setFieldValue("watchEndDate",(new Date).getTime()))),b=this.database.getMetricObject("metadata",!0,this.isVideo),null===b?this.data:(this.setFieldValue("contentDuration",b.duration),this.data))},n.prototype.formatStateObject=function(){function a(a){return a.charAt(0).toUpperCase()+a.slice(1)}var b=this.database.getMetricObject("state",!0);return null===b?{}:(this.data={},this.data.current=a(b.current),this.data.detail=b.reason,this.data.previous=a(b.previousState),this.data.previoustime=b.previousTime,this.data)},n.prototype.formatEncodingObject=function(a,b){return this.excludedList=a,this.data={},this.setFieldValue("originBitrate",b.previousBitrate),this.setFieldValue("changeBitrate",b.bitrate),this.setFieldValue("position",this.formatPositionValue(b.position)),this.data},n.prototype.formatMetricCounts=function(a,b,c,d){var e,f=0,g=0,h=b.length,i=[],j=[],k=0,l=0,m=null;for(f=0;h>f;f+=1)if(m=b[f][c],e=m[d],k=1,l=b[f][c].time,void 0===j[e]){for(g=f+1;h>g;g+=1)b[g][c][d]===e&&(k++,"encoding"===c&&(l+=b[g][c].time));if("encoding"===c)this.formatEncodingObject(a,m),this.setFieldValue("time",l);else{if("error"!==c)return{};this.formatErrorObject(a,m)}this.setFieldValue("nb",k),i.push(this.data),j[e]=!0}return i},n.prototype.formatLastEncodingObject=function(a){var b=this.database.getMetricObject("encoding",!0,this.isVideo);return null===b?{}:this.formatEncodingObject(a,b)},n.prototype.formatActionObject=function(a,b){var c=-1;switch(this.data={},this.excludedList=a,b.type){case"seek":c=this.USE_SEEK;break;case"play":c=this.USE_PLAY;break;case"pause":c=this.USE_PAUSE;break;case"initial_start":c=this.USE_PLAY}return this.setFieldValue("typeCode",c),this.setFieldValue("position",this.formatPositionValue(b.position)),this.data},n.prototype.formatLastActionObject=function(a){var b=this.database.getMetricObject("action",!0);return null===b?{}:this.formatActionObject(a,b)},n.prototype.formatTheConditionObject=function(a){var b=this.database.getMetricObject("condition");return null===b?{}:this.formatConditionObject(a,b)},n.prototype.formatConditionObject=function(a,b){return this.data={},this.excludedList=a,this.setFieldValue("fdc",b.droppedFrames),this.setFieldValue("wsize",b.windowSize),this.setFieldValue("full",b.fullScreen),this.setFieldValue("fps",b.fps),this.setFieldValue("dspeed",b.bandwidth/1e3),this.data},n.prototype.formatErrorObject=function(a,b){switch(this.data={},this.excludedList=a,b.code){case 0:this.setFieldValue("orangeErrorCode",this.ORANGE_STALLED_STREAM_ERROR);break;case"MEDIA_KEYERR":case"MEDIA_KEYERR_UNKNOWN":case"MEDIA_KEYERR_CLIENT":case"MEDIA_KEYERR_SERVICE":case"MEDIA_KEYERR_OUTPUT":case"MEDIA_KEYERR_HARDWARECHANGE":case"MEDIA_KEYERR_DOMAIN":case"MEDIA_KEYSYSERR_ACCESS_DENIED":case"MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN":case"MEDIA_KEYMESSERR_NOCHALLENGE":case"MEDIA_KEYMESSERR_XHR_ABORTED":case"MEDIA_KEYMESSERR_XHR_ERROR":case"MEDIA_KEYMESSERR_NO_SESSION":case"MEDIA_KEYMESSERR_NO_REMOVE_SESSION":case"MEDIA_KEYMESSERR_NO_CLOSE_SESSION":case"MEDIA_ERR_DECODE":case"MEDIA_ERR_ENCRYPTED":case"CAPABILITY_ERR_MEDIAKEYS":case"MEDIA_ERR_SRC_NOT_SUPPORTED":case"MANIFEST_ERR_CODEC":this.setFieldValue("orangeErrorCode",this.ORANGE_DRM_OR_DECODER_ERROR);break;case"CC_ERR_PARSE":case"MEDIA_ERR_APPEND_SOURCEBUFFER":case"MEDIA_ERR_REMOVE_SOURCEBUFFER":case"MEDIA_ERR_CREATE_SOURCEBUFFER":case"MANIFEST_ERR_PARSE":case"MANIFEST_ERR_NOSTREAM":case"CAPABILITY_ERR_MEDIASOURCE":case"HASPLAYER_INIT_ERROR":this.setFieldValue("orangeErrorCode",this.ORANGE_UNDEFINED_PLAYER_ERROR);break;case"DOWNLOAD_ERR_MANIFEST":case"DOWNLOAD_ERR_CONTENT":case"DOWNLOAD_ERR_INIT":case"DOWNLOAD_ERR_SIDX":case"MEDIA_ERR_ABORTED":case"MEDIA_ERR_NETWORK":this.setFieldValue("orangeErrorCode",this.ORANGE_HTTP_ERROR);break;default:this.setFieldValue("orangeErrorCode",this.ORANGE_UNDEFINED_PLAYER_ERROR)}return this.setFieldValue("chunkURL",b.chunkURL),this.setFieldValue("position",this.formatPositionValue(b.position)),this.setFieldValue("errorCode",b.code),this.setFieldValue("comment",b.message),this.data},n.prototype.formatLastErrorObject=function(a){var b=this.database.getMetricObject("error",!0);return null===b?{}:this.formatErrorObject(a,b)},n.prototype.formatMetadataObject=function(a){var b,c,d=this.database.getMetricObject("session"),e=this.database.getMetricObject("metadata",!1,this.isVideo);return this.data={},this.excludedList=a,this.setFieldValue("playerType",d.playerType),null===e?this.data:(e.hasOwnProperty("duration")&&(b=e.duration<0?"LIVE":"VOD"),this.setFieldValue("encodingBr",e.bitrates),this.setFieldValue("contentType",b),this.setFieldValue("encodingFormat",e.codec),this.setFieldValue("encapsulation",e.format),c=this.database.getMetricObject("condition"),null===c?this.data:(this.setFieldValue("fdc",c.droppedFrames),this.data))},n.prototype.formatPositionValue=function(a){return Math.round(1e3*a)},n.prototype.DEFAULT_EVENTS_OBJECT_FILTER="session;realtime",n.prototype.DEFAULT_EVENT_TYPE_SESSION_FILTER="error;profil;usage",n.prototype.DEFAULT_EVENT_TYPE_REALTIME_FILTER="error;profil",n.prototype.ORANGE_STREAM_BROKEN_ERROR=10,n.prototype.ORANGE_HTTP_ERROR=20,n.prototype.ORANGE_STALLED_STREAM_ERROR=30,n.prototype.ORANGE_DRM_OR_DECODER_ERROR=40,n.prototype.ORANGE_DRM_NO_LICENSE=41,n.prototype.ORANGE_DRM_INVALID_LICENSE=42,n.prototype.ORANGE_DRM_INVALID_LICENSE2=43,n.prototype.ORANGE_GENERIC_ERROR=50,n.prototype.ORANGE_UNDEFINED_PLAYER_ERROR=99,n.prototype.ORANGE_DEVICE_CRASH_ERROR=100,n.prototype.USE_PLAY=1,n.prototype.USE_PAUSE=2,n.prototype.USE_STOP=3,n.prototype.USE_FAST_FORWARD=4,n.prototype.USE_FAST_BACKWARD=5,n.prototype.USE_SEEK=6,f.formatters.Prisme=n,q=this.dijon,w});
/* jshint ignore:end */
